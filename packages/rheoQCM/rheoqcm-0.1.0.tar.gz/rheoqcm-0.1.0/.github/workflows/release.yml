name: Release to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Run full test suite before publishing
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true  # Stop on first failure for releases
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        uv venv --python ${{ matrix.python-version }}
        uv pip install -e ".[dev]"

    - name: Run tests (excluding GUI and hardware)
      timeout-minutes: 20
      shell: bash
      run: |
        uv run pytest tests -v \
          -p no:pytest-qt \
          -m "not gui and not hardware" \
          --cov=src/rheoQCM \
          --cov-report=xml \
          --cov-report=term-missing \
          -n auto

  # Run linting checks
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python 3.12
      run: uv python install 3.12

    - name: Install dependencies
      run: |
        uv venv --python 3.12
        uv pip install -e ".[dev]"

    - name: Run Ruff lint
      run: uv run ruff check src tests

    - name: Run Ruff format
      run: uv run ruff format --check src tests

    - name: Run MyPy
      run: uv run mypy src/rheoQCM --ignore-missing-imports --no-strict-optional

  # Build documentation to ensure it works
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python 3.12
      run: uv python install 3.12

    - name: Install dependencies
      run: |
        uv venv --python 3.12
        uv pip install -e ".[dev]"
        uv pip install -r docs/requirements.txt

    - name: Build documentation
      run: |
        uv run sphinx-build -W -b html docs/source docs/build

  # Build and publish to PyPI (only after all tests pass)
  publish:
    name: Publish to PyPI
    needs: [test, lint, docs]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rheoQCM
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: |
        uv venv --python 3.12
        uv pip install -e ".[dev]"

    - name: Build package
      run: uv run python -m build

    - name: Verify package metadata
      run: uv run twine check dist/*

    - name: Verify version matches release tag
      env:
        GITHUB_REF: ${{ github.ref }}
      run: |
        # Extract version from pyproject.toml
        PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        # Extract version from git tag (remove 'v' prefix if present)
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        TAG_VERSION=${TAG_VERSION#refs/tags/}

        echo "Package version: $PACKAGE_VERSION"
        echo "Git tag version: $TAG_VERSION"

        if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Package version ($PACKAGE_VERSION) does not match git tag ($TAG_VERSION)"
          exit 1
        fi

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        verbose: true
