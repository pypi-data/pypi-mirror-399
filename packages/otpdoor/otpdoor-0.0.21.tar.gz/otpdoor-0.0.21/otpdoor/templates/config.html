<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - OTPdoor</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/_auth_style.css">
    <script>
        function confirmSecretReset() {
            return confirm("CRITICAL ACTION: This will IMMEDIATELY invalidate all currently configured devices. You will need to re-scan the new QR code on all devices to maintain access.\n\nAre you absolutely sure you want to proceed?");
        }
    </script>
</head>

<body class="{{ 'light-mode' if theme == 'light' else '' }}">
    <div class="config-card">
        <h1>OTPdoor Settings</h1>
        {% if is_default_secret %}
        <div class="error-message" style="margin-top: 1rem; border: 2px solid var(--error-text);">
            <strong>üö® SECURITY RISK: DEFAULT SECRET DETECTED</strong><br>
            You are using the well-known default TOTP secret. Please generate a new one below for the 'default' domain
            to secure your installation.
        </div>
        {% endif %}

        {% if message %}
        <div class="message success">
            {{ message }}
        </div>
        {% endif %}

        <div class="section">
            <h2>Interface Theme</h2>
            <form method="POST" action="?domain={{ domain }}">
                <input type="hidden" name="action" value="update_theme">
                <div class="form-group">
                    <label>Selected Theme:</label>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" name="theme" value="dark"
                            class="{{ 'btn-secondary' if theme == 'light' else '' }}" style="flex: 1;">Dark
                            Mode</button>
                        <button type="submit" name="theme" value="light"
                            class="{{ 'btn-secondary' if theme == 'dark' else '' }}" style="flex: 1;">Light
                            Mode</button>
                    </div>
                </div>
            </form>
        </div>

        {% if domain == 'default' %}
        <div class="section">
            <h2>Managed Domains</h2>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">
                Manage existing authentication domains.
            </p>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for d in domains %}
                <a href="?domain={{ d }}" class="domain-tag {{ 'active' if d == domain else '' }}"
                    style="text-decoration: none;">
                    {{ d }}
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="section">
            <h2>Create New Domain</h2>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">
                Add a new authentication domain for a specific application.
            </p>
            <form method="POST" action="?domain=default">
                <input type="hidden" name="action" value="add_domain">
                <div class="form-group">
                    <label for="new_domain">Domain Name:</label>
                    <input type="text" id="new_domain" name="new_domain" placeholder="e.g. myapp" required
                        pattern="[a-zA-Z0-9_-]+" title="Alphanumeric, underscores, and hyphens only">
                </div>
                <button type="submit">Create Domain</button>
            </form>
        </div>
        {% else %}
        <div class="section">
            <a href="?domain=default" style="font-size: 0.85rem; color: var(--accent); text-decoration: none;">‚Üê Back to
                Default Domain Management</a>
        </div>
        {% endif %}

        <div class="section">
            <h2>Session Duration</h2>
            <form method="POST" action="?domain={{ domain }}">
                <input type="hidden" name="action" value="update_duration">
                <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label>Duration:</label>
                        <input type="number" name="duration" value="{{ display_duration }}" required>
                    </div>
                    <div style="width: 120px;">
                        <label>Unit:</label>
                        <select name="unit">
                            <option value="seconds" {% if unit=='seconds' %}selected{% endif %}>Seconds</option>
                            <option value="minutes" {% if unit=='minutes' %}selected{% endif %}>Minutes</option>
                            <option value="hours" {% if unit=='hours' %}selected{% endif %}>Hours</option>
                        </select>
                    </div>
                </div>
                <button type="submit">Update Duration</button>
            </form>
        </div>

        <div class="section">
            <h2>TOTP Secret</h2>
            <div class="warning-box">
                <strong>Highly Sensitive Action (Domain: {{ domain }})</strong>
                Generating a new secret will immediately invalidate all existing devices.
                You will lose access until you scan the new QR code.
            </div>
            <p style="font-size: 0.9rem; margin-bottom: 1rem;">Current Secret: <span class="current-value">{{ secret
                    }}</span></p>
            <form method="POST" action="?domain={{ domain }}" onsubmit="return confirmSecretReset()">
                <input type="hidden" name="action" value="new_secret">
                <button type="submit" class="btn-secondary">Generate New Secret</button>
            </form>

            {% if provisioning_uri %}
            <div class="qr-section">
                <p style="margin-bottom: 1rem; font-size: 0.9rem;">Scan this QR code with your authenticator:</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={{ provisioning_uri | urlencode }}"
                    alt="QR Code">
                <p style="font-size: 0.8rem; color: var(--text-muted);">Warning: This will invalidate old devices for {{
                    domain }}.</p>
            </div>
            {% endif %}
        </div>

        <div class="section" id="test-section">
            <h2>Test Configuration</h2>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.25rem;">
                Verify your authenticator app is synced correctly with this domain.
            </p>

            {% if test_message %}
            <div class="message {{ 'success' if 'Success' in test_message else 'error-message' }}"
                style="margin-bottom: 1.5rem;">
                {{ test_message }}
            </div>
            {% endif %}

            <form method="POST" action="?domain={{ domain }}#test-section">
                <input type="hidden" name="action" value="test_code">
                <div style="display: flex; gap: 12px; align-items: stretch;">
                    <div style="flex: 1.5;">
                        <input type="text" name="test_code" placeholder="000 000" required pattern="\d{6}"
                            title="6-digit authentication code" maxlength="6"
                            style="text-align: center; letter-spacing: 0.2em; font-family: 'Outfit', sans-serif; font-weight: 700; height: 50px; font-size: 1.25rem; margin: 0;">
                    </div>
                    <div style="flex: 1;">
                        <button type="submit" style="height: 50px; margin: 0; padding: 0;">Verify Code</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="nav-links">
            <a href="{{ auth_path }}?domain={{ domain }}" style="color: var(--text-muted); font-size: 0.8rem;">Session
                Sign Out</a>
        </div>
    </div>
</body>

</html>