name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'

jobs:
  pypi-publish:
    name: Upload release to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/causers
    permissions:
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install maturin
        run: pip install maturin

      - name: Sync Cargo.toml version with Git Tag
        shell: bash
        run: |
          # 1. Get the version from the tag (v0.1.0 -> 0.1.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Syncing Cargo.toml to version $VERSION"
          
          # 2. Use sed to replace the version in Cargo.toml
          # This regex looks for 'version = "..."' inside Cargo.toml and updates it
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          
          # 3. Verify it worked
          grep "^version" Cargo.toml

      - name: Build and Publish
        run: maturin publish