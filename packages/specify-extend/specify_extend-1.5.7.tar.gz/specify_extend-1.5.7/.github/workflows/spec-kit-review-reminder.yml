name: Spec-Kit Review Reminder

# This workflow automatically comments on spec-kit PRs to remind about review requirements
# and integrates with GitHub's code review system

on:
  pull_request:
    types: [opened, reopened]
    branches:
      - main
      - master
      - develop

permissions:
  pull-requests: write
  contents: read

jobs:
  review-reminder:
    name: Post Review Reminder
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if spec-kit branch
        id: check_branch
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch: $BRANCH_NAME"

          # Check if branch matches spec-kit extension patterns
          if [[ "$BRANCH_NAME" =~ ^(bugfix|modify|refactor|hotfix|deprecate|cleanup|baseline|enhance)/ ]] || \
             [[ "$BRANCH_NAME" =~ ^[0-9]+-.*$ ]]; then
            echo "is_speckit=true" >> $GITHUB_OUTPUT

            # Extract workflow type
            if [[ "$BRANCH_NAME" =~ ^([a-z]+)/ ]]; then
              WORKFLOW_TYPE="${BASH_REMATCH[1]}"
            elif [[ "$BRANCH_NAME" =~ ^[0-9]+ ]]; then
              WORKFLOW_TYPE="feature"
            else
              WORKFLOW_TYPE="unknown"
            fi

            echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT

            # Get workflow command
            case "$WORKFLOW_TYPE" in
              bugfix) COMMAND="/speckit.bugfix" ;;
              enhance) COMMAND="/speckit.enhance" ;;
              modify) COMMAND="/speckit.modify" ;;
              refactor) COMMAND="/speckit.refactor" ;;
              hotfix) COMMAND="/speckit.hotfix" ;;
              deprecate) COMMAND="/speckit.deprecate" ;;
              cleanup) COMMAND="/speckit.cleanup" ;;
              baseline) COMMAND="/speckit.baseline" ;;
              feature) COMMAND="/speckit.specify" ;;
              *) COMMAND="/speckit.*" ;;
            esac

            echo "command=$COMMAND" >> $GITHUB_OUTPUT
          else
            echo "is_speckit=false" >> $GITHUB_OUTPUT
          fi

      - name: Check review status
        if: steps.check_branch.outputs.is_speckit == 'true'
        id: review_status
        run: |
          # Search for review file
          REVIEW_FOUND=false
          REVIEW_APPROVED=false

          # Search in specs directory
          for review_file in $(find specs .specify/specs \( -name "review.md" -o -name "review-report.md" -o -name "review-notes.md" -o -name "REVIEW.md" \) 2>/dev/null); do
            if [ -f "$review_file" ]; then
              REVIEW_FOUND=true

              # Check if approved
              if grep -qiE '\*\*Status\*\*:?\s*(‚úÖ|:white_check_mark:)?\s*Approved' "$review_file"; then
                REVIEW_APPROVED=true
                break
              fi
            fi
          done

          echo "review_found=$REVIEW_FOUND" >> $GITHUB_OUTPUT
          echo "review_approved=$REVIEW_APPROVED" >> $GITHUB_OUTPUT

      - name: Post reminder comment
        if: steps.check_branch.outputs.is_speckit == 'true' && steps.review_status.outputs.review_approved != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowType = '${{ steps.check_branch.outputs.workflow_type }}';
            const command = '${{ steps.check_branch.outputs.command }}';
            const reviewFound = '${{ steps.review_status.outputs.review_found }}' === 'true';

            let emoji = 'üìã';
            let statusMessage = '';

            if (reviewFound) {
              emoji = '‚ö†Ô∏è';
              statusMessage = `
            ## ‚ö†Ô∏è Review Status

            A review file was found, but it doesn't show an "Approved" status.

            Please ensure your review file contains:
            \`\`\`markdown
            **Status**: ‚úÖ Approved
            \`\`\`
            or
            \`\`\`markdown
            **Status**: ‚ö†Ô∏è Approved with Notes
            \`\`\`
            `;
            } else {
              statusMessage = `
            ## üìã Review Required

            This PR is from a spec-kit workflow branch but doesn't have a completed code review yet.
            `;
            }

            const comment = `${emoji} **Spec-Kit Review Reminder**

            ${statusMessage}

            ### Before merging this PR:

            1. **Complete the code review**:
               \`\`\`bash
               /speckit.review
               \`\`\`

            2. **Verify review status**:
               - Review file should be created in your spec directory
               - Status should be "‚úÖ Approved" or "‚ö†Ô∏è Approved with Notes"
               - Review should validate implementation against specification

            3. **Commit the review file**:
               \`\`\`bash
               git add specs/*/review.md
               git commit -m "Add code review for ${workflowType}"
               git push
               \`\`\`

            ### About Spec-Kit Review

            The \`/speckit.review\` workflow:
            - ‚úÖ Validates implementation against specification
            - ‚úÖ Checks code quality and best practices
            - ‚úÖ Runs tests and verifies results
            - ‚úÖ Documents findings and recommendations
            - ‚úÖ Updates task completion status

            ### Review Outcomes

            Your review will result in one of three outcomes:

            - **‚úÖ Approved** - All criteria met, ready to merge
            - **‚ö†Ô∏è Approved with Notes** - Minor issues that don't block merge
            - **‚ùå Needs Changes** - Issues must be fixed before merge

            ### Automated Checks

            This PR will be automatically checked for:
            - Existence of review file in spec directory
            - Review status is "Approved" or "Approved with Notes"
            - PRs without approved reviews will be **blocked from merging**

            ---

            üí° **Tip**: You can run the review helper workflow to check your review status:
            \`Actions ‚Üí Spec-Kit Review Helper ‚Üí Run workflow ‚Üí check-status\`

            üìö **Need help?** See the [review workflow documentation](extensions/workflows/review/README.md)
            `;

            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Post success comment
        if: steps.check_branch.outputs.is_speckit == 'true' && steps.review_status.outputs.review_approved == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `‚úÖ **Spec-Kit Review Complete**

            This PR has a completed and approved code review! üéâ

            The automated review check will verify:
            - ‚úÖ Review file exists
            - ‚úÖ Review status is "Approved"
            - ‚úÖ Ready for merge

            Thank you for following the spec-kit workflow!
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Request review (if configured)
        if: steps.check_branch.outputs.is_speckit == 'true' && steps.review_status.outputs.review_approved != 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Optional: Auto-request review from team or individuals
            // Configure in repository settings or uncomment and customize:

            // const reviewers = ['username1', 'username2'];  // GitHub usernames
            // const teams = ['team-name'];  // GitHub team slugs

            // try {
            //   await github.rest.pulls.requestReviewers({
            //     owner: context.repo.owner,
            //     repo: context.repo.repo,
            //     pull_number: context.issue.number,
            //     reviewers: reviewers,
            //     team_reviewers: teams
            //   });
            //   console.log('Review requested from configured reviewers');
            // } catch (error) {
            //   console.log('Could not request reviews:', error.message);
            // }

            console.log('Review request step (currently disabled - configure if needed)');

      - name: Add labels
        if: steps.check_branch.outputs.is_speckit == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowType = '${{ steps.check_branch.outputs.workflow_type }}';
            const reviewApproved = '${{ steps.review_status.outputs.review_approved }}' === 'true';

            const labels = [`spec-kit:${workflowType}`];

            if (!reviewApproved) {
              labels.push('needs-review');
            } else {
              labels.push('review-approved');
            }

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            } catch (error) {
              console.log('Could not add labels:', error.message);
            }
