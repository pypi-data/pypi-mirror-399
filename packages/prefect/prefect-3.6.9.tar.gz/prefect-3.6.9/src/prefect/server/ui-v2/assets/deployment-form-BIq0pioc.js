import{j as e,r as m,s as M,c as Y,G as Z,L as H}from"./vendor-tanstack-zpsXWFxg.js";import{du as K,U as Q,V as J,X as q,Y as z,_ as B,Z as R,$,a0 as U,aT as ee,o as O,I as re,u as S,M as ae,S as se,a as oe,b as ne,c as le,d as te,e as A,ac as ce,dv as ie,cM as me,ai as de,ao as p,a2 as k,aj as h,ak as x,al as j,am as b,an as ue,ar as pe,x as he,J as xe}from"./index-4D6ue93A.js";import{u as je,L as be}from"./lazy-schema-form-T24oREiG.js";import"./primitives-DRAYI_UV.js";import"./toggle-group-CtVLGj1O.js";import{u as _e,m as ge,E as ve}from"./vendor-codemirror-KWel9Npa.js";import{W as ye}from"./deployment-action-header-PnKCwBPh.js";import{d as fe,b as G,c as y,r as Se,g as Ce,e as Ne,h as Ee,N as we,f as ke}from"./vendor-forms-DEIP3aGx.js";const Le=({presetOptions:s=[],selected:o,onSelect:a})=>e.jsx(m.Suspense,{children:e.jsx(Fe,{presetOptions:s,selected:o,onSelect:a})}),Fe=({presetOptions:s=[],selected:o,onSelect:a})=>{const[t,n]=m.useState(""),{data:c}=M(K()),l=m.useDeferredValue(t),d=m.useMemo(()=>c.filter(r=>r.name.toLowerCase().includes(l.toLowerCase())),[c,l]),i=m.useMemo(()=>s.filter(r=>r.label.toLowerCase().includes(l.toLowerCase())),[l,s]);return e.jsxs(Q,{children:[e.jsx(J,{selected:!!o,"aria-label":"Select a global concurrency limit",children:c.find(r=>r.id===o)?.name}),e.jsxs(q,{children:[e.jsx(z,{value:t,onValueChange:n,placeholder:"Search for a global concurrency limit..."}),e.jsx(B,{children:"No global concurrency limit found"}),e.jsx(R,{children:e.jsxs($,{children:[i.map(r=>e.jsx(U,{selected:o===r.value,onSelect:()=>{a(r.value),n("")},value:String(r.label),children:r.label},r.label)),d.map(r=>e.jsx(U,{selected:o===r.name,onSelect:g=>{a(g),n("")},value:r.id,children:r.name},r.id))]})})]})]})},Ie=[ge(),ve.lineWrapping],X=Y.forwardRef(({className:s,value:o,onChange:a,copy:t=!1,onBlur:n,disabled:c,hideLineNumbers:l=!1,...d},i)=>{const r=m.useRef(null);let g;c&&(g={lineNumbers:!l,highlightActiveLine:!1,foldGutter:!1,highlightActiveLineGutter:!1});const{setContainer:f}=_e({container:r.current,extensions:Ie,value:o,onChange:a,indentWithTab:!1,editable:!c,basicSetup:g});m.useEffect(()=>{r.current&&f(r.current)},[f]);const C=u=>{S.success("Copied to clipboard"),navigator.clipboard.writeText(u)};return e.jsx("div",{className:ee("rounded-md border shadow-xs overflow-hidden focus-within:outline-hidden focus-within:ring-1 focus-within:ring-ring relative",s),ref:u=>{r.current=u,typeof i=="function"?i(u):i&&(i.current=u)},...d,children:t&&o&&e.jsx(O,{onClick:()=>C(o),variant:"ghost",size:"icon",className:"absolute top-0 right-0 z-10","aria-label":"copy",children:e.jsx(re,{id:"Copy",className:"size-2"})})})});X.displayName="MarkdownInput";const Ve=({presetOptions:s=[],selected:o,onSelect:a})=>e.jsx(m.Suspense,{children:e.jsx(Te,{presetOptions:s,selected:o,onSelect:a})}),Te=({presetOptions:s=[],selected:o,onSelect:a})=>{const[t,n]=m.useState(""),{data:c}=M(ae()),l=m.useDeferredValue(t),d=m.useMemo(()=>c.filter(r=>r.name.toLowerCase().includes(l.toLowerCase())),[c,l]),i=m.useMemo(()=>s.filter(r=>r.label.toLowerCase().includes(l.toLowerCase())),[l,s]);return e.jsxs(Q,{children:[e.jsx(J,{selected:!!o,"aria-label":"Select a work pool",children:o}),e.jsxs(q,{children:[e.jsx(z,{value:t,onValueChange:n,placeholder:"Search for a work pool..."}),e.jsx(B,{children:"No work pool found"}),e.jsx(R,{children:e.jsxs($,{children:[i.map(r=>e.jsx(U,{selected:o===r.value,onSelect:()=>{a(r.value),n("")},value:String(r.label),children:r.label},r.label)),d.map(r=>e.jsx(U,{selected:o===r.name,onSelect:g=>{a(g),n("")},value:r.name,children:r.name},r.id))]})})]})]})},L={ENQUEUE:"ENQUEUE",CANCEL_NEW:"CANCEL_NEW"},Ue=({onValueChange:s,value:o})=>e.jsxs(se,{value:o,onValueChange:a=>{s(a===""?void 0:a)},children:[e.jsx(oe,{children:e.jsx(ne,{placeholder:L.ENQUEUE})}),e.jsx(le,{children:e.jsxs(te,{children:[e.jsx(A,{value:L.ENQUEUE,children:L.ENQUEUE}),e.jsx(A,{value:L.CANCEL_NEW,children:L.CANCEL_NEW})]})})]}),Oe=(s,{mode:o})=>G({name:y().refine(a=>o==="edit"?!0:a!==s.name,{message:"Name must be different from the original deployment"}),description:y().nullable().optional(),work_pool_name:y().nullable().optional(),work_queue_name:y().nullable().optional(),tags:Ne(y()).optional(),concurrency_options:G({collision_strategy:ke(["ENQUEUE","CANCEL_NEW"]).optional()}).nullable().optional(),job_variables:y().superRefine((a,t)=>{try{return a?JSON.parse(a):void 0}catch(n){return console.error(n),t.addIssue({code:"custom",message:"Invalid JSON"}),we}}),enforce_parameter_schema:Ce(),parameter_openapi_schema:Se(Ee()).optional().nullable().readonly(),global_concurrency_limit_id:y().uuid().optional().nullable()}),De={name:"",description:"",tags:[],job_variables:"",enforce_parameter_schema:!0,global_concurrency_limit_id:null},We=(s,{mode:o})=>{const a=Z(),t=fe({resolver:ce(Oe(s,{mode:o})),defaultValues:De}),{values:n,setValues:c,errors:l,validateForm:d}=je(),{createDeployment:i}=ie(),{updateDeployment:r}=me();return m.useEffect(()=>{const{name:f,description:C,work_pool_name:u,work_queue_name:F,tags:I,concurrency_options:V,parameter_openapi_schema:T,enforce_parameter_schema:N,job_variables:E,global_concurrency_limit:w}=s;c(s.parameters),t.reset({description:C,name:f,work_pool_name:u,work_queue_name:F,tags:I,concurrency_options:V,parameter_openapi_schema:T,enforce_parameter_schema:N,job_variables:E?JSON.stringify(E):"",global_concurrency_limit_id:w?.id})},[t,s,c]),{form:t,onSave:async f=>{const{name:C,job_variables:u,description:F,work_pool_name:I,work_queue_name:V,tags:T,enforce_parameter_schema:N,concurrency_options:E,parameter_openapi_schema:w,global_concurrency_limit_id:D}=f,W=u?JSON.parse(u):void 0;if(w&&N)try{await d({schema:w})}catch(v){const _="Unknown error while updating validating schema.";S.error(_),console.error(_,v)}if(l.length>0)return;const P=E?.collision_strategy?{collision_strategy:E.collision_strategy}:void 0;switch(o){case"duplicate":i({concurrency_options:P,description:F,enforce_parameter_schema:N,flow_id:s.flow_id,job_variables:W,name:C,parameters:n,parameter_openapi_schema:w||void 0,paused:s.paused,tags:T,work_pool_name:I||null,work_queue_name:V||null,global_concurrency_limit_id:D},{onSuccess:({id:v})=>{S.success("Deployment created"),a({to:"/deployments/deployment/$id",params:{id:v}})},onError:v=>{const _=v.message||"Unknown error while creating deployment.";console.error(_),S.error(_)}});break;case"edit":r({concurrency_options:P,description:F,enforce_parameter_schema:N,id:s.id,job_variables:W,parameters:n,paused:s.paused,tags:T,work_pool_name:I||null,work_queue_name:V||null,global_concurrency_limit_id:D},{onSuccess:()=>{S.success("Deployment updated"),a({to:"/deployments/deployment/$id",params:{id:s.id}})},onError:v=>{const _=v.message||"Unknown error while updating deployment.";console.error(_),S.error(_)}});break}},parametersFormValues:n,setParametersFormValues:c,parameterFormErrors:l}},Be=({deployment:s,mode:o})=>{const{form:a,onSave:t,parameterFormErrors:n,setParametersFormValues:c,parametersFormValues:l}=We(s,{mode:o}),d=a.watch("work_pool_name"),i=a.getValues("parameter_openapi_schema");return e.jsx(de,{...a,children:e.jsxs("form",{onSubmit:r=>{a.handleSubmit(t)(r)},className:"space-y-4",children:[e.jsx(p,{children:a.formState.errors.root?.message}),e.jsx(k,{variant:"h3",children:"General"}),e.jsx(h,{control:a.control,name:"name",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Name"}),e.jsx(b,{children:e.jsx(ue,{...r,value:r.value,disabled:o==="edit"})}),e.jsx(p,{})]})}),e.jsx(h,{control:a.control,name:"description",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Description (Optional)"}),e.jsx(b,{children:e.jsx(X,{"aria-label":"deployment description input",value:r.value??"",onChange:r.onChange})}),e.jsx(p,{})]})}),e.jsx(h,{control:a.control,name:"work_pool_name",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Work Pool (Optional)"}),e.jsx(b,{children:e.jsx(Ve,{presetOptions:[{label:"None",value:""}],onSelect:r.onChange,selected:r.value})}),e.jsx(p,{})]})}),d&&e.jsx(h,{control:a.control,name:"work_queue_name",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Work Queue (Optional)"}),e.jsx(b,{children:e.jsx(ye,{workPoolName:d,presetOptions:[{label:"None",value:""}],onSelect:r.onChange,selected:r.value})}),e.jsx(p,{})]})}),e.jsx(h,{control:a.control,name:"tags",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Tags (Optional)"}),e.jsx(b,{children:e.jsx(pe,{...r})}),e.jsx(p,{})]})}),e.jsx(h,{control:a.control,name:"concurrency_options.collision_strategy",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:e.jsxs("div",{className:"col gap-1 mb-0.5",children:[e.jsx(k,{variant:"bodySmall",children:"Concurrency Limit Collision Strategy (Optional)"}),e.jsx(k,{variant:"bodySmall",className:"text-muted-foreground",children:"Configure behavior for runs once the concurrency limit is reached."})]})}),e.jsx(b,{children:e.jsx(Ue,{value:r.value,onValueChange:r.onChange})}),e.jsx(p,{})]})}),e.jsx(h,{control:a.control,name:"global_concurrency_limit_id",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Global concurrency limit"}),e.jsx(b,{children:e.jsx(Le,{presetOptions:[{label:"None",value:null}],onSelect:r.onChange,selected:r.value})}),e.jsx(p,{})]})}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx(k,{variant:"h3",className:"mb-4",children:"Parameters"}),i&&e.jsx(be,{schema:i,errors:n,values:l,onValuesChange:c,kinds:["json"]}),e.jsx(h,{control:a.control,name:"enforce_parameter_schema",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Enforce Parameter Schema"}),e.jsx(b,{children:e.jsx(he,{className:"block",checked:r.value,onCheckedChange:r.onChange})}),e.jsx(p,{})]})})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx(k,{variant:"h3",className:"mb-4",children:"Job Variables"}),e.jsx(h,{control:a.control,name:"job_variables",render:({field:r})=>e.jsxs(x,{children:[e.jsx(j,{children:"Job Variables (Optional)"}),e.jsx(b,{children:e.jsx(xe,{...r})}),e.jsx(p,{})]})})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(H,{to:"/deployments/deployment/$id",params:{id:s.id},children:e.jsx(O,{variant:"secondary",children:"Cancel"})}),e.jsx(O,{type:"submit",children:"Save"})]})]})})};export{Be as D};
//# sourceMappingURL=deployment-form-BIq0pioc.js.map
