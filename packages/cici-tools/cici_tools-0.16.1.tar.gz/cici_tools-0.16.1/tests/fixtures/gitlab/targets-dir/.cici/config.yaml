# SPDX-FileCopyrightText: UL Research Institutes
# SPDX-License-Identifier: Apache-2.0

name: opentofu

repo_url: https://gitlab.com/saferatday0/library/opentofu

gitlab_project_path: saferatday0/library/opentofu

brief: >-
  Deploy OpenTofu-managed infrastructure from GitLab.

description: |-

  OpenTofu is an open-source infrastructure-as-code tool that serves as
  a community-driven fork of Terraform. Created in response to HashiCorp’s
  license change for Terraform, OpenTofu maintains compatibility with
  Terraform’s configuration language and state files while being governed
  by the Linux Foundation.

  It allows developers and DevOps teams to define, provision, and manage
  cloud infrastructure using declarative configuration files. OpenTofu
  supports the same providers and modules as Terraform, making it a
  drop-in replacement that can manage resources across AWS, Azure, Google
  Cloud, and hundreds of other services.

  The key advantage of OpenTofu is that it remains truly open-source under
  the Mozilla Public License 2.0, ensuring it will always be free to use
  and modify without licensing restrictions.

  This pipeline:

  - Formats the Opentofu-managed project with
    [opentofu fmt](https://opentofu.org/docs/cli/commands/fmt/).

  - Validates the Opentofu-managed project with
    [opentofu validate](https://opentofu.org/docs/cli/commands/validate/).

  - Plans the Opentofu-managed project with
    [opentofu plan](https://opentofu.org/docs/cli/commands/plan/).

  - Applies the Opentofu-managed project with
    [opentofu apply](https://opentofu.org/docs/cli/commands/apply/).

  - Runs Trivy scanner against the Opentofu-managed project with
    [trivy config](https://trivy.dev/v0.48/docs/references/configuration/cli/trivy_config/).

  - Publishes an OpenTofu module when a new tag is cut.

  ## Configuration

  ### Multiple environments

  When multiple environments are deployed from a project, it will likely be
  necessary to use different variable values for different environments.
  To add credentials specific to an environment, use one of the following
  environment scopes:

    - development - `development/*`

    - production - `production/*`

    - staging - `staging/*`

  ## Usage

  ### Dual deployment preset

  Include the pipeline:

  ```yaml
  include:
  - project: saferatday0/library/opentofu
    file:
      - opentofu-fmt.yml
      - opentofu-staging-auto-apply.yml
      - opentofu-staging-trivy.yml
      - opentofu-staging-validate.yml
      - opentofu-production-apply.yml
      - opentofu-production-plan.yml
      - opentofu-production-trivy.yml
      - opentofu-production-validate.yml
  ```

  ### Deploy to all default environemts

  Include the pipeline:

  ```yaml
  include:
  - project: saferatday0/library/opentofu
    file:
      - opentofu-development-auto-apply.yml
      - opentofu-production-apply.yml
      - opentofu-production-plan.yml
      - opentofu-staging-auto-apply.yml
  ```

  ### Publish an OpenTofu Module

  An opentofu module will only get published when a new tag is cut. Make sure
  you set the following environment variable in the .gitlab-ci.yml at the root
  level of this project. Without it, the module will fail to publish. You can
  set it anything you would like for example: google, aws, azure etc. In the
  following example it is being set to google.

  ```yaml
  variables:
    OPENTOFU_MODULE_SYSTEM: google
  ```

  ### Run trivy

  `trivy`` does misconfiguration scanning for OpenTofu. Include the pipeline for
  the relevant deployments:

  ```yaml
  include:
  - project: saferatday0/library/opentofu
    file:
      - opentofu-production-trivy.yml
  ```

  ### Deploy to a `production`` environment

  Include the pipeline:

  ```yaml
  include:
  - project: saferatday0/library/opentofu
    file:
      - opentofu-production-apply.yml
      - opentofu-production-plan.yml
  ```

  ### Deploy to a `staging` environment

  Include the pipeline:

  ```yaml
  include:
  - project: saferatday0/library/opentofu
    file:
      - opentofu-staging-auto-apply.yml
  ```

  ### Run `opentofu validate`

  Include the pipeline:

  ```yaml
  include:
  - project: saferatday0/library/opentofu
    file:
      - opentofu-production-validate.yml
  ```

  ### Run `trivy`

  trivy does misconfiguration scanning for OpenTofu. Include the pipeline for
  the relevant deployments:

  ```yaml
  include:
    - project: saferatday0/library/opentofu
      file:
        - opentofu-production-trivy.yml
  ```

variables:
  OPENTOFU_MODULE_VERSION:
    brief: Opentofu module version.
    default: "${CI_COMMIT_TAG}"

  OPENTOFU_MODULE_NAME:
    brief: Opentofu module project name.
    default: "${CI_PROJECT_NAME}"

  OPENTOFU_MODULE_DIR:
    brief: Opentofu module project directory.
    default: "${CI_PROJECT_DIR}"
