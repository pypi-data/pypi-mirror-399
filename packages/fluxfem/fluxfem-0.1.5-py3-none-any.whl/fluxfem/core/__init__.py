from .forms import FormContext, MixedFormContext, FieldPair, ElementVector, vector_load_form
from .context_types import VolumeContext, SurfaceContext
from .space import (
    FESpaceBase,
    FESpace,
    FESpacePytree,
    make_space,
    make_space_pytree,
    make_tet_space,
    make_tet_space_pytree,
    make_tet10_space,
    make_tet10_space_pytree,
    make_hex_space,
    make_hex_space_pytree,
    make_hex20_space,
    make_hex20_space_pytree,
    make_hex27_space,
    make_hex27_space_pytree,
)
from .data import MeshData, BasisData, SpaceData
from .basis import (
    make_hex_basis,
    make_hex_basis_pytree,
    make_hex20_basis,
    make_hex20_basis_pytree,
    make_hex27_basis,
    make_hex27_basis_pytree,
    make_tet_basis,
    make_tet_basis_pytree,
    make_tet10_basis,
    make_tet10_basis_pytree,
)
from .assembly import (
    assemble_bilinear_form,
    assemble_linear_form,
    assemble_functional,
    assemble_residual,
    assemble_jacobian,
    assemble_residual_scatter,
    assemble_jacobian_scatter,
    assemble_residual_elementwise_xla,
    assemble_jacobian_elementwise_xla,
    make_element_residual_kernel,
    make_element_jacobian_kernel,
    element_residual,
    element_jacobian,
    make_sparsity_pattern,
    assemble_jacobian_values,
    assemble_mass_matrix,
    scalar_body_force_form,
    make_scalar_body_force_form,
    constant_body_force_form,
)
from ..physics.elasticity.linear import vector_body_force_form, constant_body_force_vector_form
from .interp import eval_shape_functions_hex8, interpolate_field_at_element_points
from .weakform import (
    Expr,
    FieldRef,
    ParamRef,
    trial_ref,
    test_ref,
    unknown_ref,
    Params,
    LinearForm,
    BilinearForm,
    ResidualForm,
    compile_surface_linear,
    MixedWeakForm,
    compile_bilinear,
    compile_linear,
    compile_residual,
    compile_mixed_residual,
    grad,
    sym_grad,
    outer,
    dot,
    sdot,
    ddot,
    inner,
    action,
    gaction,
    normal,
    ds,
    dOmega,
    I,
    det,
    inv,
    transpose,
    log,
    transpose_last2,
    matmul,
    matmul_std,
    einsum,
)
from ..mesh import (
    BaseMeshPytree,
    bbox_predicate,
    plane_predicate,
    axis_plane_predicate,
    slab_predicate,
    HexMesh,
    HexMeshPytree,
    StructuredHexBox,
    SurfaceMesh,
    SurfaceMeshPytree,
    tag_axis_minmax_facets,
    TetMesh,
    TetMeshPytree,
    StructuredTetBox,
    StructuredTetTensorBox,
    load_gmsh_mesh,
    load_gmsh_hex_mesh,
    load_gmsh_tet_mesh,
    make_surface_from_facets,
)
from .basis import (
    HexTriLinearBasis,
    HexTriLinearBasisPytree,
    HexSerendipityBasis20,
    HexSerendipityBasis20Pytree,
    HexTriQuadraticBasis27,
    HexTriQuadraticBasis27Pytree,
    TetLinearBasis,
    TetLinearBasisPytree,
    TetQuadraticBasis10,
    TetQuadraticBasis10Pytree,
)
import importlib

from ..physics import lame_parameters, isotropic_3d_D
from .solver import spdirect_solve_cpu, spdirect_solve_gpu, spdirect_solve_jax, coo_to_csr

_SOLVER_EXPORTS = {
    "SparsityPattern",
    "FluxSparseMatrix",
    "LinearSolver",
    "NonlinearSolver",
    "enforce_dirichlet_dense",
    "enforce_dirichlet_sparse",
    "free_dofs",
    "condense_dirichlet_fluxsparse",
    "condense_dirichlet_dense",
    "expand_dirichlet_solution",
    "cg_solve",
    "cg_solve_jax",
    "NonlinearAnalysis",
    "NewtonLoopConfig",
    "LoadStepResult",
    "NewtonSolveRunner",
    "solve_nonlinear",
    "LinearAnalysis",
    "LinearSolveConfig",
    "LinearStepResult",
    "LinearSolveRunner",
    "newton_solve",
}

_SOLVER_BC_EXPORTS = {
    "SurfaceFormField",
    "SurfaceFormContext",
    "vector_surface_load_form",
    "make_vector_surface_load_form",
    "assemble_surface_linear_form",
}


def __getattr__(name: str):
    if name in _SOLVER_EXPORTS:
        module = importlib.import_module("..solver", __name__)
    elif name in _SOLVER_BC_EXPORTS:
        module = importlib.import_module("..solver.bc", __name__)
    else:
        raise AttributeError(f"module {__name__!r} has no attribute {name!r}")

    value = getattr(module, name)
    globals()[name] = value
    return value

__all__ = [
    "FESpace",
    "FESpaceBase",
    "FESpacePytree",
    "FormContext",
    "MixedFormContext",
    "VolumeContext",
    "SurfaceContext",
    "VolumeContext",
    "SurfaceContext",
    "FieldPair",
    "ElementVector",
    "vector_load_form",
    "make_space",
    "make_space_pytree",
    "make_hex_basis",
    "make_hex_basis_pytree",
    "make_hex_space",
    "make_hex_space_pytree",
    "make_hex20_basis",
    "make_hex20_basis_pytree",
    "make_hex20_space",
    "make_hex20_space_pytree",
    "make_hex27_basis",
    "make_hex27_basis_pytree",
    "make_hex27_space",
    "make_hex27_space_pytree",
    "make_tet_basis",
    "make_tet_basis_pytree",
    "make_tet_space",
    "make_tet_space_pytree",
    "make_tet10_basis",
    "make_tet10_basis_pytree",
    "make_tet10_space",
    "make_tet10_space_pytree",
    "assemble_bilinear_form",
    "assemble_linear_form",
    "assemble_functional",
    "assemble_residual",
    "assemble_jacobian",
    "assemble_residual_scatter",
    "assemble_jacobian_scatter",
    "assemble_residual_elementwise_xla",
    "assemble_jacobian_elementwise_xla",
    "make_element_residual_kernel",
    "make_element_jacobian_kernel",
    "element_residual",
    "element_jacobian",
    "make_sparsity_pattern",
    "assemble_jacobian_values",
    "assemble_residual_elementwise",
    "assemble_jacobian_elementwise",
    "assemble_mass_matrix",
    "scalar_body_force_form",
    "make_scalar_body_force_form",
    "constant_body_force_form",
    "vector_body_force_form",
    "constant_body_force_vector_form",
    "eval_shape_functions_hex8",
    "interpolate_field_at_element_points",
    "Expr",
    "FieldRef",
    "ParamRef",
    "trial_ref",
    "test_ref",
    "unknown_ref",
    "Params",
    "LinearForm",
    "BilinearForm",
    "ResidualForm",
    "MixedWeakForm",
    "compile_bilinear",
    "compile_linear",
    "compile_residual",
    "compile_surface_linear",
    "compile_mixed_residual",
    "grad",
    "sym_grad",
    "outer",
    "dot",
    "sdot",
    "ddot",
    "inner",
    "action",
    "gaction",
    "normal",
    "ds",
    "dOmega",
    "I",
    "det",
    "inv",
    "transpose",
    "log",
    "transpose_last2",
    "matmul",
    "matmul_std",
    "einsum",
    "HexMesh",
    "HexMeshPytree",
    "StructuredHexBox",
    "SurfaceMesh",
    "SurfaceMeshPytree",
    "SurfaceFormField",
    "SurfaceFormContext",
    "vector_surface_load_form",
    "make_vector_surface_load_form",
    "assemble_surface_linear_form",
    "load_gmsh_mesh",
    "load_gmsh_hex_mesh",
    "load_gmsh_tet_mesh",
    "make_surface_from_facets",
    "TetMesh",
    "TetMeshPytree",
    "StructuredTetBox",
    "StructuredTetTensorBox",
    "tag_axis_minmax_facets",
    "BaseMeshPytree",
    "bbox_predicate",
    "plane_predicate",
    "axis_plane_predicate",
    "slab_predicate",
    "HexTriLinearBasis",
    "HexTriLinearBasisPytree",
    "HexSerendipityBasis20",
    "HexSerendipityBasis20Pytree",
    "HexTriQuadraticBasis27",
    "HexTriQuadraticBasis27Pytree",
    "TetLinearBasis",
    "TetLinearBasisPytree",
    "TetQuadraticBasis10",
    "TetQuadraticBasis10Pytree",
    "lame_parameters",
    "isotropic_3d_D",
    "spdirect_solve_cpu",
    "spdirect_solve_gpu",
    "spdirect_solve_jax",
    "coo_to_csr",
    "SparsityPattern",
    "FluxSparseMatrix",
    "LinearSolver",
    "NonlinearSolver",
    "enforce_dirichlet_dense",
    "enforce_dirichlet_sparse",
    "free_dofs",
    "condense_dirichlet_fluxsparse",
    "condense_dirichlet_dense",
    "expand_dirichlet_solution",
    "cg_solve",
    "cg_solve_jax",
    "NonlinearAnalysis",
    "NewtonLoopConfig",
    "LoadStepResult",
    "NewtonSolveRunner",
    "solve_nonlinear",
    "LinearAnalysis",
    "LinearSolveConfig",
    "LinearStepResult",
    "LinearSolveRunner",
    "newton_solve",
    "jacobian_sparse",
    "eval_shape_functions_hex8",
    "interpolate_field_at_element_points",
    "MeshData",
    "BasisData",
    "SpaceData",
]
