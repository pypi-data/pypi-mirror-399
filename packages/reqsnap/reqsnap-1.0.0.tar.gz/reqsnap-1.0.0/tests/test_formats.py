
"""
Format tests for ReqSnap (JSON, YAML, TOML)
"""

import sys
import tempfile
import json
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from reqsnap.core import RequirementsLocker


def test_json_format():
    """Test JSON format output"""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write("requests\n")
        temp_file = f.name
    
    try:
        locker = RequirementsLocker(temp_file)
        lock_data = locker.generate_lock_data()
        
        # Save as JSON
        json_file = Path(temp_file).with_suffix('.json')
        locker.save_lock_file(lock_data, str(json_file), 'json')
        
        # Verify JSON is valid
        with open(json_file, 'r') as f:
            data = json.load(f)
            assert data['summary']['total_packages'] == 1
        
        print("‚úÖ JSON format works")
        
        # Clean up
        json_file.unlink()
        
    finally:
        Path(temp_file).unlink()


def test_yaml_format():
    """Test YAML format output"""
    try:
        import yaml
        YAML_AVAILABLE = True
    except ImportError:
        YAML_AVAILABLE = False
        print("‚ö†Ô∏è  Skipping YAML test (pyyaml not installed)")
        return
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write("requests\n")
        temp_file = f.name
    
    try:
        locker = RequirementsLocker(temp_file)
        lock_data = locker.generate_lock_data()
        
        # Save as YAML
        yaml_file = Path(temp_file).with_suffix('.yaml')
        locker.save_lock_file(lock_data, str(yaml_file), 'yaml')
        
        # Verify YAML is valid
        with open(yaml_file, 'r') as f:
            data = yaml.safe_load(f)
            assert data['summary']['total_packages'] == 1
        
        print("‚úÖ YAML format works")
        
        # Clean up
        yaml_file.unlink()
        
    finally:
        Path(temp_file).unlink()


def test_toml_format():
    """Test TOML format output"""
    try:
        import toml
        TOML_AVAILABLE = True
    except ImportError:
        TOML_AVAILABLE = False
        print("‚ö†Ô∏è  Skipping TOML test (toml not installed)")
        return
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write("requests\n")
        temp_file = f.name
    
    try:
        locker = RequirementsLocker(temp_file)
        lock_data = locker.generate_lock_data()
        
        # Save as TOML
        toml_file = Path(temp_file).with_suffix('.toml')
        locker.save_lock_file(lock_data, str(toml_file), 'toml')
        
        # Verify TOML is valid
        with open(toml_file, 'r') as f:
            data = toml.load(f)
            assert data['summary']['total_packages'] == 1
        
        print("‚úÖ TOML format works")
        
        # Clean up
        toml_file.unlink()
        
    finally:
        Path(temp_file).unlink()


def test_lock_format():
    """Test traditional lock format"""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write("requests\nflask\n")
        temp_file = f.name
    
    try:
        locker = RequirementsLocker(temp_file)
        lock_data = locker.generate_lock_data()
        
        # Save as traditional lock
        lock_file = Path(temp_file).with_suffix('.lock')
        locker.save_lock_file(lock_data, str(lock_file), 'lock')
        
        # Verify lock file exists and has content
        assert lock_file.exists()
        with open(lock_file, 'r') as f:
            content = f.read()
            assert "Generated by ReqSnap" in content
        
        print("‚úÖ Traditional lock format works")
        
        # Clean up
        lock_file.unlink()
        
    finally:
        Path(temp_file).unlink()


if __name__ == "__main__":
    test_json_format()
    test_yaml_format()
    test_toml_format()
    test_lock_format()
    print("\nüéâ All format tests passed!")
