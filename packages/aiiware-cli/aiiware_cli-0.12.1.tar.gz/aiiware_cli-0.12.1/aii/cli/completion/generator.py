# Copyright 2025-present AiiWare.com. All Rights Reserved.
#
# This source code is proprietary and confidential to AiiWare.com.
# Unauthorized copying, modification, distribution, or use is strictly
# prohibited without prior written permission.

"""Shell completion script generator.

v0.12.0: Simplified - generates static completion for CLI commands.
Function-based completion removed with Pure CLI architecture.
"""


from dataclasses import dataclass, field
from typing import Dict, List, Optional


@dataclass
class CompletionSpec:
    """Specification for shell completions.

    Attributes:
        commands: List of all available command names
        flags: Mapping of command names to their available flags
        flag_values: Mapping of flag names to suggested values
    """
    commands: List[str] = field(default_factory=list)
    flags: Dict[str, List[str]] = field(default_factory=dict)
    flag_values: Dict[str, List[str]] = field(default_factory=dict)


class CompletionGenerator:
    """Generate shell completion scripts for CLI commands.

    v0.12.0: Static completion based on CLI subcommands.
    """

    # Global flags available for all commands
    GLOBAL_FLAGS = ["--help", "--version", "--debug", "--verbose", "--clean", "--standard", "--thinking"]

    # CLI subcommands (static list)
    CLI_COMMANDS = [
        "config", "doctor", "history", "mcp", "prompt", "run", "serve", "stats",
        "install-completion", "uninstall-completion", "chat"
    ]

    def __init__(self, registry: Optional[object] = None):
        """Initialize completion generator.

        Args:
            registry: Ignored in v0.12.0 (kept for backward compatibility)
        """
        self.spec = self._build_spec()

    def _build_spec(self) -> CompletionSpec:
        """Build completion specification from CLI commands.

        Returns:
            CompletionSpec with commands, flags, and flag values
        """
        flags: Dict[str, List[str]] = {}

        # Add flags for subcommands
        flags["config"] = ["init", "show", "set", "model", "provider", "--help"]
        flags["mcp"] = ["add", "remove", "list", "enable", "disable", "catalog", "install", "status", "test", "update", "list-tools", "--help"]
        flags["prompt"] = ["list", "show", "use", "create", "--help"]
        flags["run"] = ["git", "mcp", "--help"]
        flags["stats"] = ["--period", "models", "cost", "--help"]
        flags["doctor"] = ["--help"]
        flags["serve"] = ["start", "stop", "status", "--port", "--help"]
        flags["history"] = ["list", "show", "delete", "--help"]
        flags["install-completion"] = ["--shell", "--help"]
        flags["uninstall-completion"] = ["--shell", "--help"]
        flags["chat"] = ["--help"]

        return CompletionSpec(
            commands=sorted(self.CLI_COMMANDS),
            flags=flags,
            flag_values={
                "--shell": ["bash", "zsh", "fish"],
                "--period": ["7d", "30d", "90d", "all"],
            }
        )

    def generate_bash(self) -> str:
        """Generate bash completion script."""
        commands = " ".join(self.spec.commands)

        case_statements = []
        for cmd, cmd_flags in self.spec.flags.items():
            flags_str = " ".join(cmd_flags)
            case_statements.append(f'        {cmd})\n            flags="{flags_str}"\n            ;;')

        cases = "\n".join(case_statements)

        return f'''# Bash completion for aii
# Generated by aii completion generator

_aii_completion() {{
    local cur prev commands flags
    cur="${{COMP_WORDS[COMP_CWORD]}}"
    prev="${{COMP_WORDS[COMP_CWORD-1]}}"
    commands="{commands}"

    if [[ $COMP_CWORD -eq 1 ]]; then
        COMPREPLY=($(compgen -W "$commands" -- "$cur"))
        return 0
    fi

    local cmd="${{COMP_WORDS[1]}}"
    case "$cmd" in
{cases}
        *)
            flags="--help"
            ;;
    esac

    COMPREPLY=($(compgen -W "$flags" -- "$cur"))
    return 0
}}

complete -F _aii_completion aii
'''

    def generate_zsh(self) -> str:
        """Generate zsh completion script."""
        commands_with_desc = []
        descriptions = {
            "config": "Configure aii settings",
            "doctor": "Run health checks",
            "history": "Manage chat history",
            "mcp": "MCP server management",
            "prompt": "Prompt library management",
            "run": "Run domain operations",
            "serve": "Manage API server",
            "stats": "Usage statistics",
            "chat": "Interactive chat mode",
            "install-completion": "Install shell completion",
            "uninstall-completion": "Uninstall shell completion"
        }

        for cmd in self.spec.commands:
            desc = descriptions.get(cmd, cmd)
            commands_with_desc.append(f'        "{cmd}:{desc}"')

        commands_list = "\n".join(commands_with_desc)

        return f'''#compdef aii
# Zsh completion for aii

_aii() {{
    local -a commands
    commands=(
{commands_list}
    )

    _arguments -C \\
        '1: :->command' \\
        '*::arg:->args'

    case $state in
        command)
            _describe -t commands 'aii commands' commands
            ;;
    esac
}}

_aii "$@"
'''

    def generate_fish(self) -> str:
        """Generate fish completion script."""
        completions = []
        descriptions = {
            "config": "Configure aii settings",
            "doctor": "Run health checks",
            "history": "Manage chat history",
            "mcp": "MCP server management",
            "prompt": "Prompt library management",
            "run": "Run domain operations",
            "serve": "Manage API server",
            "stats": "Usage statistics",
            "chat": "Interactive chat mode",
            "install-completion": "Install shell completion",
            "uninstall-completion": "Uninstall shell completion"
        }

        for cmd in self.spec.commands:
            desc = descriptions.get(cmd, cmd)
            completions.append(f'complete -c aii -n "__fish_use_subcommand" -a "{cmd}" -d "{desc}"')

        return "# Fish completion for aii\n# Generated by aii completion generator\n\n" + "\n".join(completions) + "\n"
