name: üß™ Test

on:
  push:
    branches: [main]
    paths:
      - .github/workflows/test.yml
      - target_s3tables/**
      - tests/**
      - pyproject.toml
      - uv.lock
  pull_request:
    paths:
      - .github/workflows/test.yml
      - target_s3tables/**
      - tests/**
      - pyproject.toml
      - uv.lock
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1

permissions:
  id-token: write # Needed for AWS OIDC authentication

jobs:
  unit_tests:
    name: üß™ Unit Tests / Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v6

      - name: üèó Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: üèó Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: ">=0.8"

      - name: ‚ñ∂Ô∏è Run Tox
        run: |
          uvx --with=tox-uv tox -e ${{ matrix.python-version }}

  integration_tests_glue_rest:
    name: üß™ Integration Tests / Glue Rest / Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SINGER_SDK_LOG_CONFIG: ./target_s3tables_logging.yaml
      TARGET_S3TABLES_CATALOG_MODE: glue_rest
      TARGET_S3TABLES_REGION: ${{ secrets.AWS_REGION }}
      TARGET_S3TABLES_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      TARGET_S3TABLES_TABLE_BUCKET_NAME: ${{ secrets.S3TABLES_TABLE_BUCKET_NAME }}
      TARGET_S3TABLES_NAMESPACE: default
      TARGET_S3TABLES_WRITE_MODE: append
      TARGET_S3TABLES_BATCH_SIZE_ROWS: 5000
      TARGET_S3TABLES_SANITIZE_NAMES: true
      TARGET_S3TABLES_CREATE_TABLES: true
      TARGET_S3TABLES_EVOLVE_SCHEMA: true
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v6

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/S3TablesTestGitHubActions
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üèó Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: üèó Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: ">=0.8"

      - name: üì¶ Install dependencies
        run: |
          uv sync --frozen
          uv tool install meltano

      - name: ‚öôÔ∏è Set table name prefix
        run: |
          # The table name prefix is set to be the python version with the '.' removed
          echo "TARGET_S3TABLES_TABLE_NAME_PREFIX=glue_rest_$(echo ${{ matrix.python-version }} | tr -d '.')" >> $GITHUB_ENV

      - name: ‚ñ∂Ô∏è Run Meltano
        run: |
          meltano run tap-smoke-test target-s3tables

  integration_tests_s3tables_rest:
    name: üß™ Integration Tests / S3Tables Rest / Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SINGER_SDK_LOG_CONFIG: ./target_s3tables_logging.yaml
      TARGET_S3TABLES_CATALOG_MODE: s3tables_rest
      TARGET_S3TABLES_TABLE_BUCKET_ARN: arn:aws:s3tables:${{ secrets.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:bucket/${{ secrets.S3TABLES_TABLE_BUCKET_NAME }}
      TARGET_S3TABLES_REGION: ${{ secrets.AWS_REGION }}
      TARGET_S3TABLES_NAMESPACE: default
      TARGET_S3TABLES_WRITE_MODE: append
      TARGET_S3TABLES_BATCH_SIZE_ROWS: 5000
      TARGET_S3TABLES_SANITIZE_NAMES: true
      TARGET_S3TABLES_CREATE_TABLES: true
      TARGET_S3TABLES_EVOLVE_SCHEMA: true
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v6

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/S3TablesTestGitHubActions
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üèó Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: üèó Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: ">=0.8"

      - name: üì¶ Install dependencies
        run: |
          uv sync --frozen
          uv tool install meltano

      - name: ‚öôÔ∏è Set table name prefix
        run: |
          # The table name prefix is set to be the python version with the '.' removed
          echo "TARGET_S3TABLES_TABLE_NAME_PREFIX=s3tables_rest_$(echo ${{ matrix.python-version }} | tr -d '.')" >> $GITHUB_ENV

      - name: ‚ñ∂Ô∏è Run Meltano
        run: |
          meltano run tap-smoke-test target-s3tables

  type_check:
    name: ‚òëÔ∏è Type Checking
    runs-on: ubuntu-latest
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v6

      - name: üèó Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: üèó Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: ">=0.8"

      - name: ‚ñ∂Ô∏è Run Tox
        run: |
          uvx --with=tox-uv tox -e typing
