# src/kitagentsdk/templates/Makefile.template
export PYTHONDONTWRITEBYTECODE=1

VENV             ?= .venv
PYTHON_SYSTEM    ?= python3
MAIN_SCRIPT      ?= main.py

OUTPUT_DIR       ?= _output
CONFIG_TRAIN     ?= config-train.json
CONFIG_TEST      ?= config-test.json
REQUIREMENTS     ?= requirements.txt

# SDK install mode:
#   - pypi:     install kitagentsdk from requirements.txt (recommended for users)
#   - editable: pip install -e ../kitagentsdk (recommended for SDK development)
SDK_MODE         ?= pypi
SDK_PATH         ?= ../kitagentsdk

# Optional: add cert/trusted-host/proxy args here when needed
PIP_EXTRA_ARGS   ?=

ifeq ($(OS),Windows_NT)
	VENV_BIN = Scripts
else
	VENV_BIN = bin
endif

VENV_PYTHON = $(VENV)/$(VENV_BIN)/python
PIP        = $(VENV_PYTHON) -m pip

.PHONY: help all install install-sdk clean train test config-train config-test

help:
	@echo ""
	@echo "Kit Agent: {{AGENT_NAME}}"
	@echo ""
	@echo "Targets:"
	@echo "  make install            Create venv + install deps"
	@echo "  make train              Run training (uses $(CONFIG_TRAIN))"
	@echo "  make test               Run test/backtest (uses $(CONFIG_TEST))"
	@echo "  make config-train       Create a minimal train config JSON"
	@echo "  make config-test        Create a minimal test config JSON"
	@echo "  make clean              Remove venv + build artifacts"
	@echo ""
	@echo "Options:"
	@echo "  SDK_MODE=pypi|editable  (default: $(SDK_MODE))"
	@echo "  SDK_PATH=../kitagentsdk (default: $(SDK_PATH))"
	@echo "  PYTHON_SYSTEM=python3   (default: $(PYTHON_SYSTEM))"
	@echo "  PIP_EXTRA_ARGS='...'    (default: empty)"

all: install

install: $(VENV)/.created install-sdk
	@echo "üêç Installing remaining requirements from $(REQUIREMENTS)..."
	@$(PIP) install -r $(REQUIREMENTS) $(PIP_EXTRA_ARGS)
	@echo "‚úÖ Installation complete."

$(VENV)/.created:
	@if [ ! -d "$(VENV)" ]; then \
		echo "üêç Creating Python virtual environment..."; \
		$(PYTHON_SYSTEM) -m venv $(VENV); \
	fi
	@echo "üêç Upgrading pip..."
	@$(PIP) install --upgrade pip $(PIP_EXTRA_ARGS)
	@touch $(VENV)/.created

install-sdk:
	@if [ "$(SDK_MODE)" = "editable" ]; then \
		echo "üêç Installing kitagentsdk in editable mode from $(SDK_PATH)..."; \
		$(PIP) install -e $(SDK_PATH) $(PIP_EXTRA_ARGS); \
		echo "‚ö†Ô∏è  If your $(REQUIREMENTS) pins kitagentsdk==..., remove that line to avoid conflicts."; \
	else \
		echo "üêç Using kitagentsdk from PyPI (via $(REQUIREMENTS))..."; \
	fi

config-train:
	@if [ -f "$(CONFIG_TRAIN)" ]; then \
		echo "‚ÑπÔ∏è  $(CONFIG_TRAIN) already exists."; \
	else \
		echo '{ "total_steps": 1000, "learning_rate": 0.0001 }' > $(CONFIG_TRAIN); \
		echo "‚úÖ Wrote $(CONFIG_TRAIN) (edit values as needed)."; \
	fi

config-test:
	@if [ -f "$(CONFIG_TEST)" ]; then \
		echo "‚ÑπÔ∏è  $(CONFIG_TEST) already exists."; \
	else \
		echo '{ "total_steps": 0 }' > $(CONFIG_TEST); \
		echo "‚úÖ Wrote $(CONFIG_TEST) (edit values as needed)."; \
	fi

clean:
	@echo "üßπ Cleaning up project..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf $(VENV) $(OUTPUT_DIR) *.egg-info dist build
	@echo "‚úÖ Cleanup complete."

train: install
	@if [ ! -f "$(CONFIG_TRAIN)" ]; then \
		echo "‚ùå Missing $(CONFIG_TRAIN). Run: make config-train (then edit it)"; \
		exit 1; \
	fi
	@echo "üöÄ Training..."
	@rm -rf $(OUTPUT_DIR) && mkdir -p $(OUTPUT_DIR)
	@$(VENV_PYTHON) $(MAIN_SCRIPT) train --config $(CONFIG_TRAIN) --output-path ./$(OUTPUT_DIR)
	@echo "‚úÖ Training done. See $(OUTPUT_DIR)/"

test: install
	@if [ ! -f "$(CONFIG_TEST)" ]; then \
		echo "‚ùå Missing $(CONFIG_TEST). Run: make config-test (then edit it)"; \
		exit 1; \
	fi
	@echo "üöÄ Testing / backtest..."
	@mkdir -p $(OUTPUT_DIR)
	@$(VENV_PYTHON) $(MAIN_SCRIPT) test --config $(CONFIG_TEST) --output-path ./$(OUTPUT_DIR)
	@echo "‚úÖ Test done."
