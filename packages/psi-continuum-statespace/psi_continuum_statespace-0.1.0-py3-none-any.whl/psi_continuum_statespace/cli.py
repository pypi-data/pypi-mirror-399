# psi_continuum_statespace/cli.py

"""
Command-line interface for the Psi–Continuum state-space diagnostics.

All files generated by this CLI are runtime artefacts produced for
demonstration and exploratory purposes and do not represent published
results.
"""

import argparse
import json
import csv
from datetime import datetime

import numpy as np

from psi_continuum_v2.cosmology.models.lcdm_params import LCDMParams
from psi_continuum_v2.cosmology.models.psicdm_params import PsiCDMParams

from .consistency import compute_consistency_bundle
from .plotting import (
    plot_consistency,
    plot_state_space_differences,
)
from .diagnostics import (
    max_deviation,
    integrated_distance,
)


# ---------------------------------------------------------------------
# Default model setup
# ---------------------------------------------------------------------

def build_default_models():
    """
    Default illustrative parameter sets.

    These values are placeholders for demonstration purposes
    and do not represent fitted observational results.
    """
    lcdm = LCDMParams(H0=70.0, Om0=0.3)

    param_sets = {
        "SN-only":  PsiCDMParams(H0=70.0, Om0=0.3, eps0=0.020),
        "BAO-only": PsiCDMParams(H0=70.0, Om0=0.3, eps0=0.040),
        "Joint":    PsiCDMParams(H0=70.0, Om0=0.3, eps0=0.030),
    }

    return lcdm, param_sets


# ---------------------------------------------------------------------
# Interactive shell
# ---------------------------------------------------------------------

def interactive_loop(z, lcdm, param_sets):
    """
    Interactive Psi–Continuum state-space diagnostics shell.
    """
    Psi_bundle = compute_consistency_bundle(z, lcdm, param_sets)
    session_log = []

    def timestamp():
        return datetime.now().strftime("%Y%m%d_%H%M%S")

    menu = """
Psi–Continuum State-Space Diagnostics
------------------------------------
1. Plot Ψ(z) trajectories
2. Plot |ΔΨ(z)| relative to reference
3. Show consistency metrics
4. Update ε₀ parameters and recompute
5. Exit

Select an option [1–5]: """

    while True:
        choice = input(menu).strip()

        # -------------------------------------------------------------
        # 1. Plot Psi(z)
        # -------------------------------------------------------------
        if choice == "1":
            fname = f"psi_consistency_{timestamp()}.png"
            plot_consistency(z, Psi_bundle, filename=fname)

            session_log.append({
                "action": "plot_consistency",
                "file": fname,
                "time": timestamp(),
            })

            print(f"Saved: {fname}\n")

        # -------------------------------------------------------------
        # 2. Plot differences
        # -------------------------------------------------------------
        elif choice == "2":
            labels = list(Psi_bundle.keys())

            print("\nAvailable reference trajectories:")
            for i, label in enumerate(labels, start=1):
                print(f"  {i}. {label}")

            sel = input("Select reference [default: Joint]: ").strip()

            if not sel:
                ref = "Joint"
            else:
                try:
                    ref = labels[int(sel) - 1]
                except (ValueError, IndexError):
                    print("Invalid reference selection.\n")
                    continue

            fname = f"psi_delta_{ref}_{timestamp()}.png"
            plot_state_space_differences(
                z,
                Psi_bundle,
                reference=ref,
                outfile=fname
            )

            session_log.append({
                "action": "plot_delta",
                "reference": ref,
                "file": fname,
                "time": timestamp(),
            })

            print(f"Saved: {fname}\n")

        # -------------------------------------------------------------
        # 3. Metrics
        # -------------------------------------------------------------
        elif choice == "3":
            print("\nState-space consistency metrics\n")

            labels = list(Psi_bundle.keys())
            rows = []

            for i in range(len(labels)):
                for j in range(i + 1, len(labels)):
                    a, b = labels[i], labels[j]

                    max_dev = max_deviation(
                        Psi_bundle[a],
                        Psi_bundle[b],
                        percent=True
                    )
                    dist = integrated_distance(
                        z,
                        Psi_bundle[a],
                        Psi_bundle[b]
                    )

                    print(f"{a} ↔ {b}")
                    print(f"  max |ΔΨ| = {max_dev:.3f} %")
                    print(f"  ∫|ΔΨ| dz = {dist:.5f}\n")

                    rows.append((a, b, max_dev, dist))

            csv_name = f"psi_metrics_{timestamp()}.csv"
            with open(csv_name, "w", newline="") as f:
                writer = csv.writer(f)
                writer.writerow(
                    ["model_a", "model_b", "max_delta_percent", "integrated_distance"]
                )
                writer.writerows(rows)

            session_log.append({
                "action": "metrics",
                "file": csv_name,
                "time": timestamp(),
            })

            print(f"Metrics saved to {csv_name}\n")

        # -------------------------------------------------------------
        # 4. Update eps0
        # -------------------------------------------------------------
        elif choice == "4":
            print("\nUpdate ε₀ values (press Enter to keep current):")

            for label, params in param_sets.items():
                current = params.eps0
                value = input(f"  {label} ε₀ [{current:.3f}]: ").strip()
                if value:
                    try:
                        params.eps0 = float(value)
                    except ValueError:
                        print("Invalid value, keeping previous ε₀.")

            Psi_bundle = compute_consistency_bundle(z, lcdm, param_sets)

            session_log.append({
                "action": "update_eps0",
                "values": {k: v.eps0 for k, v in param_sets.items()},
                "time": timestamp(),
            })

            print("Ψ(z) recomputed.\n")

        # -------------------------------------------------------------
        # 5. Exit
        # -------------------------------------------------------------
        elif choice == "5":
            log_name = f"psi_session_{timestamp()}.json"
            with open(log_name, "w") as f:
                json.dump(session_log, f, indent=2)

            print(f"Session log saved to {log_name}")
            print("Exiting interactive shell.")
            break

        else:
            print("Invalid choice. Please select 1–5.\n")


# ---------------------------------------------------------------------
# Main entry point
# ---------------------------------------------------------------------

def main():
    parser = argparse.ArgumentParser(
        description="Psi–Continuum state-space diagnostics"
    )

    subparsers = parser.add_subparsers(dest="command")

    subparsers.add_parser("plot", help="Plot Psi(z) state-space trajectories")
    subparsers.add_parser("diff", help="Plot |ΔPsi(z)| relative to joint solution")
    subparsers.add_parser("metrics", help="Print state-space consistency metrics")
    subparsers.add_parser(
        "interactive",
        aliases=["i"],
        help="Interactive Psi–Continuum state-space shell"
    )

    args = parser.parse_args()

    if args.command is None:
        parser.print_help()
        return

    # Late-time redshift range used for illustrative diagnostics
    z = np.linspace(0.0, 2.0, 300)
    lcdm, param_sets = build_default_models()
    Psi_bundle = compute_consistency_bundle(z, lcdm, param_sets)

    if args.command == "plot":
        plot_consistency(z, Psi_bundle, filename="psi_consistency.png")

    elif args.command == "diff":
        plot_state_space_differences(
            z,
            Psi_bundle,
            reference="Joint",
            outfile="psi_delta.png"
        )

    elif args.command == "metrics":
        print("\nPsi–Continuum state-space metrics\n")
        for a, b in [("SN-only", "Joint"), ("BAO-only", "Joint")]:
            max_dev = max_deviation(Psi_bundle[a], Psi_bundle[b], percent=True)
            dist = integrated_distance(z, Psi_bundle[a], Psi_bundle[b])
            print(f"{a} ↔ {b}")
            print(f"  max |ΔΨ|  = {max_dev:.3f} %")
            print(f"  ∫|ΔΨ| dz  = {dist:.5f}\n")

    elif args.command in ("interactive", "i"):
        interactive_loop(z, lcdm, param_sets)


if __name__ == "__main__":
    main()
