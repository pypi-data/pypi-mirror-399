name: Conventional Commits Validation

# Validates that PR titles follow conventional commits format
# Blocks PRs that don't follow the required format: type(scope): ISSUE-KEY: description
on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  pull_request_target:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  validate-conventional-commits:
    name: Validate PR Title Format
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Match pattern: type: ISSUE-KEY: description
          titlePattern: '^(\w*): (?:AL|SRED)-[0-9]{1,6}:\s(.+)$'
          titlePatternCorrespondence: "type,description"

          # Valid commit types (matching alation-ui specification)
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build

          # Custom error messages
          subjectPattern: "^(?![A-Z]).+$"
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

          headerPattern: '^(\w*): (?:AL|SRED)-[0-9]{1,6}:\s(.+)$'
          headerPatternCorrespondence: "type,subject"

        continue-on-error: false

      - name: Comment on PR if validation fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) return;

            const comment = `## ‚ùå Conventional Commits Validation Failed

            Your PR title does not follow the required conventional commits format.

            **Required format:**
            \`\`\`
            <type>: ISSUE-KEY: <description>
            \`\`\`

            **Examples:**
            - \`feat: AL-12345: add new data quality metrics\`
            - \`fix: AL-12346: resolve search pagination issue\`
            - \`docs: AL-12347: update API documentation\`
            - \`refactor: AL-12348: simplify user authentication logic\`

            **Valid types:** feat, fix, docs, style, refactor, perf, test, chore, ci, build

            **Valid issue keys:** AL-XXXXX or SRED-XXXXX

            Please update your PR title to match the required format. The PR will be blocked until the title is corrected.

            For more information see: [Conventional Commits Documentation](https://github.com/Alation/alation/blob/master/CONVENTIONAL_COMMITS.md)`;

            // Check if we already commented on this PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('Conventional Commits Validation Failed')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - name: Set commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const description = state === 'success'
              ? 'PR title follows conventional commits format'
              : 'PR title must follow conventional commits format';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request?.head.sha || context.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'Conventional Commits / PR Title Validation'
            });
