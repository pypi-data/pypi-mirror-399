name: Test SQL Lineage Library

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'examples/**'
      - 'pyproject.toml'
      - '.github/workflows/test-clpipe.yml'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'examples/**'
      - 'pyproject.toml'
      - '.github/workflows/test-clpipe.yml'

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run tests
        run: |
          uv run pytest tests/ -v

  lint:
    name: Linting and formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Check formatting with ruff
        run: |
          uv run ruff format --check src/ tests/

      - name: Lint with ruff
        run: |
          uv run ruff check src/ tests/

      - name: Type check with mypy
        run: |
          uv run mypy src/
        continue-on-error: true  # Don't fail on type errors for now

  test-examples:
    name: Test examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e .

      - name: Test simple example
        run: |
          uv run python examples/simple_example.py
        continue-on-error: true  # Examples might need API updates

      - name: Test pipeline example
        run: |
          uv run python examples/pipeline_example.py
        continue-on-error: true  # Examples might need API updates
