[project]
name = "rolypoly_tk"
dynamic = ["version"]
authors = [
    { name = "Uri Neri", email = "uneri@lbl.gov" },
    { name = "Simon Roux", email = "sroux@lbl.gov" },
    { name = "Brian Bushnell", email = "bbushnell@lbl.gov" },
    { name = "Antonio Camargo", email = "antoniop.camargo@lbl.gov" },
    { name = "Andrei Stecca Steindorff", email = "andreiss@jgi.doe.gov" },
    { name = "Clement Coclet", email = "cclement@jgi.doe.gov" },
    { name = "David Parker", email = "dparker@carnegiescience.edu" },
    { name = "Dimitris Karapliafis", email = "dimitris.karapliafis@atwur.nl" },
    { name = "Frederik Schulz", email = "fschulz@lbl.gov" },
]
description = "RNA virus analysis toolkit"
readme = "README.md"
requires-python = ">=3.9"
license = { file = "LICENSE" }
# License-File = "license"
dependencies = [
    "genomicranges>=0.7.3,<0.8",
    "iranges>=0.5.1,<0.6",
    "lightmotif>=0.10.0,<0.11",
    "mappy>=2.30,<3",
    "needletail>=0.7.0,<0.8",
    "psutil>=7.0.0,<8",
    "pyfastx>=2.2.0,<3",
    "pyhmmer>=0.11.1,<0.12",
    "requests>=2.32.4,<3",
    "rich-click>=1.8.9,<2",
    "rich>=14.0.0,<15",
    "viennarna>=2.7.0,<3",
    "intervaltree>=3.1.0,<4",
    "polars>=1.29.0,<2",
    "bbmapy>=0.0.56,<0.0.58",
    "xxhash>=3.6.0,<4",
    "pyrodigal-rv>=0.1.0,<0.2",
]

[project.urls]
Source = "https://code.jgi.doe.gov/rolypoly/rolypoly"
Documentation = "https://pages.jgi.doe.gov/rolypoly/docs/"
pypi = "https://pypi.org/project/rolypoly-tk/"

[project.scripts]
rolypoly = "rolypoly.rolypoly:rolypoly"

[dependency-groups]
build = ["hatch >=1.14.0,<2", "pip >=25.0.1,<26"]
format = ["ruff >=0.11.3,<0.12"]
publish = ["twine >=6.1.0,<7"]
dev = ["aria2p>=0.12.1,<0.13", "tqdm>=4.67.1,<5", "fsspec>=2025.10.0,<2026", "networkx>=3.2.1,<4", "matplotlib>=3.9.4,<4", "baltic>=0.3.0,<0.4", "tskit>=0.6.4,<0.7", "pytest>=8.4.2,<9"]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"


[tool.hatch.version]
path = "src/rolypoly/__init__.py"

[tool.hatch.build]
packages = ["src/rolypoly"]

[tool.hatch.build.targets.wheel]
packages = ["src/rolypoly"]
package-dir = { rolypoly_tk = "src/rolypoly" }

[tool.pixi.workspace]
channels = ["conda-forge", "bioconda"]
platforms = ["linux-64"]

[tool.pixi.pypi-dependencies]
rolypoly_tk = { path = ".", editable = true }

# Core dependencies needed for base rolypoly functionality
[tool.pixi.dependencies]
pip = ">=25.1.1,<26"

# Feature-based dependencies for modular installation
[tool.pixi.feature.reads.dependencies]
# For reads processing commands (filter-reads, shrink-reads, mask-dna)
seqkit = ">=2.10.0,<3"
bowtie = ">=1.3.1,<2"
falco = ">=1.2.5,<2"
pigz = ">=2.8,<3"

[tool.pixi.feature.assembly.dependencies]
# For assembly commands (assemble, filter-contigs)  
spades = ">=4.2.0,<5"
megahit = ">=1.2.9,<2"
plass = ">=5.cf8933,<6"
mmseqs2 = ">=17.b804f,<19"

[tool.pixi.feature.annotation-rna.dependencies]
# For RNA annotation commands (annotate-rna)
infernal = ">=1.1.5,<2"
linearfold = ">=1.0.1.dev20220829,<2"
aragorn = ">=1.2.41,<2"
trnascan-se = ">=2.0.12,<3"

[tool.pixi.feature.annotation-prot.dependencies]
# For protein annotation commands (annotate-prot)
# hmmer = ">=3.4,<4"
mmseqs2 = ">=17.b804f,<19"
diamond = ">=2.1.12,<3"

[tool.pixi.feature.identify.dependencies]
# For virus identification commands (marker-search, search-viruses)
mmseqs2 = ">=18.8cc5c,<19"
hmmer = ">=3.4,<4"
diamond = ">=2.1.12,<3"

[tool.pixi.feature.misc.dependencies]
# For miscellaneous commands (fetch-sra, quick-taxonomy, etc.)
aria2 = ">=1.37.0,<2"
freebayes = ">=1.3.10,<2"

[tool.pixi.feature.dev.dependencies]
# Development and testing tools
entrez-direct = ">=24.0,<25"
ipython = "*"
uv = ">=0.7.13,<0.8"
jupyter = "*"
ipykernel = ">=6.30.1,<7"
blast = ">=2.17.0,<3"
aria2 = ">=1.37.0,<2"

[tool.pixi.tasks]
gh-push = "src/setup/on_gh.sh push"
gh-pull = "src/setup/on_gh.sh pull"

[tool.pixi.feature.py39.dependencies]
python = "~=3.9.0"

[tool.pixi.environments]
# Minimal environment with just core Python dependencies
default = { features = ["py39"] }

# Complete environment with all dependencies (for full functionality)
complete = { features = ["py39", "reads", "assembly", "annotation-rna", "annotation-prot", "identify", "misc"] }

# Development environment
dev = { features = ["py39", "reads", "assembly", "annotation-rna", "annotation-prot", "identify", "misc", "build", "format", "publish", "dev"] }

# Specific command group environments for targeted installations
reads-only = { features = ["py39", "reads"] }
assembly-only = { features = ["py39", "assembly"] }
annotation-only = { features = ["py39", "annotation-rna", "annotation-prot"] }
annotation-rna-only = { features = ["py39", "annotation-rna"] }
annotation-prot-only = { features = ["py39", "annotation-prot"] }
identify-only = { features = ["py39", "identify"] }
misc-only = { features = ["py39", "misc"] }

# Common workflow combinations
basic-analysis = { features = ["py39", "reads", "assembly", "identify"] }
full-annotation = { features = ["py39", "reads", "assembly", "annotation-rna", "annotation-prot", "identify"] }

# [tool.pixi.project]
# platforms = []

[tool.pixi.feature.format.tasks]
format = "ruff check --select I --fix src && ruff format src"

[tool.pixi.feature.publish.tasks]
publish-pypi = "twine upload dist/* --verbose"

[tool.pixi.feature.build.tasks]
build-pypi = "hatch version micro && hatch build --clean"

[tool.pixi.feature.dev.tasks]
test-import = "python -c 'import rolypoly; print(rolypoly.__version__)'"

[tool.ruff]
exclude = [
    ".bzr",
    ".direnv",
    ".eggs",
    ".git",
    ".git-rewrite",
    ".hg",
    ".ipynb_checkpoints",
    ".mypy_cache",
    ".nox",
    ".pants.d",
    ".pyenv",
    ".pytest_cache",
    ".pytype",
    ".ruff_cache",
    ".svn",
    ".tox",
    ".venv",
    ".vscode",
    "__pypackages__",
    "_build",
    "buck-out",
    "build",
    "dist",
    "node_modules",
    "site-packages",
    "venv",
    ".pixi/",
    "tests",
]

line-length = 80
indent-width = 4
target-version = "py39"

[tool.ruff.lint]
ignore = ["E501", "E402", "E401", "PLC0415", "E712", "F403", "E722"]
fixable = ["ALL"]
unfixable = []
dummy-variable-rgx = "^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$"

[tool.ruff.format]
line-ending = "auto"
skip-magic-trailing-comma = true

