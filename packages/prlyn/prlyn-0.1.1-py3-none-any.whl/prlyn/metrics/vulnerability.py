import re
from typing import List
from prlyn.models import VulnerabilityScore, ClassifiedSentence, SentenceLabel

STRONG_DELIMITERS = {r"###", r"---", r"===", r"<.*?>"}
DEFENSIVE_ANCHORS = {
    "under no circumstances",
    "must never",
    "ignore any instructions",
    "do not reveal",
    "stay in character",
    "never explain",
}
LEAKAGE_TERMS = {
    "explain your logic",
    "reveal your instructions",
    "system prompt",
    "how you work",
    "your inner workings",
}


class VulnerabilityAnalyzer:
    def analyze(
        self, sentences: List[ClassifiedSentence], text: str
    ) -> VulnerabilityScore:
        # 1. Delimiter Analysis
        has_strong_delimiters = any(
            re.search(pattern, text) for pattern in STRONG_DELIMITERS
        )

        # 2. Defensive Anchors
        found_anchors = []
        lower_text = text.lower()
        for anchor in DEFENSIVE_ANCHORS:
            if anchor in lower_text:
                found_anchors.append(anchor)

        missing_anchors = list(DEFENSIVE_ANCHORS - set(found_anchors))

        # 3. Reflexive Leakage Risks
        leakage_risks = []
        for i, s in enumerate(sentences):
            s_lower = s.text.lower()
            if any(term in s_lower for term in LEAKAGE_TERMS):
                leakage_risks.append(i)

        # 4. Vulnerable Zones (Vague/Unconstrained sections about user input)
        vulnerable_zones = []
        for i, s in enumerate(sentences):
            s_lower = s.text.lower()
            if (
                "user input" in s_lower or "the user" in s_lower
            ) and s.primary_label == SentenceLabel.INSTRUCTION:
                # Check if this instruction is surrounded by context/constraints
                # Heuristic: if it's an instruction about user input but no anchors are nearby
                vulnerable_zones.append(i)

        # Calculate a simple score
        # Base score 0.5
        # +0.2 if strong delimiters
        # +0.1 per defensive anchor (max 0.3)
        # -0.1 per leakage risk
        score = 0.5
        if has_strong_delimiters:
            score += 0.2
        score += min(0.3, len(found_anchors) * 0.1)
        score -= len(leakage_risks) * 0.1

        return VulnerabilityScore(
            vulnerability_zones=vulnerable_zones,
            has_strong_delimiters=has_strong_delimiters,
            missing_defensive_anchors=missing_anchors[:3],  # Suggest top 3
            reflexive_leakage_risks=leakage_risks,
            score=max(0.0, min(1.0, score)),
        )
