{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/littlebearapps/token-audit/blob/main/docs/schema/session-v1.7.0.json",
  "title": "Token Audit Session Schema v1.7.0",
  "description": "JSON Schema for token-audit session files (v1.7.0 - Analysis Layer)",
  "type": "object",
  "required": ["_file", "session", "token_usage", "cost_estimate_usd"],
  "properties": {
    "_file": {
      "type": "object",
      "description": "File metadata header for AI agent readability",
      "required": ["name", "type", "schema_version", "generated_by", "generated_at"],
      "properties": {
        "name": {
          "type": "string",
          "description": "File name (matches actual filename)"
        },
        "type": {
          "type": "string",
          "const": "token_audit_session",
          "description": "File type identifier"
        },
        "purpose": {
          "type": "string",
          "description": "Human-readable description for AI agents"
        },
        "schema_version": {
          "type": "string",
          "pattern": "^1\\.[0-9]+\\.[0-9]+$",
          "description": "Schema version (e.g., '1.7.0')"
        },
        "schema_docs": {
          "type": "string",
          "format": "uri",
          "description": "URL to schema documentation"
        },
        "generated_by": {
          "type": "string",
          "description": "Tool and version that generated this file"
        },
        "generated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp with timezone"
        }
      }
    },
    "session": {
      "type": "object",
      "description": "Session metadata",
      "required": ["id", "platform", "project", "started_at"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique session identifier"
        },
        "project": {
          "type": "string",
          "description": "Project name (from working directory)"
        },
        "platform": {
          "type": "string",
          "enum": ["claude-code", "codex-cli", "gemini-cli", "ollama-cli"],
          "description": "Platform that generated this session"
        },
        "model": {
          "type": "string",
          "description": "Primary AI model used"
        },
        "models_used": {
          "type": "array",
          "items": {"type": "string"},
          "description": "All models used in session (v1.6.0+)"
        },
        "working_directory": {
          "type": "string",
          "description": "Absolute path where session was tracked"
        },
        "started_at": {
          "type": "string",
          "format": "date-time",
          "description": "Session start (ISO 8601 with timezone)"
        },
        "ended_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "Session end (ISO 8601 with timezone)"
        },
        "duration_seconds": {
          "type": ["number", "null"],
          "minimum": 0,
          "description": "Session duration in seconds"
        },
        "source_files": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Source log files monitored"
        },
        "message_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of messages in session"
        }
      }
    },
    "token_usage": {
      "type": "object",
      "description": "Aggregate token consumption",
      "required": ["input_tokens", "output_tokens", "total_tokens"],
      "properties": {
        "input_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Total input tokens"
        },
        "output_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Total output tokens"
        },
        "reasoning_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Thinking/reasoning tokens (v1.3.0+)"
        },
        "cache_created_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Cache creation tokens"
        },
        "cache_read_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Cache read tokens"
        },
        "total_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Sum of all token types"
        },
        "cache_efficiency": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Cache efficiency ratio (0-1)"
        }
      }
    },
    "cost_estimate_usd": {
      "type": "number",
      "minimum": 0,
      "description": "Estimated cost in USD"
    },
    "model_usage": {
      "type": "object",
      "description": "Per-model token and cost breakdown (v1.6.0+)",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "input_tokens": {"type": "integer", "minimum": 0},
          "output_tokens": {"type": "integer", "minimum": 0},
          "cache_created_tokens": {"type": "integer", "minimum": 0},
          "cache_read_tokens": {"type": "integer", "minimum": 0},
          "total_tokens": {"type": "integer", "minimum": 0},
          "cost_usd": {"type": "number", "minimum": 0},
          "call_count": {"type": "integer", "minimum": 0}
        }
      }
    },
    "mcp_summary": {
      "type": "object",
      "description": "MCP tool usage summary",
      "properties": {
        "total_calls": {
          "type": "integer",
          "minimum": 0,
          "description": "Total MCP tool calls"
        },
        "unique_tools": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of distinct tools used"
        },
        "unique_servers": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of distinct MCP servers used"
        },
        "servers_used": {
          "type": "array",
          "items": {"type": "string"},
          "description": "List of server names"
        },
        "top_by_tokens": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "tool": {"type": "string"},
              "server": {"type": "string"},
              "tokens": {"type": "integer"},
              "calls": {"type": "integer"}
            }
          },
          "description": "Top 5 tools by token consumption"
        },
        "top_by_calls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "tool": {"type": "string"},
              "server": {"type": "string"},
              "calls": {"type": "integer"},
              "tokens": {"type": "integer"}
            }
          },
          "description": "Top 5 tools by call frequency"
        }
      }
    },
    "builtin_tool_summary": {
      "type": "object",
      "description": "Built-in tool usage (v1.2.0+)",
      "properties": {
        "total_calls": {"type": "integer", "minimum": 0},
        "total_tokens": {"type": "integer", "minimum": 0},
        "tools": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "tool": {"type": "string"},
              "calls": {"type": "integer"},
              "tokens": {"type": "integer"}
            }
          }
        }
      }
    },
    "cache_analysis": {
      "type": "object",
      "description": "Cache efficiency analysis",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["efficient", "inefficient", "neutral"],
          "description": "Cache efficiency status"
        },
        "summary": {"type": "string"},
        "creation_tokens": {"type": "integer", "minimum": 0},
        "read_tokens": {"type": "integer", "minimum": 0},
        "ratio": {"type": "number", "minimum": 0},
        "net_savings_usd": {"type": "number"},
        "top_cache_creators": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "tool": {"type": "string"},
              "tokens": {"type": "integer"},
              "pct": {"type": "number"}
            }
          }
        },
        "top_cache_readers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "tool": {"type": "string"},
              "tokens": {"type": "integer"},
              "pct": {"type": "number"}
            }
          }
        },
        "recommendation": {"type": "string"}
      }
    },
    "tool_calls": {
      "type": "array",
      "description": "Individual tool call records",
      "items": {
        "type": "object",
        "required": ["index", "tool"],
        "properties": {
          "index": {"type": "integer", "minimum": 1},
          "timestamp": {"type": "string", "format": "date-time"},
          "tool": {"type": "string"},
          "server": {"type": "string"},
          "model": {"type": "string", "description": "Model for this call (v1.6.0+)"},
          "input_tokens": {"type": "integer", "minimum": 0},
          "output_tokens": {"type": "integer", "minimum": 0},
          "cache_created_tokens": {"type": "integer", "minimum": 0},
          "cache_read_tokens": {"type": "integer", "minimum": 0},
          "total_tokens": {"type": "integer", "minimum": 0},
          "duration_ms": {"type": ["integer", "null"], "minimum": 0},
          "content_hash": {"type": ["string", "null"]},
          "is_estimated": {"type": "boolean", "description": "Token estimation flag (v1.4.0+)"},
          "estimation_method": {"type": "string", "enum": ["tiktoken", "sentencepiece", "character"]},
          "estimation_encoding": {"type": "string"}
        }
      }
    },
    "smells": {
      "type": "array",
      "description": "Efficiency anti-patterns detected (v1.5.0+, expanded v1.7.0)",
      "items": {
        "type": "object",
        "required": ["pattern", "severity", "description"],
        "properties": {
          "pattern": {
            "type": "string",
            "enum": [
              "HIGH_VARIANCE",
              "TOP_CONSUMER",
              "HIGH_MCP_SHARE",
              "CHATTY",
              "LOW_CACHE_HIT",
              "REDUNDANT_CALLS",
              "EXPENSIVE_FAILURES",
              "UNDERUTILIZED_SERVER",
              "BURST_PATTERN",
              "LARGE_PAYLOAD",
              "SEQUENTIAL_READS",
              "CACHE_MISS_STREAK",
              "CREDENTIAL_EXPOSURE"
            ],
            "description": "Smell pattern identifier"
          },
          "severity": {
            "type": "string",
            "enum": ["critical", "high", "medium", "warning", "low", "info"],
            "description": "Severity level (warning = medium alias)"
          },
          "tool": {
            "type": "string",
            "description": "Tool triggering the smell (optional)"
          },
          "description": {
            "type": "string",
            "description": "Human-readable explanation"
          },
          "evidence": {
            "type": "object",
            "description": "Pattern-specific supporting data"
          }
        }
      }
    },
    "recommendations": {
      "type": "array",
      "description": "AI-consumable actionable suggestions (v1.7.0+)",
      "items": {
        "type": "object",
        "required": ["type", "confidence", "evidence", "action", "impact", "source_smell"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["REMOVE_UNUSED_SERVER", "ENABLE_CACHING", "BATCH_OPERATIONS", "OPTIMIZE_COST"],
            "description": "Recommendation category"
          },
          "confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Confidence score (0.0-1.0)"
          },
          "evidence": {
            "type": "string",
            "description": "Human/AI readable explanation"
          },
          "action": {
            "type": "string",
            "description": "Specific action to take"
          },
          "impact": {
            "type": "string",
            "description": "Expected benefit from action"
          },
          "source_smell": {
            "type": "string",
            "description": "Smell pattern that triggered this"
          },
          "details": {
            "type": "object",
            "description": "Context-specific data"
          }
        }
      }
    },
    "zombie_tools": {
      "type": "object",
      "description": "Unused MCP tools per server (v1.5.0+)",
      "additionalProperties": {
        "type": "array",
        "items": {"type": "string"}
      }
    },
    "data_quality": {
      "type": "object",
      "description": "Accuracy indicators (v1.5.0+)",
      "properties": {
        "accuracy_level": {
          "type": "string",
          "enum": ["exact", "estimated", "calls-only"],
          "description": "Token accuracy level"
        },
        "token_source": {
          "type": "string",
          "description": "Tokenizer used (native, tiktoken, sentencepiece)"
        },
        "token_encoding": {
          "type": "string",
          "description": "Specific encoding (o200k_base, gemma, etc.)"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Estimated accuracy (0.0-1.0)"
        },
        "pricing_source": {
          "type": "string",
          "enum": ["api", "cache", "cache-stale", "file", "defaults"],
          "description": "Pricing data source (v1.6.0+)"
        },
        "pricing_freshness": {
          "type": "string",
          "enum": ["fresh", "cached", "stale", "unknown"],
          "description": "Pricing freshness (v1.6.0+)"
        },
        "notes": {
          "type": "string",
          "description": "Additional context"
        }
      }
    },
    "static_cost": {
      "type": "object",
      "description": "Context tax from MCP schemas (v1.6.0+)",
      "properties": {
        "total_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Total estimated tokens for MCP schemas"
        },
        "source": {
          "type": "string",
          "enum": ["known_db", "estimate", "mixed", "none"],
          "description": "Data source"
        },
        "by_server": {
          "type": "object",
          "additionalProperties": {"type": "integer"},
          "description": "Per-server token breakdown"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence level"
        }
      }
    },
    "cost_no_cache_usd": {
      "type": "number",
      "minimum": 0,
      "description": "Hypothetical cost without caching"
    },
    "cache_savings_usd": {
      "type": "number",
      "description": "Savings from caching (can be negative)"
    },
    "analysis": {
      "type": "object",
      "description": "Additional analysis data",
      "properties": {
        "redundancy": {
          "type": "object",
          "properties": {
            "duplicate_calls": {"type": "integer", "minimum": 0},
            "potential_token_savings": {"type": "integer", "minimum": 0}
          }
        },
        "anomalies": {
          "type": "array",
          "items": {"type": "object"}
        }
      }
    },
    "aggregation_metadata": {
      "type": "object",
      "description": "Cross-session analysis (v1.7.0+, aggregation reports only)",
      "properties": {
        "query": {
          "type": "object",
          "properties": {
            "start_date": {"type": "string", "format": "date"},
            "end_date": {"type": "string", "format": "date"},
            "platform": {"type": ["string", "null"]},
            "project": {"type": ["string", "null"]}
          }
        },
        "summary": {
          "type": "object",
          "properties": {
            "total_sessions": {"type": "integer", "minimum": 0},
            "sessions_with_smells": {"type": "integer", "minimum": 0}
          }
        },
        "smell_trends": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "pattern": {"type": "string"},
              "total_occurrences": {"type": "integer"},
              "sessions_affected": {"type": "integer"},
              "frequency_percent": {"type": "number"},
              "trend": {"type": "string", "enum": ["improving", "worsening", "stable"]},
              "trend_change_percent": {"type": "number"},
              "severity_breakdown": {"type": "object"},
              "top_tools": {"type": "array"},
              "first_seen": {"type": "string", "format": "date-time"},
              "last_seen": {"type": "string", "format": "date-time"}
            }
          }
        },
        "generated_at": {"type": "string", "format": "date-time"}
      }
    }
  }
}
