<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ollama Home – Models & Blobs</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root { color-scheme: light dark; }
      code { background: rgba(127,127,127,0.15); padding: 0.1rem 0.3rem; border-radius: 4px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      details > summary { cursor: pointer; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <header class="mb-3">
        <h1 class="h3 mb-2">Ollama Model Repository</h1>
        <div class="text-muted small">
          Root: <code>{{ ollama_root }}</code>
          · Manifests: <code>{{ manifests_root }}</code>
          · Blobs: <code>{{ blobs_root }}</code>
        </div>
      </header>

      {% if error %}
        <div class="alert alert-warning" role="alert">{{ error }}</div>
      {% endif %}

      {% if entries and entries|length > 0 %}
        <div class="mb-3 text-muted small">Total manifests: <span class="badge text-bg-secondary" id="count">{{ entries|length }}</span></div>

        <div class="mb-3" style="max-width: 720px;">
          <input id="search" class="form-control" type="search" placeholder="Filter models... (type to filter)" autofocus />
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th id="sort-name" class="sortable" style="width: 70%" aria-sort="none">Model <span class="sort-indicator"></span></th>
                <th id="sort-size" class="text-end sortable" style="width: 30%" aria-sort="none">Size (GB) <span class="sort-indicator"></span></th>
              </tr>
            </thead>
            <tbody id="models">
              {% for e in entries %}
                <tr class="model-item" data-name="{{ e.name|lower }}" {% if e.model_bytes %}data-bytes="{{ e.model_bytes }}"{% endif %}>
                  <td class="mono">
                    {% if e.model_blob_filename %}
                      <span class="text-decoration-none">{{ e.name }}</span>
                      <div class="small text-muted">
                        <a class="link-secondary" target="_blank" href="/model/metadata?model={{ e.name }}">Model Metadata</a>
                        {% if e.template_blob_filename or e.license_blob_filename or e.params_blob_filename %}
                          |
                          {% if e.template_blob_filename %}
                            <a class="link-secondary" target="_blank" href="/model/template?model={{ e.name }}">Template</a>
                          {% endif %}
                          {% if e.license_blob_filename %}
                            {% if e.template_blob_filename %}|
                            {% endif %}
                            <a class="link-secondary" target="_blank" href="/model/license?model={{ e.name }}">License</a>
                          {% endif %}
                          {% if e.params_blob_filename %}
                            {% if e.template_blob_filename or e.license_blob_filename %}|
                            {% endif %}
                            <a class="link-secondary" target="_blank" href="/model/params?model={{ e.name }}">Parameter Presets</a>
                          {% endif %}
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="text-decoration-none">{{ e.name }}</span>
                    {% endif %}
                    <div class="small text-muted mt-1">Manifest: <code title="Manifest file path">{{ e.path }}</code></div>
                  </td>
                  <td class="text-end">
                    {% if e.model_gb %}
                      {{ e.model_gb }}
                      <span class="text-muted small" title="{{ e.model_bytes }} bytes">GB</span>
                    {% else %}
                      <span class="text-muted">–</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">No manifests found.</p>
      {% endif %}
    </div>

    <script>
      // Simple in-page filter (mirrors the behavior on the metadata page)
      const search = document.getElementById('search');
      const rows = Array.from(document.querySelectorAll('.model-item'));
      const count = document.getElementById('count');
      const tbody = document.getElementById('models');
      const thName = document.getElementById('sort-name');
      const thSize = document.getElementById('sort-size');
      const indicators = () => Array.from(document.querySelectorAll('th.sortable .sort-indicator'));
      const headers = [thName, thSize].filter(Boolean);
      if (search && rows.length && count) {
        function applyFilter() {
          const q = search.value.toLowerCase();
          let visible = 0;
          for (const tr of rows) {
            const text = tr.textContent.toLowerCase();
            const show = !q || text.includes(q);
            tr.style.display = show ? '' : 'none';
            if (show) visible++;
          }
          count.textContent = visible;
        }
        search.addEventListener('input', applyFilter);
      }

      // Sorting
      let sortState = { key: null, dir: 1 }; // dir: 1 asc, -1 desc

      function updateSortIndicators() {
        for (const th of headers) {
          th.setAttribute('aria-sort', 'none');
          const span = th.querySelector('.sort-indicator');
          if (span) span.textContent = '';
        }
        if (!sortState.key) return;
        const th = sortState.key === 'name' ? thName : thSize;
        if (!th) return;
        th.setAttribute('aria-sort', sortState.dir === 1 ? 'ascending' : 'descending');
        const span = th.querySelector('.sort-indicator');
        if (span) span.textContent = sortState.dir === 1 ? '▲' : '▼';
      }

      function compareName(a, b) {
        const an = a.dataset.name || '';
        const bn = b.dataset.name || '';
        if (an < bn) return -1;
        if (an > bn) return 1;
        return 0;
      }

      function compareSize(a, b) {
        const avRaw = a.dataset.bytes;
        const bvRaw = b.dataset.bytes;
        const aMissing = avRaw === undefined || avRaw === '';
        const bMissing = bvRaw === undefined || bvRaw === '';
        if (aMissing && bMissing) return 0;
        if (aMissing) return 1; // missing sizes go last
        if (bMissing) return -1;
        const av = Number(avRaw);
        const bv = Number(bvRaw);
        if (av < bv) return -1;
        if (av > bv) return 1;
        return 0;
      }

      function applySort() {
        if (!sortState.key) return;
        const cmp = sortState.key === 'name' ? compareName : compareSize;
        rows.sort((a, b) => sortState.dir * cmp(a, b));
        for (const tr of rows) tbody.appendChild(tr); // re-append in new order
        updateSortIndicators();
      }

      function toggleSort(key) {
        if (sortState.key === key) {
          sortState.dir = -1 * sortState.dir; // toggle
        } else {
          sortState.key = key;
          sortState.dir = 1; // default to ascending
        }
        applySort();
      }

      if (thName) thName.addEventListener('click', () => toggleSort('name'));
      if (thSize) thSize.addEventListener('click', () => toggleSort('size'));
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>
  </body>
  </html>
