
from starlette.middleware.base import BaseHTTPMiddleware
from fastapi import Request


class AppStateMiddleware(BaseHTTPMiddleware):
    """
    Middleware to attach the FastAPI application instance to the request state.

    This allows easy access to the application object (e.g., for accessing
    settings or database connections registered on the app) from downstream
    request handlers or other middleware via request.state.app.
    """
    async def dispatch(self, request: Request, call_next):
        """
        Dispatches the request, injecting the application instance into the state

        Args:
            request: The incoming Starlette/FastAPI Request object.
            call_next: A callable that proceeds to the next middleware or endpoint

        Returns:
            The response generated by the subsequent middleware or endpoint.
        """
        request.state.app = request.app
        response = await call_next(request)
        return response