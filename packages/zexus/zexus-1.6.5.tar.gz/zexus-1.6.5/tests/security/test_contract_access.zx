# Contract Access Control - Smart Contract Integration Test
# Security Fix #9: Demonstrates TX.caller with access control in real contracts

print "=========================================="
print "SMART CONTRACT ACCESS CONTROL TEST"
print "=========================================="
print ""

# Simulated Token Contract with Access Control
print "Test: Token Contract with Owner and Roles"
print "-------------------------------------------"

# Initialize contract
let contract_id = "SimpleToken"
let owner_address = "0xOwner"
let user1 = "0xAlice"
let user2 = "0xBob"

# Set owner
set_owner(contract_id, owner_address)
print "✓ Contract owner set to: " + owner_address

# Grant minting permission only to owner
grant_permission(contract_id, owner_address, "mint")
grant_permission(contract_id, owner_address, "burn")
print "✓ Mint and burn permissions granted to owner"

# Grant transfer permission to all users
grant_permission(contract_id, user1, "transfer")
grant_permission(contract_id, user2, "transfer")
print "✓ Transfer permission granted to users"

print ""

# Test 1: Owner-Only Operations
print "Test 1: Owner-Only Operations"
print "------------------------------"

# Simulate contract call from owner
if (is_owner(contract_id, owner_address)) {
    if (has_permission(contract_id, owner_address, "mint")) {
        print "✓ Owner can mint tokens"
    }
    
    if (has_permission(contract_id, owner_address, "burn")) {
        print "✓ Owner can burn tokens"
    }
}

# Simulate contract call from non-owner
if (!is_owner(contract_id, user1)) {
    if (!has_permission(contract_id, user1, "mint")) {
        print "✓ Non-owner cannot mint tokens"
    }
    
    if (!has_permission(contract_id, user1, "burn")) {
        print "✓ Non-owner cannot burn tokens"
    }
}

print ""

# Test 2: Multi-Role Access Control
print "Test 2: Multi-Role Access Control"
print "-----------------------------------"

let vault_contract = "SecureVault"
set_owner(vault_contract, "0xVaultOwner")

# Define roles
grant_role(vault_contract, "0xAdmin1", "admin")
grant_role(vault_contract, "0xAdmin2", "admin")
grant_role(vault_contract, "0xAuditor1", "auditor")

# Grant permissions based on roles
grant_permission(vault_contract, "0xAdmin1", "withdraw")
grant_permission(vault_contract, "0xAdmin2", "withdraw")
grant_permission(vault_contract, "0xAuditor1", "view_balance")

print "✓ Vault contract roles configured"

# Verify role-based access
if (has_role(vault_contract, "0xAdmin1", "admin") && 
    has_permission(vault_contract, "0xAdmin1", "withdraw")) {
    print "✓ Admin can withdraw funds"
}

if (has_role(vault_contract, "0xAuditor1", "auditor") &&
    !has_permission(vault_contract, "0xAuditor1", "withdraw")) {
    print "✓ Auditor cannot withdraw funds"
}

print ""

# Test 3: Dynamic Permission Management
print "Test 3: Dynamic Permission Management"
print "--------------------------------------"

let dao_contract = "DAO"
set_owner(dao_contract, "0xDAOCreator")

# Initially, only owner can propose
grant_permission(dao_contract, "0xDAOCreator", "propose")
print "✓ Initial: Only creator can propose"

# Grant proposer role to members
grant_role(dao_contract, "0xMember1", "proposer")
grant_permission(dao_contract, "0xMember1", "propose")

if (has_permission(dao_contract, "0xMember1", "propose")) {
    print "✓ Member granted proposal rights"
}

# Revoke permission dynamically
revoke_permission(dao_contract, "0xMember1", "propose")

if (!has_permission(dao_contract, "0xMember1", "propose")) {
    print "✓ Proposal rights dynamically revoked"
}

print ""

# Test 4: Ownership Transfer Pattern
print "Test 4: Ownership Transfer Pattern"
print "------------------------------------"

let transfer_contract = "Transferable"
set_owner(transfer_contract, "0xOriginalOwner")
print "✓ Original owner: 0xOriginalOwner"

# Verify original ownership
if (is_owner(transfer_contract, "0xOriginalOwner")) {
    # Transfer ownership (only owner can do this)
    set_owner(transfer_contract, "0xNewOwner")
    print "✓ Ownership transferred to: 0xNewOwner"
}

# Verify new ownership
if (is_owner(transfer_contract, "0xNewOwner")) {
    print "✓ New owner verified"
}

if (!is_owner(transfer_contract, "0xOriginalOwner")) {
    print "✓ Original owner no longer has ownership"
}

print ""

# Test 5: Access Control Matrix
print "Test 5: Access Control Matrix"
print "------------------------------"

let matrix_contract = "AccessMatrix"
set_owner(matrix_contract, "0xRoot")

# Create a permission matrix
# Root has everything
grant_permission(matrix_contract, "0xRoot", "create")
grant_permission(matrix_contract, "0xRoot", "read")
grant_permission(matrix_contract, "0xRoot", "write")
grant_permission(matrix_contract, "0xRoot", "delete")

# Editor has most but not delete
grant_role(matrix_contract, "0xEditor", "editor")
grant_permission(matrix_contract, "0xEditor", "create")
grant_permission(matrix_contract, "0xEditor", "read")
grant_permission(matrix_contract, "0xEditor", "write")

# Viewer has read only
grant_role(matrix_contract, "0xViewer", "viewer")
grant_permission(matrix_contract, "0xViewer", "read")

# Verify the matrix
let root_perms = 0
if (has_permission(matrix_contract, "0xRoot", "create")) { root_perms = root_perms + 1 }
if (has_permission(matrix_contract, "0xRoot", "read")) { root_perms = root_perms + 1 }
if (has_permission(matrix_contract, "0xRoot", "write")) { root_perms = root_perms + 1 }
if (has_permission(matrix_contract, "0xRoot", "delete")) { root_perms = root_perms + 1 }

let editor_perms = 0
if (has_permission(matrix_contract, "0xEditor", "create")) { editor_perms = editor_perms + 1 }
if (has_permission(matrix_contract, "0xEditor", "read")) { editor_perms = editor_perms + 1 }
if (has_permission(matrix_contract, "0xEditor", "write")) { editor_perms = editor_perms + 1 }

let viewer_perms = 0
if (has_permission(matrix_contract, "0xViewer", "read")) { viewer_perms = viewer_perms + 1 }

print "Root permissions count: " + string(root_perms)
print "Editor permissions count: " + string(editor_perms)
print "Viewer permissions count: " + string(viewer_perms)
print "✓ Permission matrix verified"

print ""

# Test 6: Multi-Contract Role Inheritance
print "Test 6: Multi-Contract Role Inheritance"
print "----------------------------------------"

# Parent contract
let parent_contract = "ParentContract"
set_owner(parent_contract, "0xParentOwner")
grant_role(parent_contract, "0xUser", "member")

# Child contract
let child_contract = "ChildContract"
set_owner(child_contract, "0xChildOwner")

# Roles are isolated (no automatic inheritance)
if (has_role(parent_contract, "0xUser", "member") &&
    !has_role(child_contract, "0xUser", "member")) {
    print "✓ Roles properly isolated between contracts"
}

# Can grant separately if needed
grant_role(child_contract, "0xUser", "member")

if (has_role(parent_contract, "0xUser", "member") &&
    has_role(child_contract, "0xUser", "member")) {
    print "✓ Cross-contract roles can be granted explicitly"
}

print ""

print "=========================================="
print "SMART CONTRACT TESTS PASSED"
print "=========================================="
print ""
print "Summary:"
print "--------"
print "✅ Owner-only operations enforced"
print "✅ Multi-role access control working"
print "✅ Dynamic permission management"
print "✅ Ownership transfer pattern"
print "✅ Fine-grained permission matrix"
print "✅ Multi-contract role isolation"
print ""
print "Real-world smart contract patterns validated!"
