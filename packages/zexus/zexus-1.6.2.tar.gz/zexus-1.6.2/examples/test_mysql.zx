#!/usr/bin/env zexus
# MySQL Database Test
# Requires MySQL server running on localhost:3306
# Create database first: mysql -u root -p -e "CREATE DATABASE test_zexus"

print("=== MySQL Database Test ===\n")

# Connect to MySQL
print("Connecting to MySQL...")
let db = mysql_connect("test_zexus", "root", "root")

# Get methods
let exec_fn = db["execute"]
let query_fn = db["query"]
let query_one_fn = db["query_one"]
let commit_fn = db["commit"]
let rollback_fn = db["rollback"]
let last_id_fn = db["last_insert_id"]
let close_fn = db["close"]

print("✓ Connected successfully\n")

# Drop table if exists
print("Cleaning up old data...")
exec_fn("DROP TABLE IF EXISTS products")
print("✓ Cleanup complete\n")

# Create table
print("Creating products table...")
exec_fn("CREATE TABLE products (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(100), price DECIMAL(10,2), stock INT)")
print("✓ Table created\n")

# Insert data
print("Inserting test data...")
exec_fn("INSERT INTO products (name, price, stock) VALUES ('Widget', 19.99, 100)")
let widget_id = last_id_fn()
print("  Inserted Widget (ID: " + string(widget_id) + ")")

exec_fn("INSERT INTO products (name, price, stock) VALUES ('Gadget', 29.99, 50)")
let gadget_id = last_id_fn()
print("  Inserted Gadget (ID: " + string(gadget_id) + ")")

exec_fn("INSERT INTO products (name, price, stock) VALUES ('Doohickey', 9.99, 200)")
let doohickey_id = last_id_fn()
print("  Inserted Doohickey (ID: " + string(doohickey_id) + ")")
print("")

# Query all products
print("Querying all products...")
let products = query_fn("SELECT * FROM products ORDER BY name")
print("Found " + string(len(products)) + " products:")
if len(products) >= 1 {
    let product = products[0]
    print("  - " + product["name"] + " ($" + string(product["price"]) + "), stock: " + string(product["stock"]))
}
if len(products) >= 2 {
    let product = products[1]
    print("  - " + product["name"] + " ($" + string(product["price"]) + "), stock: " + string(product["stock"]))
}
if len(products) >= 3 {
    let product = products[2]
    print("  - " + product["name"] + " ($" + string(product["price"]) + "), stock: " + string(product["stock"]))
}
print("")

# Query one product
print("Querying single product (Widget)...")
let widget = query_one_fn("SELECT * FROM products WHERE name = 'Widget'")
if widget != null {
    print("✓ Found: " + widget["name"] + " at $" + string(widget["price"]))
} else {
    print("✗ Product not found")
}
print("")

# Update product
print("Updating Widget price...")
exec_fn("UPDATE products SET price = 24.99 WHERE name = 'Widget'")
let updated = query_one_fn("SELECT * FROM products WHERE name = 'Widget'")
print("✓ Widget's new price: $" + string(updated["price"]))
print("")

# Transaction test
print("Testing transactions...")
exec_fn("INSERT INTO products (name, price, stock) VALUES ('TempItem', 5.99, 10)")
rollback_fn()  # Rollback - TempItem should not exist
let temp = query_one_fn("SELECT * FROM products WHERE name = 'TempItem'")
if temp == null {
    print("✓ Rollback successful (TempItem not found)")
} else {
    print("✗ Rollback failed")
}
print("")

# Commit test
print("Testing commit...")
exec_fn("INSERT INTO products (name, price, stock) VALUES ('Thingamajig', 14.99, 75)")
commit_fn()
let thing = query_one_fn("SELECT * FROM products WHERE name = 'Thingamajig'")
if thing != null {
    print("✓ Commit successful (Thingamajig found)")
} else {
    print("✗ Commit failed")
}
print("")

# Delete product
print("Deleting Gadget...")
exec_fn("DELETE FROM products WHERE name = 'Gadget'")
let remaining = query_fn("SELECT * FROM products")
print("✓ Remaining products: " + string(len(remaining)))
print("")

# Cleanup
print("Cleaning up...")
exec_fn("DROP TABLE products")
close_fn()
print("✓ Database closed\n")

print("=== All MySQL Tests Passed! ===")
