name: Security & Compliance

# Comprehensive security and compliance checks
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:

concurrency:
  group: security-compliance-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF to Code Scanning
  actions: read

jobs:
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    # Only run on pull requests where there's always a diff to scan
    # Push events to main can have BASE=HEAD which causes TruffleHog to error
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}
        extra_args: --debug --only-verified

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install license scanning tools
      run: |
        uv venv
        uv pip install pip-licenses

    - name: Scan Python package licenses
      run: |
        echo "=== Python Package Licenses ==="
        uv run pip-licenses --format=markdown --output-file=python-licenses.md
        cat python-licenses.md

    - name: Check for GPL licenses
      run: |
        # Check for GPL licenses (excluding LGPL and multi-licensed packages)
        # Multi-licensed packages like docutils (BSD/GPL/Public Domain) are acceptable
        # if they offer at least one permissive license option

        MULTI_LICENSED_OK=(
          "docutils"  # BSD/GPL/Public Domain - we use BSD
        )

        # Get packages with GPL in license
        GPL_PACKAGES=$(grep -i "GPL" python-licenses.md | grep -v -i "LGPL" || true)

        if [ -n "$GPL_PACKAGES" ]; then
          echo "Checking GPL-licensed packages..."

          # Check each package
          STRICT_GPL=""
          while IFS= read -r line; do
            PACKAGE_NAME=$(echo "$line" | cut -d'|' -f2 | tr -d ' ')

            # Check if it's in our multi-licensed allow list
            IS_ALLOWED=false
            for allowed in "${MULTI_LICENSED_OK[@]}"; do
              if [[ "$PACKAGE_NAME" == "$allowed" ]]; then
                IS_ALLOWED=true
                echo "‚úÖ $PACKAGE_NAME: Multi-licensed (acceptable alternative available)"
                break
              fi
            done

            if ! $IS_ALLOWED; then
              STRICT_GPL="$STRICT_GPL\n$line"
            fi
          done <<< "$GPL_PACKAGES"

          if [ -n "$STRICT_GPL" ]; then
            echo "‚ùå Strict GPL-licensed packages found:"
            echo -e "$STRICT_GPL"
            exit 1
          else
            echo "‚úÖ All GPL packages have acceptable license alternatives"
          fi
        else
          echo "‚úÖ No GPL licenses found"
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v6
      with:
        name: license-report
        path: python-licenses.md

  container-security:
     name: Container Security Scan (Government Grade)
     runs-on: ubuntu-latest
     strategy:
       matrix:
         dockerfile:
           - { path: 'deploy/docker/Dockerfile', tag: 'fraiseql:standard', label: 'Standard' }
           # Distroless removed due to CRITICAL/HIGH vulnerabilities in Python 3.11
           # See security-assessment-2025-12-09-distroless.md for details
           # Will re-enable when gcr.io/distroless/python3.13 becomes available
     steps:
     - uses: actions/checkout@v4

     - name: Build ${{ matrix.dockerfile.label }} container
       run: |
         # Build container for security scanning
         docker build \
           --file ${{ matrix.dockerfile.path }} \
           --tag ${{ matrix.dockerfile.tag }} \
           --target runtime \
           .

     - name: Scan container with Trivy (SARIF for GitHub)
       uses: aquasecurity/trivy-action@master
       with:
         scan-type: 'image'
         scan-ref: ${{ matrix.dockerfile.tag }}
         format: 'sarif'
         output: 'trivy-${{ matrix.dockerfile.label }}-results.sarif'
         severity: 'CRITICAL,HIGH,MEDIUM'  # Government standard: include MEDIUM
         exit-code: 0  # Report only, don't fail
         trivyignores: '.trivyignore'

     - name: Upload Trivy SARIF results to GitHub Security
       uses: github/codeql-action/upload-sarif@v4
       if: always()
       with:
         sarif_file: 'trivy-${{ matrix.dockerfile.label }}-results.sarif'
         category: 'container-${{ matrix.dockerfile.label }}'

     - name: Scan container with Trivy (JSON for detailed analysis)
       uses: aquasecurity/trivy-action@master
       with:
         scan-type: 'image'
         scan-ref: ${{ matrix.dockerfile.tag }}
         format: 'json'
         output: 'trivy-${{ matrix.dockerfile.label }}-detailed.json'
         severity: 'CRITICAL,HIGH,MEDIUM,LOW'
         trivyignores: '.trivyignore'

     - name: Generate compliance report
       run: |
         echo "# Container Security Report - ${{ matrix.dockerfile.label }}" > security-report.md
         echo "" >> security-report.md
         echo "**Image**: ${{ matrix.dockerfile.tag }}" >> security-report.md
         echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-report.md
         echo "**Compliance Level**: Government Agency Ready" >> security-report.md
         echo "" >> security-report.md

         # Count vulnerabilities by severity
         CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-${{ matrix.dockerfile.label }}-detailed.json)
         HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-${{ matrix.dockerfile.label }}-detailed.json)
         MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-${{ matrix.dockerfile.label }}-detailed.json)
         LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-${{ matrix.dockerfile.label }}-detailed.json)

         echo "## Vulnerability Summary" >> security-report.md
         echo "- üî¥ Critical: $CRITICAL" >> security-report.md
         echo "- üü† High: $HIGH" >> security-report.md
         echo "- üü° Medium: $MEDIUM" >> security-report.md
         echo "- üîµ Low: $LOW" >> security-report.md
         echo "" >> security-report.md

         # Check for unpatched vulnerabilities
         UNPATCHED=$(jq '[.Results[]?.Vulnerabilities[]? | select(.FixedVersion=="")] | length' trivy-${{ matrix.dockerfile.label }}-detailed.json)
         echo "## Patch Availability" >> security-report.md
         echo "- Unpatched vulnerabilities: $UNPATCHED" >> security-report.md
         echo "" >> security-report.md

         # Government compliance gate
         if [ "$CRITICAL" -gt 0 ]; then
           echo "‚ùå CRITICAL vulnerabilities found - Government compliance FAILED"
           echo "**Status**: ‚ùå Non-compliant (Critical vulnerabilities present)" >> security-report.md
           exit 1
         elif [ "$HIGH" -gt 0 ]; then
           echo "‚ö†Ô∏è  HIGH severity vulnerabilities found - Review required"
           echo "**Status**: ‚ö†Ô∏è  Review Required (High severity vulnerabilities)" >> security-report.md
           # Don't fail for HIGH in base OS packages if documented in .trivyignore
           if [ "${{ matrix.dockerfile.label }}" == "Distroless (Production)" ]; then
             echo "Distroless image - HIGH vulnerabilities acceptable if in .trivyignore"
             exit 0
           fi
         else
           echo "‚úÖ Container meets government security standards"
           echo "**Status**: ‚úÖ Compliant" >> security-report.md
         fi

         cat security-report.md

     - name: Upload detailed scan results
       uses: actions/upload-artifact@v6
       if: always()
       with:
         name: trivy-${{ matrix.dockerfile.label }}-detailed
         path: |
           trivy-${{ matrix.dockerfile.label }}-detailed.json
           security-report.md

     - name: Generate SBOM (Software Bill of Materials)
       run: |
         # Generate SBOM in CycloneDX format for government compliance
         docker run --rm \
           -v /var/run/docker.sock:/var/run/docker.sock \
           aquasec/trivy image \
           --format cyclonedx \
           --output sbom-${{ matrix.dockerfile.label }}.json \
           ${{ matrix.dockerfile.tag }}

     - name: Upload SBOM
       uses: actions/upload-artifact@v6
       with:
         name: sbom-${{ matrix.dockerfile.label }}
         path: sbom-${{ matrix.dockerfile.label }}.json

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Audit Python dependencies
      run: |
        uv venv
        uv pip install ".[dev,all]"
        uv run pip-audit --format json --output audit-results.json || true

    - name: Check for critical vulnerabilities
      run: |
        if [ -f audit-results.json ]; then
          # Check for CRITICAL or HIGH severity vulnerabilities
          if jq -e '.vulnerabilities[] | select(.severity == "CRITICAL" or .severity == "HIGH")' audit-results.json > /dev/null; then
            echo "üö® Critical or high-severity vulnerabilities found!"
            jq '.vulnerabilities[] | select(.severity == "CRITICAL" or .severity == "HIGH")' audit-results.json
            exit 1
          else
            echo "‚úÖ No critical or high-severity vulnerabilities found"
          fi
        else
          echo "‚ö†Ô∏è  pip-audit did not generate results file"
        fi

    - name: Upload audit results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: dependency-audit-results
        path: audit-results.json

  compliance-check:
    name: Compliance Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Check security policy exists
      run: |
        if [ ! -f "SECURITY.md" ]; then
          echo "‚ùå SECURITY.md file is missing"
          exit 1
        fi
        echo "‚úÖ Security policy exists"

    - name: Check for security headers in nginx config
      run: |
        if grep -q "add_header X-Frame-Options" deploy/nginx-fraiseql.conf; then
          echo "‚úÖ Security headers found in nginx config"
        else
          echo "‚ö†Ô∏è  Security headers not found in nginx config"
        fi

    - name: Validate secrets are not committed
      run: |
        # Check for common secret patterns (excluding legitimate code patterns)
        # This check looks for actual secrets, not just the words "password", "token", etc.

        # Exclude legitimate uses:
        # - Function parameters and variable names (e.g., "password: str")
        # - Type hints and field definitions
        # - Documentation and examples
        # - Error handling and logging
        # - Database URL utilities (handling passwords, not storing them)

        # Files to completely skip (legitimate password/token handling)
        SKIP_FILES=(
          "src/fraiseql/utils/db_url.py"
          "src/fraiseql/fields.py"
          "src/fraiseql/monitoring/notifications.py"
          "src/fraiseql/enterprise/crypto/signing.py"
          "src/fraiseql/sql/sql_generator.py"
          "src/fraiseql/cli/commands/init.py"
          "src/fraiseql/cli/commands/migrate.py"
          "src/fraiseql/auth/auth0.py"
          "src/fraiseql/auth/auth0_with_revocation.py"
          "src/fraiseql/auth/token_revocation.py"
          "src/fraiseql/auth/native/tokens.py"
          "src/fraiseql/auth/native/provider.py"
          "src/fraiseql/auth/native/router.py"
          "src/fraiseql/auth/native/__init__.py"
          "src/fraiseql/auth/native/models.py"
          "src/fraiseql/auth/base.py"
          "src/fraiseql/enterprise/rbac/middleware.py"
          "src/fraiseql/security/csrf_protection.py"
        )

        # Build find exclusion args
        FIND_ARGS=""
        for file in "${SKIP_FILES[@]}"; do
          FIND_ARGS="$FIND_ARGS -not -path ./$file"
        done

        # Search for potential secrets (excluding the skipped files)
        POTENTIAL_SECRETS=$(find src/ -type f \( -name "*.py" -o -name "*.yml" -o -name "*.yaml" \) $FIND_ARGS -exec grep -n -H -i "password\|secret\|token" {} \; | \
          grep -v "password: str" | \
          grep -v "password:" | \
          grep -v "secret_key: str" | \
          grep -v "token: str" | \
          grep -v "access_token:" | \
          grep -v "refresh_token:" | \
          grep -v "def.*password" | \
          grep -v "def.*token" | \
          grep -v "def.*secret" | \
          grep -v "KeyError" | \
          grep -v "error_keywords" | \
          grep -v "raise.*Error" | \
          grep -v '"password"' | \
          grep -v "'password'" | \
          grep -v "# password" | \
          grep -v "# token" | \
          grep -v "# secret" | \
          grep -v "description=" | \
          grep -v "Example:" | \
          grep -v "example" || true)

        if [ -n "$POTENTIAL_SECRETS" ]; then
          echo "‚ö†Ô∏è  Potential secrets found (manual review needed):"
          echo "$POTENTIAL_SECRETS"
          echo ""
          echo "If these are false positives (function parameters, type hints, etc.),"
          echo "add them to SKIP_FILES in .github/workflows/security-compliance.yml"
          # Don't fail - just warn
          exit 0
        else
          echo "‚úÖ No obvious secrets found in source code"
        fi

    - name: Check for required security files
      run: |
        required_files=("SECURITY.md" "LICENSE" "CODE_OF_CONDUCT.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Required file $file is missing"
            exit 1
          fi
        done
        echo "‚úÖ All required security and compliance files present"

  security-gate:
    name: Security Gate ‚úÖ
    runs-on: ubuntu-latest
    needs: [secrets-scan, license-scan, container-security, dependency-audit, compliance-check]
    if: always()
    steps:
      - name: Security compliance check
        run: |
          # Check if all security jobs passed
          # secrets-scan is skipped on push events (only runs on PRs) - that's OK
          if [[ "${{ needs.secrets-scan.result }}" != "success" && "${{ needs.secrets-scan.result }}" != "skipped" ]]; then
            echo "‚ùå Secrets scan failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.license-scan.result }}" != "success" ]]; then
            echo "‚ùå License compliance failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.container-security.result }}" != "success" ]]; then
            echo "‚ùå Container security scan failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.dependency-audit.result }}" != "success" ]]; then
            echo "‚ùå Dependency audit failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.compliance-check.result }}" != "success" ]]; then
            echo "‚ùå Compliance validation failed - Security gate blocked"
            exit 1
          fi
          echo "‚úÖ All security and compliance checks passed - Security gate open"
          echo "üîí Code meets security and compliance standards"
