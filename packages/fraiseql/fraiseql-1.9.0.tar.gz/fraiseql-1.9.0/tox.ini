# Tox configuration for FraiseQL
# Tests for Python 3.13+

[tox]
envlist =
    py313
    lint
    type-check
    docs
skip_missing_interpreters = true
# Disable isolated build - Rust extension must be built externally with maturin
isolated_build = false

[testenv]
description = Run tests with pytest
# Install maturin as a build dependency for Rust extension
deps =
    maturin>=1.9,<2.0
    pytest>=8.3.5
    pytest-asyncio>=1.0.0
    pytest-benchmark>=4.0.0
    pytest-timeout>=2.4.0
    pytest-xdist>=3.5.0
    pytest-cov>=4.0.0
    pytest-mock>=3.11.0
    faker>=37.5.3
    testcontainers[postgres]>=4.10.0
    testcontainers[vault]>=4.10.0
    docker>=7.1.0
    asgi-lifespan>=2.1.0
    # Optional dependencies needed for tests (matches CI environment)
    moto[kms]>=5.0.0
    hvac>=2.0.0
    prometheus-client>=0.20.0
    email-validator>=2.0.0
    pyyaml>=6.0.0
# Use allowlist_externals to allow cargo/rustc/maturin during build
allowlist_externals =
    cargo
    rustc
    maturin
commands_pre =
    # Build and install Rust extension in development mode
    maturin develop --uv
    # Verify Rust extension loaded successfully
    python -c "from fraiseql import _fraiseql_rs; print('âœ… _fraiseql_rs loaded:', _fraiseql_rs)"
commands =
    # Exclude blog example tests that require testcontainers (slow, can timeout in CI)
    pytest -m "not blog_simple and not blog_enterprise" {posargs:--tb=short -v}
passenv =
    HOME
    USER
    CI
    GITHUB_*
    DOCKER_*
    # Pass Rust/Cargo environment variables
    CARGO_*
    RUSTUP_*
    RUSTC_*
setenv =
    PYTEST_TIMEOUT = 300

[testenv:py313]
description = Run tests on Python 3.13
basepython = python3.13

[testenv:lint]
description = Run code quality checks with ruff
basepython = python3.13
deps =
    ruff>=0.13.0
skip_install = true
commands =
    ruff check src/ tests/ examples/
    ruff format --check src/ tests/ examples/

[testenv:type-check]
description = Run type checking with pyright
basepython = python3.13
deps =
    pyright>=1.1.405
commands =
    pyright src/fraiseql

[testenv:docs]
description = Build documentation
basepython = python3.13
deps =
    mkdocs>=1.5.0
    mkdocs-material>=9.0.0
    pymdown-extensions>=10.0
commands =
    mkdocs build --strict

[testenv:coverage]
description = Run tests with coverage reporting
basepython = python3.13
deps =
    {[testenv]deps}
    pytest-cov>=4.0.0
commands =
    pytest --cov=fraiseql --cov-report=term-missing --cov-report=html --cov-report=xml {posargs}

[testenv:integration]
description = Run integration tests only
basepython = python3.13
deps = {[testenv]deps}
commands =
    pytest tests/integration/ {posargs:--tb=short -v}

[testenv:unit]
description = Run unit tests only (fast)
basepython = python3.13
deps = {[testenv]deps}
commands =
    pytest tests/unit/ {posargs:--tb=short -v}

[testenv:examples]
description = Test all examples
basepython = python3.13
deps = {[testenv]deps}
commands =
    pytest examples/ {posargs:--tb=short -v}

[testenv:quick]
description = Quick test run (core tests only, parallel)
basepython = python3.13
deps = {[testenv]deps}
commands =
    pytest -m core -n auto {posargs:--tb=short}

[testenv:build]
description = Build package for distribution
basepython = python3.13
skip_install = true
deps =
    build>=1.0.0
    twine>=6.1.0
commands =
    python -m build
    twine check dist/*

[testenv:clean]
description = Clean up build artifacts and cache
skip_install = true
allowlist_externals =
    rm
    find
commands =
    rm -rf build/ dist/ .eggs/ *.egg-info
    rm -rf .tox/ .pytest_cache/ .coverage htmlcov/
    find . -type d -name __pycache__ -exec rm -rf {} +
    find . -type f -name "*.pyc" -delete
