name: Verify Examples Compliance

on:
  pull_request:
    paths:
      - 'examples/**/*.sql'
      - 'examples/**/*.py'
      - 'docs/**/*.md'
      - '.phases/verify-examples-compliance/**'
  push:
    branches: [main, develop]
    paths:
      - 'examples/**/*.sql'
      - 'examples/**/*.py'
      - 'docs/**/*.md'
      - '.phases/verify-examples-compliance/**'

jobs:
  verify:
    name: Trinity Pattern Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Verify all examples
        id: verify
        run: |
          # Run verification on all examples
          python .phases/verify-examples-compliance/verify.py examples/*/ --json > compliance-report.json

          # Extract summary
          total_examples=$(jq '.metadata.total_examples' compliance-report.json)
          fully_compliant=$(jq '.metadata.fully_compliant' compliance-report.json)
          average_score=$(jq '.metadata.average_score' compliance-report.json)

          echo "total_examples=$total_examples" >> $GITHUB_OUTPUT
          echo "fully_compliant=$fully_compliant" >> $GITHUB_OUTPUT
          echo "average_score=$average_score" >> $GITHUB_OUTPUT

          # Check for ERROR violations
          error_count=$(jq '[.reports[].violations[] | select(.severity == "ERROR")] | length' compliance-report.json)
          echo "error_count=$error_count" >> $GITHUB_OUTPUT

      - name: Generate markdown report
        run: |
          python .phases/verify-examples-compliance/report_generator.py \
            --input compliance-report.json \
            --output compliance-report.md \
            --format markdown

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('compliance-report.md', 'utf8');

            // Extract key metrics
            const totalExamples = ${{ steps.verify.outputs.total_examples }};
            const fullyCompliant = ${{ steps.verify.outputs.fully_compliant }};
            const averageScore = ${{ steps.verify.outputs.average_score }};
            const errorCount = ${{ steps.verify.outputs.error_count }};

            let status = '✅';
            let message = 'All examples compliant!';

            if (errorCount > 0) {
              status = '❌';
              message = `${errorCount} pattern violations found`;
            } else if (fullyCompliant < totalExamples) {
              status = '⚠️';
              message = `${fullyCompliant}/${totalExamples} examples fully compliant`;
            }

            const body = `${status} **Trinity Pattern Verification**\n\n${message}\n\n- **Examples**: ${totalExamples}\n- **Fully Compliant**: ${fullyCompliant}\n- **Average Score**: ${averageScore.toFixed(1)}%\n- **Errors**: ${errorCount}\n\n[View Full Report](compliance-report.md)`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on errors
        if: steps.verify.outputs.error_count > 0
        run: |
          echo "❌ Found ${error_count} pattern violations"
          echo "See compliance-report.md for details"
          exit 1

      - name: Upload compliance report
        uses: actions/upload-artifact@v6
        with:
          name: compliance-report
          path: |
            compliance-report.json
            compliance-report.md
          retention-days: 30
