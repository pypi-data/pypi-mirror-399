"""Rich console reporter for netspecs."""

from __future__ import annotations

from datetime import datetime
from pathlib import Path
from typing import Optional

from rich.console import Console
from rich.panel import Panel
from rich.rule import Rule
from rich.table import Table
from rich.text import Text


# Theme colors
THEME = {
    "primary": "dodger_blue2",
    "success": "green",
    "warning": "yellow",
    "error": "red",
    "info": "cyan",
    "muted": "dim",
    "accent": "magenta",
}


class ConsoleReporter:
    """Reporter that outputs results to the console using Rich."""
    
    def __init__(self):
        self.console = Console()
    
    def report(self, results: dict, output_dir: Optional[Path] = None):
        """
        Output results to the console.
        
        Args:
            results: Dictionary of test results
            output_dir: Output directory (unused for console output)
        """
        self._print_header()
        
        if "network_info" in results:
            self._report_network_info(results["network_info"])
        
        if "connectivity" in results:
            self._report_connectivity(results["connectivity"], results.get("connectivity_summary"))
        
        if "latency" in results:
            self._report_latency(results["latency"])
        
        if "jitter" in results:
            self._report_jitter(results["jitter"])
        
        if "speed" in results:
            self._report_speed(results["speed"], results.get("bandwidth_variability"))
        
        if "bufferbloat" in results:
            self._report_bufferbloat(results["bufferbloat"])
        
        if "prioritization" in results:
            self._report_prioritization(results["prioritization"])
        
        if "monitor" in results:
            self._report_monitor(results["monitor"])
        
        self._print_footer()
    
    def _print_header(self):
        """Print report header."""
        self.console.print()
        
        header_text = Text()
        header_text.append("NETSPECS", style=f"bold {THEME['primary']}")
        header_text.append(" | ", style="dim")
        header_text.append("Internet Diagnostics Report", style="bold")
        
        self.console.print(Panel(
            header_text,
            subtitle=f"[dim]{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}[/dim]",
            border_style=THEME["primary"],
            padding=(0, 2),
        ))
    
    def _print_footer(self):
        """Print report footer."""
        self.console.print()
        self.console.print(Rule(style="dim"))
        self.console.print(
            f"[dim]Report generated by netspecs[/dim]",
            justify="center"
        )
        self.console.print()
    
    def _section_header(self, title: str, icon: str = ""):
        """Print a section header."""
        self.console.print()
        self.console.print(Rule(f"[bold {THEME['primary']}]{icon} {title}[/]", align="left"))
    
    def _report_network_info(self, info: dict):
        """Report network information."""
        self._section_header("Network Information")
        
        grid = Table.grid(padding=(0, 2))
        grid.add_column(style="dim", justify="right")
        grid.add_column()
        
        grid.add_row("Public IP:", f"[bold]{info.get('public_ip', 'Unknown')}[/bold]")
        grid.add_row("ISP:", info.get("isp", "Unknown"))
        grid.add_row("Local IP:", info.get("local_ip", "Unknown"))
        grid.add_row("Gateway:", info.get("default_gateway", "Unknown"))
        
        dns = info.get("dns_servers", [])
        grid.add_row("DNS:", ", ".join(dns) if dns else "Unknown")
        
        iface = info.get("interface_type", "Unknown")
        iface_color = THEME["success"] if iface == "ethernet" else THEME["warning"]
        grid.add_row("Interface:", f"[{iface_color}]{iface.upper()}[/{iface_color}]")
        
        self.console.print(grid)
        
        # Traceroute hops
        hops = info.get("traceroute_hops", [])
        if hops:
            self.console.print()
            self.console.print(f"[dim]First {len(hops)} network hops:[/dim]")
            hop_text = []
            for hop in hops:
                ip = hop.get("ip") or "*"
                rtt = hop.get("rtt_ms")
                rtt_str = f"{rtt:.0f}ms" if rtt else "-"
                hop_text.append(f"[dim]{hop['hop']}.[/dim] {ip} [dim]({rtt_str})[/dim]")
            self.console.print("  " + "  ->  ".join(hop_text))
    
    def _report_connectivity(self, results: list[dict], summary: Optional[dict] = None):
        """Report connectivity results."""
        self._section_header("Connectivity")
        
        # Compact inline format for connectivity
        reachable = []
        unreachable = []
        
        for r in results:
            if r.get("reachable"):
                reachable.append(r["host"])
            else:
                unreachable.append(r["host"])
        
        if reachable:
            self.console.print(f"[{THEME['success']}]Reachable:[/] {', '.join(reachable)}")
        if unreachable:
            self.console.print(f"[{THEME['error']}]Unreachable:[/] {', '.join(unreachable)}")
        
        if summary:
            rate = summary.get("success_rate", 0)
            color = THEME["success"] if rate == 100 else THEME["warning"] if rate >= 50 else THEME["error"]
            self.console.print(
                f"[dim]Success rate:[/] [{color}]{rate:.0f}%[/{color}] "
                f"[dim]({summary['reachable']}/{summary['total_hosts']})[/dim]"
            )
    
    def _report_latency(self, results: list[dict]):
        """Report latency results."""
        self._section_header("Latency & Packet Loss")
        
        table = Table(
            show_header=True,
            header_style=f"bold {THEME['primary']}",
            border_style="dim",
            row_styles=["", "dim"],
        )
        table.add_column("Host", style="bold")
        table.add_column("Avg", justify="right")
        table.add_column("Min", justify="right", style="dim")
        table.add_column("Max", justify="right", style="dim")
        table.add_column("P95", justify="right")
        table.add_column("Jitter", justify="right")
        table.add_column("Loss", justify="right")
        table.add_column("Status", justify="center")
        
        for r in results:
            loss = r.get("packet_loss_percent", 0)
            avg = r.get("avg_ms", 0)
            p95 = r.get("p95_ms", r.get("max_ms", 0))
            
            # Determine status
            if loss > 5:
                status = f"[{THEME['error']}]HIGH LOSS[/]"
            elif avg > 100:
                status = f"[{THEME['warning']}]SLOW[/]"
            elif r.get("success", True):
                status = f"[{THEME['success']}]OK[/]"
            else:
                status = f"[{THEME['error']}]FAIL[/]"
            
            # Color-code loss
            loss_color = THEME["error"] if loss > 5 else THEME["warning"] if loss > 1 else ""
            loss_str = f"[{loss_color}]{loss:.1f}%[/{loss_color}]" if loss_color else f"{loss:.1f}%"
            
            table.add_row(
                r["host"],
                f"{avg:.1f}ms",
                f"{r.get('min_ms', 0):.1f}ms",
                f"{r.get('max_ms', 0):.1f}ms",
                f"{p95:.1f}ms",
                f"{r.get('jitter_ms', 0):.1f}ms",
                loss_str,
                status,
            )
        
        self.console.print(table)
    
    def _report_jitter(self, results: list[dict]):
        """Report jitter results."""
        self._section_header("Jitter Analysis")
        
        self.console.print(f"[dim]Jitter = standard deviation of latency (lower is better)[/dim]")
        self.console.print()
        
        table = Table(
            show_header=True,
            header_style=f"bold {THEME['primary']}",
            border_style="dim",
        )
        table.add_column("Host", style="bold")
        table.add_column("Jitter", justify="right")
        table.add_column("P50", justify="right")
        table.add_column("P95", justify="right")
        table.add_column("P99", justify="right")
        table.add_column("Samples", justify="right", style="dim")
        table.add_column("Rating", justify="center")
        
        for r in results:
            jitter = r.get("jitter_ms", 0)
            
            if jitter > 30:
                rating = f"[{THEME['error']}]POOR[/]"
                jitter_style = THEME["error"]
            elif jitter > 10:
                rating = f"[{THEME['warning']}]FAIR[/]"
                jitter_style = THEME["warning"]
            else:
                rating = f"[{THEME['success']}]GOOD[/]"
                jitter_style = THEME["success"]
            
            table.add_row(
                r["host"],
                f"[{jitter_style}]{jitter:.2f}ms[/{jitter_style}]",
                f"{r.get('p50_ms', r.get('avg_ms', 0)):.1f}ms",
                f"{r.get('p95_ms', 0):.1f}ms",
                f"{r.get('p99_ms', 0):.1f}ms",
                str(r.get("samples", 0)),
                rating,
            )
        
        self.console.print(table)
    
    def _report_speed(self, speed: dict, variability: Optional[dict] = None):
        """Report speed test results."""
        self._section_header("Speed Test")
        
        # Ookla results
        if speed.get("ookla_available"):
            grid = Table.grid(padding=(0, 3))
            grid.add_column(justify="right", style="dim")
            grid.add_column(justify="left")
            grid.add_column(justify="right", style="dim")
            grid.add_column(justify="left")
            
            grid.add_row(
                "Download:",
                f"[bold {THEME['success']}]{speed['ookla_download_mbps']} Mbps[/]",
                "Upload:",
                f"[bold {THEME['success']}]{speed['ookla_upload_mbps']} Mbps[/]",
            )
            grid.add_row(
                "Ping:",
                f"{speed.get('ookla_ping_ms', 0)} ms",
                "Jitter:",
                f"{speed.get('ookla_jitter_ms', 0)} ms",
            )
            
            self.console.print(grid)
            
            if speed.get("ookla_server"):
                self.console.print(f"[dim]Server: {speed['ookla_server']}[/dim]")
        else:
            self.console.print(f"[{THEME['warning']}]Ookla Speedtest CLI not available[/]")
        
        # HTTP results
        if speed.get("http_tests"):
            self.console.print()
            self.console.print(f"[{THEME['info']}]HTTP Download Tests:[/]")
            
            for test in speed["http_tests"]:
                status = THEME["success"] if test.get("success") else THEME["error"]
                speed_str = f"{test['speed_mbps']:.1f} Mbps" if test.get("speed_mbps") else "Failed"
                self.console.print(f"  [{status}]{test['name']}:[/{status}] {speed_str}")
            
            if speed.get("http_download_mbps"):
                self.console.print(f"  [bold]Average: {speed['http_download_mbps']} Mbps[/bold]")
        
        # Variability
        if variability and variability.get("avg_mbps"):
            self.console.print()
            var_pct = variability.get("variability_percent", 0)
            var_color = THEME["error"] if var_pct > 30 else THEME["warning"] if var_pct > 15 else THEME["success"]
            self.console.print(
                f"[dim]Bandwidth variability:[/dim] "
                f"{variability['min_mbps']}-{variability['max_mbps']} Mbps "
                f"([{var_color}]{var_pct:.0f}% variation[/{var_color}])"
            )
    
    def _report_bufferbloat(self, result: dict):
        """Report bufferbloat test results."""
        self._section_header("Bufferbloat Test")
        
        grade = result.get("grade", "?")
        grade_colors = {
            "A": THEME["success"],
            "B": THEME["success"],
            "C": THEME["warning"],
            "D": THEME["error"],
            "F": THEME["error"],
        }
        grade_color = grade_colors.get(grade, "white")
        
        # Big grade display
        grade_panel = Panel(
            Text(grade, style=f"bold {grade_color}", justify="center"),
            title="Grade",
            title_align="center",
            width=12,
            border_style=grade_color,
        )
        
        self.console.print(grade_panel)
        
        # Details grid
        grid = Table.grid(padding=(0, 2))
        grid.add_column(style="dim", justify="right")
        grid.add_column()
        
        grid.add_row("Baseline P95:", f"{result.get('baseline_p95_ms', 0):.1f} ms")
        grid.add_row("Under load P95:", f"{result.get('loaded_p95_ms', 0):.1f} ms")
        
        increase = result.get("bloat_increase_ms", 0)
        increase_color = THEME["error"] if increase > 60 else THEME["warning"] if increase > 10 else THEME["success"]
        grid.add_row("Latency increase:", f"[{increase_color}]+{increase:.1f} ms[/{increase_color}]")
        grid.add_row("Bloat factor:", f"{result.get('bloat_factor', 0):.1f}x")
        
        self.console.print(grid)
        
        # Interpretation
        self.console.print()
        if grade in ["A", "B"]:
            self.console.print(f"[{THEME['success']}]Minimal bufferbloat - network handles load well[/]")
        elif grade == "C":
            self.console.print(f"[{THEME['warning']}]Moderate bufferbloat - some lag may occur under load[/]")
        else:
            self.console.print(f"[{THEME['error']}]Significant bufferbloat - expect lag during heavy usage[/]")
    
    def _report_prioritization(self, result: dict):
        """Report prioritization detection results."""
        self._section_header("Prioritization Detection")
        
        grid = Table.grid(padding=(0, 2))
        grid.add_column(style="dim", justify="right")
        grid.add_column()
        
        grid.add_row("Target:", result.get("host", "Unknown"))
        grid.add_row("Baseline:", f"{result.get('baseline_avg_ms', 0):.1f} ms")
        
        self.console.print(grid)
        
        # Phase results
        if result.get("phases"):
            self.console.print()
            table = Table(
                show_header=True,
                header_style=f"bold {THEME['primary']}",
                border_style="dim",
            )
            table.add_column("Phase")
            table.add_column("Latency", justify="right")
            table.add_column("Change", justify="right")
            table.add_column("Jitter", justify="right")
            
            baseline = result.get("baseline_avg_ms", 0)
            for phase in result["phases"]:
                avg = phase.get("avg_ms", 0)
                change = avg - baseline if baseline else 0
                change_color = THEME["error"] if change > 50 else THEME["warning"] if change > 20 else ""
                change_str = f"[{change_color}]{change:+.1f}ms[/{change_color}]" if change_color else f"{change:+.1f}ms"
                
                table.add_row(
                    phase.get("name", "").replace("_", " ").title(),
                    f"{avg:.1f}ms",
                    change_str,
                    f"{phase.get('jitter_ms', 0):.1f}ms",
                )
            
            self.console.print(table)
        
        # Verdict
        self.console.print()
        if result.get("throttling_detected"):
            severity = result.get("throttling_severity", "unknown").upper()
            self.console.print(f"[{THEME['error']}]Throttling detected: {severity}[/]")
        else:
            self.console.print(f"[{THEME['success']}]No significant throttling detected[/]")
    
    def _report_monitor(self, result: dict):
        """Report long-term monitoring results."""
        self._section_header("Long-Term Monitoring")
        
        duration = result.get("total_duration_seconds", 0) // 60
        self.console.print(f"[dim]Monitored for {duration} minutes[/dim]")
        self.console.print()
        
        # Summary grid
        grid = Table.grid(padding=(0, 3))
        grid.add_column(justify="right", style="dim")
        grid.add_column()
        grid.add_column(justify="right", style="dim")
        grid.add_column()
        
        loss = result.get("overall_loss_percent", 0)
        loss_color = THEME["error"] if loss > 2 else THEME["warning"] if loss > 0.5 else THEME["success"]
        
        grid.add_row(
            "Samples:",
            f"{result.get('total_samples', 0)}",
            "Loss:",
            f"[{loss_color}]{loss:.2f}%[/{loss_color}]",
        )
        grid.add_row(
            "Avg:",
            f"{result.get('overall_avg_ms', 0):.1f}ms",
            "Jitter:",
            f"{result.get('overall_jitter_ms', 0):.1f}ms",
        )
        grid.add_row(
            "P95:",
            f"{result.get('overall_p95_ms', 0):.1f}ms",
            "P99:",
            f"{result.get('overall_p99_ms', 0):.1f}ms",
        )
        
        self.console.print(grid)
        
        # Spike info
        spikes = result.get("spike_count", 0)
        if spikes > 0:
            spike_color = THEME["error"] if spikes > 10 else THEME["warning"]
            self.console.print(
                f"\n[{spike_color}]Detected {spikes} latency spikes (>2x median)[/{spike_color}]"
            )
            
            worst = result.get("worst_latencies", [])
            if worst:
                worst_str = ", ".join(f"{w:.0f}ms" for w in worst[:5])
                self.console.print(f"[dim]Worst latencies: {worst_str}[/dim]")
        else:
            self.console.print(f"\n[{THEME['success']}]No significant latency spikes detected[/]")
