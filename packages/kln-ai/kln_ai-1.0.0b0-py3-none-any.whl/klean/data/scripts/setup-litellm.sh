#!/usr/bin/env bash
# K-LEAN LiteLLM Setup Wizard
# ===========================
# Interactive configuration for LiteLLM with multiple provider support
# Usage: ./setup-litellm.sh [provider]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CONFIG_DIR="${HOME}/.config/litellm"
BACKUP_DIR="${CONFIG_DIR}/backups"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# Ensure config directory exists
ensure_config_dir() {
    mkdir -p "$CONFIG_DIR" "$BACKUP_DIR"
}

# Backup existing config
backup_config() {
    if [ -f "$CONFIG_DIR/config.yaml" ]; then
        local timestamp=$(date +%s)
        cp "$CONFIG_DIR/config.yaml" "$BACKUP_DIR/config.yaml.$timestamp"
        log_info "Backed up existing config to $BACKUP_DIR/config.yaml.$timestamp"
    fi
}

# Read API key securely
read_api_key() {
    local prompt="$1"
    local api_key=""
    echo -n -e "${BLUE}?${NC} $prompt: "
    read -rs api_key
    echo ""
    echo "$api_key"
}

# Auto-detect NanoGPT subscription status
detect_nanogpt_endpoint() {
    local api_key="$1"

    # Check subscription status
    local response
    response=$(curl -s --max-time 5 "https://nano-gpt.com/api/subscription/v1/usage" \
        -H "Authorization: Bearer $api_key" 2>/dev/null)

    if echo "$response" | grep -q '"active":true'; then
        echo "https://nano-gpt.com/api/subscription/v1"
        return 0
    else
        echo "https://nano-gpt.com/api/v1"
        return 0
    fi
}

# Provider: NanoGPT
setup_nanogpt() {
    log_info "Configuring NanoGPT provider..."

    # Get API key
    local api_key
    api_key=$(read_api_key "Enter your NanoGPT API key (get from https://nano-gpt.com)")

    if [ -z "$api_key" ]; then
        log_error "API key cannot be empty"
        return 1
    fi

    # Auto-detect subscription vs pay-per-use
    log_info "Detecting account type..."
    local api_base
    api_base=$(detect_nanogpt_endpoint "$api_key")

    if [[ "$api_base" == *"subscription"* ]]; then
        log_success "Subscription account detected"
    else
        log_info "Pay-per-use account detected"
    fi

    # Create .env file
    cat > "$CONFIG_DIR/.env" << EOF
# K-LEAN LiteLLM Environment Variables - NanoGPT
# Generated by setup-litellm.sh

NANOGPT_API_BASE=$api_base
NANOGPT_API_KEY=$api_key
EOF
    chmod 600 "$CONFIG_DIR/.env"

    # Copy config template
    if [ -f "$REPO_DIR/config/litellm/config.yaml" ]; then
        cp "$REPO_DIR/config/litellm/config.yaml" "$CONFIG_DIR/config.yaml"
    elif [ -f "${HOME}/.config/litellm/config.yaml" ]; then
        cp "${HOME}/.config/litellm/config.yaml" "$CONFIG_DIR/config.yaml"
    fi

    log_success "NanoGPT configuration created"
}

# Provider: OpenRouter
setup_openrouter() {
    log_info "Configuring OpenRouter provider..."

    # Get API key
    local api_key
    api_key=$(read_api_key "Enter your OpenRouter API key (get from https://openrouter.ai)")

    if [ -z "$api_key" ]; then
        log_error "API key cannot be empty"
        return 1
    fi

    # Create .env file
    cat > "$CONFIG_DIR/.env" << EOF
# K-LEAN LiteLLM Environment Variables - OpenRouter
# Generated by setup-litellm.sh

OPENROUTER_API_BASE=https://openrouter.ai/api/v1
OPENROUTER_API_KEY=$api_key
EOF
    chmod 600 "$CONFIG_DIR/.env"

    # Copy config template
    if [ -f "$REPO_DIR/config/litellm/openrouter.yaml" ]; then
        cp "$REPO_DIR/config/litellm/openrouter.yaml" "$CONFIG_DIR/config.yaml"
    elif [ -f "${HOME}/.config/litellm/openrouter.yaml" ]; then
        cp "${HOME}/.config/litellm/openrouter.yaml" "$CONFIG_DIR/config.yaml"
    fi

    log_success "OpenRouter configuration created"
}

# Menu for provider selection
select_provider() {
    local provider="${1:-}"

    if [ -z "$provider" ]; then
        echo ""
        echo -e "${BLUE}K-LEAN LiteLLM Setup Wizard${NC}"
        echo "=============================="
        echo ""
        echo "Select your provider:"
        echo "  1) NanoGPT (12 models)"
        echo "  2) OpenRouter (diverse models)"
        echo "  3) Skip setup (use existing config)"
        echo ""

        echo -n "Enter choice [1-3]: "
        read -r choice
        provider="$choice"
    fi

    case "$provider" in
        1|nanogpt|nano)
            setup_nanogpt
            ;;
        2|openrouter|router)
            setup_openrouter
            ;;
        3|skip|none)
            log_info "Skipping setup"
            return 0
            ;;
        *)
            log_error "Invalid choice: $provider"
            return 1
            ;;
    esac
}

# Display summary and next steps
show_summary() {
    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}LiteLLM Setup Complete!${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Configuration saved to:"
    echo "  Config: $CONFIG_DIR/config.yaml"
    echo "  Secrets: $CONFIG_DIR/.env (keep safe!)"
    echo ""
    echo "Next steps:"
    echo "  1. Start LiteLLM:"
    echo "     source ~/.config/litellm/.env && litellm --config ~/.config/litellm/config.yaml"
    echo ""
    echo "  2. Or use the wrapper:"
    echo "     ~/.claude/scripts/litellm-start.sh"
    echo ""
    echo "  3. Test models:"
    echo "     healthcheck"
    echo ""
}

# Main
main() {
    ensure_config_dir
    backup_config
    select_provider "$@" || exit 1
    show_summary
}

main "$@"
