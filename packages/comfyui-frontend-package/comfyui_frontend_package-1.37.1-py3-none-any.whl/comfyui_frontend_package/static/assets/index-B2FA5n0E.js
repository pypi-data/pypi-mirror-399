var st=Object.defineProperty;var u=(n,e)=>st(n,"name",{value:e,configurable:!0});import{q as p,cI as T,cJ as Xe,cK as b,aj as C,an as R,cL as at,ab as K,aH as ee,cM as rt,cN as lt,bm as Ke,a5 as dt,v as ct,f as S,$ as ut,t as D,o as te,cO as pt,cP as gt,cQ as L,cR as P,aZ as ft,cS as be,cT as ht,cU as mt,cV as yt,cW as wt,cX as Pe,cY as oe,cZ as F,c_ as $,ax as de,c$ as Je,d0 as vt,d1 as bt,d2 as Nt,d3 as W,A as It,a as E,C as Ct,d4 as kt,d5 as Qe,d6 as Dt,at as xt,ay as _t,e as Z,d7 as V,cH as ae,d8 as Tt,cG as ce,d9 as ke,da as De,db as St,u as Ze,cF as Mt,dc as Et,dd as Ot,R as Le,de as At,c5 as Pt,df as Lt,dg as Gt,dh as Wt,di as Rt}from"./index-FoJ8Eu4a.js";import{bs as Ft,cw as Ge,cZ as H,n as xe,ey as Ut}from"./vendor-other-BxP-0xn6.js";import{_ as _e}from"./Load3D.vue_vue_type_script_setup_true_lang-BJ0IqFdp.js";import{g as ue,s as et}from"./audioUtils-iqnmct8N.js";import{u as Q}from"./audioService-B43wn81n.js";import"./vendor-primevue-rR0TB_Js.js";import"./vendor-vue-BEnTqVKr.js";import"./vendor-xterm-CWYFmgbN.js";import"./vendor-three-BsnVSA6y.js";import"./vendor-tiptap-4vvRsqpM.js";class M extends Xe{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,t,s){const o=b("button",{type:"button",textContent:e,contextPredicate:t,onclick:s});M.items.push(o)}static invalidatePreview(){if(T.clipspace&&T.clipspace.imgs&&T.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=T.clipspace.imgs[T.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(M.instance){const e=M.instance,t=b("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(t)):e.element=b("div.comfy-modal",{parent:document.body},[t]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(b("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),M.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let t in M.items){const s=M.items[t];(!s.contextPredicate||s.contextPredicate())&&e.push(M.items[t])}return e.push(b("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(T.clipspace?.imgs){const e=[],t=T.clipspace.imgs;for(let d=0;d<t.length;d++)e.push(b("option",{value:d},[`${d}`]));const s=b("select",{id:"clipspace_img_selector",onchange:u(d=>{d.target&&T.clipspace&&(T.clipspace.selectedIndex=d.target.selectedIndex,M.invalidatePreview())},"onchange")},e),o=b("tr",{},[b("td",{},[b("font",{color:"white"},["Select Image"])]),b("td",{},[s])]),i=b("select",{id:"clipspace_img_paste_mode",onchange:u(d=>{d.target&&T.clipspace&&(T.clipspace.img_paste_mode=d.target.value)},"onchange")},[b("option",{value:"selected"},"selected"),b("option",{value:"all"},"all")]);i.value=T.clipspace.img_paste_mode;const a=b("tr",{},[b("td",{},[b("font",{color:"white"},["Paste Mode"])]),b("td",{},[i])]),r=b("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[b("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),l=b("tr",{},[r]);return b("table",{},[o,a,l])}else return[]}createImgPreview(){return T.clipspace?.imgs?b("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){M.invalidate(),this.element.style.display="block"}}p.registerExtension({name:"Comfy.Clipspace",init(n){n.openClipspace=function(){M.instance||(M.instance=new M,T.clipspace_invalidate_handler=M.invalidate),T.clipspace?M.instance.show():n.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=M;const Bt={name:"Comfy.ContextMenuFilter",init(){const n=C.ContextMenu;C.ContextMenu=function(e,t){const s=new n(e,t);if(t?.className==="dark"&&e?.length>4){const o=document.createElement("input");o.classList.add("comfy-context-menu-filter"),o.placeholder="Filter list",s.root.prepend(o);const i=Array.from(s.root.querySelectorAll(".litemenu-entry"));let a=[...i],r=a.length;requestAnimationFrame(()=>{const d=R.active_canvas.current_node?.widgets?.filter(h=>at(h)&&h.options.values?.length===e.length).find(h=>h.options.values?.every((m,y)=>m===e[y]))?.value;let c=d?e.findIndex(h=>h===d):0;c<0&&(c=0);let f=a[c];v();function v(){f?.style.setProperty("background-color",""),f?.style.setProperty("color",""),f=a[c],f?.style.setProperty("background-color","#ccc","important"),f?.style.setProperty("color","#000","important")}u(v,"updateSelected");const g=u(()=>{if(s.root.getBoundingClientRect().top<0){const m=1-s.root.getBoundingClientRect().height/s.root.clientHeight,y=s.root.clientHeight*m/2;s.root.style.top=-y+"px"}},"positionList");o.addEventListener("keydown",h=>{switch(h.key){case"ArrowUp":h.preventDefault(),c===0?c=r-1:c--,v();break;case"ArrowRight":h.preventDefault(),c=r-1,v();break;case"ArrowDown":h.preventDefault(),c===r-1?c=0:c++,v();break;case"ArrowLeft":h.preventDefault(),c=0,v();break;case"Enter":f?.click();break;case"Escape":s.close();break}}),o.addEventListener("input",()=>{const h=o.value.toLocaleLowerCase();if(a=i.filter(m=>{const y=!h||m.textContent?.toLocaleLowerCase().includes(h);return m.style.display=y?"block":"none",y}),c=0,a.includes(f)&&(c=a.findIndex(m=>m===f)),r=a.length,v(),t.event){let m=t.event.clientY-10;const y=document.body.getBoundingClientRect(),w=s.root.getBoundingClientRect();y.height&&m>y.height-w.height-10&&(m=Math.max(0,y.height-w.height-10)),s.root.style.top=m+"px",g()}}),requestAnimationFrame(()=>{o.focus(),g()})})}return s},C.ContextMenu.prototype=n.prototype}};p.registerExtension(Bt);function Vt(n=[]){if(!this.outputs[0].links?.length||!this.graph)return;const e=[...this.outputs[0].links.map(s=>this.graph.links[s]),...n];let t=this.widgets?.[0].value;for(const s of e){const o=this.graph?.getNodeById(s.target_id),i=o?.inputs[s.target_slot];if(!i){console.warn("Unable to resolve node or input for link",s);continue}const a=i.widget?.name;if(!a){console.warn("Invalid widget or widget name",i.widget);continue}const r=o.widgets?.find(l=>l.name===a);if(!r){console.warn(`Unable to find widget "${a}" on node [${o.id}]`);continue}r.value=t,r.callback?.(r.value,p.canvas,o,p.canvas.graph_mouse,{})}}u(Vt,"applyToGraph");function $t(){this.applyToGraph=K(this.applyToGraph,Vt);const n=this.widgets[0],e=Ft([]);n.options.values=e;const t=u(()=>{e.splice(0,e.length,...this.widgets.filter(o=>o.name.startsWith("option")&&o.value).map(o=>`${o.value}`)),!p.configuringGraph&&(e.includes(`${n.value}`)||(n.value=e[0]??"",n.callback?.(n.value)))},"updateCombo");n.callback=K(n.callback,()=>this.applyToGraph());function s(o){if(!o.widgets)return;const i=o.widgets.length-1;o.addWidget("string",`option${i}`,"",()=>{});const a=o.widgets.at(-1);if(!a)return;let r="";Object.defineProperty(a,"value",{get(){return r},set(l){if(r=l,t(),!o.widgets)return;const d=o.widgets.at(-1);if(d===this){l&&s(o);return}l||o.widgets.at(-2)!==this||d?.value||(o.widgets.pop(),o.computeSize(o.size),this.callback(l))}})}u(s,"addOption"),s(this)}u($t,"onNodeCreated");p.registerExtension({name:"Comfy.CustomCombo",beforeRegisterNodeDef(n,e){e?.name==="CustomCombo"&&(n.prototype.onNodeCreated=K(n.prototype.onNodeCreated,$t))}});ee().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(n){if(n.widgets){const e=n.widgets.filter(t=>t.dynamicPrompts);for(const t of e)t.serializeValue=(s,o)=>{if(typeof t.value!="string")return t.value;const i=rt(t.value);return s?.widgets_values&&(s.widgets_values[o]=i),i}}}});p.registerExtension({name:"Comfy.EditAttention",init(){const n=p.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(i,a){const r=parseFloat(i);if(isNaN(r))return i;const l=r+a;return String(Number(l.toFixed(10)))}u(e,"incrementWeight");function t(i,a){let r=a,l=a,d=0,c=0;for(;r>=0&&(r--,!(i[r]==="("&&d===c));)i[r]==="("&&d++,i[r]===")"&&c++;if(r<0)return null;for(d=0,c=0;l<i.length&&!(i[l]===")"&&d===c);)i[l]==="("&&d++,i[l]===")"&&c++,l++;return l===i.length?null:{start:r+1,end:l}}u(t,"findNearestEnclosure");function s(i){const a=/^\((.*)\)$/,r=i.match(a),l=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,d=i.match(l);return r&&!d?`(${r[1]}:1.0)`:i}u(s,"addWeightToParentheses");function o(i){const a=i.composedPath()[0],r=parseFloat(n.value);if(a.tagName!=="TEXTAREA"||!(i.key==="ArrowUp"||i.key==="ArrowDown")||!i.ctrlKey&&!i.metaKey)return;i.preventDefault();let l=a.selectionStart,d=a.selectionEnd,c=a.value.substring(l,d);if(!c){const g=t(a.value,l);if(g)l=g.start,d=g.end,c=a.value.substring(l,d);else{const h=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!h.includes(a.value[l-1])&&l>0;)l--;for(;!h.includes(a.value[d])&&d<a.value.length;)d++;if(c=a.value.substring(l,d),!c)return}}c[c.length-1]===" "&&(c=c.substring(0,c.length-1),d-=1),a.value[l-1]==="("&&a.value[d]===")"&&(l-=1,d+=1,c=a.value.substring(l,d)),(c[0]!=="("||c[c.length-1]!==")")&&(c=`(${c})`),c=s(c);const f=i.key==="ArrowUp"?r:-r,v=c.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(g,h,m)=>(m=e(m,f),m==1?h:`(${h}:${m})`));a.setSelectionRange(l,d),document.execCommand("insertText",!1,v),a.setSelectionRange(l,l+v.length)}u(o,"editAttention"),window.addEventListener("keydown",o)}});const zt={validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},me=u(async n=>lt(n)&&await Ke().NetWork.canAccessUrl(n),"checkMirrorReachable");(async()=>{if(!dt())return;const n=Ke(),e=await n.getElectronVersion(),t=ct(),s=S(),{staticUrls:o,buildDocsUrl:i}=ut(),a=u((r,l)=>{l!==void 0&&r!==l&&n.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");p.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((r,l)=>{l&&n.Config.setWindowStyle(r)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(r){return me(r+zt.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:me}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:me}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){n.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){n.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){n.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){n.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){n.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){n.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){n.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(i("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const r=await n.checkForUpdates({disableUpdateReadyAction:!0});if(!r.isUpdateAvailable){s.add({severity:"info",summary:D("desktopUpdate.noUpdateFound"),life:5e3});return}if(await te().confirm({title:D("desktopUpdate.updateFoundTitle",{version:r.version}),message:D("desktopUpdate.updateAvailableMessage"),type:"default"}))try{n.restartAndInstall()}catch(d){Ge.error("Error installing update:",d),s.add({severity:"error",summary:D("g.error"),detail:D("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(r){Ge.error("Error checking for updates:",r),s.add({severity:"error",summary:D("g.error"),detail:D("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await te().confirm({message:D("desktopMenu.confirmReinstall"),title:D("desktopMenu.reinstall"),type:"reinstall"})&&n.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){n.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){t.modifiedWorkflows.length>0&&!await te().confirm({message:D("desktopMenu.confirmQuit"),title:D("desktopMenu.quit"),type:"default"})||n.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:o.githubElectron,icon:"pi pi-github"}]})})();class jt extends pt{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,t,s,o,i){super(e,t,s,o),this.groupNodeHandler=i}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const t=this.node.getInputNode(e);if(!t)return;const s=this.node.getInputLink(e);if(!s)throw new Error("Failed to get input link");const o=String(t.id);let i=this.nodesByExecutionId?.get(o);if(!i){const a=o.split(":").at(-1);a!==void 0&&(i=this.nodesByExecutionId?.get(a))}if(!i)throw new Error(`Failed to get input node ${o} for group node child ${this.id} with slot ${e}`);return{node:i,origin_id:o,origin_slot:s.origin_slot}}}const ye=Symbol();function tt(n,e){if(typeof n=="object"&&typeof e=="object")for(const t in e){const s=e[t];if(typeof s=="object"){let o=n[t];o||(o=n[t]={}),tt(o,e[t])}else n[t]=s}return n}u(tt,"merge");class ot extends gt{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=b("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=C.registered_node_types[`${L}${P}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=U.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();const s=this.groupData.nodeData.nodes;if(this.nodeItems=s.map((i,a)=>b("li.draggable-item",{dataset:{nodeindex:i.index+""},onclick:u(()=>{this.changeNode(a)},"onclick")},[b("span.drag-handle"),b("div",{textContent:i.title??i.type},i.title?b("span",{textContent:i.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let a=this.draggable.getAllItems().findIndex(r=>r.classList.contains("selected"));a===-1&&(a=this.selectedNodeIndex),this.changeNode(a,!0)}const o=[...s];this.draggable?.dispose(),this.draggable=new ft(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:i,newPosition:a}})=>{if(i!==a){o.splice(a,0,o.splice(i,1)[0]);for(let r=0;r<o.length;r++)this.storeModification({nodeIndex:o[r].index,section:ye,prop:"order",value:r})}})}storeModification(e){const{nodeIndex:t,section:s,prop:o,value:i}=e,a=this.modifications[this.selectedGroup]??={},r=a.nodes??={},l=r[t??this.selectedNodeInnerIndex]??={},d=l[s]??={};if(typeof i=="object"){const c=d[o]??={};Object.assign(c,i)}else d[o]=i}getEditElement(e,t,s,o,i,a=!0){s===o&&(s="");const r=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[t];return r&&(r.name!=null&&(s=r.name),r.visible!=null&&(i=r.visible)),b("div",[b("input",{value:s,placeholder:o,type:"text",onchange:u(l=>{this.storeModification({section:e,prop:t,value:{name:l.target.value}})},"onchange")}),b("label",{textContent:"Visible"},[b("input",{type:"checkbox",checked:i,disabled:!a,onchange:u(l=>{this.storeModification({section:e,prop:t,value:{visible:!!l.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),o=p.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(i=>this.getEditElement("input",i,e[i],i,o?.[i]?.visible!==!1))),!!t.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),o=p.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...t.map(i=>{let a=e[i];if(a)return this.getEditElement("input",i,a,i,o?.[i]?.visible!==!1)}).filter(Boolean)),!!t.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),s=t?.output??[],o=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],a=p.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,l=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...s.map((d,c)=>{const f=o?.[c],v=t.output_name?.[c]??d;let g=a?.[c]?.name;const h=a?.[c]?.visible||f!=null;return(!g||g===v)&&(g=""),this.getEditElement("output",c,g,v,h,l)}).filter(Boolean)),!!s.length}show(e){const t=Object.keys(p.rootGraph.extra?.groupNodes??{}).sort((i,a)=>i.localeCompare(a));this.innerNodesList=b("ul.comfy-group-manage-list-items"),this.widgetsPage=b("section.comfy-group-manage-node-page"),this.inputsPage=b("section.comfy-group-manage-node-page"),this.outputsPage=b("section.comfy-group-manage-node-page");const s=b("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((i,[a,r])=>(i[a]={tab:b("a",{onclick:u(()=>{this.changeTab(a)},"onclick"),textContent:a}),page:r},i),{});const o=b("div.comfy-group-manage-outer",[b("header",[b("h2","Group Nodes"),b("select",{onchange:u(i=>{this.changeGroup(i.target.value)},"onchange")},t.map(i=>b("option",{textContent:i,selected:`${L}${P}${i}`===e,value:i})))]),b("main",[b("section.comfy-group-manage-list",this.innerNodesList),b("section.comfy-group-manage-node",[b("header",Object.values(this.tabs).map(i=>i.tab)),s])]),b("footer",[b("button.comfy-btn",{onclick:u(()=>{if(p.rootGraph.nodes.find(a=>a.type===`${L}${P}`+this.selectedGroup)){S().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete p.rootGraph.extra.groupNodes[this.selectedGroup],C.unregisterNodeType(`${L}${P}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),b("button.comfy-btn",{onclick:u(async()=>{let i,a=[];const r={};for(const l in this.modifications){const d=p.rootGraph.extra.groupNodes[l];let c=d.config??={},f=this.modifications[l]?.nodes;if(f){const g=Object.keys(f);if(f[g[0]][ye]){const h=[],m={},y={};for(const w of g){const N=f[w][ye].order;h[N]=d.nodes[+w],m[N]=f[w],h[N].index=N}for(const w of d.links)w[0]!=null&&(w[0]=d.nodes[w[0]].index),w[2]!=null&&(w[2]=d.nodes[w[2]].index);if(d.external)for(const w of d.external)w[0]=d.nodes[w[0]];for(const w of g)c[w]&&(y[d.nodes[w].index]=c[w]),delete c[w];d.nodes=h,f=m,d.config=c=y}tt(c,f)}r[l]=d,i||(i=p.rootGraph.nodes.reduce((g,h)=>(g[h.type]??=[],g[h.type].push(h),g),{}));const v=i[`${L}${P}`+l];v&&a.push(...v)}await Y.registerFromWorkflow(r,{});for(const l of a)l.recreate();this.modifications={},this.app.canvas.setDirty(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),b("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(o),this.changeGroup(e?t.find(i=>`${L}${P}${i}`===e)??t[0]:t[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=ot;const Ht=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),We=u(n=>{const e=n.min??-1/0,t=n.max??1/0;return{min:e,max:t}},"getRange"),qt=u((n,e)=>{const t=n[0],s=n[1]??{},o=e[1]??{},i=We(s),a=We(o);if(i.min>a.max||i.max<a.min)return null;const r=s.step??1,l=o.step??1,d={min:Math.max(i.min,a.min),max:Math.min(i.max,a.max),step:wt(r,l)};return Te([t,{...s,...d}],[t,{...o,...d}])},"mergeNumericInputSpec"),Yt=u((n,e)=>{const t=n[1]??{},s=e[1]??{},o=Pe(n),i=Pe(e),a=H.intersection(o,i);return a.length===0?null:Te(["COMBO",{...t,options:a}],["COMBO",{...s,options:a}])},"mergeComboInputSpec"),Te=u((n,e)=>{const t=be(n),s=n[1]??{},o=e[1]??{};return H.union(H.keys(s),H.keys(o)).filter(r=>!Ht.has(r)).every(r=>{const l=s[r],d=o[r];return l===d||H.isNil(l)&&H.isNil(d)})?[t,{...s,...o}]:null},"mergeCommonInputSpec"),Xt=u((n,e)=>{const t=be(n),s=be(e);return t!==s?null:ht(n)||mt(n)?qt(n,e):yt(n)?Yt(n,e):Te(n,e)},"mergeInputSpec"),Kt=u(n=>n.type==="PrimitiveNode","isPrimitiveNode"),we="Run widget replace on values";class Ne extends de{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(we in this.properties))&&this.addProperty(we,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;const t=[...this.outputs[0].links.map(o=>this.graph.links[o]),...e];let s=this.widgets?.[0].value;s&&this.properties[we]&&(s=Je(this.graph,s));for(const o of t){const i=this.graph?.getNodeById(o.target_id),a=i?.inputs[o.target_slot];if(!a){console.warn("Unable to resolve node or input for link",o);continue}const r=a.widget?.name;if(!r){console.warn("Invalid widget or widget name",a.widget);continue}const l=i.widgets?.find(d=>d.name===r);if(!l){console.warn(`Unable to find widget "${r}" on node [${i.id}]`);continue}l.value=s,l.callback?.(l.value,p.canvas,i,p.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[F]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,t,s){if(p.configuringGraph)return;const o=this.outputs[0].links;s?o?.length&&!this.widgets?.length&&this.#e():(this.#t(),o?.length||this.onLastDisconnect())}onConnectOutput(e,t,s,o,i){if(!s.widget&&!(s.type in $))return!1;if(this.outputs[e].links?.length){const a=this.#o(s);return a&&this.applyToGraph([{target_id:o.id,target_slot:i}]),a}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const t=this.outputs[0].links[0],s=this.graph.links[t];if(!s)return;const o=this.graph.getNodeById(s.target_id);if(!o||!o.inputs)return;const i=o.inputs[s.target_slot];if(!i)return;let a;if(i.widget)a=i.widget;else{if(!(i.type in $))return;a={name:i.name,[F]:()=>[i.type,{}]}}const r=a[F]?.();if(!r)return;const{type:l}=Qt(r);this.outputs[0].type=l,this.outputs[0].name=l,this.outputs[0].widget=a,this.#i(a[oe]??r,o,a.name,e)}#i(e,t,s,o){let i=e[0];i instanceof Array&&(i="COMBO");const[a,r]=this.size;let l;if(vt(i)?l=($[i](this,"value",e,p)||{}).widget:l=this.addWidget(i,"value",null,()=>{},{}),t?.widgets&&l){const c=t.widgets.find(f=>f.name===s);c&&(l.value=c.value)}if(!e?.[1]?.control_after_generate&&(l.type==="number"||l.type==="combo")){let c=this.widgets_values?.[1];c||(c="fixed"),bt(this,l,c,void 0,e),this.widgets?.[1]&&(l.linkedWidgets=[this.widgets[1]]);let f=this.widgets_values?.[2];f&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=f)}const d=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&d?.length===this.widgets.length-1)for(let c=0;c<d.length;c++)this.widgets[c+1].value=d[c];if(l.callback=K(l.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],a),Math.max(this.size[1],r)]),!o){const c=this.computeSize();this.size[0]<c[0]&&(this.size[0]=c[0]),this.size[1]<c[1]&&(this.size[1]=c[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(t=>t.value);if(this.#n(),this.#e(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}#t(){const e=this.outputs[0],t=e.links??[],s=!!e.widget?.[oe];if(s&&delete e.widget?.[oe],t?.length<2&&s){t.length&&this.recreateWidget();return}const o=e.widget?.[F]?.();if(!(!o||!(o[0]==="INT"||o[0]==="FLOAT")||!this.graph))for(const a of t){const r=this.graph.links[a];if(!r)continue;const l=this.graph.getNodeById(r.target_id);if(!l)continue;const d=l.inputs[r.target_slot];this.#o(d,s)}}#o(e,t){const s=this.outputs?.[0],o=e.widget?.[F]?.();return o?!!re.call(this,s,o,t,this.recreateWidget):!1}#n(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#n()}}function Se(n){return n.widget?.[oe]??n.widget?.[F]?.()??["*",{}]}u(Se,"getWidgetConfig");function Re(n){const{nodeData:e}=this.constructor;return e?.input?.required?.[n]??e?.input?.optional?.[n]}u(Re,"getConfig");function Jt(n,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),n.inputs.find(t=>t.widget?.name===e.name)}u(Jt,"convertToInput");function Qt(n){let e=n[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(Qt,"getWidgetType");function Ie(n,e){if(!n.widget||(e?n.widget[F]=()=>e:delete n.widget,!(n instanceof Nt)))return;const t=n.node.graph;if(!t)return;const s=t.links[n.link??-1];if(!s)return;const o=t.getNodeById(s.origin_id);!o||!Kt(o)||(e?o.recreateWidget():p.configuringGraph||(o.disconnectOutput(0),o.onLastDisconnect()))}u(Ie,"setWidgetConfig");function re(n,e,t,s,o){o||(o=Se(n));const i=Xt(o,e);if(i||t){i&&(n.widget[oe]=i);const a=s?.call(this);if(a){const r=a.options.min,l=a.options.max;r!=null&&a.value<r&&(a.value=r),l!=null&&a.value>l&&(a.value=l),a.callback(a.value)}}return{customConfig:i?.[1]??{}}}u(re,"mergeIfValid");p.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(n,e,t){n.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},n.prototype.onGraphConfigured=K(n.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const o of this.inputs)if(o.widget){const i=o.widget.name;o.widget[F]||(o.widget[F]=()=>Re.call(this,i)),this.widgets?.find(r=>r.name===i)||this.removeInput(this.inputs.findIndex(r=>r===o))}}}),n.prototype.onConfigure=K(n.prototype.onConfigure,function(){if(!t.configuringGraph&&this.inputs){for(const o of this.inputs)if(o.widget&&!o.widget[F]){const i=o.widget.name;o.widget[F]=()=>Re.call(this,i)}}});const s=n.prototype.onInputDblClick;n.prototype.onInputDblClick=function(...[o,...i]){const a=s?.apply(this,[o,...i]),r=this.inputs[o];if(!r.widget&&!(r.type in $)&&!(r.widget?.[F]?.()?.[0]instanceof Array))return a;const l=C.createNode("PrimitiveNode"),d=t.canvas.graph;if(!l||!d)return a;d?.add(l);const c=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;d.getNodeOnPos(c[0],c[1],d.nodes);)c[1]+=C.NODE_TITLE_HEIGHT;return l.pos=c,l.connect(0,this,o),l.title=r.name,a}},registerCustomNodes(){C.registerNodeType("PrimitiveNode",Object.assign(Ne,{title:"Primitive"})),Ne.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=Ne;window.comfyAPI.widgetInputs.getWidgetConfig=Se;window.comfyAPI.widgetInputs.convertToInput=Jt;window.comfyAPI.widgetInputs.setWidgetConfig=Ie;window.comfyAPI.widgetInputs.mergeIfValid=re;const q={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(n){const e=`${L}${P}${n}`;return p.rootGraph.extra?.groupNodes?.[n]?p.rootGraph.nodes.find(t=>t.type===e)?q.InUse.InWorkflow:q.InUse.Registered:q.InUse.Free},storeGroupNode(n,e){let t=p.rootGraph.extra;t||(p.rootGraph.extra=t={});let s=t.groupNodes;s||(t.groupNodes=s={}),s[n]=e}};class Fe{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),q.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await te().prompt({title:D("groupNode.create"),message:D("groupNode.enterName"),defaultValue:""});if(!e)return;switch(q.isInUseGroupNode(e)){case q.InUse.InWorkflow:S().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case q.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=p.rootGraph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((t,s)=>t.index-s.index||t.node.id-s.node.id).map(({node:t})=>t)}getNodeData(){const e=u(s=>{for(const o of s.links){const a=p.rootGraph.getNodeById(o[4]).outputs[o[1]].type;o.push(a)}},"storeLinkTypes"),t=u(s=>{s.external=[];for(let o=0;o<this.nodes.length;o++){const i=this.nodes[o];if(i.outputs?.length)for(let a=0;a<i.outputs.length;a++){let r=!1;const l=i.outputs[a];let d=l.type;if(l.links?.length){for(const c of l.links){const f=p.rootGraph.links[c];if(f&&(d==="*"&&(d=f.type),!p.canvas.selected_nodes[f.target_id])){r=!0;break}}r&&s.external.push([o,a,d])}}}},"storeExternalLinks");{const s=Dt(this.nodes,p.canvas?.graph),o=JSON.parse(s);return e(o),t(o),o}}}class Y{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=L){this.nodeDef={output:[],output_name:[],output_is_list:[],output_is_hidden:[],name:e+P+this.name,display_name:this.name,category:"group nodes"+(P+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(o=>o.type).join(", ")}`,python_module:"custom_nodes."+this.name,[W]:this},this.inputs=[];const t={},s={};for(let o=0;o<this.nodeData.nodes.length;o++){const i=this.nodeData.nodes[o];i.index=o,this.processNode(i,t,s)}for(const o of this.#e)o();this.#e=null,await p.registerNodeDef(`${L}${P}`+this.name,this.nodeDef),Ct().addNodeDef(this.nodeDef)}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[t,s,o,i]=e;t!=null&&(this.linksFrom[t]||(this.linksFrom[t]={}),this.linksFrom[t][s]||(this.linksFrom[t][s]=[]),this.linksFrom[t][s].push(e),this.linksTo[o]||(this.linksTo[o]={}),this.linksTo[o][i]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,t,s){const o=this.getNodeDef(e);if(!o)return;const i={...o.input?.required,...o.input?.optional};this.inputs.push(this.processNodeInputs(e,t,i)),o.output?.length&&this.processNodeOutputs(e,s,o)}getNodeDef(e){const t=ne[e.type];if(t)return t;const s=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!s)return;let o=s[0][0][5];if(o==="COMBO"){const a=e.outputs[0].widget.name,r=this.nodeData.nodes[s[0][0][2]].type,l=ne[r];o=(l.input.required[a]??l.input.optional[a])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[o,{}]}},output:[o],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const o=this.linksTo[e.index];if(o&&s&&!this.externalFrom[e.index]?.[0])return null;let i={},a="*";if(s)for(const[,,r,l]of s[0]){const d=this.nodeData.nodes[r],c=d.inputs[l];if(a==="*"&&(a=c.type),c.widget){const f=ne[d.type],v=f.input.required[c.widget.name]??f.input.optional[c.widget.name],g=[v[0],i];i=re({widget:g},v,!1,null,g)?.customConfig??i}}else if(o){const[r,l]=o[0];a=this.nodeData.nodes[r].outputs[l].type}else{for(const r of this.nodeData.links)if(r[2]===e.index){a=r[5];break}if(a==="*"){const r=this.externalFrom[e.index]?.[0];r&&(a=r)}}return i.forceInput=!0,{input:{required:{[a]:[a,i]}},output:[a],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,t,s,o,i){const a=this.nodeData.config?.[e.index]?.input?.[t];let r=a?.name??e.inputs?.find(c=>c.name===t)?.label??t,l=r,d="";return(e.type==="PrimitiveNode"&&e.title||r in s)&&(d=`${e.title??e.type} `,l=r=`${d}${t}`,r in s&&(r=`${d}${s[r]} ${t}`)),s[l]=(s[l]??1)+1,(t==="seed"||t==="noise_seed")&&(i||(i={}),i.control_after_generate=`${d}control_after_generate`),o[0]==="IMAGEUPLOAD"&&(i||(i={}),i.widget=this.oldToNewWidgetMap[e.index]?.[o[1]?.widget??"image"]??"image"),i&&(o=[o[0],{...o[1],...i}]),{name:r,config:o,customConfig:a}}processWidgetInputs(e,t,s,o){const i=[],a=new Map,r=this.oldToNewWidgetMap[t.index]={};for(const l of s)if(kt().inputIsWidget(e[l])){const d=t.inputs?.findIndex(c=>c.name===l&&c.widget?.name===l);if(d>-1)a.set(d,l),r[l]=null;else{const{name:c,config:f}=this.getInputConfig(t,l,o,e[l]);this.nodeDef.input.required[c]=f,r[l]=c,this.newToOldWidgetMap[c]={node:t,inputName:l}}}else i.push(l);return{converted:a,slots:i}}checkPrimitiveConnection(e,t,s){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[i,a,r,l]=e,d=this.primitiveDefs[i],c=s[t],f=d.input.required.value,g=re({widget:f},c,!1,null,f);f[1]=g?.customConfig??s[t][1]?{...s[t][1]}:{};let h=this.oldToNewWidgetMap[i].value;h=h.substr(0,h.length-6),f[1].control_after_generate=!0,f[1].control_prefix=h;let m=this.widgetToPrimitive[r];m||(m=this.widgetToPrimitive[r]={}),m[t]&&m[t].push(i),m[t]=i;let y=this.primitiveToWidget[i];y||(y=this.primitiveToWidget[i]=[]),y.push({nodeId:r,inputName:t})}}processInputSlots(e,t,s,o,i,a){this.nodeInputs[t.index]={};for(let r=0;r<s.length;r++){const l=s[r];if(o[r]){this.checkPrimitiveConnection(o[r],l,e);continue}const{name:d,config:c,customConfig:f}=this.getInputConfig(t,l,a,e[l]);this.nodeInputs[t.index][l]=d,f?.visible!==!1&&(this.nodeDef.input.required[d]=c,i[r]=this.inputCount++)}}processConvertedWidgets(e,t,s,o,i,a,r){const l=[...o.keys()].sort().map(d=>o.get(d));for(let d=0;d<l.length;d++){const c=l[d];if(i[s.length+d]){this.checkPrimitiveConnection(i[s.length+d],c,e);continue}const{name:f,config:v}=this.getInputConfig(t,c,r,e[c],{defaultInput:!0});this.nodeDef.input.required[f]=v,this.newToOldWidgetMap[f]={node:t,inputName:c},this.oldToNewWidgetMap[t.index]||(this.oldToNewWidgetMap[t.index]={}),this.oldToNewWidgetMap[t.index][c]=f,a[s.length+d]=this.inputCount++}}#e=[];processNodeInputs(e,t,s){const o=[],i=Object.keys(s);if(!i.length)return;const{converted:a,slots:r}=this.processWidgetInputs(s,e,i,t),l=this.linksTo[e.index]??{},d=this.oldToNewInputMap[e.index]={};return this.processInputSlots(s,e,r,l,d,t),this.#e.push(()=>this.processConvertedWidgets(s,e,r,a,l,d,t)),o}processNodeOutputs(e,t,s){const o=this.oldToNewOutputMap[e.index]={};for(let i=0;i<s.output.length;i++){const r=this.linksFrom[e.index]?.[i]&&!this.externalFrom[e.index]?.[i],l=this.nodeData.config?.[e.index]?.output?.[i],d=l?.visible??!r;if(this.outputVisibility.push(d),!d)continue;o[i]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:i},this.nodeDef.output.push(s.output[i]),this.nodeDef.output_is_list.push(s.output_is_list[i]);let c=l?.name;if(!c){c=s.output_name?.[i]??s.output[i];const v=e.outputs.find(g=>g.name===c);v?.label&&(c=v.label)}let f=c;if(f in t){const v=`${e.title??e.type} `;f=`${v}${c}`,f in t&&(f=`${v}${e.index} ${c}`)}t[f]=1,this.nodeDef.output_name.push(f)}}static async registerFromWorkflow(e,t){for(const s in e){const o=e[s];let i=!1;for(const r of o.nodes)r.type in C.registered_node_types||(t.push({type:r.type,hint:` (In group node '${L}${P}${s}')`}),t.push({type:`${L}${P}`+s,action:{text:"Remove from workflow",callback:u(l=>{delete e[s],l.target.textContent="Removed",l.target.style.pointerEvents="none",l.target.style.opacity=.7},"callback")}}),i=!0);if(i)continue;await new Y(s,o).registerType()}}}class U{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[W],this.node.setInnerNodes=g=>{this.innerNodes=g;for(let h=0;h<this.innerNodes.length;h++){const m=this.innerNodes[h];m.graph??=this.node.graph;for(const y of m.widgets??[])y.type==="converted-widget"&&(y.serializeValue=y.origSerializeValue);m.index=h,m.getInputNode=y=>{const w=this.groupData.oldToNewInputMap[m.index]?.[y];if(w!=null)return this.node.getInputNode(w);const N=this.groupData.linksTo[m.index]?.[y];if(!N)return null;const I=g[N[0]];return I.type==="PrimitiveNode"?null:I},m.getInputLink=y=>{const w=this.groupData.oldToNewInputMap[m.index]?.[y];if(w!=null){const I=this.node.inputs[w].link;let k=p.rootGraph.links[I];return k={...k,target_id:m.id,target_slot:+y},k}let N=this.groupData.linksTo[m.index]?.[y];return N?(N={origin_id:g[N[0]].id,origin_slot:N[1],target_id:m.id,target_slot:+y},N):null}}},this.node.updateLink=g=>{g={...g};const h=this.groupData.newToOldOutputMap[g.origin_slot];let m=this.innerNodes[h.node.index],y;for(;m?.type==="Reroute";)y=m.getInputLink(0),m=m.getInputNode(0);return m?y&&U.isGroupNode(m)?m.updateLink(y):(g.origin_id=m.id,g.origin_slot=y?.origin_slot??h.slot,g):null},this.node.getInnerNodes=(g,h=[],m=[],y=new Set)=>{if(y.has(this.node))throw new Error("RecursionError: while flattening subgraph");y.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((I,k)=>{const x=C.createNode(I.type);return x.configure(I),x.id=`${this.node.id}:${k}`,x.graph=this.node.graph,x})),this.updateInnerWidgets();const w=[...h,this.node.id],N=this.node.graph?.getNodeById(h.at(-1))??void 0;for(const I of this.innerNodes){I.graph??=this.node.graph;const k=String(I.id);I.id=k.split(":").at(-1);const x=new jt(I,w,g,N);I.id=k,x.groupNodeHandler=this,m.push(x)}return m},this.node.recreate=async()=>{const g=this.node.id,h=this.node.size,m=this.node.convertToNodes(),y=C.createNode(this.node.type);y.id=g,y.setInnerNodes(m),y[W].populateWidgets(),p.rootGraph.add(y),y.setSize([Math.max(y.size[0],h[0]),Math.max(y.size[1],h[1])]);const N=new Fe(m).getNodeData();return y[W].groupData.nodeData.links=N.links,y[W].replaceNodes(m),y},this.node.convertToNodes=()=>{const g=u(()=>{const y={...this.groupData.nodeData};y.nodes=[...y.nodes];const w=this.node.getInnerNodes();let N=[];for(let A=0;A<y.nodes.length;A++){let X=w?.[A]?.id;X==null||isNaN(X)?X=void 0:N.push(X),y.nodes[A]={...y.nodes[A],id:X}}Qe(JSON.stringify(y),p.canvas);const[I,k]=this.node.pos;let x,_;const O=N.length?N:Object.keys(p.canvas.selected_nodes),j=[];for(let A=0;A<O.length;A++){const X=O[A],z=p.rootGraph.getNodeById(X),Ee=w[A];if(j.push(z),(_==null||z.pos[0]<_)&&(_=z.pos[0]),(x==null||z.pos[1]<x)&&(x=z.pos[1]),!z.widgets)continue;const ge=this.groupData.oldToNewWidgetMap[Ee.index];if(ge){const it=Object.keys(ge);for(const Oe of it){const Ae=ge[Oe];if(!Ae)continue;const fe=this.node.widgets.findIndex(B=>B.name===Ae);if(fe!==-1)if(Ee.type==="PrimitiveNode")for(let B=0;B<z.widgets.length;B++)z.widgets[B].value=this.node.widgets[fe+B].value;else{const B=this.node.widgets[fe],he=z.widgets.find(J=>J.name===Oe);if(!he)continue;he.value=B.value;for(let J=0;J<B.linkedWidgets?.length;J++)he.linkedWidgets[J].value=B.linkedWidgets[J].value}}}}for(const A of j)A.pos[0]-=_-I,A.pos[1]-=x-k;return{newNodes:j,selectedIds:O}},"addInnerNodes"),h=u(y=>{for(const w in this.groupData.oldToNewInputMap){const N=y[w],I=p.rootGraph.getNodeById(N),k=this.groupData.oldToNewInputMap[w];for(const x in k){const _=k[x];if(_==null)continue;const O=e.inputs[_];if(O.link==null)continue;const j=p.rootGraph.links[O.link];if(!j)continue;p.rootGraph.getNodeById(j.origin_id).connect(j.origin_slot,I,+x)}}},"reconnectInputs"),m=u(y=>{for(let w=0;w<e.outputs?.length;w++){const N=e.outputs[w];if(!N.links)continue;const I=[...N.links];for(const k of I){const x=this.groupData.newToOldOutputMap[w],_=p.rootGraph.links[k],O=p.rootGraph.getNodeById(_.target_id);p.rootGraph.getNodeById(y[x.node.index]).connect(x.slot,O,_.target_slot)}}},"reconnectOutputs");p.canvas.emitBeforeChange();try{const{newNodes:y,selectedIds:w}=g();return h(w),m(w),p.rootGraph.remove(this.node),y}finally{p.canvas.emitAfterChange()}};const t=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(g,h){t?.apply(this,arguments);let m=h.findIndex(y=>y?.content==="Outputs");m===-1?m=h.length:m++,h.splice(m,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>Ce(this.type),"callback")})};const s=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(g,h){s?.apply(this,arguments);const m=g.fillStyle;g.beginPath(),g.rect(11,-h+11,2,2),g.rect(14,-h+11,2,2),g.rect(17,-h+11,2,2),g.rect(11,-h+14,2,2),g.rect(14,-h+14,2,2),g.rect(17,-h+14,2,2),g.rect(11,-h+17,2,2),g.rect(14,-h+17,2,2),g.rect(17,-h+17,2,2),g.fillStyle=this.boxcolor||C.NODE_DEFAULT_BOXCOLOR,g.fill(),g.fillStyle=m};const o=e.onDrawForeground,i=this.groupData.nodeData;e.onDrawForeground=function(g){o?.apply?.(this,arguments);const h=It().nodeProgressStates[this.id];if(h&&h.state==="running"&&this.runningInternalNodeId!==null){const m=i.nodes[this.runningInternalNodeId];if(!m)return;const y=`Running ${m.title||m.type} (${this.runningInternalNodeId}/${i.nodes.length})`;g.save(),g.font="12px sans-serif";const w=g.measureText(y);g.fillStyle=e.boxcolor||C.NODE_DEFAULT_BOXCOLOR,g.beginPath(),g.roundRect(0,-C.NODE_TITLE_HEIGHT-20,w.width+12,20,5),g.fill(),g.fillStyle="#fff",g.fillText(y,6,-C.NODE_TITLE_HEIGHT-6),g.restore()}};const a=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,a?.apply(this,arguments)};const r=this,l=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const g=r.groupData.nodeData.config;if(g)for(const h in g){const m=g[h]?.input;for(const y in m){if(m[y].visible!==!1)continue;const w=r.groupData.oldToNewWidgetMap[h][y],N=this.widgets.find(I=>I.name===w);N&&(N.type="hidden",N.computeSize=()=>[0,-4])}}return l?.apply(this,arguments)};function d(g,h,m){const y=u(({detail:w})=>{const N=h(w);if(!N||p.rootGraph.getNodeById(N))return;const k=this.innerNodes?.findIndex(x=>x.id==N);k>-1&&(this.node.runningInternalNodeId=k,E.dispatchCustomEvent(g,m(w,`${this.node.id}`,this.node)))},"handler");return E.addEventListener(g,y),y}u(d,"handleEvent");const c=d.call(this,"executing",g=>g,(g,h)=>h),f=d.call(this,"executed",g=>g?.display_node||g?.node,(g,h,m)=>({...g,node:h,display_node:h,merge:!m.resetExecution})),v=e.onRemoved;this.node.onRemoved=function(){v?.apply(this,arguments),E.removeEventListener("executing",c),E.removeEventListener("executed",f)},this.node.refreshComboInNode=g=>{for(const h in this.groupData.newToOldWidgetMap){const m=this.node.widgets.find(y=>y.name===h);if(m?.type==="combo"){const y=this.groupData.newToOldWidgetMap[h],w=g[y.node.type],N=w?.input?.required?.[y.inputName]??w?.input?.optional?.[y.inputName];if(!N)continue;m.options.values=N[0],y.inputName!=="image"&&!m.options.values.includes(m.value)&&(m.value=m.options.values[0],m.callback(m.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const t=this.node.widgets.find(r=>r.name===e);if(!t)continue;const s=t.value,o=this.groupData.newToOldWidgetMap[e];let i=this.innerNodes[o.node.index];if(i.type==="PrimitiveNode"){i.primitiveValue=s;const r=this.groupData.primitiveToWidget[o.node.index];for(const l of r??[]){const c=this.innerNodes[l.nodeId].widgets.find(f=>f.name===l.inputName);c&&(c.value=s)}continue}else if(i.type==="Reroute"){const r=this.groupData.linksFrom[o.node.index];if(r)for(const[l,,d,c]of r[0]){const f=this.innerNodes[d],v=f.inputs[c];if(v.widget){const g=f.widgets?.find(h=>h.name===v.widget.name);g&&(g.value=s)}}}const a=i.widgets?.find(r=>r.name===o.inputName);a&&(a.value=s)}}populatePrimitive(e,t,s){const o=this.groupData.widgetToPrimitive[t]?.[s];if(o==null)return;const i=this.groupData.oldToNewWidgetMap[o].value,a=this.node.widgets.findIndex(r=>r.name===i);if(a>-1){const r=this.innerNodes[o];let l=r.widgets.length;l-1!==this.node.widgets[a].linkedWidgets?.length&&(l=1);for(let d=0;d<l;d++)this.node.widgets[a+d].value=r.widgets[d].value}return!0}populateReroute(e,t,s){if(e.type!=="Reroute")return;const o=this.groupData.linksFrom[t]?.[0]?.[0];if(!o)return;const[,,i,a]=o,r=this.groupData.nodeData.nodes[i],l=r.inputs;if(!l?.[a]?.widget)return;const c=l.length-(r.widgets_values?.length??0),f=r.widgets_values?.[a-c];if(f==null)return;const v=Object.values(s)[0],g=this.node.widgets.find(h=>h.name===v);g&&(g.value=f)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const t=this.groupData.nodeData.nodes[e],s=this.groupData.oldToNewWidgetMap[e]??{},o=Object.keys(s);if(!t.widgets_values?.length){this.populateReroute(t,e,s);continue}let i=0;for(let a=0;a<o.length;a++){const r=o[a],l=s[r],d=this.node.widgets.findIndex(f=>f.name===l),c=this.node.widgets[d];if(this.populatePrimitive(t,e,r)||d===-1){const f=this.innerNodes[e].widgets?.find(v=>v.name===r);i+=f?.linkedWidgets?.length??0}if(d!==-1){c.value=t.widgets_values[a+i];for(let f=0;f<c.linkedWidgets?.length;f++)this.node.widgets[d+f+1].value=t.widgets_values[a+ ++i]}}}}replaceNodes(e){let t,s;for(let o=0;o<e.length;o++){const i=e[o];(s==null||i.pos[0]<s)&&(s=i.pos[0]),(t==null||i.pos[1]<t)&&(t=i.pos[1]),this.linkOutputs(i,o),p.rootGraph.remove(i),i.id=`${this.node.id}:${o}`}this.linkInputs(),this.node.pos=[s,t]}linkOutputs(e,t){if(e.outputs)for(const s of e.outputs){if(!s.links)continue;const o=[...s.links];for(const i of o){const a=p.rootGraph.links[i];if(!a)continue;const r=p.rootGraph.getNodeById(a.target_id),l=this.groupData.oldToNewOutputMap[t]?.[a.origin_slot];l!=null&&this.node.connect(l,r,a.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,t,s,o,i]=e,a=p.rootGraph.getNodeById(i);a&&a.connect(t,this.node.id,this.groupData.oldToNewInputMap[s][o])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[W]}static isGroupNode(e){return!!e.constructor?.nodeData?.[W]}static async fromNodes(e){const t=new Fe(e),s=await t.build();if(!s)return;const{name:o,nodeData:i}=s;await new Y(o,i).registerType();const r=C.createNode(`${L}${P}${o}`);return r.setInnerNodes(t.nodes),r[W].populateWidgets(),p.rootGraph.add(r),r[W].replaceNodes(t.nodes),r}}const Zt=u(n=>{for(const e of n)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${L}${P}`))},"replaceLegacySeparators");async function ve(){const n=Object.values(p.canvas.selected_nodes??{});if(n.length===0)throw new Error("No nodes selected");if(n.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of n){if(e instanceof xt)throw new Error("Selected nodes contain a subgraph node");if(U.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await U.fromNodes(n)}u(ve,"convertSelectedNodesToGroupNode");const Ue=u(n=>n.length<2||!!n.find(e=>U.isGroupNode(e)),"convertDisabled");function eo(){const n=Object.values(p.canvas.selected_nodes??{});for(const e of n)U.isGroupNode(e)&&e.convertToNodes?.()}u(eo,"ungroupSelectedGroupNodes");function Ce(n){new ot(p).show(n)}u(Ce,"manageGroupNodes");const to="Comfy.GroupNode";let ne;const oo={name:to,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>ve(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>eo(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...n)=>Ce(n[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(n){const e=[],t=Object.values(n.selected_nodes??{}),s=!Ue(t);e.push({content:"Convert to Group Node (Deprecated)",disabled:!s,callback:u(()=>ve(),"callback")});const o=n.graph?.extra?.groupNodes,i=!o||!Object.keys(o).length;return e.push({content:"Manage Group Nodes",disabled:i,callback:u(()=>Ce(),"callback")}),e},getNodeMenuItems(n){if(U.isGroupNode(n))return[];const e=Object.values(p.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!Ue(e),callback:u(()=>ve(),"callback")}]},async beforeConfigureGraph(n,e){const t=n?.extra?.groupNodes;t&&(Zt(n.nodes),await Y.registerFromWorkflow(t,e))},addCustomNodeDefs(n){ne=n},nodeCreated(n){U.isGroupNode(n)&&(n[W]=new U(n),n.title&&n[W]?.groupData?.nodeData&&q.storeGroupNode(n.title,n[W].groupData.nodeData))},async refreshComboInNodes(n){Object.assign(ne,n);const e=p.rootGraph.extra?.groupNodes;e&&await Y.registerFromWorkflow(e,{})}};p.registerExtension(oo);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=Y;window.comfyAPI.groupNode.GroupNodeHandler=U;function G(n,e){n.mode=e,n.graph?.change()}u(G,"setNodeMode");function Be(n,e){const t=Z().get("Comfy.GroupSelectedNodes.Padding");n.resizeTo([...n.children,...e],t)}u(Be,"addNodesToGroup");const no={name:"Comfy.GroupOptions",getCanvasMenuItems(n){const e=[],t=n.graph.getGroupOnPos(n.graph_mouse[0],n.graph_mouse[1]);if(!t)return n.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const i=new _t;Be(i,n.selectedItems),n.graph.add(i),n.graph.change(),i.recomputeInsideNodes()},"callback")}),e;t.recomputeInsideNodes();const s=t.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!n.selectedItems?.size,callback:u(()=>{Be(t,n.selectedItems),n.graph.change()},"callback")}),s.length===0)return e;e.push(null);let o=!0;for(let i=1;i<s.length;i++)if(s[i].mode!==s[0].mode){o=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{t.recomputeInsideNodes();const i=Z().get("Comfy.GroupSelectedNodes.Padding");t.resizeTo(t.children,i),n.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{n.selectNodes(s),n.graph.change(),n.canvas.focus()},"callback")}),o)switch(s[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of s)G(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of s)G(a,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of s)G(a,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of s)G(a,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of s)G(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of s)G(a,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of s)G(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of s)G(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of s)G(a,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const i of s)G(i,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const i of s)G(i,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const i of s)G(i,4)},"callback")});return e}};p.registerExtension(no);ee().registerExtension({name:"Comfy.ImageCompare",async nodeCreated(n){if(n.constructor.comfyClass!=="ImageCompare")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,350)]);const s=n.onExecuted;n.onExecuted=function(o){s?.call(this,o);const i=o.a_images,a=o.b_images,r=p.getRandParam(),l=i&&i.length>0?E.apiURL(`/view?${new URLSearchParams(i[0])}${r}`):"",d=a&&a.length>0?E.apiURL(`/view?${new URLSearchParams(a[0])}${r}`):"",c=n.widgets?.find(f=>f.type==="imagecompare");c&&(c.value={before:l,after:d},c.callback?.(c.value))}}});const io=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function pe(n){return[null,{content:"Save",has_submenu:!0,callback:u((e,t,s,o)=>{const i=io.map(a=>({content:a.label,callback:u(()=>{(async()=>{try{await n.exportModel(a.value),S().add({severity:"success",summary:D("toastMessages.exportSuccess",{format:a.label})})}catch(r){console.error("Export failed:",r),S().addAlert(D("toastMessages.failedToExportModel",{format:a.label}))}})()},"callback")}));new C.ContextMenu(i,{event:s,parentMenu:o})},"callback")}]}u(pe,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=pe;class Me{static{u(this,"Load3DConfiguration")}constructor(e,t){this.load3d=e,this.properties=t}configureForSaveMesh(e,t){this.setupModelHandlingForSaveMesh(t,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,t){e&&t&&(this.load3d.setTargetSize(e.value,t.value),e.callback=s=>{this.load3d.setTargetSize(s,t.value)},t.callback=s=>{this.load3d.setTargetSize(e.value,s)})}setupModelHandlingForSaveMesh(e,t){const s=this.createModelUpdateHandler(t);e&&s(e)}setupModelHandling(e,t,s){const o=this.createModelUpdateHandler(t,s);e.value&&o(e.value);const i=e.callback;let a=e.value;Object.defineProperty(e,"value",{get(){return a},set(r){a=r,e.callback&&r!==void 0&&r!==""&&e.callback(r)},enumerable:!0,configurable:!0}),e.callback=r=>{o(r),i&&i(r)}}setupDefaultProperties(e){const t=this.loadSceneConfig();this.applySceneConfig(t,e);const s=this.loadCameraConfig();this.applyCameraConfig(s);const o=this.loadLightConfig();this.applyLightConfig(o)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:Z().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+Z().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:Z().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:Z().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original"}}applySceneConfig(e,t){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(t&&t!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,t){let s=!0;return async o=>{if(!o)return;const i=o;this.setResourceFolder(i);const a=E.apiURL(V.getResourceURL(...V.splitFilePath(i),e));await this.load3d.loadModel(a,i);const r=this.loadModelConfig();if(this.applyModelConfig(r),s&&t){try{this.load3d.setCameraState(t)}catch(l){console.warn("Failed to restore camera state:",l)}s=!1}}}setResourceFolder(e){const t=e.split("/").filter(i=>i.trim());if(t.length<=2)return;const o=t.slice(1,-1).join("/");o&&this.properties&&(this.properties["Resource Folder"]=o)}}const so={name:"image",type:"Load3D",isPreview:!1},Ve={name:"image",type:"Preview3D",isPreview:!0};async function ao(n,e){if(!n?.length)return;const t=e.widgets?.find(s=>s.name==="model_file");try{const s=e.properties["Resource Folder"]||"",o=s.trim()?`3d/${s.trim()}`:"3d",i=await V.uploadFile(n[0],o);if(!i){S().addAlert(D("toastMessages.fileUploadFailed"));return}const a=E.apiURL(V.getResourceURL(...V.splitFilePath(i),"input"));ae(e).waitForLoad3d(r=>{try{r.loadModel(a)}catch{S().addAlert(D("toastMessages.failedToLoadModel"))}}),i&&t&&(t.options?.values?.includes(i)||t.options?.values?.push(i),t.value=i)}catch(s){console.error("Model upload failed:",s),S().addAlert(D("toastMessages.fileUploadFailed"))}}u(ao,"handleModelUpload");async function ro(n,e){if(n?.length)try{const t=e.properties["Resource Folder"]||"",s=t.trim()?`3d/${t.trim()}`:"3d";await V.uploadMultipleFiles(n,s)}catch(t){console.error("Extra resources upload failed:",t),S().addAlert(D("toastMessages.extraResourcesUploadFailed"))}}u(ro,"handleResourcesUpload");function $e(n,e=!1){const t=document.createElement("input");return t.type="file",t.accept=n,t.multiple=e,t.style.display="none",t}u($e,"createFileInput");ee().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0},{id:"Comfy.Load3D.PLYEngine",category:["3D","PLY","PLY Engine"],name:"PLY Engine",tooltip:'Select the engine for loading PLY files. "threejs" uses the native Three.js PLYLoader (best for mesh PLY files). "fastply" uses an optimized loader for ASCII point cloud PLY files. "sparkjs" uses Spark.js for 3D Gaussian Splatting PLY files.',type:"combo",options:["threejs","fastply","sparkjs"],defaultValue:"threejs",experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const n=p.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];if(!St(e))return;T.copyToClipspace(e),T.clipspace_return_node=e;const t={node:e};Ze().showDialog({key:"global-load3d-viewer",title:D("load3d.viewer.title"),component:Mt,props:t,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await ce().handleViewerClose(t.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(n){const e=$e(".gltf,.glb,.obj,.fbx,.stl,.ply,.spz,.splat,.ksplat",!1);n.properties["Resource Folder"]="",e.onchange=async()=>{await ao(e.files,n)},n.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const t=$e("*",!0);t.onchange=async()=>{await ro(t.files,n),t.value=""},n.addWidget("button","upload extra resources","uploadExtraResources",()=>{t.click()}),n.addWidget("button","clear","clear",()=>{ae(n).waitForLoad3d(i=>{i.clearModel()});const o=n.widgets?.find(i=>i.name==="model_file");o&&(o.value="")});const s=new ke({node:n,name:"image",component:_e,inputSpec:so,options:{}});return s.type="load3D",De(n,s),{widget:s}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Load3D")return[];const e=ce().getLoad3d(n);return e?e.isSplatModel()?[]:pe(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="Load3D")return;const[e,t]=n.size;n.setSize([Math.max(e,300),Math.max(t,600)]),await xe(),ae(n).waitForLoad3d(s=>{const i=n.properties["Camera Config"]?.state,a=new Me(s,n.properties),r=n.widgets?.find(f=>f.name==="model_file"),l=n.widgets?.find(f=>f.name==="width"),d=n.widgets?.find(f=>f.name==="height"),c=n.widgets?.find(f=>f.name==="image");if(r&&l&&d&&c){const f={loadFolder:"input",modelWidget:r,cameraState:i,width:l,height:d};a.configure(f),c.serializeValue=async()=>{const v=Tt.get(n);if(!v)return console.error("No load3d instance found for node"),null;const g=n.properties["Camera Config"]||{cameraType:v.getCurrentCameraType(),fov:v.cameraManager.perspectiveCamera.fov};g.state=v.getCameraState(),n.properties["Camera Config"]=g,v.stopRecording();const{scene:h,mask:m,normal:y}=await v.captureScene(l.value,d.value),[w,N,I]=await Promise.all([V.uploadTempImage(h,"scene"),V.uploadTempImage(m,"scene_mask"),V.uploadTempImage(y,"scene_normal")]);v.handleResize();const k={image:`threed/${w.name} [temp]`,mask:`threed/${N.name} [temp]`,normal:`threed/${I.name} [temp]`,camera_info:n.properties["Camera Config"]?.state||null,recording:""},x=v.getRecordingData();if(x){const[_]=await Promise.all([V.uploadTempImage(x,"recording","mp4")]);k.recording=`threed/${_.name} [temp]`}return k}}})}});ee().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(n,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Preview3D")return[];const e=ce().getLoad3d(n);return e?e.isSplatModel()?[]:pe(e):[]},getCustomWidgets(){return{PREVIEW_3D(n){const e=new ke({node:n,name:Ve.name,component:_e,inputSpec:Ve,options:{}});return e.type="load3D",De(n,e),{widget:e}}}},async nodeCreated(n){if(n.constructor.comfyClass!=="Preview3D")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await xe();const s=n.onExecuted;ae(n).waitForLoad3d(o=>{const i=new Me(o,n.properties),a=n.widgets?.find(r=>r.name==="model_file");if(a){const r=n.properties["Last Time Model File"];if(r){a.value=r;const d=n.properties["Camera Config"]?.state,c={loadFolder:"output",modelWidget:a,cameraState:d};i.configure(c)}n.onExecuted=function(l){s?.apply(this,arguments);let d=l.result[0];if(!d){const g=D("toastMessages.unableToGetModelFilePath");console.error(g),S().addAlert(g)}let c=l.result[1],f=l.result[2];a.value=d.replaceAll("\\","/"),n.properties["Last Time Model File"]=a.value;const v={loadFolder:"output",modelWidget:a,cameraState:c,bgImagePath:f};i.configure(v),f&&o.setBackgroundImage(f)}}})}});function nt(n){if(!n){console.error("[MaskEditor] No node provided");return}if(!n.imgs?.length&&n.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}Ot().openMaskEditor(n)}u(nt,"openMaskEditor");function lo(){const n=T.clipspace_return_node;if(!n){console.error("[MaskEditor] No clipspace_return_node found");return}nt(n)}u(lo,"openMaskEditorFromClipspace");function co(){return Ze().isDialogOpen("global-mask-editor")}u(co,"isOpened");p.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const n=p.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];nt(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>ze(n=>H.clamp(n+4,1,100)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>ze(n=>H.clamp(n-4,1,100)),"function")}],init(){T.open_maskeditor=lo,console.warn("[MaskEditor] ComfyApp.open_maskeditor is deprecated. Plugins should migrate to using the command system or direct node context menu integration.")}});const ze=u(async n=>{if(!co())return;const e=Et(),t=e.brushSettings.size,s=n(t);e.setBrushSize(s)},"changeBrushSize"),uo="Comfy.NodeTemplates",je="comfy.templates.json";class po extends Xe{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=b("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(b("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(b("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const t=await E.getUserData(je);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+" "+t.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await E.storeUserData(je,e,{stringify:!1})}catch(t){console.error(t),S().addAlert(t.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const t=new FileReader;t.onload=async()=>{const s=JSON.parse(t.result);if(s?.templates){for(const o of s.templates)o?.name&&o?.data&&this.templates.push(o);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){S().addAlert(D("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),t=new Blob([e],{type:"application/json"});Le("node_templates.json",t)}show(){super.show(b("div",{},this.templates.flatMap((e,t)=>{let s;return[b("div",{dataset:{id:t.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(o=>{this.draggedEl=o.currentTarget,o.currentTarget.style.opacity="0.6",o.currentTarget.style.border="1px dashed yellow",o.dataTransfer.effectAllowed="move",o.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(o=>{o.target.style.opacity="1",o.currentTarget.style.border="1px dashed transparent",o.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((i,a)=>{var r=Number.parseInt(i.dataset.id);i==this.draggedEl&&r!=a&&this.templates.splice(a,0,this.templates.splice(r,1)[0]),i.dataset.id=a.toString()}),this.store()},"ondragend"),ondragover:u(o=>{if(o.preventDefault(),o.currentTarget==this.draggedEl)return;let i=o.currentTarget.getBoundingClientRect();o.clientY>i.top+i.height/2?o.currentTarget.parentNode.insertBefore(this.draggedEl,o.currentTarget.nextSibling):o.currentTarget.parentNode.insertBefore(this.draggedEl,o.currentTarget)},"ondragover")},[b("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(o=>{o.target.localName=="label"&&(o.currentTarget.parentNode.draggable="true")},"onmousedown")},[b("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(o=>{clearTimeout(this.saveVisualCue);var i=o.target,a=i.parentNode.parentNode;this.templates[a.dataset.id].name=i.value.trim()||"untitled",this.store(),i.style.backgroundColor="rgb(40, 95, 40)",i.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){i.style.transitionDuration=".7s",i.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(o=>{var i=o.target;clearTimeout(this.saveVisualCue),i.style.transitionDuration="0s",i.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(o=>s=o,"$")})]),b("div",{},[b("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const o=JSON.stringify({templates:[e]},null,2),i=new Blob([o],{type:"application/json"}),a=(s.value||e.name)+".json";Le(a,i)},"onclick")}),b("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(o=>{const i=o.target.parentNode.parentNode;i.parentNode.removeChild(i),this.templates.splice(i.dataset.id*1,1),this.store();var a=this;setTimeout(function(){a.element.querySelectorAll(".templateManagerRow").forEach((r,l)=>{r.dataset.id=l.toString()})},0)},"onclick")})])])]})))}}const le=new po,He=u(async n=>{const e=localStorage.getItem("litegrapheditor_clipboard");await n(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),go={name:uo,getCanvasMenuItems(n){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(p.canvas.selected_nodes||{}).length,callback:u(async()=>{const s=await te().prompt({title:D("nodeTemplates.saveAsTemplate"),message:D("nodeTemplates.enterName"),defaultValue:""});s?.trim()&&He(()=>{p.canvas.copyToClipboard();let o=localStorage.getItem("litegrapheditor_clipboard");o=JSON.parse(o||"{}");const i=Object.keys(p.canvas.selected_nodes);for(let a=0;a<i.length;a++){const r=p.canvas.graph?.getNodeById(i[a]),l=r?.constructor.nodeData;let d=U.getGroupData(r);if(d){if(d=d.nodeData,o.groupNodes||(o.groupNodes={}),l==null)throw new TypeError("nodeData is not set");o.groupNodes[l.name]=d,o.nodes[a].type=l.name}}le.templates.push({name:s,data:JSON.stringify(o)}),le.store()})},"callback")});const t=le.templates.map(s=>({content:s.name,callback:u(()=>{He(async()=>{const o=JSON.parse(s.data);await Y.registerFromWorkflow(o.groupNodes,{}),o.reroutes?(localStorage.setItem("litegrapheditor_clipboard",s.data),p.canvas.pasteFromClipboard()):Qe(s.data,p.canvas)})},"callback")}));return t.push(null,{content:"Manage",callback:u(()=>le.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:t}}),e}};p.registerExtension(go);p.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class n extends de{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;groupcolor=R.node_colors.yellow.groupcolor;isVirtualNode;constructor(s){super(s),this.color=R.node_colors.yellow.color,this.bgcolor=R.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],p),this.serialize_widgets=!0,this.isVirtualNode=!0}}C.registerNodeType("Note",Object.assign(n,{title_mode:C.NORMAL_TITLE,title:"Note",collapsable:!0})),n.category="utils";class e extends de{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";groupcolor=R.node_colors.yellow.groupcolor;constructor(s){super(s),this.color=R.node_colors.yellow.color,this.bgcolor=R.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],p),this.serialize_widgets=!0,this.isVirtualNode=!0}}C.registerNodeType("MarkdownNote",e),e.category="utils"}});ee().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(n,e){if(e.name==="PreviewAny"){const t=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){t&&t.apply(this,[]);const o=$.MARKDOWN(this,"preview",["MARKDOWN",{}],p).widget,i=$.STRING(this,"preview",["STRING",{multiline:!0}],p).widget,a=$.BOOLEAN(this,"previewMode",["BOOLEAN",{label_on:"Markdown",label_off:"Plaintext",default:!1}],p);a.widget.callback=r=>{o.hidden=!r,o.options.hidden=!r,i.hidden=r,i.options.hidden=r},o.hidden=!0,o.options.hidden=!0,o.options.read_only=!0,o.element.readOnly=!0,o.element.disabled=!0,o.serialize=!1,i.hidden=!1,i.options.hidden=!1,i.options.read_only=!0,i.element.readOnly=!0,i.element.disabled=!0,i.serialize=!1};const s=n.prototype.onExecuted;n.prototype.onExecuted=function(o){s?.apply(this,[o]);const i=this.widgets?.filter(a=>a.name==="preview")??[];for(const a of i){const r=o.text??"";a.value=Array.isArray(r)?r[0]??"":r}}}}});p.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(n){class e extends de{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(s){super(s??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(C.INPUT,void 0,!0)})}clone(){const s=super.clone();return s&&(s.removeOutput(0),s.addOutput(this.properties.showOutputText?"*":"","*"),s.setSize(s.computeSize()),s)}onConnectionsChange(s,o,i){const{graph:a}=this;if(!a||n.configuringGraph)return;if(i&&s===C.OUTPUT&&new Set(this.outputs[0].links?.map(N=>a.links[N]?.type)?.filter(N=>N&&N!=="*")??[]).size>1){const N=[];for(const I of this.outputs[0].links??[]){const k=a.links[I];N.push(k)}N.pop();for(const I of N)a.getNodeById(I.target_id)?.disconnectInput(I.target_slot)}let r=this,l=[],d=null,c=null;for(;r;){l.unshift(r);const w=r.inputs[0].link;if(w!==null){const N=a.links[w];if(!N)return;const I=a.getNodeById(N.origin_id);if(!I)return;if(I instanceof e)I===this?(r.disconnectInput(N.target_slot),r=null):r=I;else{c=r,d=I.outputs[N.origin_slot]?.type??null;break}}else{r=null;break}}const f=[this];let v=null;for(;f.length;){r=f.pop();const w=r.outputs?.[0]?.links??[];for(const N of w){const I=a.links[N];if(!I)continue;const k=a.getNodeById(I.target_id);if(k)if(k instanceof e)f.push(k),l.push(k);else{const x=k.inputs[I.target_slot],_=x.type,O=!d||!_||C.isValidConnection(d,_);if(!O){k.disconnectInput(I.target_slot);continue}k.onConnectionsChange?.(C.INPUT,I.target_slot,O,I,x),v=k.inputs[I.target_slot].type}}}const g=d||v||"*",h=R.link_type_colors[g];let m,y;for(const w of l){w.outputs[0].type=d||"*",w.__outputType=g,w.outputs[0].name=w.properties.showOutputText?`${g}`:"",w.setSize(w.computeSize());for(const N of w.outputs[0].links||[]){const I=a.links[N];if(!I||(I.color=h,n.configuringGraph))continue;const k=a.getNodeById(I.target_id);if(!k)continue;const x=k.inputs?.[I.target_slot];if(x?.widget){const _=Se(x);m||(m=_[1]??{},y=_[0]);const O=re(x,[_[0],m]);O.customConfig&&(m=O.customConfig)}}}for(const w of l)m&&v?(w.inputs[0].widget={name:"value"},Ie(w.inputs[0],[y??`${g}`,m])):Ie(w.inputs[0],void 0);if(c?.inputs?.[0]?.link){const w=a.links[c.inputs[0].link];w&&(w.color=h)}}getExtraMenuOptions(s,o){return o.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),n.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,C.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(s){e.defaultVisibility=s,s?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),C.registerNodeType("Reroute",Object.assign(e,{title_mode:C.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const fo=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);p.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(n,e,t){if(fo.has(e.name)){const s=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const o=s?s.apply(this,arguments):void 0,i=this.widgets.find(a=>a.name==="filename_prefix");return i.serializeValue=()=>Je(t.graph,i.value),o}}else{const s=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const o=s?s.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),o}}}});const qe={name:"image",type:"Preview3D",isPreview:!0};ee().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(n,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(n){const e=new ke({node:n,name:qe.name,component:_e,inputSpec:qe,options:{}});return e.type="load3D",De(n,e),{widget:e}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="SaveGLB")return[];const e=ce().getLoad3d(n);return e?e.isSplatModel()?[]:pe(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="SaveGLB")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await xe();const s=n.onExecuted;n.onExecuted=function(o){s?.apply(this,arguments);const i=o["3d"][0];ae(n).waitForLoad3d(a=>{const r=n.widgets?.find(l=>l.name==="image");if(a&&r){const l=i.subfolder+"/"+i.filename;r.value=l,new Me(a,n.properties).configureForSaveMesh(i.type,l)}})}}});function ho(n,e){const t=e.selectedItems;if(t.size<=1)return;const s=At(t,10);if(!s)return;const[o,i,a,r]=s;n.save();const l=2/e.ds.scale;n.lineWidth=l,n.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const d=5/e.ds.scale;n.setLineDash([d,d]),n.beginPath(),n.roundRect(o,i,a,r,8/e.ds.scale),n.stroke(),n.restore()}u(ho,"drawSelectionBorder");const mo={name:"Comfy.SelectionBorder",async init(){const n=p.canvas.onDrawForeground;p.canvas.onDrawForeground=function(e,t){n?.call(this,e,t),ho(e,p.canvas)}}};p.registerExtension(mo);let ie=!1,se=0;p.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let n=null,e=null,t=null,s=null;function o(r){return Math.hypot(r.touches[0].clientX-r.touches[1].clientX,r.touches[0].clientY-r.touches[1].clientY)}u(o,"getMultiTouchPos");function i(r){return{clientX:(r.touches[0].clientX+r.touches[1].clientX)/2,clientY:(r.touches[0].clientY+r.touches[1].clientY)/2}}u(i,"getMultiTouchCenter"),p.canvasEl.parentElement?.addEventListener("touchstart",r=>{se+=r.changedTouches.length,t=null,s=null,r.touches?.length===1?(e=new Date,t=r.touches[0]):(e=null,r.touches?.length===2&&(s=p.canvas.ds.scale,t=i(r),n=o(r),p.canvas.pointer.isDown=!1))},!0),p.canvasEl.parentElement?.addEventListener("touchend",r=>{if(se-=r.changedTouches.length,r.touches?.length!==1&&(ie=!1),e&&!r.touches?.length){if(new Date().getTime()-e.getTime()>600&&r.target===p.canvasEl){const l={button:2,clientX:r.changedTouches[0].clientX,clientY:r.changedTouches[0].clientY,pointerId:1,isPrimary:!0};p.canvasEl.dispatchEvent(new PointerEvent("pointerdown",l)),setTimeout(()=>{p.canvasEl.dispatchEvent(new PointerEvent("pointerup",l))}),r.preventDefault()}e=null}});const a=u(()=>{se=0,ie=!1,e=null,t=null,s=null,n=null},"resetTouchState");document.addEventListener("visibilitychange",()=>{document.hidden&&a()}),p.canvasEl.parentElement?.addEventListener("touchcancel",a),p.canvasEl.parentElement?.addEventListener("touchmove",r=>{if(e&&t&&r.touches?.length===1){const c=r.touches[0],f=c.clientX-t.clientX,v=c.clientY-t.clientY;f*f+v*v>30&&(e=null)}if(r.touches?.length===2&&t&&!r.ctrlKey&&!r.shiftKey){r.preventDefault(),p.canvas.pointer.isDown=!1,ie=!0,C.closeAllContextMenus(window),p.canvas.search_box?.close();const c=o(r),f=i(r);if(s===null||n===null)return;let v=s*c/n;const g=(f.clientX-t.clientX)/v,h=(f.clientY-t.clientY)/v;v<p.canvas.ds.min_scale?v=p.canvas.ds.min_scale:v>p.canvas.ds.max_scale&&(v=p.canvas.ds.max_scale);const m=p.canvas.ds.scale;p.canvas.ds.scale=v,Math.abs(p.canvas.ds.scale-1)<.01&&(p.canvas.ds.scale=1);const y=p.canvas.ds.scale,w=u(N=>[f.clientX/N-p.canvas.ds.offset[0],f.clientY/N-p.canvas.ds.offset[1]],"convertScaleToOffset");var l=w(m),d=w(y);p.canvas.ds.offset[0]+=g+d[0]-l[0],p.canvas.ds.offset[1]+=h+d[1]-l[1],t.clientX=f.clientX,t.clientY=f.clientY,p.canvas.setDirty(!0,!0)}},!0)}});const yo=R.prototype.processMouseDown;R.prototype.processMouseDown=function(n){if(!(ie||se))return p.canvas.pointer.isDown=!1,yo.apply(this,[n])};const wo=R.prototype.processMouseMove;R.prototype.processMouseMove=function(n){if(!(ie||se>1))return wo.apply(this,[n])};p.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){C.search_filter_enabled=!0,C.middle_click_slot_add_default_node=!0,this.suggestionsNumber=p.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(n=>{this.setDefaults(n)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(n,e){var t=e.name;const s=e.input?.required;for(const d in s){var o=s[d];if(typeof o[0]!="string")continue;var i=o[0];if(i in $){var a=o[1];if(!a?.forceInput)continue}if(i in this.slot_types_default_out||(this.slot_types_default_out[i]=["Reroute"]),this.slot_types_default_out[i].includes(t))continue;this.slot_types_default_out[i].push(t);const c=i.toLocaleLowerCase();c in C.registered_slot_in_types||(C.registered_slot_in_types[c]={nodes:[]}),C.registered_slot_in_types[c].nodes.push(n.comfyClass)}var r=e.output??[];for(const d of r){const c=d;c in this.slot_types_default_in||(this.slot_types_default_in[c]=["Reroute"]),!this.slot_types_default_in[c].includes(t)&&(this.slot_types_default_in[c].push(t),c in C.registered_slot_out_types||(C.registered_slot_out_types[c]={nodes:[]}),C.registered_slot_out_types[c].nodes.push(n.comfyClass),C.slot_types_out.includes(c)||C.slot_types_out.push(c))}var l=this.suggestionsNumber.value;this.setDefaults(l)},setDefaults(n){C.slot_types_default_out={},C.slot_types_default_in={};for(const e in this.slot_types_default_out)C.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,n);for(const e in this.slot_types_default_in)C.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,n)}});async function vo(n,e,t,s,o=!1){try{const i=new FormData;i.append("image",t),o&&i.append("subfolder","pasted");const a=await E.fetchApi("/upload/image",{method:"POST",body:i});if(a.status===200){const r=await a.json();let l=r.name;r.subfolder&&(l=r.subfolder+"/"+l),n.options.values.includes(l)||n.options.values.push(l),s&&(e.element.src=E.apiURL(ue(...et(l))),n.value=l,n.callback?.(l))}else S().addAlert(a.status+" - "+a.statusText)}catch(i){S().addAlert(i)}}u(vo,"uploadFile");p.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(n,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(n.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const s=n.addDOMWidget(e,"audioUI",t);s.serialize=!1;const{nodeData:o}=n.constructor;if(o==null)throw new TypeError("nodeData is null");if(o.output_node){s.element.classList.add("empty-audio-widget");const a=n.onExecuted;n.onExecuted=function(r){a?.apply(this,arguments);const l=r.audio;if(!l)return;const d=l[0];s.element.src=E.apiURL(ue(d.subfolder,d.filename,d.type)),s.element.classList.remove("empty-audio-widget")}}return s.onRemove=K(s.onRemove,()=>{s.element&&(s.element.pause(),s.element.src="",s.element.remove())}),{widget:s}}}},onNodeOutputsUpdated(n){for(const[e,t]of Object.entries(n))if("audio"in t){const s=Pt(p.rootGraph,e);if(!s)continue;const o=s.widgets.find(a=>a.name==="audioUI"),i=t.audio[0];o.element.src=E.apiURL(ue(i.subfolder,i.filename,i.type)),o.element.classList.remove("empty-audio-widget")}}});p.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(n,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(n,e){const t=n.widgets.find(c=>c.name==="audio"),s=n.widgets.find(c=>c.name==="audioUI");s.options.canvasOnly=!0;const o=u(()=>{typeof t.value=="string"&&(s.element.src=E.apiURL(ue(...et(t.value))))},"onAudioWidgetUpdate");t.value&&o(),t.callback=o;const i=n.onGraphConfigured;n.onGraphConfigured=function(){i?.apply(this,arguments),t.value&&o()};const a=u(async c=>(c?.length&&vo(t,s,c[0],!0),c),"handleUpload"),r=u(c=>c.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:l}=Lt(n,{accept:"audio/*",onSelect:a}),d=n.addWidget("button",e,"",l,{serialize:!1,canvasOnly:!0});return d.label=D("g.choose_file_to_upload"),Gt(n,{fileFilter:r,onDrop:a}),Wt(n,{fileFilter:r,onPaste:a}),n.previewMediaType="audio",{widget:d}}}}});p.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const s=n.addDOMWidget(e,"audioUI",t);s.options.canvasOnly=!1;let o=null,i=!1,a=[],r=null,l=null,d=null,c=null;s.serializeValue=async()=>{i&&o&&(d=new Promise(h=>{c=h}),o.stop(),await d);const v=s.element.src;if(!v)return S().addAlert(D("g.noAudioRecorded")),"";const g=await fetch(v).then(h=>h.blob());return await Q().convertBlobToFileAndSubmit(g)},l=n.addWidget("button",e,"",async()=>{if(i)o&&i&&o.stop();else try{r=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new Ut(r,{mimeType:"audio/wav"}),a=[],o.ondataavailable=v=>{a.push(v.data)},o.onstop=async()=>{const v=new Blob(a,{type:"audio/wav"});Q().stopAllTracks(r),s.element.src&&s.element.src.startsWith("blob:")&&URL.revokeObjectURL(s.element.src),s.element.src=URL.createObjectURL(v),i=!1,l&&(l.label=D("g.startRecording")),c&&(c(),c=null,d=null)},o.onerror=v=>{console.error("MediaRecorder error:",v),Q().stopAllTracks(r),i=!1,l&&(l.label=D("g.startRecording")),c&&(c(),c=null,d=null)},o.start(),i=!0,l&&(l.label=D("g.stopRecording"))}catch(v){if(console.error("Error accessing microphone:",v),S().addAlert(D("g.micPermissionDenied")),o)try{o.stop()}catch{}Q().stopAllTracks(r),r=null,i=!1,l&&(l.label=D("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),l.label=D("g.startRecording"),l.type="audiorecord";const f=n.onRemoved;return n.onRemoved=function(){i&&o&&o.stop(),Q().stopAllTracks(r),s.element.src?.startsWith("blob:")&&URL.revokeObjectURL(s.element.src),f?.call(this)},{widget:l}}}},async nodeCreated(n){n.constructor.comfyClass==="RecordAudio"&&await Q().registerWavEncoder()}});const bo=u(n=>{const[e,t]=n;return t?(t.image_upload===!0||t.video_upload===!0||t.animated_image_upload===!0)&&(Rt(n)||e==="COMBO"):!1},"isMediaUploadComboInput"),No=u((n,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:n}],"createUploadInput");p.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(n,e){const{input:t}=e??{},{required:s}=t??{};if(!s)return;const o=Object.entries(s).find(([i,a])=>bo(a));if(o){const[i,a]=o;s.upload=No(i,a)}}});const Ye=Symbol();p.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(n,e){let t;n[Ye]=new Promise(a=>t=a);const s=document.createElement("div");s.style.background="rgba(0,0,0,0.25)",s.style.textAlign="center";const o=document.createElement("video");return o.style.height=o.style.width="100%",u(async()=>{try{const a=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});s.replaceChildren(o),setTimeout(()=>t(o),500),o.addEventListener("loadedmetadata",()=>t(o),!1),o.srcObject=a,o.play()}catch(a){const r=document.createElement("div");r.style.color="red",r.style.overflow="auto",r.style.maxHeight="100%",r.style.whiteSpace="pre-wrap",window.isSecureContext?r.textContent=`Unable to load webcam, please ensure access is granted:
`+a.message:r.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+a.message,s.replaceChildren(r)}},"loadVideo")(),{widget:n.addDOMWidget(e,"WEBCAM",s)}}}},nodeCreated(n){if(n.type,n.constructor.comfyClass!=="WebcamCapture")return;let e;const t=n.widgets.find(d=>d.name==="image"),s=n.widgets.find(d=>d.name==="width"),o=n.widgets.find(d=>d.name==="height"),i=n.widgets.find(d=>d.name==="capture_on_queue"),a=document.createElement("canvas"),r=u(()=>{a.width=s.value,a.height=o.value,a.getContext("2d").drawImage(e,0,0,s.value,o.value);const c=a.toDataURL("image/png"),f=new Image;f.onload=()=>{n.imgs=[f],p.canvas.setDirty(!0)},f.src=c},"capture"),l=n.addWidget("button","waiting for camera...","capture",r,{canvasOnly:!0});l.disabled=!0,l.serializeValue=()=>{},t.serializeValue=async()=>{if(i.value)r();else if(!n.imgs?.length){const h="No webcam image captured";throw S().addAlert(h),new Error(h)}const d=await new Promise(h=>a.toBlob(h)),c=`${+new Date}.png`,f=new File([d],c),v=new FormData;v.append("image",f),v.append("subfolder","webcam"),v.append("type","temp");const g=await E.fetchApi("/upload/image",{method:"POST",body:v});if(g.status!==200){const h=`Error uploading camera image: ${g.status} - ${g.statusText}`;throw S().addAlert(h),new Error(h)}return`webcam/${c} [temp]`},n[Ye].then(d=>{e=d,s.value||(s.value=e.videoWidth||640,o.value=e.videoHeight||480),l.disabled=!1,l.label=D("g.capture")})}});
//# sourceMappingURL=index-B2FA5n0E.js.map
