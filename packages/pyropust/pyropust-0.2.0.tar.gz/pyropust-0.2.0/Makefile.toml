[config]
default_to_workspace = false

[env]
CARGO_TERM_COLOR = "always"

# =============================================================================
# Code Generation
# =============================================================================

[tasks.gen]
description = "Generate Op class from kind.rs metadata"
command = "python3"
args = ["tools/gen_ops.py"]

[tasks.gen-native-stub]
description = "Generate pyropust_native.pyi from __init__.pyi"
command = "python3"
args = ["tools/gen_native_stub.py"]

[tasks.gen-all]
description = "Generate all code (Op class + native stub)"
dependencies = ["gen", "gen-native-stub"]

[tasks.check-gen]
description = "Check if generated code is up-to-date"
script = """
python3 tools/gen_ops.py
python3 tools/gen_native_stub.py
cargo fmt
uv run ruff format pyropust/__init__.pyi pyropust/pyropust_native.pyi --quiet
if ! git diff --exit-code src/py/op_generated.rs src/py/mod.rs src/lib.rs pyropust/__init__.pyi pyropust/pyropust_native.pyi; then
    echo "❌ Generated code is out of date. Run 'makers gen-all && makers fmt-all' to update."
    exit 1
fi
echo "✅ Generated code is up-to-date"
"""

# =============================================================================
# Default Task
# =============================================================================

[tasks.default]
clear = true
description = "Run format, lint, and test for both Rust and Python (default)"
run_task = "all"

[tasks.all]
description = "Build and run format, lint, and test for both Rust and Python"
dependencies = ["gen-all", "dev", "fmt-all", "lint-all", "test-all"]

[tasks.fmt-all]
description = "Format both Rust and Python code"
dependencies = ["rust-fmt", "ruff-fmt"]

[tasks.lint-all]
description = "Lint both Rust and Python code"
dependencies = ["rust-clippy", "ruff"]

# =============================================================================
# Maturin / Build Tasks
# =============================================================================

[tasks.dev]
description = "Build and install pyropust extension (development mode)"
command = "uv"
args = ["run", "maturin", "develop"]

[tasks.build]
alias = "dev"

[tasks.build-release]
description = "Build pyropust wheel for distribution (release mode)"
command = "uv"
args = ["run", "maturin", "build", "--release"]

[tasks.clean]
description = "Clean all build artifacts (Rust + Python)"
dependencies = ["rust-clean", "python-clean"]

[tasks.python-clean]
description = "Clean Python build artifacts"
script = '''
rm -rf pyropust/*.so
rm -rf pyropust/__pycache__
rm -rf tests/__pycache__
rm -rf tests/typing/__pycache__
rm -rf .pytest_cache
rm -rf .mypy_cache
rm -rf .ruff_cache
rm -rf dist
rm -rf target/wheels
'''

# =============================================================================
# Rust Tasks
# =============================================================================

[tasks.rust-build]
description = "Build Python extension (release) - Use 'dev' for development builds"
alias = "build-release"

[tasks.rust-build-dev]
description = "Build Python extension (development) - Use 'dev' instead"
alias = "dev"

[tasks.rust-test]
description = "Run Rust tests"
command = "cargo"
args = ["test"]

[tasks.rust-fmt]
description = "Format Rust code"
command = "cargo"
args = ["fmt"]

[tasks.rust-fmt-check]
description = "Check Rust code formatting"
command = "cargo"
args = ["fmt", "--check"]

[tasks.rust-clippy]
description = "Run clippy"
command = "cargo"
args = ["clippy", "--all-targets", "--", "-D", "warnings"]

[tasks.rust-clean]
description = "Clean Rust build artifacts"
command = "cargo"
args = ["clean"]

# =============================================================================
# Python Test Tasks
# =============================================================================

[tasks.pytest]
description = "Run Python tests (pytest) via uv"
command = "uv"
args = ["run", "pytest", "-v"]

[tasks.bench]
description = "Run Blueprint vs Python timeit benchmark"
command = "uv"
args = ["run", "python", "bench/bench_blueprint_vs_python.py"]

[tasks.pyright]
description = "Run pyright type checks via uv"
command = "uv"
args = ["run", "pyright", "."]

[tasks.mypy]
description = "Run mypy strict type checks via uv"
command = "uv"
args = ["run", "mypy", "--strict", "."]

[tasks.ruff]
description = "Run ruff linter via uv"
command = "uv"
args = ["run", "ruff", "check", "."]

[tasks.ruff-fmt]
description = "Format Python code with ruff"
command = "uv"
args = ["run", "ruff", "format", "."]

[tasks.ruff-fmt-check]
description = "Check Python code formatting with ruff"
command = "uv"
args = ["run", "ruff", "format", "--check", "."]

[tasks.test-all]
description = "Run all tests (Rust + Python: ruff, mypy, pyright, pytest)"
dependencies = ["rust-test", "ruff", "mypy", "pyright", "pytest"]

# =============================================================================
# Combined Tasks
# =============================================================================

[tasks.check]
description = "Run all checks (format check, clippy, type checks, tests, generated code)"
dependencies = [
    "check-gen",
    "rust-fmt-check",
    "ruff-fmt-check",
    "rust-clippy",
    "test-all",
]

[tasks.ci]
description = "Run CI pipeline (build + check)"
dependencies = ["dev", "check"]
