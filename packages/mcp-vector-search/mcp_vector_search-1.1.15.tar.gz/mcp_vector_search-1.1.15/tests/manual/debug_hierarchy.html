<!DOCTYPE html>
<html>
<head>
    <title>Debug Hierarchy</title>
    <script>
    async function debugHierarchy() {
        const response = await fetch('http://localhost:8080/api/graph');
        const data = await response.json();

        const allNodes = data.nodes || [];
        const allLinks = data.links || [];

        console.log('=== RAW DATA ===');
        console.log(`Total nodes: ${allNodes.length}`);
        console.log(`Total links: ${allLinks.length}`);

        // Filter tree nodes
        const chunkTypes = ['function', 'class', 'method', 'text', 'imports', 'module'];
        const treeNodes = allNodes.filter(node => {
            const type = node.type;
            return type === 'directory' || type === 'file' || chunkTypes.includes(type);
        });

        console.log(`Tree nodes: ${treeNodes.length}`);

        // Build parent map
        const parentMap = new Map();

        // Directory links
        let dirProcessed = 0;
        allLinks.forEach(link => {
            if (link.type === 'dir_containment' || link.type === 'dir_hierarchy') {
                dirProcessed++;
                parentMap.set(link.target, link.source);
            }
        });
        console.log(`After dir links: ${parentMap.size} parents (${dirProcessed} links)`);

        // File containment links
        let fileProcessed = 0;
        let fileMatched = 0;
        allLinks.forEach(link => {
            if (link.type === 'file_containment') {
                fileProcessed++;
                parentMap.set(link.target, link.source);
                fileMatched++;
            }
        });
        console.log(`After file links: ${parentMap.size} parents (${fileProcessed} file_containment links, ${fileMatched} processed)`);

        // Find roots
        const rootNodes = treeNodes.filter(node => !parentMap.has(node.id));
        console.log(`Root nodes found: ${rootNodes.length}`);

        // Count by type
        const rootTypes = {};
        rootNodes.forEach(node => {
            const type = node.type || 'undefined';
            rootTypes[type] = (rootTypes[type] || 0) + 1;
        });
        console.log('Root node types:', rootTypes);

        // Sample some chunks
        console.log('\n=== CHUNK SAMPLING ===');
        const chunks = treeNodes.filter(n => chunkTypes.includes(n.type));
        const sample = chunks.slice(0, 5);
        sample.forEach(chunk => {
            const hasParent = parentMap.has(chunk.id);
            const parent = parentMap.get(chunk.id);
            console.log(`Chunk ${chunk.id} (${chunk.type}): hasParent=${hasParent}, parent=${parent}`);

            // Find the link
            const link = allLinks.find(l => l.type === 'file_containment' && l.target === chunk.id);
            if (link) {
                console.log(`  -> Link: source=${link.source}, target=${link.target}`);
            } else {
                console.log(`  -> No file_containment link found`);
            }
        });

        console.log('\n=== COMPLETE ===');
    }

    window.onload = debugHierarchy;
    </script>
</head>
<body>
    <h1>Hierarchy Debug</h1>
    <p>Check browser console for output</p>
</body>
</html>
