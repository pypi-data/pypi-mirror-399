{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} - {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a></h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h2>ğŸš€ æ€§èƒ½ä¼˜åŒ–ç®¡ç†</h2>
        
        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="system-stats" style="margin: 20px 0;">
            <h3>ğŸ–¥ï¸ ç³»ç»ŸçŠ¶æ€</h3>
            <div id="system-loading" style="text-align: center; padding: 20px;">
                <span>åŠ è½½ä¸­...</span>
            </div>
            <div id="system-content" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">å†…å­˜ä½¿ç”¨</h4>
                        <div id="memory-usage" style="font-size: 18px; font-weight: bold; color: #333;"></div>
                        <div id="memory-details" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">ç£ç›˜ä½¿ç”¨</h4>
                        <div id="disk-usage" style="font-size: 18px; font-weight: bold; color: #333;"></div>
                        <div id="disk-details" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">æ•°æ®åº“çŠ¶æ€</h4>
                        <div id="db-status" style="font-size: 16px; font-weight: bold;"></div>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">ç¼“å­˜çŠ¶æ€</h4>
                        <div id="cache-status" style="font-size: 16px; font-weight: bold;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åº“ç»Ÿè®¡ -->
        <div class="dashboard-stats" style="margin: 20px 0;">
            <h3>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h3>
            <div id="stats-loading" style="text-align: center; padding: 20px;">
                <span>åŠ è½½ä¸­...</span>
            </div>
            <div id="stats-content" style="display: none;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f8f8;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è¡¨å</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">è®°å½•æ•°</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">æ•°æ®å¤§å° (MB)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">ç´¢å¼•å¤§å° (MB)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">æ€»å¤§å° (MB)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">å¼•æ“</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="stats-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sessions æ¸…ç† -->
        <div class="cleanup-section" style="margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
            <h3>ğŸ§¹ Sessions æ¸…ç†</h3>
            <p style="color: #666; margin-bottom: 15px;">æ¸…ç†è¿‡æœŸçš„ Django sessions æ•°æ®ï¼Œé‡Šæ”¾æ•°æ®åº“ç©ºé—´ã€‚</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- ç®€å•æ¸…ç† -->
                <div>
                    <h4 style="margin: 0 0 10px 0;">å¿«é€Ÿæ¸…ç†</h4>
                    <form method="post" action="{% url 'tbase_admin:cleanup_sessions' %}" style="margin-bottom: 10px;">
                        {% csrf_token %}
                        <button type="submit" class="button" style="background: #417690; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer;">
                            æ¸…ç†è¿‡æœŸ Sessions
                        </button>
                    </form>
                </div>
                
                <!-- é«˜çº§æ¸…ç† -->
                <div>
                    <h4 style="margin: 0 0 10px 0;">é«˜çº§æ¸…ç†</h4>
                    <form method="post" action="{% url 'tbase_admin:cleanup_sessions_advanced' %}">
                        {% csrf_token %}
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 12px;">æ¸…ç†å¤šå°‘å¤©å‰çš„æ•°æ®ï¼š</label>
                            <select name="days" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px; width: 100%;">
                                <option value="0" selected>ä»…è¿‡æœŸ Sessions</option>
                                <option value="1">1 å¤©å‰</option>
                                <option value="3">3 å¤©å‰</option>
                                <option value="7">7 å¤©å‰</option>
                                <option value="14">14 å¤©å‰</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" name="dry_run" checked> é¢„è§ˆæ¨¡å¼
                            </label>
                        </div>
                        
                        <button type="submit" class="button" style="background: #666; color: white; padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            é«˜çº§æ¸…ç†
                        </button>
                    </form>
                </div>
            </div>
            
            <small style="color: #888;">å»ºè®®æ¯æ—¥æ‰§è¡Œä¸€æ¬¡ï¼Œé¿å… sessions è¡¨è¿‡åº¦è†¨èƒ€ã€‚</small>
        </div>

        <!-- Hitcount æ¸…ç† -->
        <div class="cleanup-section" style="margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
            <h3>ğŸ“ˆ Hitcount æ•°æ®æ¸…ç†</h3>
            <p style="color: #666; margin-bottom: 15px;">æ¸…ç†æ—§çš„ç‚¹å‡»ç»Ÿè®¡æ•°æ®ï¼Œä¿æŒ hitcount è¡¨çš„åˆç†å¤§å°ã€‚</p>
            
            <form method="post" action="{% url 'tbase_admin:cleanup_hitcount' %}" style="margin-bottom: 10px;">
                {% csrf_token %}
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">æ¸…ç†å¤šå°‘å¤©å‰çš„æ•°æ®ï¼š</label>
                    <select name="days" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        <option value="7">7 å¤©</option>
                        <option value="30" selected>30 å¤©</option>
                        <option value="60">60 å¤©</option>
                        <option value="90">90 å¤©</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">æ‰¹é‡å¤§å°ï¼š</label>
                    <select name="batch_size" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                        <option value="1000">1,000</option>
                        <option value="5000" selected>5,000</option>
                        <option value="10000">10,000</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="checkbox" name="dry_run" checked> é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…åˆ é™¤ï¼‰
                    </label>
                </div>
                
                <button type="submit" class="button" style="background: #417690; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer;">
                    æ¸…ç† Hitcount æ•°æ®
                </button>
            </form>
            
            <small style="color: #888;">å»ºè®®æ¯æœˆæ¸…ç†ä¸€æ¬¡è¶…è¿‡ 30 å¤©çš„æ•°æ®ã€‚</small>
        </div>

        <!-- è¡¨ä¼˜åŒ– -->
        <div class="optimize-section" style="margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
            <h3>âš¡ æ•°æ®åº“è¡¨ä¼˜åŒ–</h3>
            <p style="color: #666; margin-bottom: 15px;">ä¼˜åŒ–æ•°æ®åº“è¡¨ç»“æ„ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚</p>
            
            <form method="post" action="{% url 'tbase_admin:optimize_tables' %}">
                {% csrf_token %}
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px;">é€‰æ‹©è¦ä¼˜åŒ–çš„è¡¨ï¼š</label>
                        <div id="tables-selection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 3px;">
                            <!-- è¡¨é€‰æ‹©åˆ—è¡¨å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px;">ä¼˜åŒ–ç±»å‹ï¼š</label>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="radio" name="optimize_type" value="optimize" checked> OPTIMIZE (å®Œæ•´ä¼˜åŒ–)
                            </label>
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="radio" name="optimize_type" value="analyze"> ANALYZE (æ›´æ–°ç»Ÿè®¡)
                            </label>
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="radio" name="optimize_type" value="repair"> REPAIR (ä¿®å¤è¡¨)
                            </label>
                        </div>
                        
                        <button type="submit" class="button" style="background: #ba2121; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; width: 100%;">
                            ä¼˜åŒ–é€‰ä¸­çš„è¡¨
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- ä¼˜åŒ–ç»“æœ -->
            <div id="optimize-results" style="margin-top: 20px; display: none;">
                <h4>ä¼˜åŒ–ç»“æœ</h4>
                <div id="results-content" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 3px;">
                    <!-- ç»“æœå°†ç”± JavaScript åŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <small style="color: #888;">âš ï¸ è¡¨ä¼˜åŒ–ä¼šé”å®šè¡¨ï¼Œè¯·åœ¨ä½å³°æœŸæ‰§è¡Œã€‚</small>
        </div>

        <!-- æ€§èƒ½å»ºè®® -->
        <div class="tips-section" style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 5px;">
            <h3>ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3>
            <ul style="margin: 0; padding-left: 20px;">
                <li style="margin-bottom: 8px;">ğŸ”„ å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼Œé¿å…è¡¨è¿‡åº¦è†¨èƒ€</li>
                <li style="margin-bottom: 8px;">ğŸ“Š ç›‘æ§æ•°æ®åº“å¤§å°ï¼ŒåŠæ—¶æ¸…ç†å†å²æ•°æ®</li>
                <li style="margin-bottom: 8px;">â° åœ¨ä½å³°æœŸæ‰§è¡Œå¤§æ‰¹é‡æ¸…ç†æ“ä½œ</li>
                <li style="margin-bottom: 8px;">ğŸš€ ä½¿ç”¨æ‰¹é‡åˆ é™¤é¿å…é•¿æ—¶é—´é”è¡¨</li>
                <li style="margin-bottom: 8px;">ğŸ“ˆ å®šæœŸä¼˜åŒ–è¡¨ç»“æ„ï¼Œä¿æŒæŸ¥è¯¢æ€§èƒ½</li>
            </ul>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentStats = {};

// é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseStats();
});

function loadDatabaseStats() {
    fetch('{% url "tbase_admin:get_database_stats" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentStats = data.stats;
                displaySystemInfo(data.stats._system || {});
                displayStats(data.stats);
                updateTablesSelection();
            } else {
                showError('stats-loading', 'åŠ è½½å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            showError('stats-loading', 'åŠ è½½å¤±è´¥: ' + error);
        });
}

function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<span style="color: red;">${message}</span>`;
    }
}

function displaySystemInfo(systemInfo) {
    if (!systemInfo || systemInfo.error) {
        document.getElementById('system-loading').innerHTML = 
            '<span style="color: orange;">ç³»ç»Ÿä¿¡æ¯ä¸å¯ç”¨</span>';
        return;
    }
    
    // å†…å­˜ä½¿ç”¨
    const memoryColor = systemInfo.memory_percent > 80 ? 'red' : 
                       systemInfo.memory_percent > 60 ? 'orange' : 'green';
    document.getElementById('memory-usage').innerHTML = 
        `<span style="color: ${memoryColor};">${systemInfo.memory_percent.toFixed(1)}%</span>`;
    document.getElementById('memory-details').innerHTML = 
        `å·²ä½¿ç”¨ ${systemInfo.memory_used_gb} GB / æ€»è®¡ ${systemInfo.memory_total_gb} GB`;
    
    // ç£ç›˜ä½¿ç”¨
    const diskColor = systemInfo.disk_percent > 90 ? 'red' : 
                     systemInfo.disk_percent > 70 ? 'orange' : 'green';
    document.getElementById('disk-usage').innerHTML = 
        `<span style="color: ${diskColor};">${systemInfo.disk_percent.toFixed(1)}%</span>`;
    document.getElementById('disk-details').innerHTML = 
        `å·²ä½¿ç”¨ ${systemInfo.disk_used_gb} GB / æ€»è®¡ ${systemInfo.disk_total_gb} GB`;
    
    // æ•°æ®åº“çŠ¶æ€
    const dbColor = systemInfo.db_status === 'connected' ? 'green' : 'red';
    const dbText = systemInfo.db_status === 'connected' ? 'âœ… å·²è¿æ¥' : 'âŒ è¿æ¥å¼‚å¸¸';
    document.getElementById('db-status').innerHTML = 
        `<span style="color: ${dbColor};">${dbText}</span>`;
    
    // ç¼“å­˜çŠ¶æ€
    const cacheColor = systemInfo.cache_status === 'available' ? 'green' : 'orange';
    const cacheText = systemInfo.cache_status === 'available' ? 'âœ… å¯ç”¨' : 'âš ï¸ ä¸å¯ç”¨';
    document.getElementById('cache-status').innerHTML = 
        `<span style="color: ${cacheColor};">${cacheText}</span>`;
    
    document.getElementById('system-loading').style.display = 'none';
    document.getElementById('system-content').style.display = 'block';
}

function displayStats(stats) {
    const tbody = document.getElementById('stats-tbody');
    tbody.innerHTML = '';
    
    // è¿‡æ»¤æ‰ç³»ç»Ÿä¿¡æ¯
    const tableStats = Object.entries(stats).filter(([key]) => !key.startsWith('_'));
    
    for (const [table, data] of Object.entries(tableStats)) {
        if (typeof data !== 'object' || !data.hasOwnProperty('rows')) continue;
        
        const row = document.createElement('tr');
        
        // ç¡®å®šçŠ¶æ€
        let status = 'âœ… æ­£å¸¸';
        let statusColor = 'green';
        let statusTitle = '';
        
        if (data.health && data.health.warnings.length > 0) {
            status = 'âš ï¸ éœ€è¦å…³æ³¨';
            statusColor = 'orange';
            statusTitle = data.health.warnings.join('; ');
        }
        
        if (data.status === 'error') {
            status = 'âŒ é”™è¯¯';
            statusColor = 'red';
            statusTitle = data.error || 'æœªçŸ¥é”™è¯¯';
        }
        
        // æ•°æ®å¤§å°æ ¼å¼åŒ–
        const size_mb = data.size_mb || 0;
        const index_mb = data.index_mb || 0;
        const total_mb = data.total_mb || (size_mb + index_mb);
        
        row.innerHTML = `
            <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">
                ${table}
                ${data.comment ? `<br><small style="color: #666;">${data.comment}</small>` : ''}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-family: monospace;">
                ${data.rows ? data.rows.toLocaleString() : 'N/A'}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-family: monospace;">
                ${size_mb.toFixed(2)}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-family: monospace;">
                ${index_mb.toFixed(2)}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-family: monospace; font-weight: bold;">
                ${total_mb.toFixed(2)}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: left; font-family: monospace;">
                ${data.engine || 'N/A'}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;" title="${statusTitle}">
                ${status}
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    document.getElementById('stats-loading').style.display = 'none';
    document.getElementById('stats-content').style.display = 'block';
}

function updateTablesSelection() {
    const container = document.getElementById('tables-selection');
    if (!container) return;
    
    container.innerHTML = '';
    
    // è¿‡æ»¤å‡ºæœ‰æ•ˆçš„è¡¨
    const validTables = Object.entries(currentStats).filter(([key, data]) => 
        !key.startsWith('_') && 
        typeof data === 'object' && 
        data.hasOwnProperty('rows') && 
        data.status !== 'error'
    );
    
    // é»˜è®¤é€‰ä¸­çš„è¡¨
    const defaultChecked = ['django_session', 'hitcount_hit'];
    
    validTables.forEach(([tableName, tableData]) => {
        const label = document.createElement('label');
        label.style.cssText = 'display: block; margin-bottom: 5px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'tables';
        checkbox.value = tableName;
        checkbox.checked = defaultChecked.includes(tableName);
        
        const text = document.createTextNode(` ${tableName} (${tableData.rows?.toLocaleString() || 'N/A'} è¡Œ, ${(tableData.total_mb || 0).toFixed(2)} MB)`);
        
        label.appendChild(checkbox);
        label.appendChild(text);
        container.appendChild(label);
    });
}

// è¡¨å•æäº¤æ—¶æ£€æŸ¥ä¼˜åŒ–ç»“æœ
document.addEventListener('submit', function(e) {
    if (e.target.action && e.target.action.includes('optimize_tables')) {
        // å»¶è¿Ÿæ£€æŸ¥ä¼˜åŒ–ç»“æœ
        setTimeout(() => {
            loadOptimizeResults();
        }, 1000);
    }
});

function loadOptimizeResults() {
    fetch('{% url "tbase_admin:get_optimize_results" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                displayOptimizeResults(data.results);
            }
        })
        .catch(error => {
            console.error('è·å–ä¼˜åŒ–ç»“æœå¤±è´¥:', error);
        });
}

function displayOptimizeResults(results) {
    const container = document.getElementById('optimize-results');
    const content = document.getElementById('results-content');
    
    if (!container || !content) return;
    
    content.innerHTML = '';
    
    results.forEach(result => {
        const div = document.createElement('div');
        div.style.cssText = 'margin-bottom: 10px; padding: 8px; border-radius: 3px;';
        
        if (result.status === 'success') {
            div.style.backgroundColor = '#d4edda';
            div.style.border = '1px solid #c3e6cb';
            div.innerHTML = `
                <strong>âœ… ${result.table}</strong><br>
                <small>
                    æ“ä½œ: ${result.operation} | 
                    ä¼˜åŒ–å‰: ${result.size_before} MB | 
                    ä¼˜åŒ–å: ${result.size_after} MB
                    ${result.size_saved > 0 ? `| èŠ‚çœ: ${result.size_saved} MB` : ''}
                </small>
            `;
        } else {
            div.style.backgroundColor = '#f8d7da';
            div.style.border = '1px solid #f5c6cb';
            div.innerHTML = `
                <strong>âŒ ${result.table}</strong><br>
                <small>é”™è¯¯: ${result.message}</small>
            `;
        }
        
        content.appendChild(div);
    });
    
    container.style.display = 'block';
}

// æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
setInterval(loadDatabaseStats, 30000);
</script>

<style>
.dashboard-stats table {
    margin-top: 10px;
}

.dashboard-stats th {
    font-weight: bold;
    background: #f8f8f8 !important;
}

.dashboard-stats tr:nth-child(even) {
    background: #f9f9f9;
}

.cleanup-section, .optimize-section, .tips-section {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.button:hover {
    background: #2c5aa0 !important;
}

.button:active {
    background: #264c7d !important;
}
</style>
{% endblock %}