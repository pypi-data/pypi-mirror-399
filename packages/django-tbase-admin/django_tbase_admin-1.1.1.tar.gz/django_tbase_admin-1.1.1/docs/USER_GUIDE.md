# Tbase_Admin 模块用户指南

## 概述

Tbase_Admin 模块提供了完整的网站性能管理功能，帮助管理员监控数据库状态、清理过期数据、优化表结构。

## 主要功能

### 1. 性能仪表板

访问路径：`/tbase_admin/performance/`

仪表板显示以下信息：

- **数据库表统计**：各表的行数和占用空间
- **实时数据刷新**：点击刷新按钮获取最新数据
- **可视化图表**：表大小和行数的直观展示

### 2. Sessions 清理

**功能**：清理过期的用户会话数据

**操作步骤**：
1. 在性能仪表板找到 "Sessions 管理" 区域
2. 点击 "清理 Sessions" 按钮
3. 系统会自动清理过期会话并显示删除的记录数

**注意事项**：
- 此操作会删除所有过期的会话数据
- 正在活跃的用户不会受影响
- 建议定期执行此操作

### 3. Hitcount 数据清理

**功能**：清理网站的访问统计数据

**操作步骤**：
1. 在仪表板找到 "Hitcount 清理" 区域
2. 设置保留天数（默认 30 天）
3. 设置批次大小（默认 5000，避免内存问题）
4. 可选择预览模式（不实际删除，只显示将要删除的数量）
5. 点击 "清理 Hitcount" 执行操作

**参数说明**：
- **保留天数**：删除多少天前的数据
- **批次大小**：每次处理的数据量，大数据量时建议调小
- **预览模式**：勾选后只显示将要删除的数据量，不实际删除

### 4. 数据库表优化

**功能**：优化数据库表结构，提高查询性能

**操作步骤**：
1. 在仪表板找到 "表优化" 区域
2. 选择要优化的表（默认会选择 django_session 和 hitcount_hit）
3. 点击 "优化表" 按钮
4. 等待优化完成

**注意事项**：
- 优化过程中表可能会被锁定
- 建议在访问量少的时候执行
- 大表优化可能需要较长时间

## 界面说明

### 仪表板布局

```
┌─────────────────────────────────────────┐
│ 性能优化管理仪表板                      │
├─────────────────────────────────────────┤
│ 数据库统计信息                          │
│ ┌─────────┬─────────┬─────────────────┐ │
│ │ 表名    │ 行数    │ 大小(MB)       │ │
│ └─────────┴─────────┴─────────────────┘ │
├─────────────────────────────────────────┤
│ Sessions 管理                           │
│ [清理 Sessions]                         │
├─────────────────────────────────────────┤
│ Hitcount 清理                           │
│ 保留天数: [30] 批次大小: [5000]         │
│ □ 预览模式 [清理 Hitcount]              │
├─────────────────────────────────────────┤
│ 表优化                                  │
│ ☑ django_session ☑ hitcount_hit        │
│ [优化表]                                │
└─────────────────────────────────────────┘
```

### 状态消息

操作完成后会显示相应的状态消息：

- ✅ **成功消息**：绿色，表示操作成功完成
- ℹ️ **信息消息**：蓝色，提供操作信息（如预览结果）
- ❌ **错误消息**：红色，表示操作失败

## 最佳实践

### 1. 定期维护计划

**每日**：
- 检查数据库统计信息
- 清理过期 sessions

**每周**：
- 清理旧的 hitcount 数据（保留 7-30 天）
- 检查表大小增长趋势

**每月**：
- 执行表优化
- 分析性能数据趋势

### 2. 数据保留策略

- **Sessions**：建议保留 7-14 天
- **Hitcount**：根据分析需求保留 30-90 天
- **日志数据**：根据合规要求保留相应时间

### 3. 性能监控指标

建议关注以下指标：

- `django_session` 表行数超过 100,000
- 单个表大小超过 100MB
- 数据库总大小增长趋势
- 查询响应时间

## 故障处理

### 常见问题

**Q: 清理操作很慢或卡住怎么办？**
A: 
- 减小批次大小
- 使用预览模式先查看数据量
- 在访问量少的时候执行

**Q: 表优化失败怎么办？**
A:
- 检查数据库权限
- 确认表是否存在
- 联系数据库管理员

**Q: 看不到某些表的统计信息？**
A:
- 检查表名是否在监控列表中
- 确认数据库连接正常
- 查看错误日志

### 应急处理

如果遇到紧急情况：

1. **立即停止操作**：关闭浏览器标签页
2. **检查数据库状态**：联系数据库管理员
3. **查看日志**：检查 Django 错误日志
4. **回滚操作**：如果有备份，考虑恢复数据

## 高级功能

### API 接口

模块提供 RESTful API 用于集成：

```
GET  /tbase_admin/api/stats/     # 获取数据库统计
POST /tbase_admin/cleanup/sessions/  # 清理 sessions
POST /tbase_admin/cleanup/hitcount/  # 清理 hitcount
POST /tbase_admin/optimize/tables/   # 优化表
```

### 自定义配置

可以通过修改 `views.py` 中的配置来调整：

```python
# 修改监控的表列表
tables_to_check = [
    'your_custom_table',
    'another_table'
]

# 调整默认参数
DEFAULT_RETENTION_DAYS = 30
DEFAULT_BATCH_SIZE = 5000
```

## 联系支持

如果遇到问题或需要帮助：

1. 查看本文档的故障处理部分
2. 检查 Django 日志文件
3. 联系系统管理员
4. 提交问题报告（包含错误信息和操作步骤）