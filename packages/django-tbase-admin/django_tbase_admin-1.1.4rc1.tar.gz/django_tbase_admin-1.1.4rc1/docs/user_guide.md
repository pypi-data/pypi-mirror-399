# Tbase_Admin 模块用户指南

## 概述

Tbase_Admin 是一个强大的 Django 管理模块，专门用于网站性能监控和数据库维护。本指南将帮助您快速掌握模块的各项功能。

## 快速开始

### 访问入口

1. 使用管理员账号登录 Django Admin
2. 访问 `/tbase_admin/performance/` 进入性能仪表板
3. 或者通过 Django Admin 侧边栏的"性能管理"菜单进入

### 首次使用

1. 查看数据库统计信息概览
2. 检查各表的行数和大小
3. 了解可用的维护功能

## 功能详解

### 📊 性能仪表板

仪表板提供网站性能的全面视图：

**实时监控**：
- 数据库表统计（行数、大小）
- 会话数量监控
- Hitcount 数据统计
- 系统性能指标

**数据刷新**：
- 手动刷新：点击"刷新数据"按钮
- 自动刷新：页面每 5 分钟自动更新
- 实时 API：通过 AJAX 获取最新数据

### 🧹 数据清理功能

#### Sessions 清理

**用途**：清理过期的用户会话，释放数据库空间

**操作方法**：
```
1. 点击 [清理 Sessions] 按钮
2. 系统自动执行清理
3. 显示删除的记录数量
```

**清理策略**：
- 删除所有过期会话
- 保留活跃用户会话
- 无需手动设置参数

#### Hitcount 清理

**用途**：管理网站访问统计数据，控制数据库大小

**参数设置**：
- **保留天数**：删除多少天前的数据（默认 30 天）
- **批次大小**：每次处理的数据量（默认 5000）
- **预览模式**：显示将要删除的数据量，不实际删除

**操作流程**：
```
1. 设置保留天数（建议 7-90 天）
2. 调整批次大小（大数据量时建议 1000-5000）
3. 可选：勾选预览模式查看影响
4. 点击 [清理 Hitcount] 执行
```

**最佳实践**：
- 日常清理：保留 30 天
- 精细分析：保留 90 天
- 节省空间：保留 7 天

### 🔧 表优化功能

**用途**：优化数据库表结构，提升查询性能

**支持的表**：
- `django_session`：用户会话表
- `hitcount_hit`：访问统计表
- 其他自定义表（可配置）

**操作步骤**：
```
1. 选择要优化的表（默认已选择核心表）
2. 点击 [优化表] 按钮
3. 等待优化完成
```

**注意事项**：
- 优化期间表可能被锁定
- 建议在低峰期执行
- 大表优化可能需要几分钟时间

## 使用场景

### 场景 1：日常维护

**目标**：保持系统性能稳定

**操作流程**：
```
每日：
1. 查看仪表板，关注表大小增长
2. 清理过期 sessions
3. 检查异常数据增长

每周：
1. 清理旧 hitcount 数据
2. 优化核心表
3. 分析性能趋势
```

### 场景 2：性能问题排查

**症状**：网站响应变慢

**排查步骤**：
```
1. 查看数据库统计，识别大表
2. 清理过期数据释放空间
3. 优化相关表结构
4. 监控优化效果
```

### 场景 3：容量规划

**目标**：预测数据库增长趋势

**分析方法**：
```
1. 记录各表的历史大小
2. 分析增长模式
3. 制定清理策略
4. 规划扩容时间
```

## 界面操作指南

### 仪表板导航

```
┌─ 性能优化管理仪表板 ─────────────────┐
│                                        │
│ 📊 数据库统计信息                      │
│ ┌─────────────┬──────────┬───────────┐ │
│ │ 表名        │ 行数     │ 大小(MB)  │ │
│ ├─────────────┼──────────┼───────────┤ │
│ │ django_session │ 1,234 │ 12.5     │ │
│ │ hitcount_hit   │ 45,678│ 89.3     │ │
│ └─────────────┴──────────┴───────────┘ │
│                                        │
│ 🧹 Sessions 管理                       │
│ [清理 Sessions] 已删除 234 条记录      │
│                                        │
│ 🧹 Hitcount 清理                       │
│ 保留天数: [30] 批次大小: [5000]        │
│ □ 预览模式 [清理 Hitcount]              │
│                                        │
│ 🔧 表优化                              │
│ ☑ django_session ☑ hitcount_hit      │
│ [优化表]                              │
│                                        │
└────────────────────────────────────────┘
```

### 状态指示器

- ✅ **成功**：操作成功完成
- ℹ️ **信息**：提示信息或预览结果
- ⚠️ **警告**：需要注意的情况
- ❌ **错误**：操作失败

### 数据格式

- **数字格式**：使用千位分隔符（1,234）
- **大小单位**：MB 为单位，保留 1 位小数
- **时间格式**：本地时间显示

## 高级功能

### API 接口

**获取统计数据**：
```http
GET /tbase_admin/api/stats/
Response: {
  "success": true,
  "stats": {
    "django_session": {"rows": 1234, "size_mb": 12.5}
  }
}
```

**清理操作**：
```http
POST /tbase_admin/cleanup/sessions/
POST /tbase_admin/cleanup/hitcount/
POST /tbase_admin/optimize/tables/
```

### 自定义配置

**监控表配置**：
```python
# 在 views.py 中修改
tables_to_check = [
    'django_session',
    'hitcount_hit',
    'your_custom_table',  # 添加自定义表
]
```

**默认参数调整**：
```python
DEFAULT_RETENTION_DAYS = 30  # 默认保留天数
DEFAULT_BATCH_SIZE = 5000    # 默认批次大小
```

## 故障排除

### 常见问题

**Q: 操作没有反应？**
```
A: 1. 检查网络连接
   2. 刷新页面重试
   3. 查看浏览器控制台错误
```

**Q: 清理速度很慢？**
```
A: 1. 减小批次大小到 1000-2000
   2. 使用预览模式先测试
   3. 在低峰期执行
```

**Q: 表优化失败？**
```
A: 1. 检查数据库权限
   2. 确认表名正确
   3. 联系数据库管理员
```

### 错误代码

| 错误类型 | 可能原因 | 解决方法 |
|---------|---------|---------|
| 权限错误 | 用户非管理员 | 使用管理员账号登录 |
| 数据库错误 | 连接失败 | 检查数据库配置 |
| 表不存在 | 表名错误 | 验证表名拼写 |
| 内存不足 | 批次太大 | 减小批次大小 |

## 最佳实践建议

### 维护计划

**高频操作**（每日）：
- 清理 sessions
- 检查表大小

**中频操作**（每周）：
- 清理 hitcount
- 优化核心表

**低频操作**（每月）：
- 全面性能分析
- 容量规划评估

### 数据保留策略

| 数据类型 | 建议保留期 | 清理频率 |
|---------|-----------|---------|
| Sessions | 7-14 天 | 每日 |
| Hitcount | 30-90 天 | 每周 |
| 系统日志 | 30-180 天 | 每月 |

### 性能监控

**关注指标**：
- 表大小增长率
- 查询响应时间
- 清理操作耗时
- 数据库连接数

**告警阈值**：
- Session 表 > 50,000 行
- 单表大小 > 500MB
- 清理耗时 > 5 分钟

## 技术支持

### 获取帮助

1. **查看文档**：阅读本指南和部署文档
2. **检查日志**：查看 Django 错误日志
3. **联系管理员**：报告问题和错误信息
4. **社区支持**：在相关技术社区提问

### 问题报告

提交问题时请包含：

- 详细的错误信息
- 操作步骤描述
- 浏览器和环境信息
- 相关的日志截图

---

💡 **提示**：建议将本指南加入书签，方便随时查阅。定期查看最佳实践部分，优化您的维护策略。