"""HTML reporter for generating web reports."""

from datetime import datetime

from rich.console import Console

from bastion.config import Config
from bastion.models import Finding, ScanResult


class HtmlReporter:
    """HTML report generator."""

    SEVERITY_COLORS = {
        "critical": "#dc3545",
        "high": "#fd7e14",
        "medium": "#ffc107",
        "low": "#17a2b8",
        "info": "#6c757d",
    }

    def __init__(self, console: Console, config: Config) -> None:
        """Initialize the HTML reporter."""
        self.console = console
        self.config = config

    def report(self, result: ScanResult) -> None:
        """Display HTML info."""
        if self.config.output_file:
            self.console.print(
                f"[green]HTML report will be written to {self.config.output_file}[/green]"
            )
        else:
            self.console.print(self.format(result))

    def format(self, result: ScanResult) -> str:
        """Format as HTML."""
        from bastion import __version__

        findings_html = self._build_findings_html(result)
        summary_html = self._build_summary_html(result)
        css = self._get_css()

        return f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bastion Security Report</title>
    <style>{css}</style>
</head>
<body>
    <div class="container">
        <h1>Bastion Security Report</h1>
        {summary_html}
        <h2>Findings</h2>
        {findings_html if findings_html else "<p>No security issues found!</p>"}
        <footer>
            Generated by Bastion v{__version__} on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
        </footer>
    </div>
</body>
</html>"""

    def _build_findings_html(self, result: ScanResult) -> str:
        """Build HTML for all findings."""
        findings_html = ""
        for finding in result.findings:
            findings_html += self._format_finding_html(finding)
        return findings_html

    def _format_finding_html(self, finding: Finding) -> str:
        """Format a single finding as HTML."""
        color = self.SEVERITY_COLORS.get(finding.severity.value, "#6c757d")
        snippet_html = finding.location.snippet.replace("<", "&lt;").replace(">", "&gt;")
        fix_html = f"<div class='fix'>Fix: {finding.fix_suggestion}</div>" if finding.fix_suggestion else ""

        return f"""
        <div class="finding" style="border-left: 4px solid {color};">
            <div class="finding-header">
                <span class="severity" style="background: {color};">{finding.severity.value.upper()}</span>
                <span class="rule-id">{finding.rule_id}</span>
                <span class="message">{finding.message}</span>
            </div>
            <div class="location">
                {finding.location.file_path}:{finding.location.start_line}:{finding.location.start_column}
            </div>
            <pre class="snippet"><code>{snippet_html}</code></pre>
            {fix_html}
        </div>
        """

    def _build_summary_html(self, result: ScanResult) -> str:
        """Build HTML for the summary section."""
        return f"""
        <div class="summary">
            <div class="summary-grid">
                <div class="stat">
                    <div class="stat-value">{result.files_scanned}</div>
                    <div class="stat-label">Files Scanned</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{len(result.findings)}</div>
                    <div class="stat-label">Total Findings</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #dc3545;">{result.critical_count}</div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #fd7e14;">{result.high_count}</div>
                    <div class="stat-label">High</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #ffc107;">{result.medium_count}</div>
                    <div class="stat-label">Medium</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{result.scan_time_seconds:.2f}s</div>
                    <div class="stat-label">Scan Time</div>
                </div>
            </div>
        </div>"""

    def _get_css(self) -> str:
        """Return the CSS styles for the HTML report."""
        return """
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; }
        .summary { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 4px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .finding { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .finding-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .severity { color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .rule-id { font-family: monospace; color: #666; }
        .message { font-weight: 500; }
        .location { font-family: monospace; font-size: 12px; color: #666; margin-bottom: 10px; }
        .snippet { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .snippet code { font-family: 'Fira Code', 'Consolas', monospace; font-size: 13px; }
        .fix { margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; color: #155724; }
        footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
        """
