# Generated by PropelAuth

import json
from typing import Callable, List, Optional, Dict, Any
from .result import Result, Ok, Err, ok, err, is_ok
from .types import RequestFunc

from .generated.create_api_key_command import CreateApiKeyCommand
from .generated.create_api_key_response import CreateApiKeyResponse
from .generated.create_api_key_error import (
    CreateApiKeyError,
    CreateApiKeyErrorInvalidFields,
    CreateApiKeyErrorInvalidFieldsDetails,
    CreateApiKeyErrorPrefixNotFound,
    CreateApiKeyErrorUserNotFound,
    CreateApiKeyErrorUnexpectedError,
    UnexpectedErrorDetails
)
from .generated.validate_api_key_command import ValidateApiKeyCommand
from .generated.validate_api_key_response import ValidateApiKeyResponse
from .generated.validate_api_key_error import (
    ValidateApiKeyError,
    ValidateApiKeyErrorInvalidApiKeyError,
    ValidateApiKeyErrorUnexpectedError,
    UnexpectedErrorDetails
)
from .generated.api_key_error import ApiKeyError
from .generated.revoke_api_key_command import RevokeApiKeyCommand
from .generated.revoke_api_key_response import RevokeApiKeyResponse
from .generated.revoke_api_key_error import (
    RevokeApiKeyError,
    RevokeApiKeyErrorLiveApiKeyNotFound,
    RevokeApiKeyErrorUnexpectedError,
    UnexpectedErrorDetails
)
from .generated.patch_api_key_command import PatchApiKeyCommand
from .generated.patch_api_key_response import PatchApiKeyResponse
from .generated.patch_api_key_error import (
    PatchApiKeyError,
    PatchApiKeyErrorInvalidFields,
    PatchApiKeyErrorInvalidFieldsDetails,
    PatchApiKeyErrorLiveApiKeyNotFound,
    PatchApiKeyErrorUnexpectedError,
    UnexpectedErrorDetails
)
from .generated.get_api_keys_command import GetApiKeysCommand
from .generated.get_api_keys_response import GetApiKeysResponse
from .generated.get_api_keys_error import (
    GetApiKeysError,
    GetApiKeysErrorInvalidQueryField,
    GetApiKeysErrorInvalidQueryFieldDetails,
    GetApiKeysErrorUserNotFound,
    GetApiKeysErrorUnexpectedError,
    UnexpectedErrorDetails
)
from .generated.api_key_full_metadata_response import ApiKeyFullMetadataResponse
from .generated.serde_json.json_value import JsonValue
from .generated.api_key_status import ApiKeyStatus

class ApiKeyClient:
    
    def __init__(self, request_func: RequestFunc):
        self._request = request_func
    
    async def create_api_key(
        self,
        prefix: Optional[str] = None,
        display_name: Optional[str] = None,
        expires_at: Optional[int] = None,
        metadata: Optional[JsonValue] = None,
        user_id: Optional[str] = None,
        owner_id: Optional[str] = None,
        scopes: Optional[List[str]] = None
    ) -> Result[CreateApiKeyResponse, CreateApiKeyError]:
        data: Dict[str, Any] = {}
        if prefix is not None:
            data["prefix"] = prefix
        if display_name is not None:
            data["displayName"] = display_name
        if expires_at is not None:
            data["expiresAt"] = expires_at
        if metadata is not None:
            data["metadata"] = metadata
        if user_id is not None:
            data["userId"] = user_id
        if owner_id is not None:
            data["ownerId"] = owner_id
        if scopes is not None:
            data["scopes"] = scopes
        response = await self._request(
            command="CreateApiKey",
            data=data
        )
        if is_ok(response):
            data = response.data

            return ok(CreateApiKeyResponse(
                key_id=data["keyId"],
                key=data["key"]
            ))

        else:
            error_data = response.error
            if error_data["type"] == "InvalidFields":
                return err(CreateApiKeyErrorInvalidFields(
                    details=CreateApiKeyErrorInvalidFieldsDetails(
                        fields=error_data["details"]["fields"]
                    )
                ))
            elif error_data["type"] == "PrefixNotFound":
                return err(CreateApiKeyErrorPrefixNotFound())
            elif error_data["type"] == "UserNotFound":
                return err(CreateApiKeyErrorUserNotFound())
            elif error_data["type"] == "UnexpectedError":
                return err(CreateApiKeyErrorUnexpectedError(
                    details=str(error_data["details"]) if isinstance(error_data["details"], (str, int, float, bool)) else json.dumps(error_data["details"])
                ))
            else:
                raise ValueError(f"Unknown error type: {error_data.get('type', 'missing type field')}")
    
    async def validate_api_key(
        self,
        key: str
    ) -> Result[ValidateApiKeyResponse, ValidateApiKeyError]:
        data: Dict[str, Any] = {}
        if key is not None:
            data["key"] = key
        response = await self._request(
            command="ValidateApiKey",
            data=data
        )
        if is_ok(response):
            data = response.data

            return ok(ValidateApiKeyResponse(
                key_id=data["keyId"],
                metadata=data["metadata"],
                scopes=data["scopes"],
                user_id=data.get("userId"),
                owner_id=data.get("ownerId")
            ))

        else:
            error_data = response.error
            if error_data["type"] == "InvalidApiKeyError":
                return err(ValidateApiKeyErrorInvalidApiKeyError(
                    details=str(error_data["details"]) if isinstance(error_data["details"], (str, int, float, bool)) else json.dumps(error_data["details"])
                ))
            elif error_data["type"] == "UnexpectedError":
                return err(ValidateApiKeyErrorUnexpectedError(
                    details=str(error_data["details"]) if isinstance(error_data["details"], (str, int, float, bool)) else json.dumps(error_data["details"])
                ))
            else:
                raise ValueError(f"Unknown error type: {error_data.get('type', 'missing type field')}")
    
    async def revoke_api_key(
        self,
        key_id: str
    ) -> Result[RevokeApiKeyResponse, RevokeApiKeyError]:
        data: Dict[str, Any] = {}
        if key_id is not None:
            data["keyId"] = key_id
        response = await self._request(
            command="RevokeApiKey",
            data=data
        )
        if is_ok(response):
            data = response.data

            return ok(RevokeApiKeyResponse())
            
        else:
            error_data = response.error
            if error_data["type"] == "LiveApiKeyNotFound":
                return err(RevokeApiKeyErrorLiveApiKeyNotFound())
            elif error_data["type"] == "UnexpectedError":
                return err(RevokeApiKeyErrorUnexpectedError(
                    details=str(error_data["details"]) if isinstance(error_data["details"], (str, int, float, bool)) else json.dumps(error_data["details"])
                ))
            else:
                raise ValueError(f"Unknown error type: {error_data.get('type', 'missing type field')}")
    
    async def patch_api_key(
        self,
        key_id: str,
        display_name: Optional[str] = None,
        expires_at: Optional[int] = None,
        set_to_never_expire: Optional[bool] = None,
        metadata: Optional[JsonValue] = None
    ) -> Result[PatchApiKeyResponse, PatchApiKeyError]:
        data: Dict[str, Any] = {}
        if key_id is not None:
            data["keyId"] = key_id
        if display_name is not None:
            data["displayName"] = display_name
        if expires_at is not None:
            data["expiresAt"] = expires_at
        if set_to_never_expire is not None:
            data["setToNeverExpire"] = set_to_never_expire
        if metadata is not None:
            data["metadata"] = metadata
        response = await self._request(
            command="PatchApiKey",
            data=data
        )
        if is_ok(response):
            data = response.data

            return ok(PatchApiKeyResponse())
            
        else:
            error_data = response.error
            if error_data["type"] == "InvalidFields":
                return err(PatchApiKeyErrorInvalidFields(
                    details=PatchApiKeyErrorInvalidFieldsDetails(
                        fields=error_data["details"]["fields"]
                    )
                ))
            elif error_data["type"] == "LiveApiKeyNotFound":
                return err(PatchApiKeyErrorLiveApiKeyNotFound())
            elif error_data["type"] == "UnexpectedError":
                return err(PatchApiKeyErrorUnexpectedError(
                    details=str(error_data["details"]) if isinstance(error_data["details"], (str, int, float, bool)) else json.dumps(error_data["details"])
                ))
            else:
                raise ValueError(f"Unknown error type: {error_data.get('type', 'missing type field')}")
    
    async def get_api_keys(
        self,
        user_id: Optional[str] = None,
        owner_id: Optional[str] = None,
        page_number: Optional[int] = None,
        page_size: Optional[int] = None,
        prefix: Optional[str] = None,
        status: Optional[ApiKeyStatus] = None
    ) -> Result[GetApiKeysResponse, GetApiKeysError]:
        data: Dict[str, Any] = {}
        if user_id is not None:
            data["userId"] = user_id
        if owner_id is not None:
            data["ownerId"] = owner_id
        if page_number is not None:
            data["pageNumber"] = page_number
        if page_size is not None:
            data["pageSize"] = page_size
        if prefix is not None:
            data["prefix"] = prefix
        if status is not None:
            data["status"] = status
        response = await self._request(
            command="GetApiKeys",
            data=data
        )
        if is_ok(response):
            data = response.data
            api_keys: List[ApiKeyFullMetadataResponse] = []
            for api_keys_data in data["apiKeys"]:  # type: Dict[str, Any]
                api_keys.append(ApiKeyFullMetadataResponse(
                    key_id=api_keys_data["keyId"],
                    display_name=api_keys_data.get("displayName"),
                    created_at=api_keys_data["createdAt"],
                    scopes=api_keys_data["scopes"],
                    expires_at=api_keys_data["expiresAt"],
                    last_active_at=api_keys_data["lastActiveAt"],
                    metadata=api_keys_data["metadata"],
                    user_id=api_keys_data.get("userId"),
                    owner_id=api_keys_data.get("ownerId")
                ))

            return ok(GetApiKeysResponse(
                page_number=data["pageNumber"],
                page_size=data["pageSize"],
                total_results=data["totalResults"],
                api_keys=api_keys
            ))

        else:
            error_data = response.error
            if error_data["type"] == "InvalidQueryField":
                return err(GetApiKeysErrorInvalidQueryField(
                    details=GetApiKeysErrorInvalidQueryFieldDetails(
                        field=error_data["details"]["field"],
                        message=error_data["details"]["message"]
                    )
                ))
            elif error_data["type"] == "UserNotFound":
                return err(GetApiKeysErrorUserNotFound())
            elif error_data["type"] == "UnexpectedError":
                return err(GetApiKeysErrorUnexpectedError(
                    details=str(error_data["details"]) if isinstance(error_data["details"], (str, int, float, bool)) else json.dumps(error_data["details"])
                ))
            else:
                raise ValueError(f"Unknown error type: {error_data.get('type', 'missing type field')}")
    
