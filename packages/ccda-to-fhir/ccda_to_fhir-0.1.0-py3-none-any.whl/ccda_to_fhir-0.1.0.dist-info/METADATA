Metadata-Version: 2.4
Name: ccda-to-fhir
Version: 0.1.0
Summary: A Python library to convert C-CDA documents to FHIR R4B resources
Project-URL: Homepage, https://github.com/nurra/ccda-to-fhir
Project-URL: Documentation, https://github.com/nurra/ccda-to-fhir#readme
Project-URL: Repository, https://github.com/nurra/ccda-to-fhir.git
Project-URL: Issues, https://github.com/nurra/ccda-to-fhir/issues
Author-email: Nurra <hello@nurra.ai>
License: MIT
License-File: LICENSE
Keywords: ccda,cda,fhir,healthcare,hl7,interoperability,r4b
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: Intended Audience :: Healthcare Industry
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Classifier: Topic :: Scientific/Engineering :: Medical Science Apps.
Classifier: Typing :: Typed
Requires-Python: >=3.10
Requires-Dist: fhir-resources>=8.1.0
Requires-Dist: lxml>=5.0
Requires-Dist: pydantic>=2.0
Provides-Extra: dev
Requires-Dist: lxml-stubs>=0.5; extra == 'dev'
Requires-Dist: mypy>=1.0; extra == 'dev'
Requires-Dist: pytest-cov>=4.0; extra == 'dev'
Requires-Dist: pytest>=8.0; extra == 'dev'
Requires-Dist: ruff>=0.8; extra == 'dev'
Description-Content-Type: text/markdown

# ccda-to-fhir

A Python library to convert C-CDA (Consolidated Clinical Document Architecture) documents to FHIR R4B resources.

## Quick Start

```python
from ccda_to_fhir import convert_document

# From XML string
with open('patient_record.xml') as f:
    bundle = convert_document(f.read())  # Returns FHIR Bundle

# Access converted resources
for entry in bundle.entry:
    resource = entry.resource
    print(f"{resource.resource_type}: {resource.id}")
```

## Design Principles

### Fail Loud and Clear

This library is designed to **fail loudly** when it encounters unexpected data. Rather than silently dropping data or making assumptions, it will raise clear exceptions when:

- An unknown code system OID is encountered
- An unmapped status code is found
- A required element is missing or malformed
- An unexpected XML structure is detected

This ensures data integrity and makes it immediately obvious when the converter needs to be extended to handle new cases.

```python
from ccda_to_fhir import convert_document
from ccda_to_fhir.exceptions import UnknownCodeSystemError, UnmappedValueError

try:
    bundle = convert_document(xml_content)
except UnknownCodeSystemError as e:
    print(f"Unknown code system: {e.oid}")
except UnmappedValueError as e:
    print(f"Unmapped value '{e.value}' for {e.field}")
```

## C-CDA Validation

This library includes C-CDA conformance validation based on the C-CDA R2.1 specification. Validation happens automatically during parsing to ensure documents meet C-CDA requirements.

### What's Working

The library validates C-CDA documents during parsing and will raise errors if documents violate C-CDA conformance requirements. Currently implemented validators (16 templates):

**Document Level:**
- âœ… US Realm Header (2.16.840.1.113883.10.20.22.1.1)

**Clinical Statements:**
- âœ… Problem Observation (2.16.840.1.113883.10.20.22.4.4)
- âœ… Problem Concern Act (2.16.840.1.113883.10.20.22.4.3)
- âœ… Allergy Observation (2.16.840.1.113883.10.20.22.4.7)
- âœ… Allergy Concern Act (2.16.840.1.113883.10.20.22.4.30)
- âœ… Medication Activity (2.16.840.1.113883.10.20.22.4.16)
- âœ… Immunization Activity (2.16.840.1.113883.10.20.22.4.52)
- âœ… Procedure Activity (2.16.840.1.113883.10.20.22.4.14)
- âœ… Encounter Activity (2.16.840.1.113883.10.20.22.4.49)
- âœ… Vital Sign Observation (2.16.840.1.113883.10.20.22.4.27)
- âœ… Vital Signs Organizer (2.16.840.1.113883.10.20.22.4.26)
- âœ… Result Observation (2.16.840.1.113883.10.20.22.4.2)
- âœ… Result Organizer (2.16.840.1.113883.10.20.22.4.1)
- âœ… Smoking Status Observation (2.16.840.1.113883.10.20.22.4.78)
- âœ… Social History Observation (2.16.840.1.113883.10.20.22.4.38)
- âœ… Family History Observation (2.16.840.1.113883.10.20.22.4.46)

### How Validation Works

Validation happens automatically during parsing. If a C-CDA document violates conformance requirements, a `MalformedXMLError` will be raised with a detailed message:

```python
from ccda_to_fhir.ccda.parser import parse_ccda, MalformedXMLError

xml = """<?xml version="1.0"?>
<ClinicalDocument xmlns="urn:hl7-org:v3">
    <realmCode code="UK"/>  <!-- Invalid: Must be "US" for US Realm Header -->
    <!-- ... -->
</ClinicalDocument>
"""

try:
    doc = parse_ccda(xml)
except MalformedXMLError as e:
    print(f"Validation error: {e}")
    # Output: US Realm Header (2.16.840.1.113883.10.20.22.1.1):
    #         realmCode SHALL be 'US', found 'UK'
```

### Implementation Status

**Overall:** ðŸŸ¡ **ALPHA** - Comprehensive feature set with ongoing testing and refinement

**Test Coverage:**
- âœ… **1928 tests passing** (validation, parsing, conversion, and E2E tests)
- âœ… 16 C-CDA template validators implemented
- âœ… 25+ resource types with conversion support
- âœ… 100% specification compliance for implemented features

**C-CDA â†’ FHIR Conversion:**
- âœ… **Patient**: 100% complete (21/21 features - zero gaps!) ðŸŽ‰
- âœ… **Condition**: 100% complete (16/16 features - zero gaps!)
- âœ… **AllergyIntolerance**: 100% complete (15/15 features - zero gaps!)
- âœ… **Observation/Results**: 100% complete (17/17 features - zero gaps!)
- âœ… **Procedure**: 100% complete (14/14 features - zero gaps!)
- âœ… **Immunization**: 100% complete (15/15 features - zero gaps!)
- âœ… **MedicationRequest**: 100% complete (17/17 features - zero gaps!)
- âœ… **Encounter**: 100% complete (15/15 features - zero gaps!)
- âœ… **Vital Signs**: 100% complete (17/17 features - zero gaps!)
- âœ… **Social History**: 100% complete (13/13 features - zero gaps!)
- âœ… **Notes/DocumentReference**: 100% complete (14/14 features - zero gaps!)
- âœ… **Participations (Provenance)**: 100% complete (19/19 features - zero gaps!)

**FHIR Models:**
- âœ… FHIR R4B models available via [`fhir.resources`](https://github.com/nazrulworld/fhir.resources) library
- âœ… Complete Pydantic models for all FHIR resources and datatypes
- âœ… Wrapper module at `ccda_to_fhir.fhir.models` for easy imports

**For More Details:** See [docs/mapping/](docs/mapping/) for comprehensive field-level mapping documentation

## Installation

```bash
pip install ccda-to-fhir
```

Or with uv:

```bash
uv add ccda-to-fhir
```

## Supported C-CDA Templates

Based on the [HL7 C-CDA on FHIR](https://build.fhir.org/ig/HL7/ccda-on-fhir/) mapping specification:

### Document Level
- âœ… US Realm Header (2.16.840.1.113883.10.20.22.1.1)

### Clinical Statements
- âœ… Problem Concern Act (2.16.840.1.113883.10.20.22.4.3) â†’ Condition
- âœ… Problem Observation (2.16.840.1.113883.10.20.22.4.4) â†’ Condition
- âœ… Allergy Concern Act (2.16.840.1.113883.10.20.22.4.30) â†’ AllergyIntolerance
- âœ… Allergy Observation (2.16.840.1.113883.10.20.22.4.7) â†’ AllergyIntolerance
- âœ… Medication Activity (2.16.840.1.113883.10.20.22.4.16) â†’ MedicationRequest
- âœ… Immunization Activity (2.16.840.1.113883.10.20.22.4.52) â†’ Immunization
- âœ… Procedure Activity Procedure (2.16.840.1.113883.10.20.22.4.14) â†’ Procedure
- âœ… Procedure Activity Act (2.16.840.1.113883.10.20.22.4.12) â†’ Procedure
- âœ… Encounter Activity (2.16.840.1.113883.10.20.22.4.49) â†’ Encounter
- âœ… Result Organizer (2.16.840.1.113883.10.20.22.4.1) â†’ DiagnosticReport
- âœ… Result Observation (2.16.840.1.113883.10.20.22.4.2) â†’ Observation
- âœ… Vital Signs Organizer (2.16.840.1.113883.10.20.22.4.26) â†’ Observation (vital-signs)
- âœ… Vital Sign Observation (2.16.840.1.113883.10.20.22.4.27) â†’ Observation (vital-signs)
- âœ… Social History Observation (2.16.840.1.113883.10.20.22.4.38) â†’ Observation
- âœ… Smoking Status Observation (2.16.840.1.113883.10.20.22.4.78) â†’ Observation
- âœ… Pregnancy Observation (2.16.840.1.113883.10.20.15.3.8) â†’ Observation
- âœ… Note Activity (2.16.840.1.113883.10.20.22.4.202) â†’ DocumentReference

### Supporting Templates
- âœ… Author Participation (2.16.840.1.113883.10.20.22.4.119) â†’ Practitioner, PractitionerRole, Provenance
- âœ… Comment Activity (2.16.840.1.113883.10.20.22.4.64) â†’ Annotation (notes)
- âœ… Assessment Scale Observation (2.16.840.1.113883.10.20.22.4.69) â†’ Evidence
- âœ… Date of Diagnosis Act (2.16.840.1.113883.10.20.22.4.502) â†’ Extension

## Resource Mapping Summary

| C-CDA Section/Entry | FHIR Resource | Implementation |
|---------------------|---------------|----------------|
| Patient (recordTarget) | Patient | âœ… 100% (21/21 features) |
| Problems | Condition | âœ… 100% (16/16 features) |
| Allergies | AllergyIntolerance | âœ… 100% (15/15 features) |
| Medications | MedicationRequest, MedicationStatement | âœ… 100% (17/17 features) |
| Immunizations | Immunization | âœ… 100% (15/15 features) |
| Procedures | Procedure | âœ… 100% (14/14 features) |
| Results | DiagnosticReport, Observation | âœ… 100% (17/17 features) |
| Vital Signs | Observation (vital-signs) | âœ… 100% (17/17 features) |
| Social History | Observation | âœ… 100% (13/13 features) |
| Encounters | Encounter | âœ… 100% (15/15 features) |
| Notes | DocumentReference | âœ… 100% (14/14 features) |
| Authors/Performers | Practitioner, PractitionerRole, Provenance | âœ… 100% (19/19 features) |

**For detailed feature mapping:** See [docs/mapping/](docs/mapping/) for comprehensive field-level documentation

## Key Features

### Standards Compliance
- âœ… **100% HL7 C-CDA on FHIR IG v2.0.0 compliant** for implemented features
- âœ… **US Core profiles** (Patient, AllergyIntolerance, Condition, Observation, etc.)
- âœ… **FHIR R4 specification** with R4B compatibility

### Advanced Mapping Support
- âœ… **Complex nested structures**: Blood pressure components, pregnancy observations with EDD/gestational age/LMP
- âœ… **Complete provenance tracking**: Multi-author support with Provenance resources
- âœ… **Narrative preservation**: Section text/reference resolution to FHIR Narrative
- âœ… **Extension support**: US Core extensions (race, ethnicity, birthsex, tribal affiliation, sex parameter)
- âœ… **Body site qualifiers**: Laterality support for procedures and vital signs
- âœ… **SDOH categorization**: 44+ LOINC codes mapped to 15 SDOH domains
- âœ… **DiagnosticReport generation**: Result organizers with standalone observations
- âœ… **Reference ranges**: Complex vital signs reference range mapping
- âœ… **Negation handling**: No-known-allergy, refuted conditions, not-done procedures

### Data Type Coverage
- âœ… All standard C-CDA data types (CD, CE, PQ, IVL_TS, IVL_PQ, ED, etc.)
- âœ… Period-based effective times (effectivePeriod for time ranges)
- âœ… Encapsulated data (ED type â†’ valueAttachment via R5 backport extension)
- âœ… NullFlavor â†’ data-absent-reason mappings
- âœ… Qualifier support (body site laterality, etc.)

## Performance

- **Parsing speed**: ~50-100ms for typical C-CDA documents (1-10 sections)
- **Memory usage**: Proportional to document size; ~10-20MB for standard documents
- **Scalability**: Tested with documents up to 1000+ clinical statements
- **Bundle size**: Average 10-50 FHIR resources per C-CDA document

**Note**: Performance may vary based on document complexity, section count, and clinical statement density.

## Development

This project uses [uv](https://docs.astral.sh/uv/) for dependency management.

```bash
# Clone the repository
git clone https://github.com/nurra/ccda-to-fhir.git
cd ccda-to-fhir

# Install dependencies
uv sync --dev

# Run tests
uv run pytest

# Run linting
uv run ruff check .
uv run mypy src/
```

## License

MIT
