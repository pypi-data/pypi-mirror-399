[tool.poetry]
name = "python-eventflow"
version = "1.0.1"
description = "Production-ready event-driven architecture toolkit with Transactional Inbox/Outbox patterns"
authors = ["Parham Davari <parham.davarii@gmail.com>"]
license = "MIT"
readme = "README.md"
homepage = "https://github.com/parhamdavari/eventflow"
repository = "https://github.com/parhamdavari/eventflow"
documentation = "https://github.com/parhamdavari/eventflow"
packages = [{include = "eventflow"}]
keywords = ["event-driven", "microservices", "inbox", "outbox", "redis-streams", "reliable-messaging"]
classifiers = [
    "Development Status :: 5 - Production/Stable",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Topic :: Software Development :: Libraries :: Python Modules",
    "Topic :: System :: Distributed Computing",
]

[tool.poetry.dependencies]
python = "^3.10"
sqlalchemy = "^2.0"
redis = "^5.0"

[tool.poetry.group.dev.dependencies]
pytest = "^8.0"
pytest-asyncio = "^0.23"
pytest-cov = "^5.0"
mypy = "^1.9"
black = "^24.0"
ruff = "^0.3"
asyncpg = "^0.29"
aiosqlite = "^0.19"
bandit = {version = "^1.7", extras = ["toml"]}
pre-commit = "^4.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"

# =============================================================================
# PYTEST CONFIGURATION
# =============================================================================
[tool.pytest.ini_options]
asyncio_mode = "auto"
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = ["-ra", "-q", "--strict-markers"]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests requiring external services",
]

# =============================================================================
# MYPY CONFIGURATION
# =============================================================================
[tool.mypy]
python_version = "3.10"
warn_return_any = true
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
check_untyped_defs = true
plugins = ["sqlalchemy.ext.mypy.plugin"]

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false
disallow_incomplete_defs = false

# =============================================================================
# BLACK CONFIGURATION
# =============================================================================
[tool.black]
line-length = 100
target-version = ["py310", "py311", "py312"]
include = '\.pyi?$'
extend-exclude = '''
/(
  \.git
  | \.mypy_cache
  | \.ruff_cache
  | \.venv
  | dist
  | build
)/
'''

# =============================================================================
# RUFF CONFIGURATION
# =============================================================================
[tool.ruff]
line-length = 100
target-version = "py310"
src = ["eventflow", "tests"]
exclude = [".git", ".mypy_cache", ".ruff_cache", ".venv", "dist", "build"]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort (import sorting)
    "N",      # pep8-naming
    "UP",     # pyupgrade
    "S",      # flake8-bandit (security)
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "DTZ",    # flake8-datetimez
    "T10",    # flake8-debugger
    "EM",     # flake8-errmsg
    "FA",     # flake8-future-annotations
    "ISC",    # flake8-implicit-str-concat
    "ICN",    # flake8-import-conventions
    "PIE",    # flake8-pie
    "PT",     # flake8-pytest-style
    "Q",      # flake8-quotes
    "RSE",    # flake8-raise
    "RET",    # flake8-return
    "SIM",    # flake8-simplify
    "TID",    # flake8-tidy-imports
    "TCH",    # flake8-type-checking
    "ARG",    # flake8-unused-arguments
    "PTH",    # flake8-use-pathlib
    "PL",     # Pylint
    "TRY",    # tryceratops
    "PERF",   # Perflint
    "RUF",    # Ruff-specific rules
]
ignore = [
    "E501",    # Line too long (handled by Black)
    "S101",    # Use of assert (needed for pytest)
    "COM812",  # Missing trailing comma (conflicts with Black)
    "ISC001",  # Single-line implicit string concat (conflicts with Black)
    "PLR0913", # Too many arguments
    "PLR2004", # Magic value comparison
    "TRY003",  # Avoid specifying long messages outside exception class
    "TRY300",  # Consider moving statement to else block
    "TRY400",  # Use logging.exception instead of logging.error
    "TRY401",  # Redundant exception in logging.exception
    "EM101",   # Exception must not use a string literal
    "EM102",   # Exception must not use an f-string literal
    "BLE001",  # Do not catch blind exception
    "DTZ005",  # datetime.now() without tz - we use tz=timezone.utc
    "PTH123",  # open() should be replaced by Path.open()
    "UP007",   # Use X | Y for type union (requires 3.10+ only syntax)
    "TCH001",  # Move application import into type-checking block
    "TCH002",  # Move third-party import into type-checking block
    "TCH003",  # Move standard library import into type-checking block
    "PERF203", # try-except in loop (performance overhead acceptable here)
]
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = ["S101", "PLR2004", "ARG", "SLF001", "DTZ"]
"tests/conftest.py" = ["S101", "PLR2004", "ARG", "SLF001"]
"__init__.py" = ["F401"]

[tool.ruff.lint.isort]
known-first-party = ["eventflow"]
force-single-line = false
lines-after-imports = 2

[tool.ruff.lint.flake8-pytest-style]
fixture-parentheses = true
mark-parentheses = true

# =============================================================================
# BANDIT SECURITY CONFIGURATION
# =============================================================================
[tool.bandit]
exclude_dirs = ["tests", ".venv"]
skips = ["B101"]

# =============================================================================
# COVERAGE CONFIGURATION
# =============================================================================
[tool.coverage.run]
source = ["eventflow"]
branch = true
omit = ["*/tests/*", "*/__init__.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstractmethod",
]
fail_under = 45
show_missing = true