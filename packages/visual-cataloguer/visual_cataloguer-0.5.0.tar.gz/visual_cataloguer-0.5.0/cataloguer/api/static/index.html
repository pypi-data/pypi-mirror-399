<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Cataloguer</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --warning: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        header h1 { font-size: 1.25rem; font-weight: 600; }
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .stats-bar span { display: flex; align-items: center; gap: 0.25rem; }
        .search-box {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .search-box input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .search-box button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }
        .search-box button:hover { background: var(--primary-dark); }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 2rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        .card {
            background: var(--card);
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: #f1f5f9;
        }
        .card-body { padding: 0.75rem; }
        .card-title {
            font-weight: 500;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            margin-top: 0.25rem;
        }
        .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        .badge-listed { background: #dcfce7; color: #166534; }
        .badge-review { background: #fef3c7; color: #92400e; }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card);
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { font-size: 1.125rem; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }
        .modal-body { padding: 1rem; }
        .modal-img {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            background: #f1f5f9;
            border-radius: 0.5rem;
        }
        .form-group { margin-top: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .box-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
        }
        .box-card:hover { border-color: var(--primary); }
        .box-card.active {
            border-color: var(--primary);
            background: #eff6ff;
        }
        .box-card h3 { font-size: 1rem; margin-bottom: 0.25rem; }
        .box-card span { color: var(--text-muted); font-size: 0.875rem; }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        .tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        @media (max-width: 640px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .boxes-grid { grid-template-columns: 1fr; }
            .filters { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 0.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Visual Cataloguer</h1>
            <div class="stats-bar" id="stats">
                <span>Loading...</span>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="tabs">
            <button class="tab active" data-tab="items">Items</button>
            <button class="tab" data-tab="boxes">Boxes</button>
        </div>

        <div id="items-view">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search items...">
                <button onclick="searchItems()">Search</button>
            </div>

            <div class="filters" id="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="unlisted">Unlisted</button>
                <button class="filter-btn" data-filter="review">Needs Review</button>
            </div>

            <div class="grid" id="items-grid"></div>
            <div class="pagination" id="pagination"></div>
        </div>

        <div id="boxes-view" style="display: none;">
            <div class="boxes-grid" id="boxes-grid"></div>
            <h3 id="box-title" style="margin-bottom: 1rem;"></h3>
            <div class="grid" id="box-items-grid"></div>
        </div>
    </main>

    <div class="modal" id="item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Item Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <img class="modal-img" id="modal-img" src="" alt="Item image">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="modal-title-input">
                </div>
                <div class="form-group">
                    <label>Platform</label>
                    <input type="text" id="modal-platform">
                </div>
                <div class="form-group">
                    <label>Completeness</label>
                    <select id="modal-completeness">
                        <option value="unknown">Unknown</option>
                        <option value="loose">Loose</option>
                        <option value="boxed">Boxed</option>
                        <option value="partial">Partial</option>
                        <option value="complete_set">Complete Set</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>OCR Text (read-only)</label>
                    <textarea id="modal-ocr" readonly style="background: #f8fafc;"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveItem()">Save Changes</button>
                    <button class="btn btn-success" id="mark-listed-btn" onclick="markListed()">Mark as Listed</button>
                    <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentFilter = 'all';
        let currentSearch = '';
        let currentItem = null;
        let currentBox = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadItems();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    document.getElementById('items-view').style.display = tabName === 'items' ? 'block' : 'none';
                    document.getElementById('boxes-view').style.display = tabName === 'boxes' ? 'block' : 'none';
                    if (tabName === 'boxes') loadBoxes();
                });
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    currentPage = 1;
                    loadItems();
                });
            });

            // Search on Enter
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchItems();
            });

            // Modal click outside
            document.getElementById('item-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stats').innerHTML = `
                    <span><strong>${stats.total_items}</strong> items</span>
                    <span><strong>${stats.total_boxes}</strong> boxes</span>
                    <span><strong>${stats.needs_review}</strong> need review</span>
                    <span><strong>${stats.ebay_listed}</strong> listed</span>
                `;
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function loadItems() {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                let url = '/api/items';
                const params = new URLSearchParams({ page: currentPage, per_page: 24 });

                if (currentFilter === 'unlisted') {
                    url = '/api/items/unlisted';
                } else if (currentFilter === 'review') {
                    params.set('needs_review', 'true');
                }

                if (currentSearch) {
                    url = '/api/search';
                    params.set('q', currentSearch);
                }

                const res = await fetch(`${url}?${params}`);
                const data = await res.json();
                const items = data.items || data.results || [];

                if (items.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No items found</div>';
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                grid.innerHTML = items.map(item => `
                    <div class="card" onclick="openItem(${item.item_id})">
                        <img class="card-img" src="/api/items/${item.item_id}/image/thumb"
                             alt="${item.title_manual || item.title_guess || 'Item'}"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f1f5f9%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22>No Image</text></svg>'">
                        <div class="card-body">
                            <div class="card-title">${item.title_manual || item.title_guess || 'Unknown'}</div>
                            <div class="card-meta">
                                <span>${item.platform_manual || item.platform_guess || '?'}</span>
                                ${item.ebay_listed ? '<span class="badge badge-listed">Listed</span>' : ''}
                                ${item.needs_review ? '<span class="badge badge-review">Review</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                renderPagination(data.total, data.page, data.per_page);
            } catch (e) {
                console.error('Failed to load items:', e);
                grid.innerHTML = '<div class="empty-state">Failed to load items</div>';
            }
        }

        function renderPagination(total, page, perPage) {
            const pages = Math.ceil(total / perPage);
            const pagination = document.getElementById('pagination');

            if (pages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button ${page <= 1 ? 'disabled' : ''} onclick="goToPage(${page - 1})">Prev</button>
            `;

            for (let i = 1; i <= Math.min(pages, 5); i++) {
                html += `<button class="${i === page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (pages > 5) {
                html += `<span>...</span><button onclick="goToPage(${pages})">${pages}</button>`;
            }

            html += `<button ${page >= pages ? 'disabled' : ''} onclick="goToPage(${page + 1})">Next</button>`;

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadItems();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function searchItems() {
            currentSearch = document.getElementById('search-input').value;
            currentPage = 1;
            loadItems();
        }

        async function loadBoxes() {
            const grid = document.getElementById('boxes-grid');
            grid.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const res = await fetch('/api/boxes');
                const data = await res.json();

                if (data.boxes.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No boxes found</div>';
                    return;
                }

                grid.innerHTML = data.boxes.map(box => `
                    <div class="box-card ${currentBox === box.box_id ? 'active' : ''}"
                         onclick="selectBox('${box.box_id}')">
                        <h3>${box.box_id}</h3>
                        <span>${box.item_count} items</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load boxes:', e);
                grid.innerHTML = '<div class="empty-state">Failed to load boxes</div>';
            }
        }

        async function selectBox(boxId) {
            currentBox = boxId;
            loadBoxes(); // Refresh to show active state

            const grid = document.getElementById('box-items-grid');
            document.getElementById('box-title').textContent = `Items in ${boxId}`;
            grid.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const res = await fetch(`/api/boxes/${boxId}/items?per_page=50`);
                const data = await res.json();

                if (data.items.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No items in this box</div>';
                    return;
                }

                grid.innerHTML = data.items.map(item => `
                    <div class="card" onclick="openItem(${item.item_id})">
                        <img class="card-img" src="/api/items/${item.item_id}/image/thumb"
                             alt="${item.title_manual || item.title_guess || 'Item'}"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f1f5f9%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2394a3b8%22>No Image</text></svg>'">
                        <div class="card-body">
                            <div class="card-title">${item.title_manual || item.title_guess || 'Unknown'}</div>
                            <div class="card-meta">
                                <span>${item.platform_manual || item.platform_guess || '?'}</span>
                                ${item.ebay_listed ? '<span class="badge badge-listed">Listed</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load box items:', e);
                grid.innerHTML = '<div class="empty-state">Failed to load items</div>';
            }
        }

        async function openItem(itemId) {
            try {
                const res = await fetch(`/api/items/${itemId}`);
                currentItem = await res.json();

                document.getElementById('modal-title').textContent =
                    currentItem.title_manual || currentItem.title_guess || `Item #${itemId}`;
                document.getElementById('modal-img').src = `/api/items/${itemId}/image/full`;
                document.getElementById('modal-title-input').value =
                    currentItem.title_manual || currentItem.title_guess || '';
                document.getElementById('modal-platform').value =
                    currentItem.platform_manual || currentItem.platform_guess || '';
                document.getElementById('modal-completeness').value = currentItem.completeness || 'unknown';
                document.getElementById('modal-notes').value = currentItem.notes || '';
                document.getElementById('modal-ocr').value = currentItem.ocr_text_raw || '';

                const listedBtn = document.getElementById('mark-listed-btn');
                if (currentItem.ebay_listed) {
                    listedBtn.textContent = 'Already Listed';
                    listedBtn.disabled = true;
                } else {
                    listedBtn.textContent = 'Mark as Listed';
                    listedBtn.disabled = false;
                }

                document.getElementById('item-modal').classList.add('open');
            } catch (e) {
                console.error('Failed to load item:', e);
                alert('Failed to load item details');
            }
        }

        function closeModal() {
            document.getElementById('item-modal').classList.remove('open');
            currentItem = null;
        }

        async function saveItem() {
            if (!currentItem) return;

            try {
                const res = await fetch(`/api/items/${currentItem.item_id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title_manual: document.getElementById('modal-title-input').value || null,
                        platform_manual: document.getElementById('modal-platform').value || null,
                        completeness: document.getElementById('modal-completeness').value,
                        notes: document.getElementById('modal-notes').value || null,
                    }),
                });

                if (res.ok) {
                    closeModal();
                    loadItems();
                    loadStats();
                } else {
                    alert('Failed to save changes');
                }
            } catch (e) {
                console.error('Failed to save item:', e);
                alert('Failed to save changes');
            }
        }

        async function markListed() {
            if (!currentItem) return;

            try {
                const res = await fetch(`/api/items/${currentItem.item_id}/mark-listed`, {
                    method: 'PATCH',
                });

                if (res.ok) {
                    closeModal();
                    loadItems();
                    loadStats();
                } else {
                    alert('Failed to mark as listed');
                }
            } catch (e) {
                console.error('Failed to mark as listed:', e);
                alert('Failed to mark as listed');
            }
        }
    </script>
</body>
</html>
