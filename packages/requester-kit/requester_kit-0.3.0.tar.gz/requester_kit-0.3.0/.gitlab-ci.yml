include:
  - project: devops1/shared/ci
    ref: release/1.0
    file: image/kaniko.template.yaml

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^hotfix-.*/
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"
      when: never
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

.rules:
  only_main_branch:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never
  only_mr:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  always_but_not_mr_and_hotfix_or_scheduled:
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^hotfix-.*/ && $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: always
  hotfix:
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^hotfix-.*/ && $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: never

Hotfix:
  stage: hotfix
  script:
    - exit 0
  rules:
    - !reference [.rules, hotfix]

before_script:
  - echo -e "\e[0Ksection_start:`date +%s`:envs[collapsed=true]\r\e[0KJob environment variables"
  - printenv | sort
  - echo -e "\e[0Ksection_end:`date +%s`:envs\r\e[0K"

stages:
- hotfix
- build
- check
- coverage
- approve
- publish


variables:
  BUILT_IMAGE_REGISTRY_URL: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}"

# ================================================
#           BUILD
# ================================================

Build:
  stage: build
  variables:
    IMAGE_NAME: ""
    IMAGE_TAG: $CI_COMMIT_SHORT_SHA
    DOCKERFILE: ${CI_PROJECT_DIR}/.ci/Dockerfile
    CONTEXT: ${CI_PROJECT_DIR}
  extends:
    - .image:kaniko
  interruptible: true
  tags:
    - k8s-s-medium
  rules:
    - !reference [ .rules, always_but_not_mr_and_hotfix_or_scheduled ]


.base_dependencies: &base_dependencies
  image: ${BUILT_IMAGE_REGISTRY_URL}
  rules:
    - !reference [ .rules, only_mr ]
  dependencies:
    - Build
  interruptible: true

# ================================================
#           LINTERS
# ================================================


linters:
  <<: *base_dependencies
  stage: check
  script:
    - ruff check .
    - ruff format --check .
    - mypy .


# ================================================
#           TESTS
# ================================================

tests:
  <<: *base_dependencies
  stage: check
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  script:
    - mkdir reports
    - pytest . --force-sugar --color=yes -ra --cov=. --cov-report=xml:coverage.xml --cov-report term-missing --junitxml=pytest-junit.xml --cov-fail-under=100 --no-cov-on-fail
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    name: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME-$CI_JOB_NAME"
    paths:
      - coverage.xml
    expire_in: 2 days
    reports:
      junit: pytest-junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# ================================================
#           VERSION CHECK
# ================================================

check_version:
  <<: *base_dependencies
  stage: check
  variables:
    PYPI_URL: $CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/pypi/simple/$CI_PROJECT_NAME
  script:
    - CUR_VERSION=$(grep -m 1 version pyproject.toml | tr -s ' ' | tr -d '"' | tr -d "'" | cut -d' ' -f3)
    - VERSIONS=$(curl --fail-with-body $PYPI_URL)
    - | 
      if [[ $VERSIONS =~ -$CUR_VERSION ]]; then
        echo "You must bump $CI_PROJECT_NAME version"
        exit 1
      fi


# ================================================
#           PUBLISH
# ================================================

publish:
  stage: publish
  extends: .base_dependencies
  variables:
    PYPI_USERNAME: gitlab-ci-token
    PYPI_PASSWORD: $CI_JOB_TOKEN
    PYPI_REGISTRY_ID: $CI_PROJECT_ID
    PYPI_URL: $CI_API_V4_URL/projects/$PYPI_REGISTRY_ID/packages/pypi
  script:
    - rye build
    - rye publish --repository av-pypi --repository-url $PYPI_URL --token $PYPI_PASSWORD --username $PYPI_USERNAME --yes
  rules:
    - !reference [ .rules, only_main_branch ]