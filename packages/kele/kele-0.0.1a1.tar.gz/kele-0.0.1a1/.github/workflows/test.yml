name: Test

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  push:
    branches: ["**"]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number || github.ref }}
  cancel-in-progress: ${{ vars.CANCEL_IN_PROGRESS == 'true' }}

jobs:
  precheck:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.cmd.outputs.run }}
      suite: ${{ steps.cmd.outputs.suite }}
      repo: ${{ steps.pr.outputs.repo }}
      sha: ${{ steps.pr.outputs.sha }}
      base_repo: ${{ steps.pr.outputs.base_repo }}
      base_ref: ${{ steps.pr.outputs.base_ref }}
      base_sha: ${{ steps.pr.outputs.base_sha }}

    steps:
      - name: Only allow trusted users (optional but recommended)
        if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request }}
        run: |
          assoc="${{ github.event.comment.author_association }}"
          case "$assoc" in
            OWNER|MEMBER|COLLABORATOR) exit 0 ;;
            *) echo "Not allowed: $assoc"; exit 1 ;;
          esac

      - id: cmd
        run: |
          # 默认：不跑
          echo "run=false" >> "$GITHUB_OUTPUT"
          echo "suite="    >> "$GITHUB_OUTPUT"

          # 只处理 PR 评论触发
          pr_url='${{ github.event.issue.pull_request.url }}'
          if [ -z "$pr_url" ]; then
            exit 0
          fi

          body='${{ github.event.comment.body }}'

          # 支持：@testbot all / @testbot example / @testbot pytest
          if echo "$body" | grep -Eiq '(^|[^[:alnum:]_])@testbot[[:space:]]+all([^[:alnum:]_]|$)'; then
            echo "run=true"  >> "$GITHUB_OUTPUT"
            echo "suite=test_all" >> "$GITHUB_OUTPUT"
          elif echo "$body" | grep -Eiq '(^|[^[:alnum:]_])@testbot[[:space:]]+example([^[:alnum:]_]|$)'; then
            echo "run=true"  >> "$GITHUB_OUTPUT"
            echo "suite=example" >> "$GITHUB_OUTPUT"
          elif echo "$body" | grep -Eiq '(^|[^[:alnum:]_])@testbot[[:space:]]+pytest([^[:alnum:]_]|$)'; then
            echo "run=true"  >> "$GITHUB_OUTPUT"
            echo "suite=pytest" >> "$GITHUB_OUTPUT"
          fi

      - id: pr
        if: steps.cmd.outputs.run == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            core.setOutput('repo', pr.head.repo.full_name);
            core.setOutput('sha', pr.head.sha);
            core.setOutput('base_repo', pr.base.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('base_sha', pr.base.sha);

  pytest:
    needs: precheck
    if: ${{
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
      || (github.event_name == 'push' && contains(join(github.event.commits.*.message, ' '), '[pytest]'))
      || (github.event_name == 'push' && contains(join(github.event.commits.*.message, ' '), '[test_all]'))
      || (github.event_name == 'pull_request' && !github.event.pull_request.draft)
      || (github.event_name == 'issue_comment' && needs.precheck.outputs.run == 'true'
      && (needs.precheck.outputs.suite == 'test_all' || needs.precheck.outputs.suite == 'pytest'))
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (PR head for issue_comment)
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/checkout@v6
        with:
          repository: ${{ needs.precheck.outputs.repo }}
          ref: ${{ needs.precheck.outputs.sha }}
          fetch-depth: 1

      - name: Checkout (normal)
        if: ${{ github.event_name != 'issue_comment' }}
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: 3.13
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group dev

      - name: Build Rust extension
        run: uv run maturin develop --skip-install

      - name: Run pytest
        env:
          RUN_INIT_VALIDATION_IN_FROM_PARTS: true
        run: |
          if uv run --no-sync python -c "import xdist" >/dev/null 2>&1; then
            uv run --no-sync pytest -n auto --dist loadscope
          else
            uv run --no-sync pytest
          fi

  example_static:
    needs: precheck
    if: ${{
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
      || (github.event_name == 'push' && contains(join(github.event.commits.*.message, ' '), '[test_all]'))
      || (github.event_name == 'push' && contains(join(github.event.commits.*.message, ' '), '[example]'))
      || (github.event_name == 'pull_request' && !github.event.pull_request.draft)
      || (github.event_name == 'issue_comment' && needs.precheck.outputs.run == 'true'
      && (needs.precheck.outputs.suite == 'test_all' || needs.precheck.outputs.suite == 'example'))
      }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout (current) - issue_comment
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/checkout@v6
        with:
          path: curr
          fetch-depth: 1
          repository: ${{ needs.precheck.outputs.repo }}
          ref: ${{ needs.precheck.outputs.sha }}

      - name: Checkout (current) - normal
        if: ${{ github.event_name != 'issue_comment' }}
        uses: actions/checkout@v6
        with:
          path: curr
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Checkout (base) - issue_comment
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/checkout@v6
        with:
          path: base
          fetch-depth: 1
          repository: ${{ needs.precheck.outputs.base_repo }}
          ref: ${{ needs.precheck.outputs.base_sha }}

      - name: Checkout (base) - normal
        if: ${{ github.event_name != 'issue_comment' }}
        uses: actions/checkout@v6
        with:
          path: base
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || 'main' }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: 3.13
          enable-cache: true

      - name: Install dependencies (current)
        working-directory: curr
        run: uv sync

      - name: Build Rust extension (current)
        working-directory: curr
        run: uv run maturin develop --skip-install
        
      - name: Run examples static (current)
        working-directory:  "."
        timeout-minutes: 3
        id: curr_static
        continue-on-error: true
        shell: bash
        run: |
          set +e
          bash curr/_scripts/ci/run_examples_static_ci.sh curr curr_static.log
          code=$?
          set -e
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code

      - name: Install dependencies (base/main)
        working-directory: base
        run: uv sync

      - name: Build Rust extension (base/main)
        working-directory: base
        run: uv run maturin develop --skip-install

      - name: Run examples static (base/main)
        working-directory: "."
        timeout-minutes: 3
        id: base_static
        continue-on-error: true
        shell: bash
          # HACK: 等主线有了之后，run这里目录换base,然后就可以设置工作路径了
        run: |
          set +e
          bash curr/_scripts/ci/run_examples_static_ci.sh base base_static.log
          code=$?
          set -e
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit $code

      - name: Resolve PR number
        id: prnum
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Collect SHAs
        id: shas
        shell: bash
        run: |
          echo "curr_sha=$(cd curr && git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "base_sha=$(cd base && git rev-parse HEAD)" >> "$GITHUB_OUTPUT"


      - name: Build PR comment body
        if: ${{ always() && (github.event_name == 'pull_request' || github.event_name == 'issue_comment') }}
        shell: bash
        run: |
          python3 curr/_scripts/ci/examples_static_comment.py \
            --curr-log curr_static.log \
            --base-log base_static.log \
            --curr-sha "${{ steps.shas.outputs.curr_sha }}" \
            --base-sha "${{ steps.shas.outputs.base_sha }}" \
            --base-ref "${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || needs.precheck.outputs.base_ref }}" \
            --curr-exit "${{ steps.curr_static.outputs.exit_code }}" \
            --base-exit "${{ steps.base_static.outputs.exit_code }}" \
            --out pr_comment.md

      - name: Find existing PR comment
        if: ${{ always() && (github.event_name == 'pull_request' || github.event_name == 'issue_comment') }}
        id: fc
        uses: peter-evans/find-comment@v4
        with:
          issue-number: ${{ steps.prnum.outputs.number }}
          body-includes: "<!-- examples-static-report -->"

      - name: Create PR comment (first time)
        if: ${{ always() && (github.event_name == 'pull_request' || github.event_name == 'issue_comment') && steps.fc.outputs.comment-id == '' }}
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ steps.prnum.outputs.number }}
          body-path: pr_comment.md

      - name: Update PR comment (reruns)
        if: ${{ always() && (github.event_name == 'pull_request' || github.event_name == 'issue_comment') && steps.fc.outputs.comment-id != '' }}
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          body-path: pr_comment.md
          edit-mode: replace
