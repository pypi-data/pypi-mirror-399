name: Dependabot Poetry Lock Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  fix-poetry-lock:
    # Only run for dependabot PRs that have merge conflicts
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check for merge conflicts
        id: check_conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const mergeable = prData.mergeable;
            const mergeableState = prData.mergeable_state;

            console.log(`Mergeable: ${mergeable}`);
            console.log(`Mergeable State: ${mergeableState}`);

            // Check if there are conflicts
            const hasConflicts = mergeable === false || mergeableState === 'dirty';

            core.setOutput('has_conflicts', hasConflicts);
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_base', pr.base.ref);
            core.setOutput('pr_head', pr.head.ref);

            return hasConflicts;

      - name: Checkout PR branch
        if: steps.check_conflicts.outputs.has_conflicts == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check_conflicts.outputs.pr_head }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        if: steps.check_conflicts.outputs.has_conflicts == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Attempt merge and check conflict files
        if: steps.check_conflicts.outputs.has_conflicts == 'true'
        id: merge_check
        run: |
          # Fetch base branch
          git fetch origin ${{ steps.check_conflicts.outputs.pr_base }}

          # Attempt merge
          if git merge origin/${{ steps.check_conflicts.outputs.pr_base }} --no-commit --no-ff; then
            echo "No conflicts found"
            echo "poetry_conflict=false" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
            exit 0
          fi

          # Get list of conflicted files
          conflicted_files=$(git diff --name-only --diff-filter=U)
          echo "Conflicted files:"
          echo "$conflicted_files"

          # Check if conflicts are only in poetry files
          poetry_only=true
          while IFS= read -r file; do
            if [[ "$file" != "pyproject.toml" && "$file" != "poetry.lock" ]]; then
              poetry_only=false
              break
            fi
          done <<< "$conflicted_files"

          echo "poetry_conflict=$poetry_only" >> $GITHUB_OUTPUT

          # Abort merge for now
          git merge --abort

      - name: Set up Python
        if: steps.merge_check.outputs.poetry_conflict == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Poetry
        if: steps.merge_check.outputs.poetry_conflict == 'true'
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Resolve Poetry conflicts
        if: steps.merge_check.outputs.poetry_conflict == 'true'
        id: resolve
        run: |
          # Get PR title to extract package and version
          pr_title="${{ github.event.pull_request.title }}"
          echo "PR Title: $pr_title"

          # Re-attempt merge
          git fetch origin ${{ steps.check_conflicts.outputs.pr_base }}
          git merge origin/${{ steps.check_conflicts.outputs.pr_base }} --no-commit --no-ff || true

          # Accept base branch version of both files
          git checkout --theirs pyproject.toml
          git checkout --theirs poetry.lock

          # Extract package name and version from PR title
          # Dependabot format: "deps-dev: bump package from X.Y.Z to A.B.C"
          if [[ "$pr_title" =~ bump\ ([^\ ]+)\ from\ [^\ ]+\ to\ ([^\ ]+) ]]; then
            package="${BASH_REMATCH[1]}"
            version="${BASH_REMATCH[2]}"
            echo "Package: $package"
            echo "Version: $version"

            # Update the specific package version in pyproject.toml
            # Handle both formats: "package = "^X.Y.Z"" and "package = { version = "^X.Y.Z" }"
            if grep -q "^${package} = \"" pyproject.toml; then
              sed -i "s/^${package} = \".*\"/${package} = \"^${version}\"/" pyproject.toml
            elif grep -q "^${package} = {" pyproject.toml; then
              # More complex format with extras, version, etc.
              # For now, just update the simple case
              sed -i "s/^${package} = \".*\"/${package} = \"^${version}\"/" pyproject.toml
            fi

            echo "Updated $package to ^$version in pyproject.toml"
          else
            echo "Could not parse package/version from PR title"
            exit 1
          fi

          # Configure poetry to use local venv
          poetry config virtualenvs.in-project true

          # CRITICAL: Always regenerate lock file after pyproject.toml changes
          # This ensures dependency resolution is correct and consistent
          echo "üîÑ Regenerating poetry.lock..."
          poetry lock

          # Verify poetry install works with the new lock file
          echo "üì¶ Installing dependencies to verify lock file..."
          if ! poetry install; then
            echo "‚ùå ERROR: poetry install failed with the new lock file"
            echo "This indicates a dependency resolution issue"
            exit 1
          fi

          echo "‚úÖ poetry install succeeded - dependencies are correctly resolved"

          # Add resolved files
          git add pyproject.toml poetry.lock

          # Commit resolution
          git commit -m "chore(deps): resolve merge conflict - update to ${package} ${version}"

          echo "package=${package}" >> $GITHUB_OUTPUT
          echo "version=${version}" >> $GITHUB_OUTPUT

      - name: Run quality checks
        if: steps.resolve.outputs.package != ''
        run: |
          poetry run make quality

      - name: Run tests
        if: steps.resolve.outputs.package != ''
        run: |
          poetry run make test

      - name: Push resolution
        if: steps.resolve.outputs.package != ''
        run: |
          git push origin ${{ steps.check_conflicts.outputs.pr_head }}

      - name: Comment on PR
        if: steps.resolve.outputs.package != ''
        uses: actions/github-script@v7
        with:
          script: |
            const package = '${{ steps.resolve.outputs.package }}';
            const version = '${{ steps.resolve.outputs.version }}';
            const prNumber = ${{ steps.check_conflicts.outputs.pr_number }};

            const commentBody = [
              '‚úÖ **Poetry lock conflict automatically resolved**',
              '',
              `**Package**: \`${package}\``,
              `**Version**: \`${version}\``,
              '',
              '**Resolution steps**:',
              '1. ‚úÖ Merged latest base branch',
              '2. ‚úÖ Updated `pyproject.toml` with new package version',
              '3. ‚úÖ Regenerated `poetry.lock`',
              '4. ‚úÖ All quality checks passed (Black, Ruff, mypy, Bandit)',
              '5. ‚úÖ All tests passed (85%+ coverage)',
              '',
              '**Next steps**: The PR is ready for review and merge.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Create issue for manual resolution
        if: steps.check_conflicts.outputs.has_conflicts == 'true' && steps.merge_check.outputs.poetry_conflict != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.check_conflicts.outputs.pr_number }};
            const prUrl = '${{ github.event.pull_request.html_url }}';

            const issueBody = [
              '‚ö†Ô∏è **Merge conflicts require manual resolution**',
              '',
              `PR #${prNumber} has merge conflicts that extend beyond \`pyproject.toml\` and \`poetry.lock\`.`,
              '',
              '**Action required**: Please resolve conflicts manually.',
              '',
              `**PR**: ${prUrl}`
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Manual resolution needed for PR #${prNumber}`,
              body: issueBody,
              labels: ['dependencies', 'needs-review']
            });