"""Tests for the GAMESS-US formats."""

from io import StringIO

import numpy as np
import pytest

from ase import units
from ase.io.gamess_us import read_gamess_us_out, read_gamess_us_punch

BUF_OUT = r"""
 ATOM      ATOMIC                      COORDINATES (BOHR)
           CHARGE         X                   Y                   Z
 O           8.0     0.0000000000        0.0000000000        0.2253725007
 H           1.0     0.0000000000        1.4423125731       -0.9014881133
 H           1.0     0.0000000000       -1.4423125731       -0.9014881133

...

 FINAL RHF ENERGY IS      -75.9834173703 AFTER  10 ITERATIONS

...

          TOTAL MULLIKEN AND LOWDIN ATOMIC POPULATIONS
       ATOM         MULL.POP.    CHARGE          LOW.POP.     CHARGE
    1 O             8.792441   -0.792441         8.584488   -0.584488
    2 H             0.603779    0.396221         0.707756    0.292244
    3 H             0.603779    0.396221         0.707756    0.292244

...

         DX          DY          DZ         /D/  (DEBYE)
     0.000000    0.000000   -2.643157    2.643157

...

                         ----------------------
                         GRADIENT OF THE ENERGY
                         ----------------------

 UNITS ARE HARTREE/BOHR    E'X               E'Y               E'Z
    1 O                0.000000000       0.000000000       0.036558632
    2 H                0.000000000       0.003968070      -0.018279316
    3 H                0.000000000      -0.003968070      -0.018279316
"""

BUF_PUNCH = r"""
 $DATA
H2O
C1       0
O           8.0      0.0000000000      0.0000000000      0.1192620000
   N31     6

H           1.0      0.0000000000      0.7632390000     -0.4770470000
   N31     6

H           1.0      0.0000000000     -0.7632390000     -0.4770470000
   N31     6

 $END
--- CLOSED SHELL ORBITALS --- GENERATED AT 14:01:23 23-JUL-2025
H2O
E(RHF)=      -75.9834173703, E(NUC)=    9.0882944273,   10 ITERS
 $VEC
 1  1 9.95792696E-01 2.19067631E-02 0.00000000E+00 0.00000000E+00-2.08753673E-03
 1  2-7.98385184E-03 0.00000000E+00 0.00000000E+00 1.95293513E-03 1.45164194E-04
 1  3 1.94683172E-03 1.45164194E-04 1.94683172E-03
 2  1-2.12654668E-01 4.69479594E-01 0.00000000E+00 0.00000000E+00-1.09295667E-01
 2  2 4.83347624E-01 0.00000000E+00 0.00000000E+00-6.13467020E-02 1.37414587E-01
 2  3-7.74670264E-03 1.37414587E-01-7.74670264E-03
 3  1 0.00000000E+00 0.00000000E+00 0.00000000E+00 5.04309088E-01 0.00000000E+00
 3  2 0.00000000E+00 0.00000000E+00 2.73159247E-01 0.00000000E+00 2.61003726E-01
 3  3 1.26683661E-01-2.61003726E-01-1.26683661E-01
 4  1-7.57314481E-02 1.81049578E-01 0.00000000E+00 0.00000000E+00 5.48668801E-01
 4  2 3.05137157E-01 0.00000000E+00 0.00000000E+00 4.01927087E-01-1.45043414E-01
 4  3-8.34985900E-02-1.45043414E-01-8.34985900E-02
 5  1 0.00000000E+00 0.00000000E+00 6.42148917E-01 0.00000000E+00 0.00000000E+00
 5  2 0.00000000E+00 5.09430600E-01 0.00000000E+00 0.00000000E+00 0.00000000E+00
 5  3 0.00000000E+00 0.00000000E+00 0.00000000E+00
 6  1-8.46373490E-02 1.04497658E-01 0.00000000E+00 0.00000000E+00-2.35693314E-01
 6  2 1.16072249E+00 0.00000000E+00 0.00000000E+00-4.79562056E-01-5.99204459E-02
 6  3-9.83222833E-01-5.99204459E-02-9.83222833E-01
 7  1 0.00000000E+00 0.00000000E+00 0.00000000E+00 3.41392066E-01 0.00000000E+00
 7  2 0.00000000E+00 0.00000000E+00 8.18281820E-01 0.00000000E+00-4.58845196E-02
 7  3-1.36373599E+00 4.58845196E-02 1.36373599E+00
 8  1 0.00000000E+00 0.00000000E+00 0.00000000E+00-1.16238405E-01 0.00000000E+00
 8  2 0.00000000E+00 0.00000000E+00-7.00309850E-01 0.00000000E+00 9.73322230E-01
 8  3-5.26994386E-01-9.73322230E-01 5.26994386E-01
 9  1 0.00000000E+00 0.00000000E+00-9.61088530E-01 0.00000000E+00 0.00000000E+00
 9  2 0.00000000E+00 1.03755812E+00 0.00000000E+00 0.00000000E+00 0.00000000E+00
 9  3 0.00000000E+00 0.00000000E+00 0.00000000E+00
10  1 5.41781710E-02-2.80318080E-01 0.00000000E+00 0.00000000E+00 6.35756396E-01
10  2 2.01127580E-01 0.00000000E+00 0.00000000E+00-1.78479634E-01 8.59335229E-01
10  3-5.59706338E-01 8.59335229E-01-5.59706338E-01
11  1 6.70895626E-02-4.45666019E-01 0.00000000E+00 0.00000000E+00-7.47510117E-01
11  2 8.93183400E-02 0.00000000E+00 0.00000000E+00 1.18055952E+00 4.87600846E-01
11  3-5.51804944E-02 4.87600846E-01-5.51804944E-02
12  1 0.00000000E+00 0.00000000E+00 0.00000000E+00-1.03126302E+00 0.00000000E+00
12  2 0.00000000E+00 0.00000000E+00 1.54474826E+00 0.00000000E+00 7.33060458E-02
12  3-8.84603023E-01-7.33060458E-02 8.84603023E-01
13  1 5.38603772E-02-1.66584600E+00 0.00000000E+00 0.00000000E+00 2.08953346E-01
13  2 2.72446375E+00 0.00000000E+00 0.00000000E+00-8.73432339E-01-4.74496123E-01
13  3-5.96785888E-01-4.74496123E-01-5.96785888E-01
 $END
 POPULATION ANALYSIS
O            8.79244  -0.79244   8.58449  -0.58449
H            0.60378   0.39622   0.70776   0.29224
H            0.60378   0.39622   0.70776   0.29224
 MOMENTS AT POINT    1 X,Y,Z=  0.000000  0.000000  0.099260
 DIPOLE       0.000000  0.000000 -2.643157
 $GRAD
E=      -75.9834173703  GMAX=   0.0365586  GRMS=   0.0150418
O            8.    0.0000000000E+00    0.0000000000E+00    3.6558631877E-02
H            1.    0.0000000000E+00    3.9680702687E-03   -1.8279315939E-02
H            1.    0.0000000000E+00   -3.9680702687E-03   -1.8279315939E-02
 $END
 $VIB
         IVIB=   0 IATOM=   0 ICOORD=   0 E=      -75.9834173703
 0.000000000E+00 0.000000000E+00 3.655863188E-02 0.000000000E+00 3.968070269E-03
-1.827931594E-02 0.000000000E+00-3.968070269E-03-1.827931594E-02
 0.000000000E+00 5.643854273E-15-2.643157432E+00
 $END
"""


def test_read_gamess_us_out() -> None:
    """Test if a GAMESS-US output file can be parsed."""
    atoms = read_gamess_us_out(StringIO(BUF_OUT))
    assert str(atoms.symbols) == 'OH2'
    positions_ref = [
        [+0.000000, +0.000000, +0.119262],
        [+0.000000, +0.763239, -0.477047],
        [+0.000000, -0.763239, -0.477047],
    ]
    np.testing.assert_allclose(atoms.positions, positions_ref)
    assert not any(atoms.pbc)
    assert atoms.cell.rank == 0

    energy = atoms.get_potential_energy()
    assert energy == pytest.approx(-75.9834173703 * units.Ha)

    charges_ref = np.array([-0.792441, +0.396221, +0.396221])
    np.testing.assert_allclose(atoms.get_charges(), charges_ref)

    dipole_moment_ref = np.array([0.0, 0.0, -2.643157]) * units.Debye
    np.testing.assert_allclose(atoms.get_dipole_moment(), dipole_moment_ref)

    grad_ref = [
        [+0.000000000, +0.000000000, +0.036558632],
        [+0.000000000, +0.003968070, -0.018279316],
        [+0.000000000, -0.003968070, -0.018279316],
    ]
    forces_ref = -np.array(grad_ref) * units.Hartree / units.Bohr
    np.testing.assert_allclose(atoms.get_forces(), forces_ref)


def test_read_gamess_us_punch() -> None:
    """Test if a GAMESS-US PUNCH file can be parsed."""
    atoms = read_gamess_us_punch(StringIO(BUF_PUNCH))
    assert str(atoms.symbols) == 'OH2'
    positions_ref = [
        [+0.000000, +0.000000, +0.119262],
        [+0.000000, +0.763239, -0.477047],
        [+0.000000, -0.763239, -0.477047],
    ]
    np.testing.assert_allclose(atoms.positions, positions_ref)
    assert not any(atoms.pbc)
    assert atoms.cell.rank == 0

    energy = atoms.get_potential_energy()
    assert energy == pytest.approx(-75.9834173703 * units.Ha)

    charges_ref = np.array([-0.79244, +0.39622, +0.39622])
    np.testing.assert_allclose(atoms.get_charges(), charges_ref)

    dipole_moment_ref = np.array([0.0, 0.0, -2.643157]) * units.Debye
    np.testing.assert_allclose(atoms.get_dipole_moment(), dipole_moment_ref)

    grad_ref = [
        [0.0000000000e000, +0.0000000000e000, +3.6558631877e-02],
        [0.0000000000e000, +3.9680702687e-03, -1.8279315939e-02],
        [0.0000000000e000, -3.9680702687e-03, -1.8279315939e-02],
    ]
    forces_ref = -np.array(grad_ref) * units.Hartree / units.Bohr
    np.testing.assert_allclose(atoms.get_forces(), forces_ref)
