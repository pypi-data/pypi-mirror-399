name: Continuous Integration

# Universal CI/CD pipeline for MoAI-ADK projects
# Auto-detects: Python, Node.js, Go, Rust, Java, Ruby
# Triggers: Pull requests and pushes to main/develop branches

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop, main]

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-language:
    name: ðŸ” Detect Project Language
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.detect.outputs.python }}
      node: ${{ steps.detect.outputs.node }}
      go: ${{ steps.detect.outputs.go }}
      rust: ${{ steps.detect.outputs.rust }}
      java: ${{ steps.detect.outputs.java }}
      ruby: ${{ steps.detect.outputs.ruby }}
      primary_language: ${{ steps.detect.outputs.primary_language }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”Ž Auto-detect language
        id: detect
        run: |
          echo "ðŸ” Auto-detecting project language..."
          echo ""

          # Python detection
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
            echo "âœ… Python project detected"
            echo "python=true" >> $GITHUB_OUTPUT
            PRIMARY="python"
          else
            echo "python=false" >> $GITHUB_OUTPUT
          fi

          # Node.js detection
          if [ -f "package.json" ]; then
            echo "âœ… Node.js project detected"
            echo "node=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="node"
          else
            echo "node=false" >> $GITHUB_OUTPUT
          fi

          # Go detection
          if [ -f "go.mod" ]; then
            echo "âœ… Go project detected"
            echo "go=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="go"
          else
            echo "go=false" >> $GITHUB_OUTPUT
          fi

          # Rust detection
          if [ -f "Cargo.toml" ]; then
            echo "âœ… Rust project detected"
            echo "rust=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="rust"
          else
            echo "rust=false" >> $GITHUB_OUTPUT
          fi

          # Java detection
          if [ -f "pom.xml" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "âœ… Java project detected"
            echo "java=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="java"
          else
            echo "java=false" >> $GITHUB_OUTPUT
          fi

          # Ruby detection
          if [ -f "Gemfile" ]; then
            echo "âœ… Ruby project detected"
            echo "ruby=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="ruby"
          else
            echo "ruby=false" >> $GITHUB_OUTPUT
          fi

          # Set primary language
          if [ -z "$PRIMARY" ]; then
            echo "âš ï¸  No language detected, defaulting to generic checks"
            PRIMARY="generic"
          fi

          echo ""
          echo "âœ… Primary language: $PRIMARY"
          echo "primary_language=$PRIMARY" >> $GITHUB_OUTPUT

  code-quality-python:
    name: ðŸ Python Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.python == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."

          # Try pip install with pyproject.toml, setup.py, or requirements.txt
          if [ -f "pyproject.toml" ]; then
            pip install -e .[dev] || pip install -e . || true
          elif [ -f "setup.py" ]; then
            pip install -e . || true
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          fi

          # Install common linters (best-effort)
          pip install black ruff mypy bandit || true

      - name: ðŸŽ¨ Check code formatting (black)
        run: |
          echo "ðŸŽ¨ Checking Python code formatting..."
          black --check . --line-length=120 || echo "âš ï¸  Formatting issues found (non-blocking)"

      - name: ðŸ”§ Lint code (ruff)
        run: |
          echo "ðŸ”§ Linting Python code..."
          ruff check . || echo "âš ï¸  Linting issues found (non-blocking)"

      - name: ðŸ“ Type checking (mypy)
        run: |
          echo "ðŸ“ Type checking Python code..."
          mypy . --ignore-missing-imports || echo "âš ï¸  Type issues found (non-blocking)"

      - name: ðŸ” Security check (bandit)
        run: |
          echo "ðŸ” Security scanning Python code..."
          bandit -r . -ll || echo "âš ï¸  Security issues found (non-blocking)"

  code-quality-node:
    name: ðŸŸ¢ Node.js Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.node == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "ðŸ“¦ Installing Node.js dependencies..."
          npm ci || npm install || true

      - name: ðŸ”§ Lint code (ESLint)
        run: |
          echo "ðŸ”§ Linting JavaScript/TypeScript code..."
          npm run lint || npx eslint . || echo "âš ï¸  Linting issues found (non-blocking)"

      - name: ðŸŽ¨ Check formatting (Prettier)
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          npm run format:check || npx prettier --check . || echo "âš ï¸  Formatting issues found (non-blocking)"

      - name: ðŸ“ Type checking (TypeScript)
        run: |
          echo "ðŸ“ Type checking TypeScript..."
          npm run type-check || npx tsc --noEmit || echo "âš ï¸  Type issues found (non-blocking)"

  code-quality-go:
    name: ðŸ¹ Go Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.go == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: ðŸ”§ Format check (gofmt)
        run: |
          echo "ðŸ”§ Checking Go code formatting..."
          gofmt -l . | grep . && echo "âš ï¸  Formatting issues found" || echo "âœ… Format check passed"

      - name: ðŸ“ Lint code (golangci-lint)
        run: |
          echo "ðŸ“ Linting Go code..."
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run || echo "âš ï¸  Linting issues found (non-blocking)"

      - name: ðŸ” Vet code
        run: |
          echo "ðŸ” Running go vet..."
          go vet ./... || echo "âš ï¸  Vet issues found (non-blocking)"

  code-quality-rust:
    name: ðŸ¦€ Rust Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.rust == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: ðŸ”§ Format check (rustfmt)
        run: |
          echo "ðŸ”§ Checking Rust code formatting..."
          cargo fmt --check || echo "âš ï¸  Formatting issues found (non-blocking)"

      - name: ðŸ“ Lint code (clippy)
        run: |
          echo "ðŸ“ Linting Rust code..."
          cargo clippy -- -D warnings || echo "âš ï¸  Clippy warnings found (non-blocking)"

  test-python:
    name: ðŸ§ª Python Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-python]
    if: needs.detect-language.outputs.python == 'true'

    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for Python ${{ matrix.python-version }}..."

          if [ -f "pyproject.toml" ]; then
            pip install -e .[dev] || pip install -e . || true
          elif [ -f "setup.py" ]; then
            pip install -e . || true
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          fi

          pip install pytest pytest-cov || true

      - name: ðŸ§ª Run tests with coverage
        run: |
          echo "ðŸ§ª Running Python tests..."
          pytest tests/ --cov --cov-report=xml --cov-report=term -v || echo "âš ï¸  Tests failed or not found"

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-py${{ matrix.python-version }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-node:
    name: ðŸ§ª Node.js Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-node]
    if: needs.detect-language.outputs.node == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci || npm install

      - name: ðŸ§ª Run tests
        run: |
          echo "ðŸ§ª Running Node.js tests..."
          npm test || echo "âš ï¸  Tests failed or not found"

  test-go:
    name: ðŸ§ª Go Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-go]
    if: needs.detect-language.outputs.go == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: ðŸ§ª Run tests
        run: |
          echo "ðŸ§ª Running Go tests..."
          go test -v ./... -coverprofile=coverage.out || echo "âš ï¸  Tests failed or not found"

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-rust:
    name: ðŸ§ª Rust Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-rust]
    if: needs.detect-language.outputs.rust == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: ðŸ§ª Run tests
        run: |
          echo "ðŸ§ª Running Rust tests..."
          cargo test || echo "âš ï¸  Tests failed or not found"

  build-python:
    name: ðŸ—ï¸ Build Python Package
    runs-on: ubuntu-latest
    needs: [detect-language, test-python]
    if: needs.detect-language.outputs.python == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install build tools
        run: |
          pip install build || true

      - name: ðŸ”¨ Build package
        run: |
          echo "ðŸ”¨ Building Python package..."
          python -m build || echo "âš ï¸  Build failed (non-blocking)"

          if [ -d "dist/" ]; then
            echo "âœ… Package built successfully"
            ls -lh dist/
          fi

      - name: ðŸ“¤ Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/
          retention-days: 7

  build-node:
    name: ðŸ—ï¸ Build Node.js Package
    runs-on: ubuntu-latest
    needs: [detect-language, test-node]
    if: needs.detect-language.outputs.node == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci || npm install

      - name: ðŸ”¨ Build package
        run: |
          echo "ðŸ”¨ Building Node.js package..."
          npm run build || echo "âš ï¸  Build script not found (non-blocking)"

  build-go:
    name: ðŸ—ï¸ Build Go Binary
    runs-on: ubuntu-latest
    needs: [detect-language, test-go]
    if: needs.detect-language.outputs.go == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: ðŸ”¨ Build binary
        run: |
          echo "ðŸ”¨ Building Go binary..."
          go build -v ./... || echo "âš ï¸  Build failed (non-blocking)"

  build-rust:
    name: ðŸ—ï¸ Build Rust Binary
    runs-on: ubuntu-latest
    needs: [detect-language, test-rust]
    if: needs.detect-language.outputs.rust == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: ðŸ”¨ Build binary
        run: |
          echo "ðŸ”¨ Building Rust binary..."
          cargo build --release || echo "âš ï¸  Build failed (non-blocking)"

  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [detect-language]
    if: always()

    steps:
      - name: ðŸ“Š Check results
        run: |
          echo "ðŸ“Š Quality Gate Results:"
          echo ""
          echo "Primary Language: ${{ needs.detect-language.outputs.primary_language }}"
          echo ""
          echo "âœ… CI Pipeline completed"
          echo ""
          echo "Note: This is a universal CI pipeline that adapts to your project."
          echo "Failures in optional steps (linting, formatting) are non-blocking."

      - name: ðŸ“ Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ## âœ… Universal CI Pipeline Summary

          | Check | Status |
          |-------|--------|
          | Language Detection | âœ… Passed |
          | Code Quality | See individual jobs |
          | Tests | See individual jobs |
          | Build | See individual jobs |

          ### Detected Languages
          - **Python**: ${{ needs.detect-language.outputs.python }}
          - **Node.js**: ${{ needs.detect-language.outputs.node }}
          - **Go**: ${{ needs.detect-language.outputs.go }}
          - **Rust**: ${{ needs.detect-language.outputs.rust }}
          - **Java**: ${{ needs.detect-language.outputs.java }}
          - **Ruby**: ${{ needs.detect-language.outputs.ruby }}

          ### Primary Language
          **${{ needs.detect-language.outputs.primary_language }}**

          ---

          *This is a universal CI pipeline provided by MoAI-ADK*
          SUMMARY
