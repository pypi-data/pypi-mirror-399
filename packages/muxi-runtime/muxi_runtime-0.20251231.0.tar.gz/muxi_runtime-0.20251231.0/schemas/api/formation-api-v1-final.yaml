openapi: 3.1.0
info:
  title: MUXI Formation API
  description: |
    The MUXI Formation API provides comprehensive management and interaction capabilities for AI formations.

    ## Authentication
    The API uses two types of API keys:
    - **Admin Key**: Required for formation management endpoints (`X-MUXI-ADMIN-KEY` header)
    - **Client Key**: Required for user interaction endpoints (`X-MUXI-CLIENT-KEY` header)

    ## Response Format
    All API responses use a consistent envelope format:
    ```json
    {
      "object": "response_type",    // e.g., "chat_response", "agent", "error"
      "timestamp": 1706616000000,   // Unix timestamp in milliseconds
      "type": "event.type",         // e.g., "chat.completed", "agent.created"
      "request": {
        "id": "req_abc123",         // Request ID for tracking
        "idempotency_key": null     // Optional idempotency key
      },
      "success": true,              // Success indicator
      "error": null,                // Error details when success is false
      "data": {}                    // Response payload
    }
    ```

    ### Error Response Format
    When an error occurs (success is false), the error field contains:
    ```json
    {
      "error": {
        "code": "ERROR_CODE",       // Standardized error code
        "message": "Error message", // Human-readable error description
        "data": {                   // Optional additional error data
          "validation_errors": [...], // For validation errors
          "trace": "...",            // For internal errors (debug mode)
          // Other error-specific data
        }
      }
    }
    ```

    ## Key Features
    - Real-time streaming responses via SSE
    - Asynchronous job management
    - User-scoped data isolation
    - Consistent error handling with standardized error codes
    - Request ID tracking for observability
  version: 1.0.0
  contact:
    name: MUXI Team
    url: https://muxi.ai
    email: support@muxi.ai
  license:
    name: Elastic License 2.0
    url: https://www.elastic.co/licensing/elastic-license

servers:
  - url: http://localhost:8271/v1
    description: Local development server
  - url: https://{muxi_server}/api/v1/formations/{formation_id}
    description: Production server
    variables:
      muxi_server:
        default: api.muxi.ai
        description: MUXI server name
      formation_id:
        default: default
        description: Formation identifier


security:
  - AdminKey: []
  - ClientKey: []

tags:
  - name: Health
    description: Health checks
  - name: Configuration
    description: Formation configuration and status
  - name: Overlord
    description: Overlord configuration and persona
  - name: Secrets
    description: Secret management endpoints
  - name: Agents
    description: Agent management endpoints
  - name: MCP
    description: MCP configuration and servers
  - name: LLM
    description: LLM request defaults
  - name: Logging
    description: Logging configuration
  - name: Memory
    description: Memory configuration
  - name: Async
    description: Async behavior settings
  - name: Scheduler
    description: Scheduler configuration
  - name: Users
    description: Multi-identity user management
  - name: A2A
    description: Agent-to-Agent communication settings
  - name: Audit
    description: Audit log for formation changes
  - name: SOPs
    description: Standard Operating Procedures (read-only)
  - name: Chat
    description: User interaction endpoints
  - name: Requests
    description: Request tracking and cancellation
  - name: Triggers
    description: Webhook-like event handling with templates
  - name: Events
    description: Server-sent events
  - name: Sessions
    description: Session management and history
  - name: Logs
    description: Live log streaming for administrators

x-tagGroups:
  - name: Public Endpoints
    tags:
      - Health
  - name: Formation Management (Admin)
    tags:
      - Configuration
      - Overlord
      - Agents
      - Secrets
      - MCP
      - LLM
      - Logging
      - Logs
      - Memory
      - Async
      - Scheduler
      - A2A
      - Audit
  - name: Operational (Client)
    tags:
      - SOPs
      - Triggers
  - name: User Interaction (Client)
    tags:
      - Chat
      - Sessions
      - Events
      - Requests

paths:
  # Root endpoints (no version prefix)
  /:
    get:
      tags: [Health]
      summary: Root endpoint
      description: Basic service info
      operationId: getRoot
      security: []
      responses:
        '200':
          description: Service info
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                  version:
                    type: string
              examples:
                root:
                  value:
                    service: "muxi-formation"
                    version: "1.0.0"

  /v1:
    get:
      tags: [Health]
      summary: API version endpoint
      description: API version info
      operationId: getV1
      security: []
      responses:
        '200':
          description: API version
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_version:
                    type: string
              examples:
                v1:
                  value:
                    api_version: "v1"

  # Health & Status (no version prefix)
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Liveness and readiness probe
      operationId: getHealth
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  value:
                    status: healthy
                    version: "1.0.0"
                    uptime_seconds: 3600

  /status:
    get:
      tags: [Configuration]
      summary: Formation status
      description: Get current formation status snapshot
      operationId: getStatus
      security:
        - AdminKey: []
      responses:
        '200':
          description: Formation status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                status:
                  value:
                    object: "formation_status"
                    timestamp: 1706616000000
                    type: "formation.status.retrieved"
                    request:
                      id: "req_status123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      formation:
                        id: "my-formation"
                        name: "my-formation"  # Uses formation id if name not specified
                        description: "Production formation"
                        version: "1.0.0"
                      server:
                        version: "1.2.3"
                        uptime_seconds: 3600
                      agents:
                        count: 3
                        active: 2
                      mcp_servers:
                        count: 2
                        active: 2
                      stats:
                        running:
                          seconds: 3600
                          since: 1706612400
                        memory:
                          working_memory_mb: 512
                          memory_usage_mb: 256.7  # Process memory usage in MB
                        requests:
                          total: 100
                          active: 10
                        buffer_size: 1000
                        cpu_percent: 12.5  # System-wide CPU usage percentage (instantaneous)

  /config:
    get:
      tags: [Configuration]
      summary: Full formation configuration
      description: Get complete formation configuration with all defaults filled in
      operationId: getConfig
      security:
        - AdminKey: []
      responses:
        '200':
          description: Complete formation configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                config:
                  value:
                    object: "formation_config"
                    timestamp: 1706616000000
                    type: "formation.config.retrieved"
                    request:
                      id: "req_config123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      formation_id: "my-formation"
                      version: "1.0.0"
                      description: "Production formation"
                      schema_version: "1.0"
                      agents:
                        total: 3
                        resource: "/v1/agents"
                      secrets:
                        total: 5
                        resource: "/v1/secrets"
                      mcp:
                        default_retry_attempts: 3
                        default_timeout_seconds: 30
                        servers:
                          total: 2
                          resource: "/v1/mcp/servers"
                      overlord:
                        resource: "/v1/overlord"
                      llm:
                        resource: "/v1/llm/settings"
                      memory:
                        resource: "/v1/memory"
                      async:
                        resource: "/v1/async"
                      scheduler:
                        resource: "/v1/scheduler"
                      a2a:
                        resource: "/v1/a2a"
                      logging:
                        resource: "/v1/logging"

  /formation:
    get:
      tags: [Configuration]
      summary: Formation info
      description: Get basic formation information
      operationId: getFormation
      security:
        - AdminKey: []
      responses:
        '200':
          description: Formation info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                formation:
                  value:
                    object: "formation_config"
                    timestamp: 1706616000000
                    type: "formation.config.retrieved"
                    request:
                      id: "req_formation123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      formation_id: "my-formation"
                      name: "My Formation"
                      version: "1.0.0"

  # Overlord Configuration
  /overlord:
    get:
      tags: [Overlord]
      summary: Get overlord configuration
      description: Get complete overlord configuration including persona and routing settings
      operationId: getOverlord
      security:
        - AdminKey: []
      responses:
        '200':
          description: Overlord configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                overlord_config:
                  value:
                    object: "overlord_config"
                    timestamp: 1706616000000
                    type: "overlord.config.retrieved"
                    request:
                      id: "req_overlord123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      persona: |
                        You are Fynn, a helpful assistant for Company XYZ.
                        You are friendly, helpful, and professional.
                      llm:
                        model: "llama_cpp/phi-3-mini-4k-instruct"
                        api_key: "${{ secrets.OVERLORD_LLM_API_KEY }}"
                        max_extraction_tokens: 500
                        settings:
                          temperature: 0.2
                          max_tokens: 2000
                          timeout_seconds: 45
                          max_retries: 1
                          fallback_model: "openai/gpt-4o-mini"
                      caching:
                        enabled: true
                        ttl: 3600
                      response:
                        format: "markdown"
                        widgets: true
                        streaming: true
                      workflow:
                        auto_decomposition: true
                        plan_approval_threshold: 7
                        complexity_method: "heuristic"
                        complexity_threshold: 7.0
                        routing_strategy: "capability_based"
                        enable_agent_affinity: true
                        error_recovery: "retry_with_backoff"
                        parallel_execution: true
                        max_parallel_tasks: 5
                        partial_results: true
                      clarification:
                        max_questions: 5
                        style: "conversational"
                        persist_learned_info: false

  /overlord/persona:
    get:
      tags: [Overlord]
      summary: Get overlord persona
      description: Get current overlord persona configuration
      operationId: getOverlordPersona
      security:
        - AdminKey: []
      responses:
        '200':
          description: Overlord persona
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                overlord_persona:
                  value:
                    object: "overlord_persona"
                    timestamp: 1706616000000
                    type: "overlord.persona.retrieved"
                    request:
                      id: "req_persona123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      persona: |
                        You are Fynn, a helpful assistant for Company XYZ.
                        You are friendly, helpful, and professional.

  # Agent Endpoints
  /agents:
    get:
      tags: [Agents]
      summary: List agents
      description: List all agents in the formation
      operationId: listAgents
      security:
        - AdminKey: []
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                agent_list:
                  value:
                    object: "agent_list"
                    timestamp: 1706616000000
                    type: "agent.list"
                    request:
                      id: "req_xyz789"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      agents:
                        - schema: "1.0.0"
                          id: "weather-assistant"
                          name: "Weather Assistant"
                          description: "Specialized in providing weather forecasts and meteorological information."
                          active: true
                          source: "formation"
                          author: "MUXI Team <team@muxi.ai>"
                          url: "https://github.com/muxi/weather-assistant"
                          license: "MIT"
                          version: "1.0.0"
                          system_message: |
                            You are a weather assistant that provides accurate forecasts and meteorological information.
                            Only answer questions related to weather. For other topics, explain that you are a
                            specialized weather assistant and cannot help with unrelated questions.
                          a2a:
                            internal: true
                            external: true
                          llm_models:
                            - text: "openai/gpt-4o"
                              api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
                              settings:
                                temperature: 0.2
                                max_tokens: 1000
                                timeout_seconds: 30
                          role: "specialist"
                          specialties: ["weather_forecasting", "meteorology", "climate_data"]
                          knowledge:
                            enabled: false
                            sources: []
                          mcp_servers: []
                        - schema: "1.0.0"
                          id: "code-assistant"
                          name: "Code Assistant"
                          description: "Expert programming assistant for code generation and debugging"
                          active: true
                          source: "api"
                          system_message: |
                            You are an expert software engineer with deep knowledge of multiple programming languages.
                            Help users write clean, efficient, and well-documented code.
                          llm_models:
                            - text: "anthropic/claude-3-opus"
                              settings:
                                temperature: 0.1
                                max_tokens: 4096
                      count: 2

    post:
      tags: [Agents]
      summary: Add agent
      description: |
        Add a new agent via API.

        **DEPRECATED**: This endpoint is deprecated. Use formation deployment to add agents instead.
      operationId: createAgent
      deprecated: true
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentCreate'
      responses:
        '201':
          description: Agent created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                created:
                  value:
                    object: "agent"
                    timestamp: 1706616000000
                    type: "agent.created"
                    request:
                      id: "req_create123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "developer"
                      name: "Code Developer"
                      description: "Expert programming assistant"
                      model: "openai/gpt-4"
                      active: true
                      source: "api"
        '409':
          description: Agent already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                conflict:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_create456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "AGENT_EXISTS"
                      message: "Agent 'developer' already exists"
                      data: null
                    data: {}
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                validation_error:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_val789"
                      idempotency_key: null
                    success: false
                    error:
                      code: "INVALID_PARAMS"
                      message: "Validation failed: 2 error(s)"
                      data:
                        validation_errors:
                          - field: "schema"
                            msg: "Field required"
                            type: "string"
                            error: "missing"
                          - field: "llm_models.0.api_key"
                            msg: "Invalid secret reference: SECRET_KEY does not exist"
                            type: "string"
                            error: "invalid"
                    data: {}

  /agents/{agent_id}:
    get:
      tags: [Agents]
      summary: Get agent
      description: Get a specific agent configuration by ID
      operationId: getAgent
      security:
        - AdminKey: []
      parameters:
        - name: agent_id
          in: path
          required: true
          description: Unique identifier of the agent
          schema:
            type: string
      responses:
        '200':
          description: Agent configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                agent:
                  value:
                    object: "agent"
                    timestamp: 1706616000000
                    type: "agent.retrieved"
                    request:
                      id: "req_get123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      schema: "1.0.0"
                      id: "weather-assistant"
                      name: "Weather Assistant"
                      description: "Specialized in providing weather forecasts and meteorological information."
                      active: true
                      source: "formation"
                      author: "MUXI Team <team@muxi.ai>"
                      url: "https://github.com/muxi/weather-assistant"
                      license: "MIT"
                      version: "1.0.0"
                      system_message: |
                        You are a weather assistant that provides accurate forecasts and meteorological information.
                      llm_models:
                        - text: "openai/gpt-4o"
                          api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
                          settings:
                            temperature: 0.2
                            max_tokens: 1000
        '404':
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_get456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "AGENT_NOT_FOUND"
                      message: "Agent 'unknown' not found"
                      data: null
                    data: {}

    patch:
      tags: [Agents]
      summary: Update agent
      description: |
        Update agent configuration.

        **DEPRECATED**: This endpoint is deprecated. Use formation deployment to update agents instead.
      operationId: updateAgent
      deprecated: true
      security:
        - AdminKey: []
      parameters:
        - name: agent_id
          in: path
          required: true
          description: Unique identifier of the agent
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentUpdate'
      responses:
        '200':
          description: Agent updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                updated:
                  value:
                    object: "agent"
                    timestamp: 1706616000000
                    type: "agent.updated"
                    request:
                      id: "req_update123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "assistant"
                      name: "General Assistant"
                      description: "Updated description"
                      model: "openai/gpt-4"
                      active: false
                      source: "formation"
        '404':
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_update456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "AGENT_NOT_FOUND"
                      message: "Agent 'unknown' not found"
                      data: null
                    data: {}

    delete:
      tags: [Agents]
      summary: Delete agent
      description: |
        Remove an API-created agent.

        **DEPRECATED**: This endpoint is deprecated. Use formation deployment to manage agents instead.
      operationId: deleteAgent
      deprecated: true
      security:
        - AdminKey: []
      parameters:
        - name: agent_id
          in: path
          required: true
          description: Unique identifier of the agent
          schema:
            type: string
      responses:
        '200':
          description: Agent deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                deleted:
                  value:
                    object: "message"
                    timestamp: 1706616000000
                    type: "agent.deleted"
                    request:
                      id: "req_delete123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Agent 'developer' removed successfully"
        '403':
          description: Cannot delete YAML-defined agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                forbidden:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.authorization"
                    request:
                      id: "req_delete456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "FORBIDDEN"
                      message: "Cannot delete YAML-defined agent"
                      data: null
                    data: {}
        '404':
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Secret Endpoints
  #
  # Note: Secret names are case-insensitive and normalized. All names are converted to uppercase
  # with non-alphanumeric characters replaced by underscores. For example:
  # - "api-key", "API_KEY", "Api-Key" all refer to the same secret: "API_KEY"
  # - "my-secret-123" becomes "MY_SECRET_123"
  # - Special characters are replaced: "user@email" becomes "USER_EMAIL"
  /secrets:
    get:
      tags: [Secrets]
      summary: List secrets
      description: List all secret keys with masked values
      operationId: listSecrets
      security:
        - AdminKey: []
      responses:
        '200':
          description: List of secrets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                secret_list:
                  value:
                    object: "secret_list"
                    timestamp: 1706616000000
                    type: "secret.list"
                    request:
                      id: "req_abc123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      secrets:
                        OPENAI_API_KEY: "sk-••••••••••••••••••••••••••••••••Gst"
                        ANTHROPIC_API_KEY: "sk-ant-••••••••••••••••••••••••••••"
                        DATABASE_URL: "postgresql://••••••••@localhost:5432/muxi"
                        FORMATION_ADMIN_API_KEY: "fma-••••••••••••••••••••••••"
                        FORMATION_CLIENT_API_KEY: "fmc-••••••••••••••••••••••••"
                      count: 5

    post:
      tags: [Secrets]
      summary: Create secret
      description: Create a new secret
      operationId: createSecret
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecretCreate'
            examples:
              create_secret:
                value:
                  key: "NEW_API_KEY"
                  value: "sk-1234567890abcdef"
      responses:
        '201':
          description: Secret created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                created:
                  value:
                    object: "message"
                    timestamp: 1706616000000
                    type: "secret.created"
                    request:
                      id: "req_secret123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Secret 'NEW_API_KEY' created successfully"
        '409':
          description: Secret already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '503':
          description: Secrets manager not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /secrets/{key}:

    put:
      tags: [Secrets]
      summary: Update secret
      description: Update an existing secret
      operationId: updateSecret
      security:
        - AdminKey: []
      parameters:
        - name: key
          in: path
          required: true
          description: Name of the secret key (case-insensitive, will be normalized to uppercase)
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecretUpdate'
      responses:
        '200':
          description: Secret updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Secret not found
        '503':
          description: Secrets manager not available

    delete:
      tags: [Secrets]
      summary: Delete secret
      description: Delete a secret
      operationId: deleteSecret
      security:
        - AdminKey: []
      parameters:
        - name: key
          in: path
          required: true
          description: Name of the secret key (case-insensitive, will be normalized to uppercase)
          schema:
            type: string
      responses:
        '200':
          description: Secret deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Secret not found
        '409':
          description: Secret is in use and cannot be deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '503':
          description: Secrets manager not available

  # LLM Settings
  /llm/settings:
    get:
      tags: [LLM]
      summary: Get LLM defaults
      description: Current global LLM request settings
      operationId: getLlmSettings
      security:
        - AdminKey: []
      responses:
        '200':
          description: LLM settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                settings:
                  value:
                    object: "llm_settings"
                    timestamp: 1706616000000
                    type: "llm.settings.retrieved"
                    request:
                      id: "req_llm123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      settings:
                        temperature: 0.7
                        max_tokens: 1000
                        timeout_seconds: 30
                        max_retries: 3
                        fallback_model: "anthropic/claude-3.5-sonnet"
                      api_keys:
                        openai: "${{ secrets.OPENAI_API_KEY }}"
                        anthropic: "${{ secrets.ANTHROPIC_API_KEY }}"
                      models:
                        - text: "openai/gpt-4o"
                          settings:
                            temperature: 0.7
                            max_tokens: 1000
                        - vision: "openai/gpt-4o"
                          settings:
                            temperature: 0.7
                            max_tokens: 1500
                        - audio: "openai/whisper-1"
                        - documents: "openai/gpt-4o"
                        - embedding: "openai/text-embedding-3-large"

    patch:
      tags: [LLM]
      summary: Update LLM defaults
      description: |
        Update temperature, max_tokens, timeout_seconds.
        DEPRECATED: LLM configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: updateLlmSettings
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLlmSettingsRequest'
      responses:
        '200':
          description: LLM settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /llm/settings/{item}:
    delete:
      tags: [LLM]
      summary: Reset LLM setting
      description: |
        Revert setting to default value.
        DEPRECATED: LLM configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: resetLlmSetting
      security:
        - AdminKey: []
      parameters:
        - name: item
          in: path
          required: true
          description: Setting name to reset
          schema:
            type: string
            enum: [temperature, max_tokens, timeout_seconds]
      responses:
        '200':
          description: Setting reset to default
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Audit Log (Not Yet Implemented - returns 501)
  /audit:
    get:
      tags: [Audit]
      summary: Get audit log (not yet implemented)
      description: |
        **Status: Not Yet Implemented (returns 501)**

        Will retrieve formation audit trail including:
        - Initialization events: agent.registered, mcp.server.registered, etc.
        - Runtime operations: secret.created, secret.deleted, memory.buffer.cleared

        See docs/features/audit-logging.md for the implementation plan.

        **Planned Log Location:** `~/.muxi/formations/{formation_id}/audit.log`

        **Planned Format:** JSONL (one JSON object per line)
      operationId: getAuditLog
      security:
        - AdminKey: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
          description: Maximum number of entries to return (most recent first)
        - name: action
          in: query
          schema:
            type: string
          description: Filter by action type (e.g., agent.created, secret.deleted)
        - name: resource_type
          in: query
          schema:
            type: string
            enum: [agent, secret, mcp_server, scheduler_job, logging_destination, async, memory]
          description: Filter by resource type
        - name: since
          in: query
          schema:
            type: string
            format: date-time
          description: Return entries since this ISO 8601 timestamp
      responses:
        '200':
          description: Audit log entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                audit_entries:
                  value:
                    object: "audit_log"
                    timestamp: 1706616000000
                    type: "audit.retrieved"
                    request:
                      id: "req_audit123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      entries:
                        - timestamp: "2025-10-23T14:23:45.123Z"
                          request_id: "req_abc123"
                          action: "agent.created"
                          resource_type: "agent"
                          resource_id: "weather-bot"
                          user: "admin"
                          ip: "192.168.1.100"
                          result: "success"
                          status_code: 201
                          message: "Agent 'weather-bot' created by admin"
                        - timestamp: "2025-10-23T14:24:10.456Z"
                          request_id: "req_xyz789"
                          action: "agent.deleted"
                          resource_type: "agent"
                          resource_id: "old-bot"
                          user: "admin"
                          ip: "192.168.1.100"
                          result: "success"
                          status_code: 200
                          message: "Agent 'old-bot' deleted by admin"
                        - timestamp: "2025-10-23T14:25:33.789Z"
                          request_id: "req_def456"
                          action: "secret.created"
                          resource_type: "secret"
                          resource_id: "OPENAI_KEY"
                          user: "admin"
                          ip: "192.168.1.100"
                          result: "success"
                          status_code: 201
                          message: "Secret 'OPENAI_KEY' created by admin"
                      count: 3
                      total_entries: 47

    delete:
      tags: [Audit]
      summary: Clear audit log (not yet implemented)
      description: |
        **Status: Not Yet Implemented (returns 501)**

        Will clear the audit log file. See docs/features/audit-logging.md for the implementation plan.
      operationId: clearAuditLog
      security:
        - AdminKey: []
      parameters:
        - name: confirm
          in: query
          required: true
          schema:
            type: string
            enum: ["clear-audit-log"]
          description: Required confirmation string to prevent accidental deletion
      responses:
        '200':
          description: Audit log cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                cleared:
                  value:
                    object: "audit_log"
                    timestamp: 1706616000000
                    type: "audit.cleared"
                    request:
                      id: "req_clear123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Audit log cleared successfully"
                      previous_entries_count: 47
                      cleared_by: "admin"
        '400':
          description: Missing or invalid confirmation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                missing_confirmation:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_clear456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "INVALID_REQUEST"
                      message: "Confirmation required: add ?confirm=clear-audit-log"
                      data: null
                    data: {}

  # Standard Operating Procedures (SOPs)
  /sops:
    get:
      tags: [SOPs]
      summary: List available SOPs
      description: |
        List all Standard Operating Procedures defined in the formation.

        SOPs are workflow templates stored in `formation_path/sops/` directory.
        They define multi-step procedures with agent routing for complex operations.

        **Read-only**: SOPs are formation-defined and cannot be modified via API.
        They must be updated in the formation YAML files and redeployed.
      operationId: listSOPs
      security:
        - ClientKey: []
      responses:
        '200':
          description: List of available SOPs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                sops_available:
                  value:
                    object: "sop_list"
                    timestamp: 1706616000000
                    type: "sops.list"
                    request:
                      id: "req_sop123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      sops:
                        - name: "customer-onboarding"
                          title: "Customer Onboarding Procedure"
                          type: "template"
                          steps: 5
                          agents_used: ["identity-verifier", "account-manager", "communication"]
                        - name: "incident-response"
                          title: "Security Incident Response"
                          type: "guide"
                          steps: 8
                          agents_used: ["security-analyst", "incident-coordinator"]
                      count: 2

  /sops/{sop_name}:
    get:
      tags: [SOPs]
      summary: Get SOP details
      description: |
        Get detailed information about a specific Standard Operating Procedure.

        Returns the SOP metadata and content, including:
        - Full markdown content
        - Frontmatter metadata
        - Referenced files (if any)
        - Execution mode (template vs guide)

        **Read-only**: SOPs cannot be modified via API.
      operationId: getSOPDetails
      security:
        - ClientKey: []
      parameters:
        - name: sop_name
          in: path
          required: true
          description: Name of the SOP (without .md extension)
          schema:
            type: string
            example: "customer-onboarding"
      responses:
        '200':
          description: SOP details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                sop_details:
                  value:
                    object: "sop"
                    timestamp: 1706616000000
                    type: "sop.retrieved"
                    request:
                      id: "req_sop456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      name: "customer-onboarding"
                      title: "Customer Onboarding Procedure"
                      type: "template"
                      content: |
                        ---
                        type: sop
                        title: Customer Onboarding Procedure
                        ---

                        1. Verify customer identity
                           - Agent: identity-verifier
                           - Check documents

                        2. Set up account
                           - Agent: account-manager
                           - Create profiles
                      metadata:
                        type: "sop"
                        title: "Customer Onboarding Procedure"
                      references:
                        - "file:templates/welcome.md"
                      agents_used:
                        - "identity-verifier"
                        - "account-manager"
                      steps: 5
        '404':
          description: SOP not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_sop789"
                      idempotency_key: null
                    success: false
                    error:
                      code: "RESOURCE_NOT_FOUND"
                      message: "SOP 'unknown-sop' not found"
                      data: null
                    data: {}

  # Chat Endpoint
  /chat:
    post:
      tags: [Chat]
      summary: Send message
      description: Send a message and receive streaming response
      operationId: chat
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple_message:
                value:
                  message: "What's the weather like today?"
              with_group:
                value:
                  message: "Generate the Q1 sales report"
                  group_id: "analyst"
              with_multiple_groups:
                value:
                  message: "Access project alpha data"
                  group_id: ["analyst", "project-alpha"]
              with_webhook:
                value:
                  message: "Generate a comprehensive report on Q1 sales"
                  group_id: "analyst"
                  webhook_url: "https://myapp.com/webhooks/report-complete"
              with_file:
                value:
                  message: "Analyze this spreadsheet"
                  files:
                    - filename: "sales.xlsx"
                      content: "UEsDBAoAAAAAAIdO4kYAAAAAAAAAAAAAAAAJAAAAZG9jUHJvcHMvUEsDBBQAAAA..."
                      content_type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      responses:
        '200':
          description: Successful response (streaming or non-streaming based on Accept header)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                non_streaming:
                  value:
                    object: "chat_response"
                    timestamp: 1706616000000
                    type: "chat.completed"
                    request:
                      id: "req_chat123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      status: "completed"
                      formation_id: "my-formation"
                      user_id: "user-123"
                      processing_time: 1.5
                      processing_mode: "sync"
                      response:
                        - type: "text"
                          text: "Hello! The weather today is sunny with a high of 72°F."
                      usage:
                        total_tokens: 150
                        prompt_tokens: 50
                        completion_tokens: 100
            text/event-stream:
              schema:
                type: string
                description: Server-sent events stream
              examples:
                streaming_with_envelope:
                  value: |
                    data: {
                      "object": "chat_response",
                      "timestamp": 1706616000000,
                      "type": "chat.streaming",
                      "request": {"id": "req_chat123", "idempotency_key": null},
                      "success": true,
                      "error": null,
                      "data": {"stream_started": true}
                    }

                    data: {"token": "Hello"}

                    data: {"token": " there"}

                    data: {"token": "!"}

                    event: done
                    data: {"finished": true}
        '202':
          description: Async processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                async_accepted:
                  value:
                    object: "async_job"
                    timestamp: 1706616000000
                    type: "chat.async_accepted"
                    request:
                      id: "job_456789"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      request_id: "job_456789"
                      mode: "async"
                      estimated_seconds: 120
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                missing_user_id:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_bad123"
                      idempotency_key: null
                    success: false
                    error:
                      code: "INVALID_REQUEST"
                      message: "Missing required field: user_id"
                      data: null
                    data: {}
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                invalid_key:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.authentication"
                    request:
                      id: "req_auth123"
                      idempotency_key: null
                    success: false
                    error:
                      code: "UNAUTHORIZED"
                      message: "Invalid or missing API key"
                      data: null
                    data: {}

  # Audio Chat Endpoint
  /audiochat:
    post:
      tags: [Chat]
      summary: Send audio message (voice notes)
      description: |
        Send audio files for transcription and conversational response.

        The audio is transcribed first using a speech-to-text model (e.g., Whisper),
        then the transcribed text is used as the user's message for the conversation.

        This endpoint is designed for voice note interactions (WhatsApp, Telegram, etc.)
        where the audio IS the user's message, not an attachment to analyze.

        For file attachments with a text prompt, use /chat with the files parameter instead.
      operationId: audiochat
      security:
        - ClientKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AudioChatRequest'
            examples:
              voice_note:
                summary: WhatsApp voice note
                value:
                  files:
                    - filename: "voice_message.m4a"
                      content: "base64_encoded_audio_content"
                      content_type: "audio/m4a"
                      size: 45824
                  user_id: "user-123"
              telegram_voice:
                summary: Telegram voice message
                value:
                  files:
                    - filename: "voice.ogg"
                      content: "base64_encoded_audio_content"
                      content_type: "audio/ogg"
                      size: 32768
                  user_id: "user-456"
                  session_id: "sess_telegram_chat"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE stream for streaming responses
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                missing_files:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_audiochat456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "files parameter is required for audiochat()"
                non_audio_file:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_audiochat789"
                      idempotency_key: null
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Only audio files (audio/*) are accepted. For video or other files, use /chat with the files parameter."
                      data:
                        field: "files"
                    data: {}
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Events Endpoints
  /events:
    get:
      tags: [Events]
      summary: Event stream
      description: |
        SSE stream of user-facing events (chat.*, agent.*, workflow.*, task.*).

        **Note:** This endpoint streams only conversation-level events. For full
        observability including system events, admins should use GET /logs instead,
        which is a superset of this endpoint.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required (streams only user's events)
        - With AdminKey: X-Muxi-User-ID optional (omit for all events, provide to filter)
      operationId: getEventStream
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for event filtering.
            - Required when using ClientKey
            - Optional when using AdminKey (omit for all, provide to filter)
      responses:
        '200':
          description: |
            Server-Sent Events stream of user-facing events. Each event is a JSON object
            sent as `data: {json}\n\n`. Only user-facing events are streamed (chat.*, agent.*,
            workflow.*, task.*).
          headers:
            Content-Type:
              schema:
                type: string
                default: text/event-stream
          content:
            text/event-stream:
              schema:
                description: |
                  Each SSE message contains a JSON object with the following structure.
                  Events are filtered to only include user-facing types.
                type: object
                properties:
                  type:
                    type: string
                    description: Event type (e.g., chat.started, agent.selected, workflow.completed)
                    example: "chat.completed"
                  timestamp:
                    type: integer
                    description: Unix timestamp in milliseconds
                    example: 1706616000000
                  message:
                    type: string
                    description: Human-readable event description
                    example: "Request completed"
                  session_id:
                    type: string
                    description: Session ID associated with the event
                    example: "sess_123"
                  request_id:
                    type: string
                    description: Request ID associated with the event
                    example: "req_456"
              example: |
                data: {"type": "chat.started", "timestamp": 1706616000000, "message": "Processing request", "session_id": "sess_123", "request_id": "req_456"}

                data: {"type": "agent.selected", "timestamp": 1706616001000, "message": "Selected agent: assistant", "session_id": "sess_123", "request_id": "req_456"}

                data: {"type": "chat.completed", "timestamp": 1706616005000, "message": "Request completed", "session_id": "sess_123", "request_id": "req_456"}

  /events/{session_id}:
    get:
      tags: [Events]
      summary: Session event stream
      description: |
        SSE stream for events in a specific session.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required, session must belong to user
        - With AdminKey: X-Muxi-User-ID optional, can access any session
      operationId: getSessionEventStream
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for ownership verification.
            - Required when using ClientKey
            - Optional when using AdminKey
        - name: session_id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
      responses:
        '200':
          description: SSE stream of events for the session
          headers:
            Content-Type:
              schema:
                type: string
                default: text/event-stream
          content:
            text/event-stream:
              schema:
                type: object
        '403':
          description: Session does not belong to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /events/{session_id}/{request_id}:
    get:
      tags: [Events]
      summary: Request event stream
      description: |
        SSE stream for events on a specific request. Includes stream lifecycle events
        (open/completed), tokens for streaming responses, and errors.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required, request must belong to user
        - With AdminKey: X-Muxi-User-ID optional, can access any request
      operationId: getRequestEventStream
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for ownership verification.
            - Required when using ClientKey
            - Optional when using AdminKey
        - name: session_id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
        - name: request_id
          in: path
          required: true
          description: Request ID
          schema:
            type: string
      responses:
        '200':
          description: |
            Server-Sent Events stream for real-time request processing. Events include
            stream lifecycle (open/completed), tokens for streaming responses, and errors.
          headers:
            Content-Type:
              schema:
                type: string
                default: text/event-stream
          content:
            text/event-stream:
              schema:
                description: |
                  Each SSE message contains a JSON object. Event types include:
                  - stream_open: Stream successfully connected
                  - token: Streaming response token
                  - stream_completed: Request processing finished
                  - error: Error occurred during processing
                type: object
                properties:
                  type:
                    type: string
                    description: Event type
                    enum: [stream_open, token, stream_completed, error]
                  content:
                    type: string
                    description: Token content (for token events)
              example: |
                data: {"type": "stream_open", "session_id": "sess_123", "request_id": "req_456"}

                data: {"type": "token", "content": "Hello"}

                data: {"type": "token", "content": " there!"}

                data: {"type": "stream_completed", "session_id": "sess_123", "request_id": "req_456"}
        '403':
          description: Request does not belong to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '404':
          description: Session or request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Request Tracking Endpoints
  # Track and manage chat requests. For scheduled/recurring tasks, see /scheduler/jobs.
  /requests:
    get:
      tags: [Requests]
      summary: List requests
      description: |
        List chat requests. Returns status, progress, and timing info
        for tracked requests (active and recently completed).

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID header is required (returns only user's requests)
        - With AdminKey: X-Muxi-User-ID header is optional (omit for all requests, provide to filter)
      operationId: listRequests
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for request filtering.
            - Required when using ClientKey (returns only that user's requests)
            - Optional when using AdminKey (omit for all, provide to filter by user)
      responses:
        '200':
          description: List of requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                request_list:
                  value:
                    object: "request_list"
                    timestamp: 1706616000000
                    type: "request.list"
                    request:
                      id: "req_list123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      requests:
                        - request_id: "req_456789"
                          status: "processing"
                          progress: 75
                          created_at: "2024-03-01T10:00:00Z"
                        - request_id: "req_123456"
                          status: "completed"
                          progress: 100
                          created_at: "2024-03-01T09:00:00Z"
                      count: 2

  # Request Status and Cancellation
  /requests/{request_id}:
    get:
      tags: [Requests]
      summary: Get request status
      description: |
        Get status of a request (active or completed within 48 hours).

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required, only returns if request belongs to user
        - With AdminKey: X-Muxi-User-ID optional, can access any request
      operationId: getRequestStatus
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for ownership verification.
            - Required when using ClientKey
            - Optional when using AdminKey
        - name: request_id
          in: path
          required: true
          description: Unique identifier of the request
          schema:
            type: string
            example: "req_abc123"
      responses:
        '200':
          description: Request status information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                active_request:
                  value:
                    object: "request_status"
                    timestamp: 1706616000000
                    type: "request.status.retrieved"
                    request:
                      id: "req_status123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      request_id: "req_abc123"
                      status: "processing"
                      progress: "3/5 tasks completed"
                completed_request:
                  value:
                    object: "request_status"
                    timestamp: 1706616000000
                    type: "request.status.retrieved"
                    request:
                      id: "req_status456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      request_id: "req_abc123"
                      status: "completed"
                      error: null
                      completed_at: 1706616000.0
                failed_request:
                  value:
                    object: "request_status"
                    timestamp: 1706616000000
                    type: "request.status.retrieved"
                    request:
                      id: "req_status789"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      request_id: "req_abc123"
                      status: "failed"
                      error: "Connection timeout to external API"
                      completed_at: 1706616000.0
                not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_status999"
                      idempotency_key: null
                    success: false
                    error:
                      code: "REQUEST_NOT_FOUND"
                      message: "Request not found"
                      data: null
                    data: {}
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                unauthorized:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.authentication"
                    request:
                      id: "req_auth123"
                      idempotency_key: null
                    success: false
                    error:
                      code: "UNAUTHORIZED"
                      message: "Invalid or missing API key"
                      data: null
                    data: {}
    delete:
      tags: [Requests]
      summary: Cancel request
      description: |
        Cancel an in-progress request. The request will be marked as cancelled
        and any pending work will be stopped. Only works for requests that are
        still processing.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required, can only cancel own requests
        - With AdminKey: X-Muxi-User-ID optional, can cancel any request
      operationId: cancelRequest
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for ownership verification.
            - Required when using ClientKey
            - Optional when using AdminKey
        - name: request_id
          in: path
          required: true
          description: Unique identifier of the request to cancel
          schema:
            type: string
            example: "req_abc123"
      responses:
        '200':
          description: Request cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                cancelled:
                  value:
                    object: "request_status"
                    timestamp: 1706616000000
                    type: "request.cancelled"
                    request:
                      id: "req_cancel123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      request_id: "req_abc123"
                      status: "cancelled"
                      message: "Request cancelled"
        '404':
          description: Request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_cancel999"
                      idempotency_key: null
                    success: false
                    error:
                      code: "NOT_FOUND"
                      message: "Request not found"
                      data: null
                    data: {}
        '403':
          description: Request does not belong to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                forbidden:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.forbidden"
                    request:
                      id: "req_cancel456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "FORBIDDEN"
                      message: "Request does not belong to this user"
                      data: null
                    data: {}

  # Triggers - Webhook-like Event Handling
  /triggers/{trigger_name}:
    post:
      tags: [Triggers]
      summary: Execute trigger
      description: |
        Execute a trigger with provided event data. Triggers are formation-scoped templates
        that convert external events into formation chat messages using ${{ data.* }} syntax
        for data substitution.

        Templates support nested data access:
        - ${{ data.key }} - Simple key access
        - ${{ data.nested.key }} - Nested key access
        - ${{ data.user.name }} - Multi-level nesting

        Processing modes:
        - Async (default): Returns immediately with request_id, processing happens in background
        - Sync: Waits for formation to process message and returns response content
      operationId: executeTrigger
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: trigger_name
          in: path
          required: true
          description: Name of the trigger template (without .md extension)
          schema:
            type: string
            example: "github-issue"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerRequest'
            examples:
              github_issue:
                summary: GitHub issue notification
                value:
                  data:
                    repository: "muxi/runtime"
                    issue:
                      number: 123
                      title: "Bug in trigger system"
                      author: "alice"
                      state: "open"
                      labels: "bug, urgent"
                      body: "The trigger system fails when..."
                  use_async: true
              linear_ticket:
                summary: Linear ticket update
                value:
                  data:
                    team: "Engineering"
                    ticket:
                      identifier: "ENG-456"
                      title: "Implement new feature"
                      status: "in_progress"
                      priority: "high"
                      assignee: "bob"
                      description: "We need to implement..."
                    action: "updated"
                  session_id: "linear-session-1"
                  use_async: true
              deployment:
                summary: Deployment notification
                value:
                  data:
                    service: "api-gateway"
                    environment: "production"
                    version: "v2.5.0"
                    status: "success"
                    deployer: "ci-bot"
                    timestamp: "2025-10-10T10:00:00Z"
                    changes: "Added trigger system, fixed 3 bugs"
                    health:
                      api: "healthy"
                      database: "healthy"
                      cache: "healthy"
                  use_async: false
      responses:
        '200':
          description: Trigger executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                async_processing:
                  summary: Async trigger accepted for processing
                  value:
                    object: "request"
                    timestamp: 1706616000000
                    type: "request.processing"
                    request:
                      id: "req_trigger123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      status: "processing"
                sync_completed:
                  summary: Sync trigger completed
                  value:
                    object: "request"
                    timestamp: 1706616000000
                    type: "request.completed"
                    request:
                      id: "req_trigger456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      status: "completed"
                      content: "New GitHub issue from muxi.runtime/runtime:\n\n**Issue #123**: Bug in trigger system..."
        '400':
          description: Bad request - template rendering failed or invalid data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                missing_key:
                  summary: Template references missing data key
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_trigger789"
                      idempotency_key: null
                    success: false
                    error:
                      code: "INVALID_REQUEST"
                      message: "Template rendering failed: Data key 'data.issue.number' not found. Available keys: ['title', 'author']"
                      data: null
                    data: {}
                non_dict_access:
                  summary: Attempting to access field on non-dict value
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_trigger101"
                      idempotency_key: null
                    success: false
                    error:
                      code: "INVALID_REQUEST"
                      message: "Template rendering failed: Cannot access 'field' in non-dict value at 'data.name.field'. Value type: str"
                      data: null
                    data: {}
        '404':
          description: Formation or trigger not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                formation_not_found:
                  summary: Formation ID mismatch
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_trigger202"
                      idempotency_key: null
                    success: false
                    error:
                      code: "RESOURCE_NOT_FOUND"
                      message: "Formation 'wrong-formation' not found. Current formation: 'my-formation'"
                      data: null
                    data: {}
                trigger_not_found:
                  summary: Trigger template does not exist
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_trigger303"
                      idempotency_key: null
                    success: false
                    error:
                      code: "RESOURCE_NOT_FOUND"
                      message: "Trigger template 'unknown-trigger' not found at: /path/to/triggers/unknown-trigger.md"
                      data: null
                    data: {}
        '503':
          description: Service unavailable - overlord not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                overlord_unavailable:
                  summary: Overlord not available
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.service_unavailable"
                    request:
                      id: "req_trigger404"
                      idempotency_key: null
                    success: false
                    error:
                      code: "SYSTEM_OVERLOAD"
                      message: "Overlord not available"
                      data: null
                    data: {}
    get:
      tags: [Triggers]
      summary: Get trigger details
      description: |
        Get detailed information about a specific trigger template.

        Returns the trigger content and metadata, including:
        - Full markdown template content
        - Expected data fields (parsed from ${{ data.xxx }} patterns)

        **Read-only**: Triggers cannot be modified via API.
      operationId: getTrigger
      security:
        - ClientKey: []
      parameters:
        - name: trigger_name
          in: path
          required: true
          description: Name of the trigger (without .md extension)
          schema:
            type: string
            example: "github-issue"
      responses:
        '200':
          description: Trigger details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                trigger_details:
                  value:
                    object: "trigger"
                    timestamp: 1706616000000
                    type: "trigger.retrieved"
                    request:
                      id: "req_trigger123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      name: "github-issue"
                      content: |
                        # GitHub Issue Notification

                        A new issue was created in ${{ data.repository }}:

                        **Issue #${{ data.issue.number }}**: ${{ data.issue.title }}
                        **Author**: ${{ data.issue.author }}
                        **Labels**: ${{ data.issue.labels }}

                        ${{ data.issue.body }}
                      data_fields:
                        - "issue.author"
                        - "issue.body"
                        - "issue.labels"
                        - "issue.number"
                        - "issue.title"
                        - "repository"
        '404':
          description: Trigger not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_trigger456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "TRIGGER_NOT_FOUND"
                      message: "Trigger 'unknown-trigger' not found"
                      data: null
                    data: {}

  /triggers:
    get:
      tags: [Triggers]
      summary: List triggers
      description: List all available trigger templates for this formation
      operationId: listTriggers
      security:
        - ClientKey: []
      responses:
        '200':
          description: List of available triggers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                triggers_available:
                  summary: Formation has triggers
                  value:
                    object: "trigger_list"
                    timestamp: 1706616000000
                    type: "triggers.listed"
                    request:
                      id: "req_list123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      triggers:
                        - "github-issue"
                        - "linear-ticket"
                        - "deployment-notification"
                      count: 3
                no_triggers:
                  summary: Formation has no triggers
                  value:
                    object: "trigger_list"
                    timestamp: 1706616000000
                    type: "triggers.listed"
                    request:
                      id: "req_list456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      triggers: []
                      count: 0

  # Logging Configuration
  /logging:
    get:
      tags: [Logging]
      summary: Get logging config
      description: View active streams and levels
      operationId: getLogging
      security:
        - AdminKey: []
      responses:
        '200':
          description: Logging configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                logging:
                  value:
                    object: "logging_config"
                    timestamp: 1706616000000
                    type: "logging.config.retrieved"
                    request:
                      id: "req_log123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      system:
                        level: "debug"
                        destination: "stdout"
                      conversation:
                        enabled: true
                        streams:
                          - transport: "stdout"
                            level: "info"
                            format: "jsonl"
                          - transport: "file"
                            destination: "/var/logs/formation.log"
                            level: "debug"
                            format: "text"
                          - transport: "stream"
                            destination: "https://logs.company.com/ingest"
                            protocol: "http"
                            format: "jsonl"
                            auth:
                              type: "bearer"
                              token: "${{ secrets.LOG_TOKEN }}"
                            events: ["request.*", "error.*"]

  /logging/destinations:
    get:
      tags: [Logging]
      summary: List logging destinations
      description: List all configured logging destinations
      operationId: listLoggingDestinations
      security:
        - AdminKey: []
      responses:
        '200':
          description: List of logging destinations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                destinations:
                  value:
                    object: "logging_destinations"
                    timestamp: 1706616000000
                    type: "logging.destinations.list"
                    request:
                      id: "req_log123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      system:
                        level: "debug"
                        destination: "stdout"
                      conversation:
                        destinations:
                          - id: "stdout-main"
                            transport: "stdout"
                            level: "info"
                            format: "jsonl"
                            enabled: true
                          - id: "file-debug"
                            transport: "file"
                            destination: "/var/logs/formation.log"
                            level: "debug"
                            format: "text"
                            enabled: true
                          - id: "http-external"
                            transport: "stream"
                            destination: "https://logs.company.com/ingest"
                            protocol: "http"
                            format: "jsonl"
                            enabled: true
                        count: 3

    post:
      tags: [Logging]
      summary: Add logging destination (DEPRECATED)
      description: |
        DEPRECATED: This endpoint is disabled. Logging configuration should be changed
        via formation YAML and redeployment. Runtime changes would be lost on next deploy.
      operationId: createLoggingDestination
      deprecated: true
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoggingDestinationCreate'
      responses:
        '410':
          description: Endpoint deprecated - use deployment instead
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /logging/destinations/{destination_id}:
    patch:
      tags: [Logging]
      summary: Update logging destination (DEPRECATED)
      description: |
        DEPRECATED: This endpoint is disabled. Logging configuration should be changed
        via formation YAML and redeployment. Runtime changes would be lost on next deploy.
      operationId: updateLoggingDestination
      deprecated: true
      security:
        - AdminKey: []
      parameters:
        - name: destination_id
          in: path
          required: true
          description: ID of the logging destination
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoggingDestinationUpdate'
      responses:
        '410':
          description: Endpoint deprecated - use deployment instead
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    delete:
      tags: [Logging]
      summary: Remove logging destination (DEPRECATED)
      description: |
        DEPRECATED: This endpoint is disabled. Logging configuration should be changed
        via formation YAML and redeployment. Runtime changes would be lost on next deploy.
      operationId: deleteLoggingDestination
      deprecated: true
      security:
        - AdminKey: []
      parameters:
        - name: destination_id
          in: path
          required: true
          description: ID of the logging destination
          schema:
            type: string
      responses:
        '410':
          description: Endpoint deprecated - use deployment instead
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Live Log Streaming
  /logs:
    get:
      tags: [Logs]
      summary: Stream live logs
      description: |
        Stream live system logs via Server-Sent Events (SSE). Admin only.
        Requires at least ONE filter parameter to prevent firehose.

        **Note:** This endpoint is a superset of /events. It includes ALL observability
        events (system, conversation, agent, workflow, etc.) while /events only streams
        user-facing conversation events. Admins should use /logs for monitoring.

        **Filter Requirements:**
        - At least one filter parameter must be provided
        - Multiple filters can be combined for more specific results

        **Use Cases:**
        - Debug specific user: `?user_id=alice&level=ERROR`
        - Monitor agent: `?agent_id=weather-assistant`
        - Track request: `?request_id=req_abc123`
        - Formation errors: `?level=ERROR`
        - Conversation events only: `?event_type=chat.*`
      operationId: streamLogs
      security:
        - AdminKey: []
      parameters:
        - name: user_id
          in: query
          required: false
          description: Filter by user ID
          schema:
            type: string
        - name: session_id
          in: query
          required: false
          description: Filter by session ID
          schema:
            type: string
        - name: request_id
          in: query
          required: false
          description: Filter by request ID
          schema:
            type: string
        - name: agent_id
          in: query
          required: false
          description: Filter by agent ID
          schema:
            type: string
        - name: level
          in: query
          required: false
          description: Filter by log level
          schema:
            type: string
            enum: [DEBUG, INFO, WARNING, ERROR, CRITICAL]
        - name: event_type
          in: query
          required: false
          description: Filter by event type pattern (supports wildcards like "chat.*")
          schema:
            type: string
      responses:
        '200':
          description: SSE stream of log events
          content:
            text/event-stream:
              schema:
                type: string
              example: |
                event: log
                data: {
                  "timestamp": 1706616000000,
                  "level": "INFO",
                  "event_type": "chat.completed",
                  "user_id": "alice",
                  "session_id": "sess123",
                  "request_id": "req_abc",
                  "message": "Request completed",
                  "data": {}
                }

                event: log
                data: {
                  "timestamp": 1706616001000,
                  "level": "ERROR",
                  "event_type": "agent.error",
                  "agent_id": "weather-assistant",
                  "request_id": "req_abc",
                  "message": "API timeout",
                  "data": {"error": "Connection timeout"}
                }
        '400':
          description: No filter parameters provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                missing_filters:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_log456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "INVALID_REQUEST"
                      message: "At least one filter parameter is required (user_id, session_id, request_id, agent_id, level, or event_type)"
                      data: null
                    data: {}

  # Memory Configuration (Admin)
  /memory:
    get:
      tags: [Memory]
      summary: Get memory config
      description: Current memory configuration
      operationId: getMemoryConfig
      security:
        - AdminKey: []
      responses:
        '200':
          description: Memory configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                memory_config:
                  value:
                    object: "memory_config"
                    timestamp: 1706616000000
                    type: "memory.config.retrieved"
                    request:
                      id: "req_mem123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      working:
                        max_memory_mb: "auto"
                        fifo_interval_min: 5
                        vector_dimension: 1536
                        mode: "local"
                        remote:
                          url: null
                          api_key: null
                          tenant: null
                      buffer:
                        size: 10
                        multiplier: 10
                        vector_search: true
                      persistent:
                        connection_string: "${{ secrets.DATABASE_URL }}"
                        embedding_model: "openai/text-embedding-3-large"

    patch:
      tags: [Memory]
      summary: Update memory config
      description: |
        Update buffer size, multiplier, working memory settings.
        DEPRECATED: Memory configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: updateMemoryConfig
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMemoryConfigRequest'
      responses:
        '200':
          description: Memory configuration updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /memory/{item}:
    delete:
      tags: [Memory]
      summary: Reset memory setting
      description: |
        Revert setting to default value.
        DEPRECATED: Memory configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: resetMemorySetting
      security:
        - AdminKey: []
      parameters:
        - name: item
          in: path
          required: true
          description: Memory setting to reset
          schema:
            type: string
      responses:
        '200':
          description: Memory setting reset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Buffer Memory Operations
  /memory/buffer:
    get:
      tags: [Memory]
      summary: Get user buffer data
      description: |
        Get buffer memory data for a specific user.

        **Authentication:**
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both

        For aggregate stats across all users, use GET /memory/stats instead.
      operationId: getBufferStatus
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: true
          schema:
            type: string
          description: User ID (required)
      responses:
        '200':
          description: User's buffer data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                user_buffer:
                  value:
                    object: "buffer_status"
                    timestamp: 1706616000000
                    type: "memory.buffer.status"
                    request:
                      id: "req_buf123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      user_id: "alice"
                      total_messages: 45
                      sessions:
                        - session_id: "sess_abc123"
                          message_count: 25
                          last_activity: "2025-10-23T10:15:00Z"
                        - session_id: "sess_xyz789"
                          message_count: 20
                          last_activity: "2025-10-22T14:45:00Z"
                      buffer_size_kb: 128
        '400':
          description: Missing X-Muxi-User-ID header
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    delete:
      tags: [Memory]
      summary: Clear buffer
      description: |
        Clear buffer memory.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required (clears user's buffer)
        - With AdminKey: X-Muxi-User-ID optional (omit to clear all, provide to clear specific user)
      operationId: clearBuffer
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for buffer clearing.
            - Required when using ClientKey
            - Optional when using AdminKey (omit to clear all, provide to clear specific user)
      responses:
        '200':
          description: Buffer cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                user_cleared:
                  summary: User's buffer cleared
                  value:
                    object: "message"
                    timestamp: 1706616000000
                    type: "memory.buffer.cleared"
                    request:
                      id: "req_clear123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Buffer cleared successfully"
                      user_id: "alice"
                      messages_cleared: 45
                      sessions_cleared: 2

  /memory/stats:
    get:
      tags: [Memory]
      summary: Get buffer aggregate stats
      description: |
        Get aggregate statistics for buffer memory across all users.
        Admin only endpoint.
      operationId: getBufferStats
      security:
        - AdminKey: []
      responses:
        '200':
          description: Aggregate buffer statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                stats:
                  value:
                    object: "buffer_stats"
                    timestamp: 1706616000000
                    type: "memory.buffer.stats"
                    request:
                      id: "req_stats123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      total_entries: 150
                      total_users: 12
                      total_sessions: 28
                      buffer_size_kb: 512
                      max_size: 1000
                      utilization: 0.15

  /memory/buffer/{session_id}:
    delete:
      tags: [Memory]
      summary: Clear session buffer
      description: |
        Clear buffer memory for a specific session.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID required, session must belong to user
        - With AdminKey: X-Muxi-User-ID optional, can clear any session
      operationId: clearSessionBuffer
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for ownership verification.
            - Required when using ClientKey
            - Optional when using AdminKey
        - name: session_id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
      responses:
        '200':
          description: Session buffer cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                cleared:
                  value:
                    object: "message"
                    timestamp: 1706616000000
                    type: "memory.buffer.session.cleared"
                    request:
                      id: "req_clear456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Session buffer cleared successfully"
                      user_id: "alice"
                      session_id: "sess_abc123"
                      messages_cleared: 25

  # NOTE: /memory/buffers has been consolidated into /memory/buffer with dual-auth

  # Async Behavior
  /async:
    get:
      tags: [Async]
      summary: Get async settings
      description: Show async thresholds and webhook settings
      operationId: getAsyncSettings
      security:
        - AdminKey: []
      responses:
        '200':
          description: Async settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                async_settings:
                  value:
                    object: "async_settings"
                    timestamp: 1706616000000
                    type: "async.settings.retrieved"
                    request:
                      id: "req_async123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      threshold_seconds: 30
                      enable_estimation: true
                      webhook_url: "https://myapp.com/webhooks/muxi"
                      webhook_retries: 3
                      webhook_timeout: 10

    patch:
      tags: [Async]
      summary: Update async settings
      description: |
        Update threshold_seconds and webhook settings.
        DEPRECATED: Async configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: updateAsyncSettings
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAsyncSettingsRequest'
      responses:
        '200':
          description: Async settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Scheduler
  /scheduler:
    get:
      tags: [Scheduler]
      summary: Get scheduler settings
      description: Show scheduler configuration and job status
      operationId: getScheduler
      security:
        - AdminKey: []
      responses:
        '200':
          description: Scheduler settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                scheduler:
                  value:
                    object: "scheduler_config"
                    timestamp: 1706616000000
                    type: "scheduler.config.retrieved"
                    request:
                      id: "req_sched123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      enabled: false
                      timezone: "UTC"
                      check_interval_minutes: 1
                      max_concurrent_jobs: 10
                      max_failures_before_pause: 3

    patch:
      tags: [Scheduler]
      summary: Update scheduler settings
      description: |
        Update scheduler configuration.
        DEPRECATED: Scheduler configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: updateScheduler
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSchedulerRequest'
      responses:
        '200':
          description: Scheduler settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # Scheduled Jobs Management
  /scheduler/jobs:
    get:
      tags: [Scheduler]
      summary: List scheduled jobs
      description: |
        List scheduled jobs with their status.

        **Authentication:**
        - With ClientKey: X-Muxi-User-ID header is required (returns only user's jobs)
        - With AdminKey: X-Muxi-User-ID header is optional (omit for all jobs, provide to filter)
      operationId: listScheduledJobs
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - name: X-Muxi-User-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            User ID for job filtering.
            - Required when using ClientKey (returns only that user's jobs)
            - Optional when using AdminKey (omit for all, provide to filter by user)
      responses:
        '200':
          description: List of scheduled jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                job_list:
                  value:
                    object: "scheduled_job_list"
                    timestamp: 1706616000000
                    type: "scheduler.jobs.list"
                    request:
                      id: "req_sched123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      jobs:
                        - id: "daily-report"
                          type: "recurring"
                          schedule: "0 9 * * *"
                          message: "Generate daily report"
                          user_id: "system"
                          enabled: true
                          next_run: "2025-10-24T09:00:00Z"
                          last_run: "2025-10-23T09:00:00Z"
                          failure_count: 0
                        - id: "reminder-001"
                          type: "one_time"
                          run_at: "2025-10-25T14:00:00Z"
                          message: "Meeting reminder"
                          user_id: "alice"
                          enabled: true
                      count: 2

    post:
      tags: [Scheduler]
      summary: Create scheduled job
      description: |
        Create a new scheduled job (one-time or recurring).

        **Schedule format:**
        - For `type: recurring`: cron expression (e.g., "0 9 * * 1" for every Monday at 9am)
        - For `type: one_time`: ISO 8601 datetime (e.g., "2025-10-25T14:00:00Z")

        **Database Storage**: Scheduler jobs are stored in the database and require
        persistent memory (PostgreSQL or MySQL). Returns 422 error if formation uses
        SQLite or no persistent memory.

        **Persistence**: Jobs survive formation restarts and are automatically loaded on startup.
      operationId: createScheduledJob
      security:
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduledJobCreate'
            examples:
              recurring_job:
                summary: Recurring job with cron
                value:
                  type: "recurring"
                  schedule: "0 9 * * 1"
                  message: "Generate weekly report"
              one_time_job:
                summary: One-time job with datetime
                value:
                  type: "one_time"
                  schedule: "2025-10-25T14:00:00Z"
                  message: "Send meeting reminder"
      responses:
        '201':
          description: Scheduled job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                created:
                  value:
                    object: "scheduled_job"
                    timestamp: 1706616000000
                    type: "scheduler.job.created"
                    request:
                      id: "req_create123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "job-abc123"
                      type: "recurring"
                      schedule: "0 */6 * * *"
                      message: "Check system health"
                      user_id: "system"
                      next_run: "2025-10-23T18:00:00Z"
        '422':
          description: Validation error (invalid schedule or no persistent memory)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                no_persistent_memory:
                  summary: No persistent memory configured
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_job456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "UNPROCESSABLE_ENTITY"
                      message: "Scheduler jobs require persistent memory"
                      data:
                        reason: "Formation has no persistent memory configured"
                        required: "Configure memory.persistent in formation (SQLite, PostgreSQL, or MySQL)"
                    data: {}
                invalid_cron:
                  summary: Invalid cron expression for recurring job
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_job789"
                      idempotency_key: null
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Invalid cron expression for recurring job"
                      data:
                        field: "schedule"
                        value: "invalid cron"
                        expected: "Valid cron expression (e.g., '0 9 * * 1')"
                    data: {}
                invalid_datetime:
                  summary: Invalid or past datetime for one_time job
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_job101"
                      idempotency_key: null
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Schedule datetime must be in the future"
                      data:
                        field: "schedule"
                        value: "2020-01-01T00:00:00Z"
                        expected: "Future ISO 8601 datetime"
                    data: {}

  /scheduler/jobs/{job_id}:
    get:
      tags: [Scheduler]
      summary: Get scheduled job details
      description: Get details for a specific scheduled job
      operationId: getScheduledJob
      security:
        - AdminKey: []
      parameters:
        - name: job_id
          in: path
          required: true
          description: Scheduled job ID
          schema:
            type: string
      responses:
        '200':
          description: Scheduled job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                job_details:
                  value:
                    object: "scheduled_job"
                    timestamp: 1706616000000
                    type: "scheduler.job.retrieved"
                    request:
                      id: "req_get123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "daily-report"
                      type: "recurring"
                      schedule: "0 9 * * *"
                      message: "Generate daily report"
                      user_id: "system"
                      next_run: "2025-10-24T09:00:00Z"
                      last_run: "2025-10-23T09:00:00Z"
                      failure_count: 0
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    delete:
      tags: [Scheduler]
      summary: Remove scheduled job
      description: Remove a scheduled job
      operationId: removeScheduledJob
      security:
        - AdminKey: []
      parameters:
        - name: job_id
          in: path
          required: true
          description: Scheduled job ID
          schema:
            type: string
      responses:
        '200':
          description: Scheduled job removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                deleted:
                  value:
                    object: "message"
                    timestamp: 1706616000000
                    type: "scheduler.job.deleted"
                    request:
                      id: "req_del123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Scheduled job 'job-abc123' removed successfully"
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # A2A Settings
  /a2a:
    get:
      tags: [A2A]
      summary: Get A2A settings
      description: List agent-to-agent communication settings
      operationId: getA2aSettings
      security:
        - AdminKey: []
      responses:
        '200':
          description: A2A settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                a2a_settings:
                  value:
                    object: "a2a_settings"
                    timestamp: 1706616000000
                    type: "a2a.settings.retrieved"
                    request:
                      id: "req_a2a123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      enabled: true
                      outbound:
                        enabled: true
                        registries:
                          - "https://a2a.muxihub.com"
                          - "https://agents.partner.com"
                        default_retry_attempts: 3
                        default_timeout_seconds: 30
                        services: []
                      inbound:
                        enabled: true
                        registries:
                          - "https://private.company.com"
                        port: 8181
                        trusted_endpoints:
                          - "muxi.partner.com"
                        mode: "api_key"
                        shared_key: "${{ secrets.A2A_SHARED_KEY }}"

  /a2a/outbound:
    patch:
      tags: [A2A]
      summary: Update A2A outbound settings
      description: |
        Update outbound A2A communication settings.
        DEPRECATED: A2A configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: updateA2aOutbound
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateA2aOutboundRequest'
      responses:
        '200':
          description: A2A outbound settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /a2a/outbound/{item}:
    delete:
      tags: [A2A]
      summary: Reset A2A outbound setting
      description: |
        Revert outbound setting to default.
        DEPRECATED: A2A configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: resetA2aOutboundSetting
      security:
        - AdminKey: []
      parameters:
        - name: item
          in: path
          required: true
          description: Setting to reset
          schema:
            type: string
      responses:
        '200':
          description: A2A outbound setting reset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # User Credentials Endpoints
  /credentials/services:
    get:
      tags: [Credentials]
      summary: List available credential services
      description: |
        List MCP servers configured to use user credentials.

        Developers should check this list before storing credentials to ensure
        the service name matches a configured MCP server. Credentials can be
        stored for any service, but only those matching configured MCPs will be used.

        Authentication:
        - ClientKey or AdminKey accepted
      operationId: listCredentialServices
      security:
        - ClientKey: []
        - AdminKey: []
      responses:
        '200':
          description: List of available credential services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                services_list:
                  value:
                    object: "credential_list"
                    timestamp: 1706616000000
                    type: "credentials.listed"
                    request:
                      id: "req_svc123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      services:
                        - service: "github"
                          server_id: "github-mcp"
                          description: "MCP server requiring user authentication"
                        - service: "gmail"
                          server_id: "gmail-mcp"
                          description: "MCP server requiring user authentication"
                      count: 2
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /credentials:
    get:
      tags: [Credentials]
      summary: List credentials
      description: |
        List all credentials for the authenticated user.
        Returns metadata only - secrets are never exposed, only a redacted preview.

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: listCredentials
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: List of user credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                credential_list:
                  value:
                    object: "credential_list"
                    timestamp: 1706616000000
                    type: "credentials.listed"
                    request:
                      id: "req_cred123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      credentials:
                        - credential_id: "cred_abc123"
                          service: "github"
                          name: "Personal GitHub"
                          credential_preview: "ghp_abc*****xyz"
                          created_at: "2024-01-15T10:00:00Z"
                          updated_at: "2024-01-15T10:00:00Z"
                        - credential_id: "cred_def456"
                          service: "gmail"
                          name: "Personal Gmail"
                          credential_preview: "ya29.a0*****Qx8"
                          created_at: "2024-03-01T09:00:00Z"
                          updated_at: "2024-03-01T09:00:00Z"
                      count: 2
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    post:
      tags: [Credentials]
      summary: Store credential
      description: |
        Store a new credential for the authenticated user.
        The credential is encrypted at rest.

        If `name` is not provided, the system will attempt to auto-discover
        a meaningful name using MCP identity tools (e.g., calling get_me on GitHub).

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: createCredential
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - service
                - credential
              properties:
                service:
                  type: string
                  description: Service name (e.g., github, gmail, slack)
                  example: "github"
                name:
                  type: string
                  description: Optional friendly name. Auto-discovered if omitted.
                  example: "Work GitHub"
                credential:
                  type: object
                  description: Credential data (structure varies by service)
                  additionalProperties: true
                  example:
                    token: "ghp_xxxxxxxxxxxx"
      responses:
        '201':
          description: Credential created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                credential_created:
                  value:
                    object: "credential"
                    timestamp: 1706616000000
                    type: "credentials.created"
                    request:
                      id: "req_cred456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      credential_id: "cred_abc123"
                      service: "github"
                      name: "Work GitHub"
                      credential_preview: "ghp_abc*****xyz"
                      created_at: "2024-01-15T10:00:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /credentials/{credential_id}:
    get:
      tags: [Credentials]
      summary: Get credential
      description: |
        Get metadata for a specific credential.
        Returns metadata only - secrets are never exposed, only a redacted preview.

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: getCredential
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: credential_id
          in: path
          required: true
          description: Unique identifier of the credential
          schema:
            type: string
      responses:
        '200':
          description: Credential metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                credential:
                  value:
                    object: "credential"
                    timestamp: 1706616000000
                    type: "credentials.retrieved"
                    request:
                      id: "req_cred789"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      credential_id: "cred_abc123"
                      service: "github"
                      name: "Personal GitHub"
                      credential_preview: "ghp_abc*****xyz"
                      created_at: "2024-01-15T10:00:00Z"
                      updated_at: "2024-01-15T10:00:00Z"
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    delete:
      tags: [Credentials]
      summary: Delete credential
      description: |
        Delete a credential for the authenticated user.

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: deleteCredential
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: credential_id
          in: path
          required: true
          description: Unique identifier of the credential to delete
          schema:
            type: string
      responses:
        '200':
          description: Credential deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                credential_deleted:
                  value:
                    object: "credential"
                    timestamp: 1706616000000
                    type: "credentials.deleted"
                    request:
                      id: "req_cred101"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      credential_id: "cred_abc123"
                      deleted: true
        '404':
          description: Credential not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # User Memory Endpoints
  /memories:
    get:
      tags: [Memory]
      summary: Get memories
      description: |
        Read memory snippets for a user.

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: getMemories
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: User memories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                memory_list:
                  value:
                    object: "memory_list"
                    timestamp: 1706616000000
                    type: "memory.list"
                    request:
                      id: "req_mem123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      memories:
                        - id: "mem_001"
                          content:
                            type: "preference"
                            detail: "Prefers concise responses"
                          created_at: "2024-01-15T10:00:00Z"
                        - id: "mem_002"
                          content:
                            type: "context"
                            detail: "Working on e-commerce project"
                          created_at: "2024-02-01T14:30:00Z"
                      count: 2

    post:
      tags: [Memory]
      summary: Create memory
      description: |
        Create a new memory for a user.

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: createMemory
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
              description: Any JSON payload
      responses:
        '200':
          description: Memory created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /memories/{memory_id}:
    delete:
      tags: [Memory]
      summary: Delete memory
      description: |
        Delete a specific memory for a user.

        Authentication:
        - ClientKey or AdminKey accepted
        - X-Muxi-User-ID header is required for both
      operationId: deleteMemory
      security:
        - ClientKey: []
        - AdminKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: memory_id
          in: path
          required: true
          description: Unique identifier of the memory
          schema:
            type: string
      responses:
        '200':
          description: Memory deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  # Session Management
  /sessions:
    get:
      tags: [Sessions]
      summary: List user sessions
      description: List all sessions for the authenticated user
      operationId: listUserSessions
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: limit
          in: query
          required: false
          description: Maximum number of sessions to return
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of user sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                sessions:
                  value:
                    object: "session_list"
                    timestamp: 1706616000000
                    type: "session.list"
                    request:
                      id: "req_sess123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      sessions:
                        - session_id: "sess_abc123"
                          created_at: "2025-10-23T10:00:00Z"
                          last_activity: "2025-10-23T10:15:00Z"
                          message_count: 12
                          active: true
                        - session_id: "sess_xyz789"
                          created_at: "2025-10-22T14:00:00Z"
                          last_activity: "2025-10-22T14:45:00Z"
                          message_count: 8
                          active: false
                      count: 2

  /sessions/{session_id}:
    get:
      tags: [Sessions]
      summary: Get session details
      description: Get detailed information about a specific session for the authenticated user
      operationId: getSession
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: session_id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                session:
                  value:
                    object: "session"
                    timestamp: 1706616000000
                    type: "session.retrieved"
                    request:
                      id: "req_sess456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      session_id: "sess_abc123"
                      user_id: "alice"
                      created_at: "2025-10-23T10:00:00Z"
                      last_activity: "2025-10-23T10:15:00Z"
                      message_count: 12
                      active: true
                      metadata:
                        first_message: "Hello, I need help with..."
                        agents_used: ["weather-assistant", "code-assistant"]

  # NOTE: DELETE /sessions/{session_id} removed - sessions are ephemeral buffer state,
  # not persistent resources. Buffer rolls off automatically and clears on restart.

  /sessions/{session_id}/messages:
    get:
      tags: [Sessions]
      summary: Get session message history
      description: Retrieve chat message history for a session for the authenticated user
      operationId: getSessionMessages
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: session_id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
        - name: limit
          in: query
          required: false
          description: Maximum number of messages (default = 50)
          schema:
            type: integer
            default: 50
        - name: before
          in: query
          required: false
          description: Get messages before this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Session message history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                messages:
                  value:
                    object: "message_list"
                    timestamp: 1706616000000
                    type: "session.messages.list"
                    request:
                      id: "req_msgs123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      session_id: "sess_abc123"
                      messages:
                        - timestamp: "2025-10-23T10:00:00Z"
                          role: "user"
                          content: "What's the weather like?"
                        - timestamp: "2025-10-23T10:00:15Z"
                          role: "assistant"
                          content: "The weather today is sunny with a high of 72°F."
                          agent_id: "weather-assistant"
                        - timestamp: "2025-10-23T10:05:00Z"
                          role: "user"
                          content: "Can you help me with Python code?"
                        - timestamp: "2025-10-23T10:05:30Z"
                          role: "assistant"
                          content: "Of course! What do you need help with?"
                          agent_id: "code-assistant"
                      count: 4
                      has_more: false

  /sessions/{session_id}/restore:
    post:
      tags: [Sessions]
      summary: Restore session from external storage
      description: |
        Hydrate a session's buffer memory with messages from external storage.
        This enables developers to implement persistent chat history in their own database
        while using MUXI's ephemeral buffer for active conversations.

        **Use Case:**
        1. Developer persists messages to their own database
        2. User returns to continue a conversation
        3. Developer calls this endpoint with stored messages
        4. Buffer is hydrated, user continues where they left off

        **Behavior:**
        - Clears any existing messages for this user+session
        - Loads provided messages into buffer in timestamp order
        - Subsequent chat requests will have full conversation context

        **Note:** Messages are still subject to buffer size limits. If more messages
        are provided than the buffer can hold, oldest messages will be dropped.
      operationId: restoreSession
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: session_id
          in: path
          required: true
          description: Session ID to restore
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messages
              properties:
                messages:
                  type: array
                  description: Messages to load into the session buffer
                  items:
                    type: object
                    required:
                      - role
                      - content
                      - timestamp
                    properties:
                      role:
                        type: string
                        enum: [user, assistant, system]
                        description: Message role
                      content:
                        type: string
                        description: Message content
                      timestamp:
                        type: string
                        format: date-time
                        description: Original message timestamp (ISO 8601)
                      agent_id:
                        type: string
                        description: Agent that generated the response (for assistant messages)
                      metadata:
                        type: object
                        description: Additional metadata to preserve
            examples:
              restore_conversation:
                value:
                  messages:
                    - role: "user"
                      content: "What's the weather like?"
                      timestamp: "2025-10-23T10:00:00Z"
                    - role: "assistant"
                      content: "The weather today is sunny with a high of 72°F."
                      timestamp: "2025-10-23T10:00:15Z"
                      agent_id: "weather-assistant"
                    - role: "user"
                      content: "Thanks! What about tomorrow?"
                      timestamp: "2025-10-23T10:01:00Z"
      responses:
        '200':
          description: Session restored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                restored:
                  value:
                    object: "session"
                    timestamp: 1706616000000
                    type: "session.restored"
                    request:
                      id: "req_restore123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      session_id: "sess_abc123"
                      messages_loaded: 3
                      messages_dropped: 0
                      message: "Session restored successfully"
        '400':
          description: Invalid request (malformed messages)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # User Identity Management
  /users/identifiers:
    post:
      tags: [Users]
      summary: Associate multiple identifiers to a user
      description: |
        Link multiple external identifiers (email, Slack ID, Telegram handle, etc.) to a single MUXI user.
        This enables context and memory carryover across different communication channels.

        **Multi-Identity Support:**
        - All identifiers resolve to the same internal user
        - Memories, credentials, and jobs are shared across all identifiers
        - Transparent to end users, simple API for developers

        **Input Formats:**
        The identifiers array supports flexible input:
        - Simple strings: `["alice@email.com", "U12345"]`
        - Tuples (with type): `[["alice@email.com", "email"], ["U12345", "slack"]]`
        - Objects: `[{"identifier": "alice@email.com", "type": "email"}]`
      operationId: associateUserIdentifiers
      security:
        - ClientKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - identifiers
              properties:
                muxi_user_id:
                  type: string
                  description: |
                    MUXI user ID (public_id) to associate identifiers to.
                    If not provided, creates a new user.
                  example: "usr_abc123"
                identifiers:
                  type: array
                  description: |
                    List of identifiers to associate. Supports multiple formats:
                    strings, arrays (identifier + type), or objects.
                  items:
                    oneOf:
                      - type: string
                        description: Simple identifier string
                        example: "alice@company.com"
                      - type: array
                        description: Identifier with type hint
                        items:
                          type: string
                        minItems: 2
                        maxItems: 2
                        example: ["U12345", "slack"]
                      - type: object
                        required: [identifier]
                        properties:
                          identifier:
                            type: string
                            example: "@alice_telegram"
                          type:
                            type: string
                            example: "telegram"
                  example:
                    - "alice@company.com"
                    - ["U12345", "slack"]
                    - {"identifier": "@alice_tg", "type": "telegram"}
            examples:
              simple_strings:
                summary: Simple string identifiers
                value:
                  muxi_user_id: "usr_abc123"
                  identifiers:
                    - "alice@company.com"
                    - "U12345"
                    - "@alice_telegram"
              with_types:
                summary: Identifiers with types
                value:
                  identifiers:
                    - ["alice@company.com", "email"]
                    - ["U12345", "slack"]
                    - ["@alice_tg", "telegram"]
              mixed_format:
                summary: Mixed format (all supported)
                value:
                  muxi_user_id: "usr_xyz789"
                  identifiers:
                    - "bob@example.com"
                    - ["U67890", "slack"]
                    - {"identifier": "+1234567890", "type": "phone"}
      responses:
        '200':
          description: Identifiers successfully associated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                success:
                  value:
                    object: "user_identifiers"
                    timestamp: 1706616000000
                    type: "user.identifiers.associated"
                    request:
                      id: "req_usr123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      muxi_user_id: "usr_abc123"
                      internal_user_id: 42
                      identifiers_associated: 3
                      new_identifiers:
                        - "U12345"
                        - "@alice_tg"
                      existing_identifiers:
                        - "alice@company.com"
                      conflicts: []
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                invalid_format:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.validation"
                    request:
                      id: "req_usr124"
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Invalid identifier format"
                      data:
                        validation_errors:
                          - field: "identifiers[2]"
                            message: "Dict format must have 'identifier' key"
        '404':
          description: MUXI user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                user_not_found:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.not_found"
                    request:
                      id: "req_usr125"
                    success: false
                    error:
                      code: "USER_NOT_FOUND"
                      message: "User not found: usr_invalid123"
        '409':
          description: Identifier conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                conflict:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.conflict"
                    request:
                      id: "req_usr126"
                    success: false
                    error:
                      code: "IDENTIFIER_CONFLICT"
                      message: "Identifier conflicts detected"
                      data:
                        conflicts:
                          - identifier: "alice@company.com"
                            reason: "Already linked to different user (ID: 123)"

    get:
      tags: [Users]
      summary: List user's identifiers
      description: List all identifiers associated with the authenticated user
      operationId: getUserIdentifiers
      security:
        - ClientKey: []
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: List of user's identifiers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                identifiers:
                  value:
                    object: "user_identifiers"
                    timestamp: 1706616000000
                    type: "user.identifiers.list"
                    request:
                      id: "req_usr123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      muxi_user_id: "usr_abc123"
                      internal_user_id: 42
                      identifiers:
                        - identifier: "alice@company.com"
                          type: "email"
                          created_at: "2025-01-15T10:00:00Z"
                        - identifier: "U12345"
                          type: "slack"
                          created_at: "2025-01-15T10:00:00Z"
                        - identifier: "@alice_tg"
                          type: "telegram"
                          created_at: "2025-02-10T14:00:00Z"
                      count: 3

  /users/identifiers/{identifier}:
    delete:
      tags: [Users]
      summary: Remove identifier mapping
      description: Remove a specific identifier mapping from a user
      operationId: deleteUserIdentifier
      security:
        - ClientKey: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Identifier to remove (e.g., email, Slack ID, etc.)
          schema:
            type: string
      responses:
        '200':
          description: Identifier removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                removed:
                  value:
                    object: "message"
                    timestamp: 1706616000000
                    type: "user.identifier.deleted"
                    request:
                      id: "req_del123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      message: "Identifier 'U12345' removed successfully"
                      muxi_user_id: "usr_abc123"
        '404':
          description: Identifier not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /users/{identifier}:
    get:
      tags: [Users]
      summary: Resolve identifier to MUXI user
      description: Look up which MUXI user an identifier belongs to
      operationId: resolveUserIdentifier
      security:
        - ClientKey: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Identifier to resolve
          schema:
            type: string
      responses:
        '200':
          description: Identifier resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                resolved:
                  value:
                    object: "user"
                    timestamp: 1706616000000
                    type: "user.resolved"
                    request:
                      id: "req_resolve123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      identifier: "alice@company.com"
                      muxi_user_id: "usr_abc123"
                      internal_user_id: 42

  /users/resolve:
    post:
      tags: [Users]
      summary: Resolve identifier with creation
      description: |
        Resolve an identifier to a MUXI user, creating a new user if the identifier
        doesn't exist. Use this instead of GET /users/{identifier} when you want
        automatic user creation.
      operationId: resolveIdentifierWithCreation
      security:
        - ClientKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - identifier
              properties:
                identifier:
                  type: string
                  description: Identifier to resolve
                identifier_type:
                  type: string
                  description: Optional type hint (email, slack, telegram, etc.)
            examples:
              resolve:
                value:
                  identifier: "alice@email.com"
                  identifier_type: "email"
      responses:
        '200':
          description: Identifier resolved (user created if new)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                resolved:
                  value:
                    object: "user"
                    timestamp: 1706616000000
                    type: "user.resolved"
                    request:
                      id: "req_resolve123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      identifier: "alice@email.com"
                      muxi_user_id: "usr_abc123"
                      internal_user_id: 42

  /users/identifiers/{user_id}:
    get:
      tags: [Users]
      summary: List identifiers by user ID
      description: List all identifiers associated with a specific MUXI user ID
      operationId: listUserIdentifiersById
      security:
        - ClientKey: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: MUXI user ID (public_id like usr_abc123)
          schema:
            type: string
      responses:
        '200':
          description: List of user's identifiers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                identifiers:
                  value:
                    object: "user_identifier_list"
                    timestamp: 1706616000000
                    type: "user.identifiers.list"
                    request:
                      id: "req_usr123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      muxi_user_id: "usr_abc123"
                      internal_user_id: 42
                      identifiers:
                        - identifier: "alice@company.com"
                          type: "email"
                          created_at: "2025-01-15T10:00:00Z"
                      count: 1
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  # MCP Configuration
  /mcp:
    get:
      tags: [MCP]
      summary: Get MCP defaults
      description: View global MCP defaults
      operationId: getMcpDefaults
      security:
        - AdminKey: []
      responses:
        '200':
          description: MCP defaults
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                defaults:
                  value:
                    object: "mcp_defaults"
                    timestamp: 1706616000000
                    type: "mcp.defaults.retrieved"
                    request:
                      id: "req_mcp123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      default_retry_attempts: 3
                      default_timeout_seconds: 30
                      max_tool_iterations: 10
                      max_tool_calls: 50
                      max_repeated_errors: 3
                      max_timeout_in_seconds: 300
                      max_tool_timeout_in_seconds: 30
                      enhance_user_prompts: true
                      servers: []

    patch:
      tags: [MCP]
      summary: Update MCP defaults
      description: |
        Update default retry attempts and timeout.
        DEPRECATED: MCP configuration should be changed via formation YAML and redeployment.
      deprecated: true
      operationId: updateMcpDefaults
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMcpDefaultsRequest'
            examples:
              update_timeout:
                value:
                  default_timeout_seconds: 60
              update_retries:
                value:
                  default_retry_attempts: 5
      responses:
        '200':
          description: MCP defaults updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                updated:
                  value:
                    object: "mcp_defaults"
                    timestamp: 1706616000000
                    type: "mcp.defaults.updated"
                    request:
                      id: "req_mcp456"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      default_retry_attempts: 5
                      default_timeout_seconds: 60

  # MCP Servers
  /mcp/servers:
    get:
      tags: [MCP]
      summary: List MCP servers
      description: List all MCP servers
      operationId: listMcpServers
      security:
        - AdminKey: []
      responses:
        '200':
          description: List of MCP servers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                server_list:
                  value:
                    object: "mcp_server_list"
                    timestamp: 1706616000000
                    type: "mcp.server.list"
                    request:
                      id: "req_servers123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      servers:
                        - schema: "1.0.0"
                          id: "local-tools"
                          description: "Local command tools for file operations and system utilities"
                          active: true
                          source: "formation"
                          type: "command"
                          author: "MUXI Team <team@muxi.ai>"
                          url: "https://github.com/modelcontextprotocol/servers"
                          license: "MIT"
                          version: "1.0.0"
                          install: "npm install -g @modelcontextprotocol/server-json-rpc"
                          command: "npx"
                          args: ["-y", "@modelcontextprotocol/server-json-rpc"]
                          working_directory: "/workspace"
                          timeout_seconds: 60
                          max_retries: 3
                        - schema: "1.0.0"
                          id: "web-tools"
                          description: "External web API tools"
                          active: true
                          source: "api"
                          type: "http"
                          endpoint: "http://localhost:8271"
                          timeout_seconds: 30
                          retry_attempts: 3
                          auth:
                            type: "bearer"
                            token: "${{ secrets.MCP_TOKEN }}"
                      count: 2

    post:
      tags: [MCP]
      summary: Add MCP server
      description: |
        Add a new MCP server.

        **DEPRECATED**: This endpoint is deprecated. Use formation deployment to add MCP servers instead.
      operationId: createMcpServer
      deprecated: true
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMcpServerRequest'
            examples:
              add_server:
                value:
                  name: "calculator"
                  url: "stdio://mcp-calculator"
                  transport: "stdio"
                  description: "Basic calculator operations"
      responses:
        '201':
          description: MCP server created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                created:
                  value:
                    object: "mcp_server"
                    timestamp: 1706616000000
                    type: "mcp.server.created"
                    request:
                      id: "req_create789"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "calculator"
                      name: "calculator"
                      url: "stdio://mcp-calculator"
                      transport: "stdio"
                      active: true
                      source: "api"
                      tools_available: ["add", "subtract", "multiply", "divide"]
                      status: "connecting"

  /mcp/servers/{server_id}:
    get:
      tags: [MCP]
      summary: Get MCP server
      description: Inspect a single MCP server
      operationId: getMcpServer
      security:
        - AdminKey: []
      parameters:
        - name: server_id
          in: path
          required: true
          description: Unique identifier of the MCP server
          schema:
            type: string
          example: "filesystem"
      responses:
        '200':
          description: MCP server details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                server_details:
                  value:
                    object: "mcp_server"
                    timestamp: 1706616000000
                    type: "mcp.server.retrieved"
                    request:
                      id: "req_get123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "filesystem"
                      name: "File System MCP"
                      url: "stdio://mcp-filesystem"
                      transport: "stdio"
                      active: true
                      source: "formation"
                      tools_available: ["read_file", "write_file", "list_directory"]
                      status: "connected"
                      config:
                        retry_attempts: 3
                        timeout_seconds: 30

    patch:
      tags: [MCP]
      summary: Update MCP server
      description: |
        Update server configuration.

        **DEPRECATED**: This endpoint is deprecated. Use formation deployment to update MCP servers instead.
      operationId: updateMcpServer
      deprecated: true
      security:
        - AdminKey: []
      parameters:
        - name: server_id
          in: path
          required: true
          description: Unique identifier of the MCP server
          schema:
            type: string
          example: "web-search"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMcpServerRequest'
            examples:
              deactivate:
                value:
                  active: false
              update_limits:
                value:
                  retry_attempts: 5
                  timeout_seconds: 45
      responses:
        '200':
          description: MCP server updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                updated:
                  value:
                    object: "mcp_server"
                    timestamp: 1706616000000
                    type: "mcp.server.updated"
                    request:
                      id: "req_update123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      id: "web-search"
                      name: "Web Search MCP"
                      url: "http://localhost:8080/mcp"
                      transport: "http"
                      active: false
                      source: "api"
                      tools_available: []
                      status: "disconnected"

    delete:
      tags: [MCP]
      summary: Delete MCP server
      description: |
        Delete an API-created MCP server.

        **DEPRECATED**: This endpoint is deprecated. Use formation deployment to manage MCP servers instead.
      operationId: deleteMcpServer
      deprecated: true
      security:
        - AdminKey: []
      parameters:
        - name: server_id
          in: path
          required: true
          description: Unique identifier of the MCP server
          schema:
            type: string
          example: "calculator"
      responses:
        '204':
          description: MCP server deleted
        '403':
          description: Cannot delete YAML-defined server
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                yaml_protected:
                  value:
                    object: "error"
                    timestamp: 1706616000000
                    type: "error.authorization"
                    request:
                      id: "req_delete456"
                      idempotency_key: null
                    success: false
                    error:
                      code: "FORBIDDEN"
                      message: "Cannot delete YAML-defined MCP server"
                      data: null
                    data: {}
        '404':
          description: MCP server not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /mcp/tools:
    get:
      tags: [MCP]
      summary: List available MCP tools
      description: Get list of all tools available across all MCP servers
      operationId: listMcpTools
      security:
        - AdminKey: []
      responses:
        '200':
          description: List of MCP tools
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                tools:
                  value:
                    object: "mcp_tool_list"
                    timestamp: 1706616000000
                    type: "mcp.tools.list"
                    request:
                      id: "req_tools123"
                      idempotency_key: null
                    success: true
                    error: null
                    data:
                      tools:
                        - name: "read_file"
                          server: "filesystem"
                          description: "Read contents of a file"
                        - name: "search"
                          server: "web-search"
                          description: "Search the web"
                      count: 2

  # NOTE: /stream/{session_id}/{request_id} has been consolidated into /events/{session_id}/{request_id}

components:
  securitySchemes:
    AdminKey:
      type: apiKey
      in: header
      name: X-MUXI-ADMIN-KEY
      description: Admin API key for formation management
    ClientKey:
      type: apiKey
      in: header
      name: X-MUXI-CLIENT-KEY
      description: Client API key for user interactions

  parameters:
    UserIdHeader:
      name: X-Muxi-User-ID
      in: header
      required: true
      schema:
        type: string
        default: "0"
      description: |
        User identifier for multi-user formations.
        - Required for formations with multi-user persistence (non-SQLite databases)
        - Defaults to "0" for single-user formations (SQLite or no persistence)
        - Must be consistent across requests within a session
        - Used to isolate user data and maintain separate conversation contexts

  schemas:
    # API Response Envelope
    ApiResponse:
      type: object
      required: [object, timestamp, type, request, success, data]
      properties:
        object:
          type: string
          description: Response object type
          example: "chat_response"
        timestamp:
          type: integer
          description: Unix timestamp in milliseconds
          example: 1706616000000
        type:
          type: string
          description: Event type for observability
          example: "chat.completed"
        request:
          type: object
          properties:
            id:
              type: string
              description: Request ID
              example: "req_abc123"
            idempotency_key:
              type: ["string", "null"]
              description: Idempotency key if provided
        success:
          type: boolean
          description: Success indicator
        error:
          type: ["object", "null"]
          properties:
            code:
              type: string
              description: Error code
              example: "INVALID_REQUEST"
            message:
              type: string
              description: Human-readable error message
            data:
              type: ["object", "null"]
              description: Additional error data (validation errors, stack traces, etc.)
              additionalProperties: true
        data:
          type: object
          description: Response data (empty object on error)
          additionalProperties: true

    # Health & Status
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        uptime_seconds:
          type: integer

    StatusResponse:
      type: object
      properties:
        formation_id:
          type: string
        agents:
          type: object
        mcp_servers:
          type: object
        memory:
          type: object
        uptime_seconds:
          type: integer

    # Agents
    AgentCreate:
      type: object
      required: [schema, id, name, description]
      properties:
        schema:
          type: string
          description: Agent schema version using semantic versioning
          example: "1.0.0"
        id:
          type: string
          description: Unique identifier for this agent (supports namespacing with '/')
          example: "weather-assistant"
        name:
          type: string
          description: Human-readable display name for the agent
          example: "Weather Assistant"
        description:
          type: string
          description: Clear description of the agent's purpose and capabilities
          example: "Specialized in providing weather forecasts and meteorological information"
        active:
          type: boolean
          description: Whether the agent is active and available for interactions
          default: true
        author:
          type: string
          description: Author information with optional email contact
          example: "John Doe <john@example.com>"
        url:
          type: string
          description: URL for agent documentation or repository
          example: "https://github.com/example/weather-agent"
        license:
          type: string
          description: License type (e.g., MIT, Apache-2.0)
          default: "Unlicense"
          example: "MIT"
        version:
          type: string
          description: Agent version using semantic versioning
          example: "1.0.0"
        system_message:
          type: string
          description: Agent personality, behavior instructions, and operational guidelines
          example: "You are a weather assistant that provides accurate forecasts and meteorological information."
        llm_models:
          type: array
          description: Agent-specific model settings that override formation defaults. Each item specifies ONE capability type.
          example:
            - text: "openai/gpt-4o"
              api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
              settings:
                temperature: 0.2
                max_tokens: 1000
                timeout_seconds: 30
                max_retries: 2
                fallback_model: "anthropic/claude-3.5-haiku"
            - vision: "anthropic/claude-3-opus"
              api_key: "${{ secrets.AGENT_ANTHROPIC_KEY }}"
              settings:
                temperature: 0.7
                max_tokens: 1500
                timeout_seconds: 45
                max_retries: 3
                fallback_model: "openai/gpt-4-vision-preview"
            - audio: "openai/whisper-1"
              api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
              settings:
                temperature: 0.0
                max_tokens: 500
                timeout_seconds: 60
                max_retries: 2
                fallback_model: "deepgram/nova-2"
            - video: "openai/gpt-4o"
              api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
              settings:
                temperature: 0.5
                max_tokens: 2000
                timeout_seconds: 120
                max_retries: 1
                fallback_model: "anthropic/claude-3-opus"
            - documents: "openai/gpt-4o"
              api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
              settings:
                temperature: 0.3
                max_tokens: 4000
                timeout_seconds: 90
                max_retries: 3
                fallback_model: "anthropic/claude-3.5-sonnet"
            - embedding: "openai/text-embedding-3-large"
              api_key: "${{ secrets.AGENT_OPENAI_KEY }}"
              settings:
                temperature: 0.0
                max_tokens: 8192
                timeout_seconds: 30
                max_retries: 5
                fallback_model: "cohere/embed-english-v3.0"
          items:
            type: object
            description: Model capability override with optional API key and settings. Each object should contain exactly ONE capability type (text, vision, audio, etc.)
            additionalProperties: true
            minProperties: 1
            properties:
              text:
                type: string
                description: Model for text generation and conversation
                example: "openai/gpt-4o"
              vision:
                type: string
                description: Model for image analysis and vision tasks
                example: "openai/gpt-4o"
              audio:
                type: string
                description: Model for audio transcription and processing
                example: "openai/whisper-1"
              video:
                type: string
                description: Model for video analysis including visual and audio content
                example: "openai/gpt-4o"
              documents:
                type: string
                description: Model for document processing and extraction
                example: "openai/gpt-4o"
              embedding:
                type: string
                description: Model for generating text embeddings
                example: "openai/text-embedding-3-large"
              api_key:
                type: string
                description: API key specific to this model capability
                example: "${{ secrets.AGENT_OPENAI_KEY }}"
              settings:
                type: object
                description: Settings specific to this model capability
                properties:
                  temperature:
                    type: number
                    format: float
                    minimum: 0.0
                    maximum: 1.0
                    description: Creativity level for this model
                    example: 0.2
                  max_tokens:
                    type: integer
                    description: Maximum tokens for responses
                    example: 1000
                  timeout_seconds:
                    type: integer
                    description: Request timeout in seconds
                    example: 30
                  max_retries:
                    type: integer
                    description: Number of retry attempts
                    example: 2
                  fallback_model:
                    type: string
                    description: Fallback model if primary fails
                    example: "anthropic/claude-3.5-haiku"
        mcp_servers:
          type: array
          description: Agent-specific MCP server configurations
          items:
            type: object
            required: [id]
            properties:
              id:
                type: string
                description: MCP server ID to use
              auth:
                type: object
                description: Override authentication for this MCP server
                properties:
                  type:
                    type: string
                    enum: [none, api_key, bearer, oauth]
                    description: Authentication type
                  api_key:
                    type: string
                    description: API key for authentication
                  token:
                    type: string
                    description: Bearer token for authentication
                  credentials:
                    type: string
                    description: OAuth credentials
        knowledge:
          type: array
          description: Agent knowledge sources and context
          items:
            type: object
            properties:
              type:
                type: string
                enum: [file, directory, url]
                description: Type of knowledge source
              path:
                type: string
                description: Path or URL to the knowledge source
              description:
                type: string
                description: Description of what this knowledge contains
        a2a:
          type: object
          description: Agent-to-agent communication settings
          properties:
            can_receive_broadcast:
              type: boolean
              description: Whether this agent can receive broadcast messages
              default: true
            can_send_to:
              type: array
              description: List of agent IDs this agent can send messages to
              items:
                type: string
            can_receive_from:
              type: array
              description: List of agent IDs this agent can receive messages from
              items:
                type: string

    AgentUpdate:
      type: object
      properties:
        name:
          type: string
          description: Human-readable display name for the agent
        description:
          type: string
          description: Clear description of the agent's purpose and capabilities
        active:
          type: boolean
          description: Whether the agent is active and available for interactions
        author:
          type: string
          description: Author information with optional email contact
        url:
          type: string
          description: URL for agent documentation or repository
        license:
          type: string
          description: License type (e.g., MIT, Apache-2.0)
        version:
          type: string
          description: Agent version using semantic versioning
        system_message:
          type: string
          description: Agent personality, behavior instructions, and operational guidelines
        llm_models:
          type: array
          description: Agent-specific model settings that override formation defaults. Each item specifies ONE capability type.
          items:
            type: object
            description: Model capability override with optional API key and settings. Each object should contain exactly ONE capability type (text, vision, audio, etc.)
            additionalProperties: true
            minProperties: 1
            properties:
              text:
                type: string
                description: Model for text generation and conversation
              vision:
                type: string
                description: Model for image analysis and vision tasks
              audio:
                type: string
                description: Model for audio transcription and processing
              video:
                type: string
                description: Model for video analysis including visual and audio content
              documents:
                type: string
                description: Model for document processing and extraction
              embedding:
                type: string
                description: Model for generating text embeddings
              api_key:
                type: string
                description: API key specific to this model capability
              settings:
                type: object
                description: Settings specific to this model capability
                properties:
                  temperature:
                    type: number
                    format: float
                    minimum: 0.0
                    maximum: 1.0
                    description: Creativity level for this model
                  max_tokens:
                    type: integer
                    description: Maximum tokens for responses
                  timeout_seconds:
                    type: integer
                    description: Request timeout in seconds
                  max_retries:
                    type: integer
                    description: Number of retry attempts
                  fallback_model:
                    type: string
                    description: Fallback model if primary fails
        mcp_servers:
          type: array
          description: Agent-specific MCP server configurations
          items:
            type: object
            required: [id]
            properties:
              id:
                type: string
                description: MCP server ID to use
              auth:
                type: object
                description: Override authentication for this MCP server
                properties:
                  type:
                    type: string
                    enum: [none, api_key, bearer, oauth]
                    description: Authentication type
                  api_key:
                    type: string
                    description: API key for authentication
                  token:
                    type: string
                    description: Bearer token for authentication
                  credentials:
                    type: string
                    description: OAuth credentials
        knowledge:
          type: array
          description: Agent knowledge sources and context
          items:
            type: object
            properties:
              type:
                type: string
                enum: [file, directory, url]
                description: Type of knowledge source
              path:
                type: string
                description: Path or URL to the knowledge source
              description:
                type: string
                description: Description of what this knowledge contains
        a2a:
          type: object
          description: Agent-to-agent communication settings
          properties:
            can_receive_broadcast:
              type: boolean
              description: Whether this agent can receive broadcast messages
            can_send_to:
              type: array
              description: List of agent IDs this agent can send messages to
              items:
                type: string
            can_receive_from:
              type: array
              description: List of agent IDs this agent can receive messages from
              items:
                type: string

    # Secrets
    SecretCreate:
      type: object
      required: [key, value]
      properties:
        key:
          type: string
          description: Name of the secret key (case-insensitive, will be normalized to uppercase with special chars replaced by underscores)
          example: "my-api-key"
        value:
          type: string
          description: Secret value
          example: "sk-1234567890abcdef"

    SecretUpdate:
      type: object
      required: [value]
      properties:
        value:
          type: string

    # MCP
    UpdateMcpDefaultsRequest:
      type: object
      properties:
        default_retry_attempts:
          type: integer
          minimum: 0
          maximum: 10
          description: Default number of retry attempts for MCP operations
        default_timeout_seconds:
          type: integer
          minimum: 1
          maximum: 300
          description: Default timeout in seconds for MCP operations

    CreateMcpServerRequest:
      type: object
      required: [name, url]
      properties:
        name:
          type: string
          description: MCP server name
        url:
          type: string
          description: MCP server URL (stdio://, http://, etc)
        transport:
          type: string
          enum: [stdio, http, sse]
          default: stdio
          description: Transport protocol
        description:
          type: string
          description: Optional description of the MCP server

    UpdateMcpServerRequest:
      type: object
      properties:
        active:
          type: boolean
          description: Whether the server is active
        retry_attempts:
          type: integer
          minimum: 0
          maximum: 10
          description: Number of retry attempts for this server
        timeout_seconds:
          type: integer
          minimum: 1
          maximum: 300
          description: Timeout in seconds for this server

    # Chat
    ChatRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
          description: User message
        group_id:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
          description: "[Reserved for future use] Optional group(s) for permission filtering. Currently accepted but not processed."
        webhook_url:
          type: string
          format: uri
          description: Optional webhook for async completion
        files:
          type: array
          description: Optional file attachments
          items:
            type: object
            properties:
              filename:
                type: string
                description: Name of the file
              content:
                type: string
                description: Base64 encoded file content
              content_type:
                type: string
                description: MIME type of the file

    TriggerRequest:
      type: object
      required: [data]
      properties:
        data:
          type: object
          additionalProperties: true
          description: |
            Event data to pass to trigger template. Supports nested objects accessed via dot notation.
            Example: {"issue": {"number": 123, "title": "Bug"}} -> ${{ data.issue.number }}
        session_id:
          type: string
          description: Optional session ID for conversation grouping
        use_async:
          type: boolean
          default: true
          description: |
            Process trigger asynchronously (true) or synchronously (false).
            - Async (default): Returns immediately with request_id, non-blocking
            - Sync: Waits for completion, returns response content
      example:
        data:
          repository: "muxi/runtime"
          issue:
            number: 123
            title: "Add trigger system"
            author: "alice"
            state: "open"
        use_async: true

    AudioChatRequest:
      type: object
      description: |
        Request for audio-based chat (voice notes).
        The audio is transcribed and the transcription becomes the user's message.
      required:
        - files
      properties:
        files:
          type: array
          description: Audio files to transcribe. Only audio/* MIME types are accepted.
          minItems: 1
          items:
            type: object
            required:
              - filename
              - content
              - content_type
            properties:
              filename:
                type: string
                description: Name of the audio file
              content:
                type: string
                format: byte
                description: Base64 encoded audio content
              content_type:
                type: string
                pattern: "^audio/"
                description: MIME type of the audio file (must be audio/*)
              size:
                type: integer
                description: Size of the file in bytes
        agent_name:
          type: string
          description: Name of the specific agent to use
        user_id:
          type: string
          description: User identifier for multi-user isolation
        session_id:
          type: string
          description: Session identifier for grouping conversations
        use_async:
          type: boolean
          description: Whether to process the request asynchronously
        webhook_url:
          type: string
          description: URL to receive async response callback
        threshold_seconds:
          type: number
          description: Time threshold for switching to async mode
        stream:
          type: boolean
          description: Whether to stream the response
        prompt_template:
          type: string
          description: Custom prompt template to use instead of auto-generated

    # New Admin Request Schemas
    UpdateLlmSettingsRequest:
      type: object
      properties:
        temperature:
          type: number
          minimum: 0
          maximum: 2
          description: Sampling temperature
        max_tokens:
          type: integer
          minimum: 1
          maximum: 32000
          description: Maximum tokens in response
        timeout_seconds:
          type: integer
          minimum: 1
          maximum: 300
          description: Request timeout in seconds

    # Logging Schemas
    LoggingDestinationCreate:
      type: object
      required: [transport, level, format]
      properties:
        id:
          type: string
          description: Optional ID (auto-generated if not provided)
        transport:
          type: string
          enum: [stdout, file, stream]
          description: Transport type
        destination:
          type: string
          description: Destination path/URL (required for file and stream)
        level:
          type: string
          enum: [DEBUG, INFO, WARNING, ERROR, CRITICAL]
          description: Log level
        format:
          type: string
          enum: [text, jsonl]
          description: Log format
        enabled:
          type: boolean
          default: true
          description: Whether destination is enabled

    LoggingDestinationUpdate:
      type: object
      properties:
        level:
          type: string
          enum: [DEBUG, INFO, WARNING, ERROR, CRITICAL]
          description: Log level
        format:
          type: string
          enum: [text, jsonl]
          description: Log format
        enabled:
          type: boolean
          description: Whether destination is enabled

    # Scheduler Schemas
    ScheduledJobCreate:
      type: object
      required: [type, schedule, message]
      properties:
        type:
          type: string
          enum: [one_time, recurring]
          description: |
            Job type. Determines how `schedule` is interpreted:
            - `recurring`: schedule is a cron expression
            - `one_time`: schedule is an ISO 8601 datetime
        schedule:
          type: string
          description: |
            Schedule specification. Format depends on `type`:
            - For `recurring`: cron expression (e.g., "0 9 * * 1" for Mondays at 9am)
            - For `one_time`: ISO 8601 datetime (e.g., "2025-10-25T14:00:00Z")
        message:
          type: string
          description: Prompt to send to the AI when the job executes

    UpdateMemoryConfigRequest:
      type: object
      properties:
        buffer:
          type: object
          properties:
            size:
              type: integer
              minimum: 100
              maximum: 10000
            multiplier:
              type: number
              minimum: 1.0
              maximum: 10.0
            vector_search:
              type: boolean
        working:
          type: object
          properties:
            max_memory_mb:
              type: integer
              minimum: 128
              maximum: 4096
            fifo_interval_min:
              type: integer
              minimum: 1
              maximum: 1440

    UpdateAsyncSettingsRequest:
      type: object
      properties:
        threshold_seconds:
          type: integer
          minimum: 5
          maximum: 600
          description: Threshold for async processing
        webhook_timeout_seconds:
          type: integer
          minimum: 1
          maximum: 60
          description: Webhook timeout
        webhook_retry_attempts:
          type: integer
          minimum: 0
          maximum: 10
          description: Webhook retry attempts
        webhook_max_payload_mb:
          type: integer
          minimum: 1
          maximum: 100
          description: Maximum webhook payload size

    UpdateSchedulerRequest:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether scheduler is enabled
        timezone:
          type: string
          description: Scheduler timezone
        check_interval_minutes:
          type: integer
          minimum: 1
          maximum: 60
          description: Check interval in minutes
        max_concurrent_jobs:
          type: integer
          minimum: 1
          maximum: 100
          description: Maximum concurrent jobs
        max_failures_before_pause:
          type: integer
          minimum: 1
          maximum: 20
          description: Max failures before pausing

    UpdateA2aOutboundRequest:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether outbound A2A is enabled
        default_retry_attempts:
          type: integer
          minimum: 0
          maximum: 10
          description: Default retry attempts
        default_timeout_seconds:
          type: integer
          minimum: 1
          maximum: 300
          description: Default timeout in seconds
        allowed_formations:
          type: array
          items:
            type: string
          description: List of allowed formations


  # Events documentation (SSE format)
  x-events:
    chat_token:
      description: Streaming chat tokens
      example: |
        event: chat_token
        data: {"request_id": "req_123", "token": "Hello"}

    job_update:
      description: Async job progress
      example: |
        event: job_update
        data: {"request_id": "job_123", "status": "processing", "progress": 45}

    job_done:
      description: Async job completed
      example: |
        event: job_done
        data: {"request_id": "job_123", "result_url": "/results/job_123"}
