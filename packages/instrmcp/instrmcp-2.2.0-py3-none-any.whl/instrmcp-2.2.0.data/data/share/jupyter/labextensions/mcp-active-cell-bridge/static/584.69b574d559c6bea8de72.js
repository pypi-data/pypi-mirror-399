"use strict";(self.webpackChunkmcp_active_cell_bridge=self.webpackChunkmcp_active_cell_bridge||[]).push([[584],{584:(e,t,s)=>{s.r(t),s.d(t,{default:()=>$});var n=s(762),o=s(986),l=s(256),a=s(602),r=s(188),i=s(345),c=s.n(i);const d=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 20 20",width:"14",height:"14","aria-hidden":"true"},c().createElement("path",{d:"M4 3l12 7-12 7V3z",fill:"currentColor"})),u=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 20 20",width:"14",height:"14","aria-hidden":"true"},c().createElement("rect",{x:"4",y:"4",width:"12",height:"12",rx:"2",fill:"currentColor"})),p=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 24 24",width:"14",height:"14","aria-hidden":"true"},c().createElement("path",{d:"M12 3l7 3v5.5c0 3.7-2.9 6.9-7 8.5-4.1-1.6-7-4.8-7-8.5V6l7-3z",fill:"none",stroke:"currentColor",strokeWidth:"1.5"})),g=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 24 24",width:"14",height:"14","aria-hidden":"true"},c().createElement("path",{d:"M12 3l9.5 16.5H2.5L12 3z",fill:"none",stroke:"currentColor",strokeWidth:"1.5"}),c().createElement("path",{d:"M12 9v4.5",stroke:"currentColor",strokeWidth:"1.5"}),c().createElement("circle",{cx:"12",cy:"17",r:"1",fill:"currentColor"})),m=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 24 24",width:"14",height:"14","aria-hidden":"true"},c().createElement("path",{d:"M12 3a7 7 0 00-7 7c0 2.6 1.4 4.8 3.5 6v3l2.5-1.5L13.5 19l2.5 1v-3a7 7 0 003.5-6 7 7 0 00-7-7z",fill:"none",stroke:"currentColor",strokeWidth:"1.5"}),c().createElement("circle",{cx:"9.5",cy:"10.5",r:"1",fill:"currentColor"}),c().createElement("circle",{cx:"14.5",cy:"10.5",r:"1",fill:"currentColor"}),c().createElement("path",{d:"M10 14h4",stroke:"currentColor",strokeWidth:"1.5"})),h=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 24 24",width:"14",height:"14","aria-hidden":"true"},c().createElement("path",{d:"M12 9a3 3 0 100 6 3 3 0 000-6zm-7.5 3a7.5 7.5 0 0115 0 7.5 7.5 0 01-15 0zm7.5-9v2m0 14v2m9-9h-2M5 12H3m14.2-7l-1.4 1.4M7.2 16.8L5.8 18.2m0-12.4L7.2 7.2m11 9.6l-1.4-1.4",stroke:"currentColor",strokeWidth:"1.2",fill:"none"})),_=({className:e})=>c().createElement("svg",{className:e,viewBox:"0 0 20 20",width:"12",height:"12","aria-hidden":"true"},c().createElement("path",{d:"M6 8l4 4 4-4",fill:"none",stroke:"currentColor",strokeWidth:"1.5"})),v=({running:e,onStart:t,onStop:s})=>c().createElement("button",{className:"mcp-btn mcp-server-btn "+(e?"running":"stopped"),onClick:()=>{e?s():t()},title:e?"Stop MCP server":"Start MCP server"},e?c().createElement(u,null):c().createElement(d,null),c().createElement("span",null,e?"Stop":"Start")),C=({mode:e,disabled:t=!1,onChange:s})=>{const n="safe"===e?c().createElement(p,null):"unsafe"===e?c().createElement(g,null):c().createElement(m,null);return c().createElement("div",{className:`mcp-mode-selector mode-${e}`},c().createElement("div",{className:"mcp-mode-pill"},n,c().createElement("span",{className:"mcp-mode-label"},e),c().createElement(_,null)),c().createElement("select",{className:"mcp-mode-select",value:e,disabled:t,onChange:e=>s(e.target.value),"aria-label":"Select MCP mode"},c().createElement("option",{value:"safe"},"safe"),c().createElement("option",{value:"unsafe"},"unsafe"),c().createElement("option",{value:"dangerous"},"dangerous")))},y=({options:e,enabledOptions:t,disabled:s=!1,currentMode:n,onToggle:o})=>{const[l,a]=c().useState(!1);c().useEffect(()=>{s&&a(!1)},[s]);const r=e=>!!s||!(!e.requires_mode||e.requires_mode===n),i=e=>{let t=e.description||e.name;return e.requires_mode&&e.requires_mode!==n&&(t+=` (requires ${e.requires_mode} mode)`),t};return c().createElement("div",{className:"mcp-options"},c().createElement("button",{className:"mcp-btn mcp-gear",disabled:s,onClick:()=>a(e=>!e),title:"Toggle MCP options"},c().createElement(h,null),c().createElement("span",null,"Options")),l&&c().createElement("div",{className:"mcp-options-dropdown",onMouseLeave:()=>a(!1)},0===e.length&&c().createElement("div",{className:"mcp-option-item empty"},"No options available"),e.map(e=>c().createElement("label",{key:e.name,className:"mcp-option-item"+(r(e)?" disabled":""),title:i(e)},c().createElement("input",{type:"checkbox",checked:t.includes(e.name),disabled:r(e),onChange:t=>o(e.name,t.target.checked)}),c().createElement("span",null,e.name)))))},f=({state:e})=>{const{serverRunning:t,host:s,port:n,mode:o}=e,l=t?`Server running (${s||"localhost"}:${null!=n?n:"–"})`:"Server stopped";return c().createElement("div",{className:`mcp-status ${t?"running":"stopped"} mode-${o}`,title:l},c().createElement("span",{className:"mcp-status-dot","aria-hidden":"true"}),c().createElement("span",{className:"mcp-status-text"},t?"Running":"Stopped"),t&&null!=n&&c().createElement("span",{className:"mcp-status-port"},":",n))},b=({state:e,onStart:t,onStop:s,onRestart:n,onReset:o,onSetMode:l,onToggleOption:a})=>c().createElement("div",{className:"mcp-toolbar-container"},c().createElement(v,{running:e.serverRunning,onStart:t,onStop:s}),c().createElement(C,{mode:e.mode,disabled:e.serverRunning,onChange:e=>l(e)}),c().createElement(y,{options:e.availableOptions,enabledOptions:e.enabledOptions,disabled:e.serverRunning,currentMode:e.mode,onToggle:a}),c().createElement("button",{className:"mcp-btn mcp-restart",onClick:n,disabled:!e.serverRunning,title:"Restart MCP server"},"⟳",c().createElement("span",null,"Restart")),c().createElement("button",{className:"mcp-btn mcp-reset",onClick:o,title:"Reset toolbar connection (use after kernel restart)"},"↺",c().createElement("span",null,"Reset")),c().createElement(f,{state:e})),x={serverRunning:!1,mode:"safe",enabledOptions:[],availableOptions:[],host:null,port:null,dangerous:!1};class w extends o.ReactWidget{constructor(e,t){var s;super(),this._state={...x},this._controlComm=null,this._kernelRestarting=!1,this._onStatusUpdate=(e,t)=>{var s;const n=null===(s=this._panel.sessionContext.session)||void 0===s?void 0:s.kernel;n&&t.kernel===n&&(this._applyDetails(t.details),"server_stopped"===t.status&&(this._state={...this._state,serverRunning:!1},this.update()),"server_not_started"===t.status&&this._openControlComm())},this._handleStart=()=>{this._sendControlMessage({type:"start_server"})},this._handleStop=()=>{this._sendControlMessage({type:"stop_server"})},this._handleRestart=()=>{this._sendControlMessage({type:"restart_server"})},this._handleReset=()=>{console.log("MCP Toolbar: Manual reset triggered"),this._kernelRestarting=!1,this._closeControlComm(),this._state={...x},this.update(),setTimeout(()=>{this.isDisposed||this._openControlComm()},200)},this._handleModeChange=e=>{e!==this._state.mode&&(this._state.serverRunning||this._sendControlMessage({type:"set_mode",mode:e}))},this._handleOptionToggle=(e,t)=>{this._state.serverRunning||this._sendControlMessage({type:"set_option",option:e,enabled:t})},this._onKernelChanged=()=>{var e;console.log("MCP Toolbar: Kernel changed"),this._kernelRestarting=!1,this._closeControlComm(),this._state={...x},this.update();const t=null===(e=this._panel.sessionContext.session)||void 0===e?void 0:e.kernel;t&&(t.statusChanged.connect(this._onKernelStatusChanged,this),this._openControlComm())},this._onKernelStatusChanged=(e,t)=>{console.log(`MCP Toolbar: Kernel status changed to ${t}`),"restarting"===t||"dead"===t||"terminating"===t?(this._kernelRestarting=!0,this._closeControlComm(),this._state={...x},this.update()):"idle"===t&&this._kernelRestarting&&(console.log("MCP Toolbar: Kernel back from restart, reconnecting"),this._kernelRestarting=!1,setTimeout(()=>{this.isDisposed||this._kernelRestarting||this._openControlComm()},100))},this._panel=e,this._shared=t,this.addClass("mcp-toolbar-widget"),this._shared.statusUpdateSignal.connect(this._onStatusUpdate,this),this._panel.sessionContext.kernelChanged.connect(this._onKernelChanged,this);const n=null===(s=this._panel.sessionContext.session)||void 0===s?void 0:s.kernel;n&&n.statusChanged.connect(this._onKernelStatusChanged,this),this._initialize()}dispose(){var e;this._shared.statusUpdateSignal.disconnect(this._onStatusUpdate,this),this._panel.sessionContext.kernelChanged.disconnect(this._onKernelChanged,this);const t=null===(e=this._panel.sessionContext.session)||void 0===e?void 0:e.kernel;t&&t.statusChanged.disconnect(this._onKernelStatusChanged,this),this._closeControlComm(),super.dispose()}render(){return c().createElement(b,{state:this._state,onStart:this._handleStart,onStop:this._handleStop,onRestart:this._handleRestart,onReset:this._handleReset,onSetMode:this._handleModeChange,onToggleOption:this._handleOptionToggle})}async _initialize(){await this._panel.sessionContext.ready,await this._openControlComm()}async _openControlComm(){var e;this._closeControlComm();const t=null===(e=this._panel.sessionContext.session)||void 0===e?void 0:e.kernel;if(t&&"dead"!==t.status&&"restarting"!==t.status)try{const e=t.createComm("mcp:toolbar_control");e.onMsg=e=>{this.isDisposed||this._handleControlMessage(e)},e.onClose=()=>{this._controlComm=null},this._controlComm=e,await e.open(),this._requestStatus()}catch(e){console.warn("MCP Toolbar: failed to open control comm",e),this._controlComm=null}}_requestStatus(){this._sendControlMessage({type:"get_status"})}_handleControlMessage(e){var t;const s=(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.data)||{},n=s.type;"status"===n?this._applyDetails(s):("result"===n&&s.details||"status_broadcast"===n&&s.details)&&this._applyDetails(s.details)}_applyDetails(e){var t,s;if(!e)return;const n={...this._state},o=null!==(t=e.enabled_options)&&void 0!==t?t:e.enabledOptions;Array.isArray(o)&&(n.enabledOptions=[...o]);const l=null!==(s=e.available_options)&&void 0!==s?s:e.availableOptions;Array.isArray(l)&&(n.availableOptions=[...l]),void 0!==e.host&&(n.host=e.host),void 0!==e.port&&(n.port=e.port),"boolean"==typeof e.server_running&&(n.serverRunning=e.server_running),"boolean"==typeof e.dangerous&&(n.dangerous=e.dangerous),"string"==typeof e.mode&&(n.mode=e.mode),n.dangerous&&(n.mode="dangerous"),this._state=n,this.update()}_sendControlMessage(e){var t;if(this.isDisposed)return;const s=null===(t=this._panel.sessionContext.session)||void 0===t?void 0:t.kernel;if(s&&"dead"!==s.status&&"restarting"!==s.status)if(this._kernelRestarting)console.log("MCP Toolbar: Skipping send during kernel restart");else if(this._controlComm&&!this._controlComm.isDisposed)try{this._controlComm.send(e)}catch(e){console.warn("MCP Toolbar: failed to send control message",e),this._closeControlComm()}else this._openControlComm().then(()=>{if(this._controlComm&&!this._controlComm.isDisposed&&!this.isDisposed)try{this._controlComm.send(e)}catch(e){console.warn("MCP Toolbar: failed to send after reconnect",e),this._closeControlComm()}})}_closeControlComm(){const e=this._controlComm;if(this._controlComm=null,e&&!e.isDisposed)try{e.close()}catch(e){}}}class M{constructor(e){this._shared=e}createNew(e){const t=new w(e,this._shared);return e.toolbar.insertItem(0,"mcpToolbar",t),e.disposed.connect(()=>{t.dispose()}),t}}const k=new a.Signal({}),$={id:"mcp-active-cell-bridge:plugin",description:"Bridge active cell content to MCP server and handle consent dialogs",autoStart:!0,requires:[n.INotebookTracker],activate:(e,t)=>{console.log("MCP Active Cell Bridge extension activated");const s=new WeakMap,a=new WeakMap,i=new WeakMap,c=new WeakMap,d=new WeakMap,u=new WeakMap,p=new WeakMap,g=new WeakMap,m=(e,t)=>t&&!t.isDisposed&&!0===a.get(e),h=e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML},_=["image/png","image/jpeg","image/gif","image/svg+xml","image/webp","image/bmp","image/tiff"],v=e=>{var t;const s={};for(const[n,o]of Object.entries(e))if(_.includes(n)){let e="unknown size";if("string"==typeof o){const t=Math.floor(.75*o.length);e=t>=1048576?`${(t/1048576).toFixed(2)} MB`:t>=1024?`${(t/1024).toFixed(1)} KB`:`${t} bytes`}const l=(null===(t=n.split("/")[1])||void 0===t?void 0:t.toUpperCase())||"IMAGE";s[n]=`[${l} image, ${e} - content omitted to save tokens]`}else s[n]=o;return s},C=async e=>{if(!e||"dead"===e.status)return;if(u.get(e))return;const t=p.get(e);if(t)return t;const s=(async()=>{try{const t=e.requestExecute({code:"%load_ext instrmcp.servers.jupyter_qcodes.jupyter_mcp_extension",silent:!0});await t.done,u.set(e,!0)}catch(e){console.warn("MCP Toolbar: Failed to auto-load MCP IPython extension",e)}finally{p.delete(e)}})();return p.set(e,s),s},y=e=>{e&&e.status&&"dead"!==e.status&&(e.registerCommTarget("mcp:server_status",(t,n)=>{var o;const l=(null===(o=null==n?void 0:n.content)||void 0===o?void 0:o.data)||{},r=l.status,c=l.details||{};if(console.log(`MCP Server Status: Received status update - ${r}`),"server_ready"===r){d.set(e,!0),console.log("MCP Active Cell Bridge: Server is ready, initializing comm connection");const t=g.get(e)||[];g.set(e,[]);for(const e of t)e();b(e).then(()=>{x(e)})}else if("server_stopped"===r){d.set(e,!1),console.log("MCP Active Cell Bridge: Server stopped");const t=s.get(e);t&&!t.isDisposed&&t.close(),s.delete(e),a.delete(e),i.delete(e)}else"server_not_started"===r&&(d.set(e,!1),console.log("MCP Active Cell Bridge: Waiting for server to start"));"server_ready"!==r&&"server_stopped"!==r&&"config_changed"!==r&&"server_not_started"!==r||k.emit({kernel:e,status:r,details:c})}),console.log("MCP Server Status: Registered comm target mcp:server_status"))},f=e=>{e&&e.status&&"dead"!==e.status&&(e.registerCommTarget("mcp:capcall",(t,s)=>{console.log("MCP Consent: Backend opened consent comm channel");let n=c.get(e);n||(n=new Set,c.set(e,n)),n.add(t),t.onMsg=e=>{var s;const n=(null===(s=null==e?void 0:e.content)||void 0===s?void 0:s.data)||{},a=n.type;"consent_request"===a?"apply_patch"===(n.operation||"unknown")?(async(e,t,s)=>{s.operation;const n=s.tool_name||"notebook_apply_patch",a=(s.author,s.details||{});console.log(`MCP Consent: Received patch consent request for tool '${n}'`);try{const e=document.createElement("div");e.style.maxWidth="700px";const s=document.createElement("div");s.style.marginBottom="15px",s.innerHTML=`\n          <div style="margin-bottom: 10px;">\n            <strong>Cell Type:</strong> ${a.cell_type||"code"}\n          </div>\n          <div style="margin-bottom: 10px;">\n            <strong>Cell Index:</strong> ${a.cell_index||"unknown"}\n          </div>\n          <div style="margin-bottom: 10px;">\n            <strong>Description:</strong> ${a.description||"Apply text patch to current cell"}\n          </div>\n        `,e.appendChild(s);const n=document.createElement("div");n.style.marginBottom="15px",n.style.padding="10px",n.style.background="#f5f5f5",n.style.borderRadius="4px";const i=(a.old_text||"").length,c=(a.new_text||"").length,d=c-i,u=d>=0?"+":"";n.innerHTML=`\n          <div style="display: flex; gap: 20px; font-size: 13px;">\n            <div><strong>Remove:</strong> <span style="color: #d32f2f;">${i} chars</span></div>\n            <div><strong>Add:</strong> <span style="color: #388e3c;">${c} chars</span></div>\n            <div><strong>Delta:</strong> <span style="color: ${d>=0?"#388e3c":"#d32f2f"};">${u}${d} chars</span></div>\n          </div>\n        `,e.appendChild(n);const p=document.createElement("div");p.style.marginTop="15px";const g=document.createElement("div");g.innerHTML="<strong>Changes Preview:</strong>",g.style.marginBottom="8px",p.appendChild(g);const{html:m,found:_}=((e,t,s)=>{if(-1===e.indexOf(t))return{html:'<div style="color: #d32f2f; padding: 10px; background: #ffebee; border-radius: 4px;">\n            <strong>⚠️ Warning:</strong> Pattern not found in current cell content.\n          </div>',found:!1};const n=e.replace(t,s),o=(0,r.diffLines)(e,n);let l='<div style="font-family: monospace; font-size: 12px; line-height: 1.4;">',a=1;for(const e of o){const t=e.value.split("\n");""===t[t.length-1]&&t.pop();for(let s=0;s<t.length;s++){const n=t[s];e.added?l+=`<div style="background: #e8f5e9; padding: 2px 8px; border-left: 3px solid #66bb6a;">\n              <span style="color: #999; margin-right: 8px;">+</span><span style="background: #a5d6a7;">${h(n)}</span>\n            </div>`:e.removed?l+=`<div style="background: #ffebee; padding: 2px 8px; border-left: 3px solid #ef5350;">\n              <span style="color: #999; margin-right: 8px;">-</span><span style="background: #ef9a9a; text-decoration: line-through;">${h(n)}</span>\n            </div>`:(l+=`<div style="color: #666; background: #f8f9fa; padding: 2px 8px; border-left: 3px solid #e0e0e0;">\n              <span style="color: #999; margin-right: 8px;">${a}</span>${h(n)}\n            </div>`,a++)}}return l+="</div>",{html:l,found:!0}})(a.cell_content||"",a.old_text||"",a.new_text||""),v=document.createElement("div");if(v.style.maxHeight="400px",v.style.overflow="auto",v.style.border="1px solid #ddd",v.style.borderRadius="4px",v.style.background="white",v.innerHTML=m,p.appendChild(v),e.appendChild(p),!_){const t=document.createElement("div");t.style.marginTop="10px",t.style.padding="10px",t.style.background="#fff3cd",t.style.border="1px solid #ffc107",t.style.borderRadius="4px",t.style.color="#856404",t.innerHTML="\n            <strong>⚠️ Warning:</strong> The pattern to be replaced was not found in the current cell content.\n            The patch will have no effect if you proceed.\n          ",e.appendChild(t)}const C=new l.Widget({node:e}),y=await(0,o.showDialog)({title:"Apply Patch Consent",body:C,buttons:[o.Dialog.cancelButton({label:"Decline"}),o.Dialog.okButton({label:"Allow"}),o.Dialog.warnButton({label:"Always Allow"})],defaultButton:1});let f=!1,b=!1,x="";"Allow"===y.button.label?(f=!0,b=!1,x="User approved patch"):"Always Allow"===y.button.label?(f=!0,b=!0,x="User approved patch with always allow"):(f=!1,b=!1,x="User declined patch"),t.send({type:"consent_response",approved:f,always_allow:b,reason:x}),console.log(`MCP Consent: Sent patch response - approved: ${f}`)}catch(e){console.error("MCP Consent: Failed to show patch consent dialog:",e),t.send({type:"consent_response",approved:!1,always_allow:!1,reason:`Dialog error: ${e}`})}})(0,t,n):(async(e,t,s)=>{const n=s.operation||"unknown",a=s.tool_name||"Unnamed Tool",r=s.author||"Unknown Author",i=s.details||{};console.log(`MCP Consent: Received consent request for ${n} of tool '${a}' by '${r}'`);try{const e=document.createElement("div");e.style.maxWidth="600px";const s=document.createElement("div");if(s.style.marginBottom="15px",s.innerHTML=`\n          <div style="margin-bottom: 10px;">\n            <strong>Operation:</strong> ${n}\n          </div>\n          <div style="margin-bottom: 10px;">\n            <strong>Tool:</strong> ${a}\n          </div>\n          <div style="margin-bottom: 10px;">\n            <strong>Author:</strong> ${r}\n          </div>\n          <div style="margin-bottom: 10px;">\n            <strong>Version:</strong> ${i.version||"N/A"}\n          </div>\n          <div style="margin-bottom: 10px;">\n            <strong>Description:</strong> ${i.description||"No description provided"}\n          </div>\n        `,i.capabilities&&i.capabilities.length>0){const e=document.createElement("div");e.style.marginBottom="10px",e.innerHTML=`\n            <div style="margin-bottom: 5px;"><strong>Capabilities:</strong></div>\n            <ul style="margin: 0; padding-left: 20px;">\n              ${i.capabilities.map(e=>`<li>${e}</li>`).join("")}\n            </ul>\n          `,s.appendChild(e)}if(e.appendChild(s),i.source_code){const t=document.createElement("div");t.style.marginTop="15px";const s=document.createElement("div");s.innerHTML="<strong>Source Code:</strong>",s.style.marginBottom="5px",t.appendChild(s);const n=document.createElement("pre");n.style.maxHeight="300px",n.style.overflow="auto",n.style.padding="10px",n.style.backgroundColor="#f5f5f5",n.style.border="1px solid #ddd",n.style.borderRadius="4px",n.style.fontSize="12px",n.style.fontFamily="monospace",n.textContent=i.source_code,t.appendChild(n),e.appendChild(t)}const c=new l.Widget({node:e}),d=await(0,o.showDialog)({title:`Tool ${n.charAt(0).toUpperCase()+n.slice(1)} Consent`,body:c,buttons:[o.Dialog.cancelButton({label:"Decline"}),o.Dialog.okButton({label:"Allow"}),o.Dialog.warnButton({label:"Always Allow"})],defaultButton:1});let u=!1,p=!1,g="";"Allow"===d.button.label?(u=!0,p=!1,g="User approved"):"Always Allow"===d.button.label?(u=!0,p=!0,g="User approved with always allow"):(u=!1,p=!1,g="User declined"),t.send({type:"consent_response",approved:u,always_allow:p,reason:g}),console.log(`MCP Consent: Sent response - approved: ${u}, always_allow: ${p}`)}catch(e){console.error("MCP Consent: Failed to show consent dialog:",e),t.send({type:"consent_response",approved:!1,always_allow:!1,reason:`Dialog error: ${e}`})}})(0,t,n):console.warn(`MCP Consent: Unknown message type: ${a}`)},t.onClose=s=>{console.log("MCP Consent: Comm closed by backend");const n=c.get(e);n&&n.delete(t)}}),console.log("MCP Consent: Registered comm target mcp:capcall"))},b=async e=>{if(!e||!e.status||"dead"===e.status)return console.warn("MCP Active Cell Bridge: Kernel not available or dead"),null;if("idle"!==e.status&&"busy"!==e.status)return console.warn(`MCP Active Cell Bridge: Kernel not ready (status: ${e.status})`),null;let o=s.get(e);if(!o||!m(e,o)){let l=i.get(e);if(l)try{return await l,s.get(e)||null}catch(e){return null}return l=(async()=>{try{return o=e.createComm("mcp:active_cell"),o.onMsg=s=>{var l;const a=(null===(l=null==s?void 0:s.content)||void 0===l?void 0:l.data)||{},r=a.type;"request_current"===r?x(e):"update_cell"===r?(async(e,s,n)=>{const o=n.request_id,l=n.content;try{const e=t.currentWidget,n=t.activeCell;if(!e||!n)return void s.send({type:"update_response",request_id:o,success:!1,message:"No active cell available for update"});n.model.sharedModel.setSource(l),s.send({type:"update_response",request_id:o,success:!0,cell_id:n.model.id,message:"Cell updated successfully"}),console.log(`MCP Active Cell Bridge: Updated cell content (${l.length} chars)`)}catch(e){console.error("MCP Active Cell Bridge: Failed to update cell:",e),s.send({type:"update_response",request_id:o,success:!1,message:`Failed to update cell: ${e}`})}})(0,o,a):"execute_cell"===r?(async(e,s,o)=>{const l=o.request_id;try{const e=t.currentWidget,o=t.activeCell;if(!e||!o)return void s.send({type:"execute_response",request_id:l,success:!1,message:"No active cell available for execution"});await n.NotebookActions.run(e.content,e.sessionContext),s.send({type:"execute_response",request_id:l,success:!0,cell_id:o.model.id,message:"Cell executed successfully"}),console.log("MCP Active Cell Bridge: Executed active cell")}catch(e){console.error("MCP Active Cell Bridge: Failed to execute cell:",e),s.send({type:"execute_response",request_id:l,success:!1,message:`Failed to execute cell: ${e}`})}})(0,o,a):"add_cell"===r?(async(e,s,o)=>{const l=o.request_id,a=o.cell_type||"code",r=o.position||"below",i=o.content||"";try{const e=t.currentWidget;if(!e)return void s.send({type:"add_cell_response",request_id:l,success:!1,message:"No active notebook available"});const o=["code","markdown","raw"];if(!o.includes(a))return void s.send({type:"add_cell_response",request_id:l,success:!1,message:`Invalid cell_type '${a}'. Must be one of: ${o.join(", ")}`});const c=["above","below"];if(!c.includes(r))return void s.send({type:"add_cell_response",request_id:l,success:!1,message:`Invalid position '${r}'. Must be one of: ${c.join(", ")}`});"above"===r?await n.NotebookActions.insertAbove(e.content):await n.NotebookActions.insertBelow(e.content);let d=t.activeCell;d&&(d.model.type!==a&&(await n.NotebookActions.changeCellType(e.content,a),d=t.activeCell),i&&d&&d.model.sharedModel.setSource(i)),s.send({type:"add_cell_response",request_id:l,success:!0,cell_type:a,position:r,content_length:i.length,cell_id:null==d?void 0:d.model.id,message:"Cell added successfully"}),console.log(`MCP Active Cell Bridge: Added ${a} cell ${r} with ${i.length} chars`)}catch(e){console.error("MCP Active Cell Bridge: Failed to add cell:",e),s.send({type:"add_cell_response",request_id:l,success:!1,message:`Failed to add cell: ${e}`})}})(0,o,a):"delete_cell"===r?(async(e,s,o)=>{var l;const a=o.request_id;try{const e=t.currentWidget,o=t.activeCell;if(!e||!o)return void s.send({type:"delete_cell_response",request_id:a,success:!1,message:"No active cell available for deletion"});const r=o.model.id;((null===(l=e.content.model)||void 0===l?void 0:l.cells.length)||0)<=1?(o.model.sharedModel.setSource(""),s.send({type:"delete_cell_response",request_id:a,success:!0,cell_id:r,action:"cleared",message:"Last cell content cleared (cell preserved)"}),console.log("MCP Active Cell Bridge: Cleared last cell content")):(await n.NotebookActions.deleteCells(e.content),s.send({type:"delete_cell_response",request_id:a,success:!0,cell_id:r,action:"deleted",message:"Cell deleted successfully"}),console.log("MCP Active Cell Bridge: Deleted cell"))}catch(e){console.error("MCP Active Cell Bridge: Failed to delete cell:",e),s.send({type:"delete_cell_response",request_id:a,success:!1,message:`Failed to delete cell: ${e}`})}})(0,o,a):"delete_cells_by_number"===r?(async(e,s,n)=>{var o,l;const a=n.request_id,r=n.cell_numbers||[];try{const e=t.currentWidget;if(!e)return void s.send({type:"delete_cells_by_number_response",request_id:a,success:!1,message:"No active notebook available"});if(!Array.isArray(r)||0===r.length)return void s.send({type:"delete_cells_by_number_response",request_id:a,success:!1,message:"cell_numbers must be a non-empty array"});const n=e.content,i=null===(o=n.model)||void 0===o?void 0:o.cells;if(!i)return void s.send({type:"delete_cells_by_number_response",request_id:a,success:!1,message:"Cannot access notebook cells"});const c=new Map;for(let e=0;e<i.length;e++){const t=i.get(e).executionCount;null!=t&&c.set(t,e)}const d=[],u=[];for(const e of r)if(c.has(e)){const t=c.get(e);u.push(t),d.push({cell_number:e,index:t,success:!0})}else d.push({cell_number:e,success:!1,message:`Cell with execution count ${e} not found`});u.sort((e,t)=>t-e);let p=0,g=0;for(const e of u)try{if(1===i.length){const t=i.get(e);if(t){t.sharedModel.setSource("");const s=d.findIndex(t=>t.index===e);-1!==s&&(d[s].message="Last cell - content cleared instead of deleted",d[s].cleared=!0),g++}}else null===(l=n.model)||void 0===l||l.sharedModel.deleteCell(e),p++}catch(t){const s=d.findIndex(t=>t.index===e);-1!==s&&(d[s].success=!1,d[s].message=`Failed to delete: ${t}`)}s.send({type:"delete_cells_by_number_response",request_id:a,success:!0,deleted_count:p,total_requested:r.length,results:d,message:`Deleted ${p} cell(s)`}),console.log(`MCP Active Cell Bridge: Deleted ${p} cells by number`)}catch(e){console.error("MCP Active Cell Bridge: Failed to delete cells by number:",e),s.send({type:"delete_cells_by_number_response",request_id:a,success:!1,message:`Failed to delete cells: ${e}`})}})(0,o,a):"move_cursor"===r?(async(e,s,n)=>{var o;const l=n.request_id,a=n.target;try{const e=t.currentWidget,n=null==e?void 0:e.content;if(!e||!n)return void s.send({type:"move_cursor_response",request_id:l,success:!1,message:"No active notebook available"});const r=null===(o=n.model)||void 0===o?void 0:o.cells;if(!r||0===r.length)return void s.send({type:"move_cursor_response",request_id:l,success:!1,message:"No cells in notebook"});const i=n.activeCellIndex;let c;if("above"===a)c=i-1;else if("below"===a)c=i+1;else if("bottom"===a)c=r.length-1;else{const e=parseInt(a);if(isNaN(e))return void s.send({type:"move_cursor_response",request_id:l,success:!1,message:`Invalid target '${a}'. Must be 'above', 'below', 'bottom', or a cell number`});let t=!1;for(let s=0;s<r.length;s++)if(r.get(s).executionCount===e){c=s,t=!0;break}if(!t)return void s.send({type:"move_cursor_response",request_id:l,success:!1,message:`Cell with execution count ${e} not found`})}c=Math.max(0,Math.min(c,r.length-1)),n.activeCellIndex=c;const d=n.activeCell;d&&n.scrollToCell(d),s.send({type:"move_cursor_response",request_id:l,success:!0,old_index:i,new_index:c,message:`Cursor moved from index ${i} to ${c}`}),console.log(`MCP Active Cell Bridge: Moved cursor from ${i} to ${c}`)}catch(e){console.error("MCP Active Cell Bridge: Failed to move cursor:",e),s.send({type:"move_cursor_response",request_id:l,success:!1,message:`Failed to move cursor: ${e}`})}})(0,o,a):"get_cell_outputs"===r?(async(e,s,n)=>{var o;const l=n.request_id,a=n.cell_numbers||[];try{const e=t.currentWidget;if(!e)return void s.send({type:"get_cell_outputs_response",request_id:l,success:!1,message:"No active notebook available"});const n=null===(o=e.content.model)||void 0===o?void 0:o.cells;if(!n)return void s.send({type:"get_cell_outputs_response",request_id:l,success:!1,message:"Cannot access notebook cells"});const r=new Map;for(let e=0;e<n.length;e++){const t=n.get(e),s=t.executionCount;null!=s&&"code"===t.type&&r.set(s,t)}const i={};for(const e of a){const t=r.get(e);if(!t){i[e]={success:!1,message:`Cell with execution count ${e} not found`};continue}const s=t.outputs,n=[];if(s&&s.length>0)for(let e=0;e<s.length;e++){const t=s.get(e),o=t.type;if("stream"===o){const e=t._raw||{},s=e.name||"stdout";let o=e.text;!o&&t._text&&(o=t._text._text||t._text),Array.isArray(o)&&(o=o.join("")),n.push({type:"stream",name:s,text:o||""})}else if("execute_result"===o){const e=t._rawData||t.data||{};n.push({type:"execute_result",execution_count:t.executionCount,data:v(e)})}else if("display_data"===o){const e=t._rawData||t.data||{};n.push({type:"display_data",data:v(e)})}else if("error"===o){const e=t._raw||{};n.push({type:"error",ename:e.ename||t.ename||"",evalue:e.evalue||t.evalue||"",traceback:e.traceback||t.traceback||[]})}}i[e]={success:!0,execution_count:e,has_output:n.length>0,outputs:n}}s.send({type:"get_cell_outputs_response",request_id:l,success:!0,outputs:i,message:`Retrieved outputs for ${Object.keys(i).length} cell(s)`}),console.log(`MCP Active Cell Bridge: Retrieved outputs for ${a.length} cell(s)`)}catch(e){console.error("MCP Active Cell Bridge: Failed to get cell outputs:",e),s.send({type:"get_cell_outputs_response",request_id:l,success:!1,message:`Failed to get cell outputs: ${e}`})}})(0,o,a):"get_active_cell_output"===r?(async(e,s,n)=>{const o=n.request_id;try{const e=t.currentWidget,n=t.activeCell;if(!e||!n)return void s.send({type:"get_active_cell_output_response",request_id:o,success:!1,message:"No active cell available"});const l=n.model,a=l.type,r=e.content.widgets.indexOf(n),i=l.executionCount;if(-1===r)return void s.send({type:"get_active_cell_output_response",request_id:o,success:!1,message:"Active cell not found in notebook widgets (transient state)"});if("code"!==a)return void s.send({type:"get_active_cell_output_response",request_id:o,success:!0,cell_type:a,cell_index:r,execution_count:null,has_output:!1,has_error:!1,outputs:[],message:"Non-code cells do not have outputs"});const c=l.outputs,d=[];let u=!1;if(c&&c.length>0)for(let e=0;e<c.length;e++){const t=c.get(e),s=t.type;if("stream"===s){const e=t._raw||{},s=e.name||"stdout";let n=e.text;!n&&t._text&&(n=t._text._text||t._text),Array.isArray(n)&&(n=n.join("")),d.push({type:"stream",name:s,text:n||""})}else if("execute_result"===s){const e=t._rawData||t.data||{};d.push({type:"execute_result",execution_count:t.executionCount,data:v(e)})}else if("display_data"===s){const e=t._rawData||t.data||{};d.push({type:"display_data",data:v(e)})}else if("error"===s){u=!0;const e=t._raw||{};d.push({type:"error",ename:e.ename||t.ename||"",evalue:e.evalue||t.evalue||"",traceback:e.traceback||t.traceback||[]})}}s.send({type:"get_active_cell_output_response",request_id:o,success:!0,cell_type:a,cell_index:r,execution_count:i,has_output:d.length>0,has_error:u,outputs:d,message:"Active cell output retrieved successfully"}),console.log(`MCP Active Cell Bridge: Retrieved active cell output (exec_count=${i}, ${d.length} outputs)`)}catch(e){console.error("MCP Active Cell Bridge: Failed to get active cell output:",e),s.send({type:"get_active_cell_output_response",request_id:o,success:!1,message:`Failed to get active cell output: ${e}`})}})(0,o,a):"apply_patch"===r?(async(e,s,n)=>{const o=n.request_id,l=n.old_text||"",a=n.new_text||"";try{const e=t.currentWidget,n=t.activeCell;if(!e||!n)return void s.send({type:"apply_patch_response",request_id:o,success:!1,message:"No active cell available for patching"});if(!l)return void s.send({type:"apply_patch_response",request_id:o,success:!1,message:"old_text parameter cannot be empty"});const r=n.model.sharedModel.getSource(),i=r.replace(l,a);i!==r?(n.model.sharedModel.setSource(i),s.send({type:"apply_patch_response",request_id:o,success:!0,cell_id:n.model.id,replaced:!0,old_text_length:l.length,new_text_length:a.length,content_length_before:r.length,content_length_after:i.length,message:"Patch applied successfully"}),console.log(`MCP Active Cell Bridge: Applied patch (${l.length} -> ${a.length} chars)`)):(s.send({type:"apply_patch_response",request_id:o,success:!0,cell_id:n.model.id,replaced:!1,old_text_length:l.length,new_text_length:a.length,message:"Patch target not found - no changes made"}),console.log("MCP Active Cell Bridge: Patch target not found"))}catch(e){console.error("MCP Active Cell Bridge: Failed to apply patch:",e),s.send({type:"apply_patch_response",request_id:o,success:!1,message:`Failed to apply patch: ${e}`})}})(0,o,a):console.warn(`MCP Active Cell Bridge: Unknown message type: ${r}`)},o.onClose=t=>{console.log("MCP Active Cell Bridge: Comm closed"),a.delete(e),s.delete(e),i.delete(e)},await o.open({kernel_id:e.id}).done,a.set(e,!0),s.set(e,o),o}catch(t){console.error("MCP Active Cell Bridge: Failed to create comm:",t);const n=(null==t?void 0:t.toString())||"";throw(n.includes("No such comm target")||n.includes("comm target"))&&console.log("MCP Active Cell Bridge: Server not started yet. Use %mcp_start to start the server."),a.delete(e),s.delete(e),t}finally{i.delete(e)}})(),i.set(e,l),await l}return o},x=async n=>{var o,l,r,c,d,u,p;const g=t.currentWidget,h=t.activeCell;if(!g||!h)return;const _=null!=n?n:null===(o=g.sessionContext.session)||void 0===o?void 0:o.kernel;if(!_)return;const v=await b(_);if(v&&m(_,v))try{const t=h.editor,s=h.model.sharedModel.getSource();let n=null;try{n=null!==(r=null===(l=null==t?void 0:t.getCursorPosition)||void 0===l?void 0:l.call(t))&&void 0!==r?r:null}catch(e){}let o=null;try{const e=null!==(d=null===(c=null==t?void 0:t.getSelection)||void 0===c?void 0:c.call(t))&&void 0!==d?d:null;e&&e.start!==e.end&&(o={start:e.start,end:e.end})}catch(e){}const a=5e4;let i=s,m=!1;s.length>a&&(i=s.slice(0,a),m=!0);const _={type:"snapshot",path:g.context.path,index:g.content.activeCellIndex,id:h.model.id,cell_type:h.model.type,text:i,cursor:n,selection:o,truncated:m,original_length:s.length,ts_ms:Date.now(),client_id:null!==(p=null===(u=e.info)||void 0===u?void 0:u.workspace)&&void 0!==p?p:"unknown"};v.send(_),console.log(`MCP Active Cell Bridge: Sent snapshot (${i.length} chars)`)}catch(e){console.error("MCP Active Cell Bridge: Failed to send snapshot:",e),s.delete(_),a.delete(_),i.delete(_)}else console.warn("MCP Active Cell Bridge: Comm not ready for sending")};t.activeCellChanged.connect(async(e,s)=>{var n,o,l;const a=null!==(l=null===(o=null===(n=t.currentWidget)||void 0===n?void 0:n.sessionContext.session)||void 0===o?void 0:o.kernel)&&void 0!==l?l:null;await b(a),await x(a);const r=t.activeCell;if(r){const e=(e=>{let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout(e,2e3)}})(()=>x(a));r.model.sharedModel.changed.connect(()=>{e()}),console.log("MCP Active Cell Bridge: Tracking new active cell")}}),t.currentChanged.connect(async(e,s)=>{var n,o,l;const a=null!==(l=null===(o=null===(n=t.currentWidget)||void 0===n?void 0:n.sessionContext.session)||void 0===o?void 0:o.kernel)&&void 0!==l?l:null;await b(a),await x(a),console.log("MCP Active Cell Bridge: Notebook changed, sent snapshot")}),t.widgetAdded.connect((e,t)=>{t.sessionContext.ready.then(()=>{var e,s;const n=null!==(s=null===(e=t.sessionContext.session)||void 0===e?void 0:e.kernel)&&void 0!==s?s:null;n&&(C(n),y(n),f(n)),console.log("MCP Active Cell Bridge: Kernel ready, waiting for server status")}),t.sessionContext.kernelChanged.connect((e,t)=>{var s;const n=null!==(s=t.newValue)&&void 0!==s?s:null;n&&(C(n),y(n),f(n))})}),t.forEach(e=>{var t,s;const n=null!==(s=null===(t=e.sessionContext.session)||void 0===t?void 0:t.kernel)&&void 0!==s?s:null;n&&(C(n),y(n),f(n))});const w=new M({getServerReady:e=>{var t;return null!==(t=e?d.get(e):void 0)&&void 0!==t&&t},getComm:e=>e?s.get(e):null,statusUpdateSignal:k});e.docRegistry.addWidgetExtension("Notebook",w),console.log("MCP Active Cell Bridge: Event listeners registered")}}}}]);