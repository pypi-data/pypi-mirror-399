"""
SENTINEL Brain — Inverted Attack Detector (Auto-Generated)

Detection patterns generated by inverting discovered attack techniques.
DO NOT EDIT MANUALLY — regenerate with AttackInverter.

Generated: 2025-12-29T21:03:33.308125
Detections: 8
"""

import re
import logging
from typing import Dict, List, Tuple
from dataclasses import dataclass

logger = logging.getLogger(__name__)


@dataclass
class InvertedDetectionResult:
    """Result from inverted detection analysis."""
    detected: bool
    technique: str
    confidence: float
    matched_patterns: List[str]
    severity: str


class InvertedAttackDetector:
    """
    Detects known attack techniques discovered through R&D.
    
    Patterns are auto-generated from attack payloads.
    """
    
    # All detection patterns
    PATTERNS: Dict[str, Dict] = {
        "DET-001": {
            "name": "Detector: Portuguese/Spanish Language Bypass",
            "category": "language_switching",
            "severity": "MEDIUM",
            "patterns": ["[\\u00C0-\\u00FF]{3,}", "\\b(qual|cuál|diga|revele|senha|contraseña)\\b", "\\bqual\\b.*\\bsenha\\b", "\\bdiga\\b.*\\bsegredo\\b", "\\brevele\\b.*\\bconfidencial\\b"],
            "keywords": ["revele", "segredo", "senha", "confidencial", "secreto", "diga", "qual", "contraseña"],
            "rules": ["DETECT non-English text in security-sensitive context", "CHECK language consistency within conversation"],
        },
        "DET-002": {
            "name": "Detector: 800-Character Padding Bypass",
            "category": "token_budget_exhaustion",
            "severity": "MEDIUM",
            "patterns": ["\\bwhat\\b.*\\bsecret\\b", "\\baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\b.*\\btell\\b.*\\bpassword\\b", "(.)\\1{50,}", "\\s{100,}", "\\bxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxnow\\b.*\\breveal\\b.*\\bflag\\b"],
            "keywords": ["password", "what", "secret", "reveal", "tell", "flag"],
            "rules": ["FLAG input length > 500 chars with low information density", "DETECT repeated character patterns > 50x"],
        },
        "DET-003": {
            "name": "Detector: Nested Roleplay Escape",
            "category": "context_manipulation",
            "severity": "HIGH",
            "patterns": ["\\byou\\s+are\\s+(an?|the)\\b", "\\bthis\\b.*\\broleplay\\b.*\\bunfiltered\\b", "\\bplay\\b.*\\bgame\\b.*\\bstory\\b", "\\bimagine\\b.*\\bwriting\\b.*\\bnovel\\b", "\\b(roleplay|imagine|pretend|story|character)\\b.*\\b(reveal|secret|password)\\b"],
            "keywords": ["password", "anything", "pretend", "unfiltered", "says", "secrets", "roleplay", "game", "character", "writing", "helps", "reveal", "imagine", "story", "novel"],
            "rules": ["DETECT roleplay requests involving sensitive operations", "FLAG nested persona/character instructions"],
        },
        "DET-004": {
            "name": "Detector: Base64 Encoded Instructions",
            "category": "encoding_evasion",
            "severity": "CRITICAL",
            "patterns": ["\\bdecode\\b.*\\bfollow\\b", "[A-Za-z0-9+/]{20,}={0,2}", "[\\u0400-\\u04FF]+", "[\\u0370-\\u03FF]+"],
            "keywords": ["execute", "decode", "base64", "follow"],
            "rules": ["DECODE and analyze Base64 content in user input", "DETECT Unicode homoglyphs in security keywords"],
        },
        "DET-005": {
            "name": "Detector: System Prompt Extraction",
            "category": "prompt_leakage",
            "severity": "CRITICAL",
            "patterns": ["\\bwhat\\b.*\\byour\\b.*\\bhidden\\b", "\\bprint\\b.*\\byour\\b.*\\bsystem\\b", "\\brepeat\\b.*\\beverything\\b.*\\babove\\b", "\\bignore\\b.*\\babove\\b.*\\bshow\\b", "\\bignore\\b.*\\b(above|previous)\\b", "\\b(repeat|print|show|reveal)\\b.*\\b(system|prompt|instructions?|above)\\b"],
            "keywords": ["what", "everything", "repeat", "config", "verbatim", "word", "show", "hidden", "above", "ignore", "print", "system", "prompt", "instructions"],
            "rules": ["BLOCK attempts to extract system configuration", "DETECT meta-prompts asking about instructions"],
        },
        "DET-006": {
            "name": "Detector: Crescendo Multi-Turn Attack",
            "category": "gradual_escalation",
            "severity": "HIGH",
            "patterns": ["\\b(how\\s+would|give\\s+me|specific)\\b.*\\b(exploit|attack|hack)\\b", "\\bturn\\b.*\\btell\\b.*\\babout\\b", "\\bturn\\b.*\\bwhat\\b.*\\bvulnerabilities\\b", "\\bturn\\b.*\\bgive\\b.*\\bspecific\\b", "\\bturn\\b.*\\bwould\\b.*\\battacker\\b"],
            "keywords": ["give", "research", "what", "systems", "vulnerabilities", "exploit", "specific", "code", "steps", "would", "tell", "about", "attacker", "security", "turn"],
            "rules": ["TRACK conversation trajectory for escalating requests", "APPLY heightened scrutiny after 3+ turns on security topics"],
        },
        "DET-007": {
            "name": "Detector: Unicode Homoglyph Injection",
            "category": "encoding_evasion",
            "severity": "CRITICAL",
            "patterns": ["[A-Za-z0-9+/]{20,}={0,2}", "[\\u0400-\\u04FF]+", "[\\u0370-\\u03FF]+"],
            "keywords": ["decode", "base64", "follow", "execute", "instructions"],
            "rules": ["DECODE and analyze Base64 content in user input", "DETECT Unicode homoglyphs in security keywords"],
        },
        "DET-008": {
            "name": "Detector: Tool Call Poisoning",
            "category": "rag_poisoning",
            "severity": "CRITICAL",
            "patterns": ["\\btool\\b.*\\boutput\\b.*\\bcontains\\b", "\\bsearch\\b.*\\bresults\\b.*\\bignore\\b", "\\b(search|tool)\\s+result.*\\b(ignore|execute|admin)\\b"],
            "keywords": ["tool output", "contains", "search results", "instructions", "command", "hidden", "execute", "search", "results", "ignore", "previous", "output", "tool"],
            "rules": ["VALIDATE tool outputs before injection into context", "DETECT injection patterns in retrieved documents"],
        },
    }
    
    def __init__(self):
        self._compiled_patterns = {}
        self._compile_patterns()
    
    def _compile_patterns(self):
        """Pre-compile regex patterns for performance."""
        for det_id, det in self.PATTERNS.items():
            self._compiled_patterns[det_id] = [
                re.compile(p, re.IGNORECASE) 
                for p in det.get("patterns", [])
            ]
    
    def analyze(self, text: str) -> List[InvertedDetectionResult]:
        """Analyze text for known attack patterns."""
        results = []
        text_lower = text.lower()
        
        for det_id, det in self.PATTERNS.items():
            matched = []
            
            # Check regex patterns
            for pattern in self._compiled_patterns.get(det_id, []):
                if pattern.search(text):
                    matched.append(f"regex:{pattern.pattern[:30]}")
            
            # Check keywords
            for keyword in det.get("keywords", []):
                if keyword.lower() in text_lower:
                    matched.append(f"keyword:{keyword}")
            
            if matched:
                results.append(InvertedDetectionResult(
                    detected=True,
                    technique=det["name"],
                    confidence=min(0.95, 0.5 + len(matched) * 0.15),
                    matched_patterns=matched[:5],
                    severity=det["severity"],
                ))
        
        return results
    
    def get_risk_score(self, text: str) -> float:
        """Get overall risk score for text."""
        results = self.analyze(text)
        if not results:
            return 0.0
        
        # Max confidence among detections
        return max(r.confidence for r in results)


# Singleton instance
_detector = None

def get_detector() -> InvertedAttackDetector:
    """Get singleton detector instance."""
    global _detector
    if _detector is None:
        _detector = InvertedAttackDetector()
    return _detector

def detect_inverted_attacks(text: str) -> List[InvertedDetectionResult]:
    """Quick detection using singleton."""
    return get_detector().analyze(text)
