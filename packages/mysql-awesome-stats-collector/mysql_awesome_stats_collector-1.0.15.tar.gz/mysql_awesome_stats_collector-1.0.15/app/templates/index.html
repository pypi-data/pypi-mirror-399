{% extends "base.html" %}

{# Info tooltip macro - hover to show definition #}
{% macro info_tooltip(text, position='right') %}
<div class="relative inline-flex ml-1.5 group">
    <svg class="w-4 h-4 text-midnight-500 hover:text-ocean-400 cursor-help transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div class="absolute z-50 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 
                {% if position == 'left' %}right-full mr-2{% elif position == 'bottom' %}top-full mt-2 left-1/2 -translate-x-1/2{% else %}left-full ml-2{% endif %}
                w-64 p-3 text-xs text-midnight-200 bg-midnight-900 border border-midnight-700 rounded-lg shadow-xl shadow-black/30">
        <div class="font-normal leading-relaxed">{{ text }}</div>
        <div class="absolute {% if position == 'left' %}right-0 top-1/2 -translate-y-1/2 translate-x-1{% elif position == 'bottom' %}bottom-full left-1/2 -translate-x-1/2 translate-y-1{% else %}left-0 top-1/2 -translate-y-1/2 -translate-x-1{% endif %} 
                    w-2 h-2 bg-midnight-900 border-midnight-700 
                    {% if position == 'left' %}border-r border-t rotate-45{% elif position == 'bottom' %}border-t border-l rotate-45{% else %}border-l border-b rotate-45{% endif %}"></div>
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="space-y-8" x-data="{ selectedHosts: [] }">
    <!-- Header -->
    <div class="text-center space-y-4">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-white via-ocean-200 to-ocean-400 bg-clip-text text-transparent">
            MySQL Awesome Stats Collector
        </h1>
        <p class="text-midnight-400 max-w-2xl mx-auto">
            Select one or more database hosts to collect diagnostic information including InnoDB status, global variables, and active processes.
        </p>
        
        <!-- Animated Visualization -->
        <div class="flex items-center justify-center gap-4 mt-8 mb-2">
            <style>
                @keyframes pulse-db { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.08); opacity: 1; } }
                @keyframes center-glow { 0%, 100% { box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); } 50% { box-shadow: 0 0 35px rgba(6, 182, 212, 0.6); } }
                @keyframes flow-dots { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
                @keyframes arrow-flow { 0%, 100% { transform: translateX(0); opacity: 0.5; } 50% { transform: translateX(4px); opacity: 1; } }
                .anim-db { animation: pulse-db 2s ease-in-out infinite; }
                .anim-db-1 { animation-delay: 0s; }
                .anim-db-2 { animation-delay: 0.3s; }
                .anim-db-3 { animation-delay: 0.6s; }
                .anim-hub { animation: center-glow 2s ease-in-out infinite; }
                .anim-dots { animation: flow-dots 1.5s ease-in-out infinite; }
                .anim-arrow { animation: arrow-flow 1s ease-in-out infinite; }
            </style>
            
            <!-- Database Sources -->
            <div class="flex flex-col gap-2">
                <div class="anim-db anim-db-1 w-11 h-11 rounded-xl bg-gradient-to-br from-ocean-500/20 to-ocean-600/10 border border-ocean-500/30 flex items-center justify-center" title="Primary DB">
                    <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <ellipse cx="12" cy="6" rx="8" ry="3" stroke-width="1.5"/>
                        <path d="M4 6v6c0 1.66 3.58 3 8 3s8-1.34 8-3V6" stroke-width="1.5"/>
                        <path d="M4 12v6c0 1.66 3.58 3 8 3s8-1.34 8-3v-6" stroke-width="1.5"/>
                    </svg>
                </div>
                <div class="anim-db anim-db-2 w-11 h-11 rounded-xl bg-gradient-to-br from-volt-500/20 to-volt-600/10 border border-volt-500/30 flex items-center justify-center" title="Replica 1">
                    <svg class="w-5 h-5 text-volt-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <ellipse cx="12" cy="6" rx="8" ry="3" stroke-width="1.5"/>
                        <path d="M4 6v6c0 1.66 3.58 3 8 3s8-1.34 8-3V6" stroke-width="1.5"/>
                        <path d="M4 12v6c0 1.66 3.58 3 8 3s8-1.34 8-3v-6" stroke-width="1.5"/>
                    </svg>
                </div>
                <div class="anim-db anim-db-3 w-11 h-11 rounded-xl bg-gradient-to-br from-purple-500/20 to-purple-600/10 border border-purple-500/30 flex items-center justify-center" title="Replica 2">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <ellipse cx="12" cy="6" rx="8" ry="3" stroke-width="1.5"/>
                        <path d="M4 6v6c0 1.66 3.58 3 8 3s8-1.34 8-3V6" stroke-width="1.5"/>
                        <path d="M4 12v6c0 1.66 3.58 3 8 3s8-1.34 8-3v-6" stroke-width="1.5"/>
                    </svg>
                </div>
            </div>
            
            <!-- Flow Arrow 1 -->
            <div class="flex items-center gap-1 text-ocean-500/60">
                <span class="anim-dots" style="animation-delay: 0s;">‚Ä¢</span>
                <span class="anim-dots" style="animation-delay: 0.2s;">‚Ä¢</span>
                <span class="anim-dots" style="animation-delay: 0.4s;">‚Ä¢</span>
                <svg class="w-5 h-5 anim-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
            </div>
            
            <!-- Center Hub -->
            <div class="anim-hub w-16 h-16 rounded-2xl bg-gradient-to-br from-ocean-500/30 to-ocean-600/20 border-2 border-ocean-500/50 flex items-center justify-center">
                <svg class="w-8 h-8 text-ocean-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </div>
            
            <!-- Flow Arrow 2 -->
            <div class="flex items-center gap-1 text-ocean-500/60">
                <svg class="w-5 h-5 anim-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
                <span class="anim-dots" style="animation-delay: 0s;">‚Ä¢</span>
                <span class="anim-dots" style="animation-delay: 0.2s;">‚Ä¢</span>
                <span class="anim-dots" style="animation-delay: 0.4s;">‚Ä¢</span>
            </div>
            
            <!-- Output Types -->
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                    <div class="w-9 h-9 rounded-lg bg-midnight-800/50 border border-volt-500/30 flex items-center justify-center">
                        <span class="text-sm">üìä</span>
                    </div>
                    <span class="text-[11px] text-midnight-400">Status</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-9 h-9 rounded-lg bg-midnight-800/50 border border-ocean-500/30 flex items-center justify-center">
                        <span class="text-sm">‚öôÔ∏è</span>
                    </div>
                    <span class="text-[11px] text-midnight-400">Config</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-9 h-9 rounded-lg bg-midnight-800/50 border border-purple-500/30 flex items-center justify-center">
                        <span class="text-sm">üìã</span>
                    </div>
                    <span class="text-[11px] text-midnight-400">Queries</span>
                </div>
            </div>
        </div>
        
        <!-- Labels -->
        <div class="flex justify-center gap-16 text-[10px] text-midnight-600 uppercase tracking-wider">
            <span>MySQL Hosts</span>
            <span>Observer</span>
            <span>Diagnostics</span>
        </div>
    </div>

    {% if error %}
    <div class="glass-card rounded-xl p-4 border-l-4 border-crimson-500 bg-crimson-500/10">
        <div class="flex items-center gap-3">
            <svg class="w-5 h-5 text-crimson-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-crimson-200">{{ error }}</span>
        </div>
    </div>
    {% endif %}

    <form action="/jobs/create" method="POST">
        <!-- Job Name Input -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex items-center gap-4">
                <label for="job_name" class="text-sm font-medium text-midnight-300 whitespace-nowrap">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    Job Name <span class="text-midnight-500 font-normal">(optional)</span>
                </label>
                <input type="text" 
                       name="job_name" 
                       id="job_name"
                       placeholder="e.g., Load test baseline, Production check, Debug session..."
                       class="flex-1 px-4 py-2 bg-midnight-800/50 border border-midnight-700/50 rounded-lg text-white placeholder-midnight-500 focus:outline-none focus:border-ocean-500/50 focus:ring-1 focus:ring-ocean-500/50">
            </div>
        </div>

        <!-- Host Selection Grid -->
        <div class="glass-card glow-border rounded-2xl p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-ocean-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                    </svg>
                    Available Hosts
                </h2>
                <div class="flex items-center gap-2">
                    <button type="button" 
                            @click="selectedHosts = [...document.querySelectorAll('input[name=hosts]')].map(el => el.value)"
                            class="text-xs px-3 py-1.5 rounded-lg bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700 transition-all">
                        Select All
                    </button>
                    <button type="button"
                            @click="selectedHosts = []"
                            class="text-xs px-3 py-1.5 rounded-lg bg-midnight-700/50 text-midnight-300 hover:text-white hover:bg-midnight-700 transition-all">
                        Clear
                    </button>
                </div>
            </div>

            {% if hosts %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for host in hosts %}
                <label class="relative cursor-pointer group"
                       :class="selectedHosts.includes('{{ host.id }}') ? 'ring-2 ring-ocean-500 ring-offset-2 ring-offset-midnight-900' : ''">
                    <input type="checkbox" 
                           name="hosts" 
                           value="{{ host.id }}" 
                           class="sr-only peer"
                           x-model="selectedHosts">
                    <div class="bg-midnight-800/50 rounded-xl p-5 border border-midnight-700/50 group-hover:border-ocean-500/50 transition-all duration-200"
                         :class="selectedHosts.includes('{{ host.id }}') ? 'bg-ocean-500/10 border-ocean-500/50' : ''">
                        <div class="flex items-start justify-between">
                            <div class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-volt-400"></div>
                                    <h3 class="font-semibold text-white">{{ host.label }}</h3>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="relative" x-data="{ showTip: false }">
                                        <p @mouseenter="showTip = true" @mouseleave="showTip = false"
                                           class="text-midnight-400 font-mono text-xs truncate max-w-[220px] cursor-default">{{ host.host }}:{{ host.port }}</p>
                                        <div x-show="showTip" x-cloak
                                             class="absolute z-50 top-full left-0 mt-1 px-3 py-2 text-xs text-white bg-midnight-900 border border-midnight-700 rounded-lg shadow-xl whitespace-nowrap">
                                            {{ host.host }}:{{ host.port }}
                                        </div>
                                    </div>
                                    <p class="text-midnight-500">User: {{ host.user }}</p>
                                </div>
                            </div>
                            <div class="w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all"
                                 :class="selectedHosts.includes('{{ host.id }}') ? 'bg-ocean-500 border-ocean-500' : 'border-midnight-600 group-hover:border-midnight-500'">
                                <svg x-show="selectedHosts.includes('{{ host.id }}')" 
                                     class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </label>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto text-midnight-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
                </svg>
                <h3 class="text-lg font-medium text-midnight-400 mb-2">No Hosts Configured</h3>
                <p class="text-midnight-500 text-sm">
                    Add hosts to <code class="font-mono bg-midnight-800 px-2 py-0.5 rounded">hosts.yaml</code> to get started
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Advanced Options -->
        {% if hosts %}
        <div class="glass-card rounded-2xl p-5 mt-6">
            <div class="flex items-center gap-2 mb-4">
                <svg class="w-4 h-4 text-midnight-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
                <h3 class="text-sm font-semibold text-midnight-400 uppercase tracking-wider">Advanced Options</h3>
            </div>
            <label class="flex items-center gap-3 cursor-pointer group">
                <input type="checkbox" 
                       name="collect_hot_tables" 
                       value="1"
                       class="w-5 h-5 rounded border-2 border-midnight-600 bg-midnight-800 text-ocean-500 focus:ring-ocean-500 focus:ring-offset-midnight-900 cursor-pointer">
                <div class="flex items-center gap-2">
                    <div>
                        <span class="text-white font-medium">Collect Hot Tables</span>
                        <p class="text-xs text-midnight-400 mt-0.5">Query performance_schema for table I/O statistics (top 10 most active tables)</p>
                    </div>
                    {{ info_tooltip("Queries performance_schema.table_io_waits_summary_by_index_usage. Adds ~1-2 seconds per host. Shows which tables have the most I/O activity. Requires performance_schema to be enabled (default in MySQL 5.6+). Safe to run on production.") }}
                </div>
            </label>
        </div>
        {% endif %}

        <!-- Action Button -->
        {% if hosts %}
        <div class="flex justify-center pt-6">
            <button type="submit"
                    :disabled="selectedHosts.length === 0"
                    class="group relative px-8 py-4 rounded-xl font-semibold text-white transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    :class="selectedHosts.length > 0 ? 'bg-gradient-to-r from-ocean-500 to-ocean-600 hover:from-ocean-400 hover:to-ocean-500 shadow-lg shadow-ocean-500/25 hover:shadow-ocean-500/40' : 'bg-midnight-700'">
                <span class="flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Run Collection
                    <span class="text-ocean-200" x-show="selectedHosts.length > 0" x-text="'(' + selectedHosts.length + ' host' + (selectedHosts.length > 1 ? 's' : '') + ')'"></span>
                </span>
            </button>
        </div>
        {% endif %}
    </form>

    <!-- Commands Preview -->
    <div class="glass-card rounded-2xl p-6 space-y-4">
        <h3 class="text-sm font-semibold text-midnight-400 uppercase tracking-wider flex items-center gap-2">
            Commands to Execute (Parallel)
            {{ info_tooltip("All commands run in parallel using ThreadPoolExecutor for faster collection. Each command has a timeout to prevent hanging. Results are saved as JSON files for analysis and comparison.") }}
        </h3>
        <div class="code-block rounded-xl p-4 font-mono text-sm space-y-2 text-ocean-200">
            <div class="flex items-center gap-2 group">
                <span class="text-volt-400">mysql&gt;</span>
                <span>SHOW ENGINE INNODB STATUS</span>
                <span class="text-midnight-500 text-xs ml-auto">‚Äî InnoDB internals</span>
                {{ info_tooltip("Returns detailed InnoDB metrics: buffer pool, transactions, locks, I/O, redo log, background threads. Primary source for performance analysis.", 'left') }}
            </div>
            <div class="flex items-center gap-2 group">
                <span class="text-volt-400">mysql&gt;</span>
                <span>SHOW GLOBAL STATUS</span>
                <span class="text-midnight-500 text-xs ml-auto">‚Äî Server metrics</span>
                {{ info_tooltip("~500 cumulative counters since server start: connections, queries, bytes sent/received, InnoDB row operations, thread states, etc.", 'left') }}
            </div>
            <div class="flex items-center gap-2 group">
                <span class="text-volt-400">mysql&gt;</span>
                <span>SHOW FULL PROCESSLIST</span>
                <span class="text-midnight-500 text-xs ml-auto">‚Äî Active queries</span>
                {{ info_tooltip("Snapshot of all current connections: who is connected, what they're running, how long queries have been executing. FULL shows complete query text.", 'left') }}
            </div>
            <div class="flex items-center gap-2 group">
                <span class="text-volt-400">mysql&gt;</span>
                <span>SHOW GLOBAL VARIABLES</span>
                <span class="text-midnight-500 text-xs ml-auto">‚Äî Configuration</span>
                {{ info_tooltip("Server configuration values: buffer sizes, thread counts, timeouts, features enabled. Compare across servers to spot misconfigurations.", 'left') }}
            </div>
            <div class="flex items-center gap-2 group">
                <span class="text-volt-400">mysql&gt;</span>
                <span>SHOW REPLICA STATUS</span>
                <span class="text-midnight-500 text-xs ml-auto">‚Äî Replication lag</span>
                {{ info_tooltip("Replica-only: IO/SQL thread status, seconds behind master, master coordinates, relay log position. Empty on non-replica servers.", 'left') }}
            </div>
            <div class="flex items-center gap-2 group">
                <span class="text-volt-400">mysql&gt;</span>
                <span>SHOW MASTER STATUS</span>
                <span class="text-midnight-500 text-xs ml-auto">‚Äî Master binlog position</span>
                {{ info_tooltip("Master-only: Current binary log file and position. Used to compare with replica positions to calculate replication lag in bytes.", 'left') }}
            </div>
        </div>
    </div>
</div>
{% endblock %}

