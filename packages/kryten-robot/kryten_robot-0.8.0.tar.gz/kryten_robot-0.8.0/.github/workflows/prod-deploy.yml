name: Deploy to Production

# DISABLED: GitHub Actions temporarily disabled for cost reasons
# Production deployment kept as workflow_dispatch only (manual trigger)
# This workflow can still be run manually if needed
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string
      reason:
        description: 'Reason for deployment'
        required: true
        type: string

permissions:
  contents: read
  deployments: write

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      
      - name: Verify version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"
      
      - name: Check VERSION file
        run: |
          if [ ! -f VERSION ]; then
            echo "âŒ VERSION file not found"
            exit 1
          fi
          FILE_VERSION=$(cat VERSION)
          INPUT_VERSION="${{ inputs.version }}"
          INPUT_VERSION="${INPUT_VERSION#v}"  # Remove 'v' prefix
          
          if [ "$FILE_VERSION" != "$INPUT_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "  VERSION file: $FILE_VERSION"
            echo "  Input version: $INPUT_VERSION"
            exit 1
          fi
          echo "âœ… VERSION file matches: $FILE_VERSION"
      
      - name: Verify tag exists
        run: |
          git fetch --tags
          if ! git rev-parse "${{ inputs.version }}" >/dev/null 2>&1; then
            echo "âŒ Tag ${{ inputs.version }} does not exist"
            exit 1
          fi
          echo "âœ… Tag exists: ${{ inputs.version }}"

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [validate]
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Lint
        run: |
          ruff check lib/ common/ bots/ web/ --select E,F,W,C90,I,N
      
      - name: Test
        run: |
          pytest test/ --cov=lib --cov=common --cov-report=term-missing
          coverage report --fail-under=92

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-gates]
    environment:
      name: production
      url: https://cytu.be/r/rosey
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      
      - name: Create deployment record
        run: |
          echo "ðŸ“ Creating deployment record..."
          echo "Version: ${{ inputs.version }}"
          echo "Reason: ${{ inputs.reason }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_PROD }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Backup current production
        run: |
          echo "ðŸ’¾ Creating backup of current production..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            BACKUP_DIR="/opt/rosey-bot-backup-$(date +%Y%m%d-%H%M%S)"
            sudo cp -r /opt/rosey-bot "$BACKUP_DIR"
            echo "âœ… Backup created at $BACKUP_DIR"
          EOF
      
      - name: Deploy code to production
        run: |
          echo "ðŸš€ Deploying ${{ inputs.version }} to production..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'tests/' \
            --exclude '*.pyc' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude '.coverage' \
            --exclude '.venv' \
            ./ ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/opt/rosey-bot/
      
      - name: Restart bot service
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} << 'EOF'
            sudo systemctl restart rosey-bot
            sudo systemctl restart rosey-dashboard
          EOF
      
      - name: Verify deployment
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10
          
          HEALTH_URL="http://${{ secrets.PROD_SERVER_HOST }}:8000/api/health"
          
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL" | grep -q "healthy"; then
              echo "âœ… Production deployment successful!"
              curl -s "$HEALTH_URL" | jq '.' || curl -s "$HEALTH_URL"
              exit 0
            fi
            echo "Waiting for health endpoint... ($i/5)"
            sleep 5
          done
          
          echo "âŒ Health endpoint not responding"
          echo "âš ï¸  Consider rolling back!"
          exit 1
      
      - name: Record deployment
        if: success()
        run: |
          echo "ðŸ’¾ Recording deployment in database..."
          echo "Version: ${{ inputs.version }}"
          echo "This would log deployment to dashboard database"
          # Will be implemented in Sortie 11 (Dashboard)
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

  rollback-prep:
    name: Prepare Rollback
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    
    steps:
      - name: Notify rollback needed
        run: |
          echo "âš ï¸ DEPLOYMENT FAILED - ROLLBACK NEEDED"
          echo "Previous deployment will be restored automatically on server"
          echo "Rollback mechanism implemented in deploy.sh script"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Send notification
        run: |
          echo "ðŸ“¢ Sending deployment notification..."
          echo "Version: ${{ inputs.version }}"
          echo "Status: ${{ needs.deploy.result }}"
          echo "Webhook notifications will be implemented in later sortie"
