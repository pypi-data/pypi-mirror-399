name: Deploy to Test

# DISABLED: GitHub Actions temporarily disabled for cost reasons
# Uncomment the 'on:' section below to re-enable
# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:
#     inputs:
#       reason:
#         description: 'Reason for manual deployment'
#         required: false
#         type: string
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        type: string

permissions:
  contents: read
  deployments: write

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Lint
        run: |
          #ruff check lib/ common/ bots/ web/ --select E,F,W,C90,I,N
          uname -a
      
      - name: Test
        run: |
          pytest test/ --cov=lib --cov=common --cov-report=term-missing
          coverage report --fail-under=70

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [quality-gates]
    environment:
      name: test
      url: https://cytu.be/r/test-rosey
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_TEST }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy code to test server
        run: |
          echo "ðŸš€ Deploying to test environment..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'tests/' \
            --exclude '*.pyc' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude '.coverage' \
            --exclude '.venv' \
            ./ ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }}:/opt/rosey-bot/
      
      - name: Restart bot service
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_HOST }} << 'EOF'
            sudo systemctl restart rosey-bot
            sudo systemctl restart rosey-dashboard
          EOF
      
      - name: Verify deployment
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10
          
          HEALTH_URL="http://${{ secrets.TEST_SERVER_HOST }}:8001/api/health"
          
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL" | grep -q "healthy"; then
              echo "âœ… Test deployment successful!"
              curl -s "$HEALTH_URL" | jq '.' || curl -s "$HEALTH_URL"
              exit 0
            fi
            echo "Waiting for health endpoint... ($i/5)"
            sleep 5
          done
          
          echo "âŒ Health endpoint not responding"
          exit 1
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
  
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Send notification
        run: |
          echo "ðŸ“¢ Sending deployment notification..."
          echo "Status: ${{ needs.deploy.result }}"
          echo "Webhook notifications will be implemented in later sortie"
