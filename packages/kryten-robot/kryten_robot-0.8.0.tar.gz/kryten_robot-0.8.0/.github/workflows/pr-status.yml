name: PR Status Check

# DISABLED: GitHub Actions temporarily disabled for cost reasons
# Uncomment the 'on:' section below to re-enable
# on:
#   pull_request:
#     types: [opened, synchronize, reopened]
on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run lint
        id: lint
        run: |
          ruff check lib/ common/ bots/ web/ --select E,F,W,C90,I,N || echo "lint_failed=true" >> $GITHUB_OUTPUT
      
      - name: Run tests
        id: test
        run: |
          pytest test/ --cov=lib --cov=common --cov-report=term-missing --cov-report=json
          coverage report --fail-under=92 || echo "test_failed=true" >> $GITHUB_OUTPUT
      
      - name: Comment PR with status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read coverage data
            let coveragePercent = 'N/A';
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
              coveragePercent = coverage.totals.percent_covered.toFixed(1);
            } catch (e) {
              console.log('Could not read coverage data');
            }
            
            const lintFailed = '${{ steps.lint.outputs.lint_failed }}' === 'true';
            const testFailed = '${{ steps.test.outputs.test_failed }}' === 'true';
            const passed = !lintFailed && !testFailed;
            
            const statusEmoji = passed ? '‚úÖ' : '‚ùå';
            const statusText = passed ? 'PASSED' : 'FAILED';
            
            const body = `## ${statusEmoji} PR Quality Check - ${statusText}
            
            **Lint:** ${lintFailed ? '‚ùå Failed' : '‚úÖ Passed'}
            **Tests:** ${testFailed ? '‚ùå Failed' : '‚úÖ Passed'} (Coverage: ${coveragePercent}%)
            
            ---
            
            <details>
            <summary>üìä Details</summary>
            
            - **Commit:** ${context.sha.substring(0, 7)}
            - **Branch:** ${context.payload.pull_request.head.ref}
            - **Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            </details>
            
            <!-- rosey-bot-pr-status -->
            `;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.body.includes('<!-- rosey-bot-pr-status -->')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }
      
      - name: Fail job if checks failed
        if: steps.lint.outputs.lint_failed == 'true' || steps.test.outputs.test_failed == 'true'
        run: exit 1
