stages:
  - quality
  - test
  - build
  - publish

lint:
  stage: quality
  image: rust:alpine
  variables:
    RUSTFLAGS: "-Dwarnings"
  script:
    - rustup component add clippy
    - cargo clippy

formatting:
  stage: quality
  image: rust:alpine
  script:
    - rustup component add rustfmt
    - cargo fmt --check

test:
  stage: test
  image: rust:alpine
  script:
    - cargo test

build python package:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  script:
    - apk add curl cargo
    # TODO: Replace this with an apk add once uv is at a higher version
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH=$PATH:$HOME/.local/bin
    - uv sync
    - if [ ! -d "dist" ]; then uv build; uvx cibuildwheel --output-dir dist; fi
  cache:
    key:
      files:
        - Cargo.lock
        - Cargo.toml
    paths:
      - dist/**
      - target/**

build js package:
  stage: build
  image: rust:alpine
  script:
    - apk add npm
    - npm install -g wasm-pack
    - wasm-pack build --release . --features=wasm

publish python package:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  script:
    - apk add curl cargo
    # TODO: Replace this with an apk add once uv is at a higher version
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH=$PATH:$HOME/.local/bin
    - if [ ! -d "dist" ]; then uv build; uvx cibuildwheel --output-dir dist; fi
    - uv publish --token $UV_PUBLISH_TOKEN
  artifacts:
    paths:
      - dist/line_items-*.tar.gz
      - dist/line_items-*.whl
  cache:
    key:
      files:
        - Cargo.lock
        - Cargo.toml
    paths:
      - dist/**
      - target/**
  rules:
      - if: $CI_COMMIT_TAG
        when: never
      - if: $CI_COMMIT_BRANCH == 'main'

publish js package:
  stage: publish
  image: rust:alpine
  script:
    - apk add npm jq
    - npm install -g wasm-pack
    - cp $NPM_CONFIG_FILE $HOME/.npmrc
    - wasm-pack build --release . --features=wasm
    - jq 'setpath(["name"]; "@artconomy/line_items")' pkg/package.json > pkg/package.json.new
    - mv pkg/package.json.new pkg/package.json
    - wasm-pack pack
    - wasm-pack publish --access=public
  artifacts:
    paths:
      # Should only ever be one file, but will change filename depending on the version.
      - pkg/line_items*.tar.gz
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == 'main'
