# Scriptbook 更新日志

## [1.4.1] - 2025-12-24

### 🐛 错误修复
- **Docker命令支持**: 添加 `pty=True` 参数，支持 `docker exec` 等需要 TTY 的命令
  - 修复 "the input device is not tty" 错误

## [1.4.0] - 2025-12-24

### ✨ 新增功能
- **xterm.js嵌入式终端**: 使用专业的终端模拟器渲染脚本输出
  - 支持完整的ANSI转义序列解析
  - 提供更好的终端体验（滚动、选择、复制）
  - 浅色主题适配（#f5f5f5背景 + #333333文字）
  - 颜色编码：stdout无色、stderr红色、stdin青色、exit黄色

### 🔧 技术改进
- 新增 `terminal-manager.js` - 终端管理器类
  - 管理多个终端实例
  - 支持主题切换
  - 持久化内容获取
- 新增 `lib/xterm.js` 和 `lib/xterm.css` - xterm.js库文件
- 移除废弃的 `ansi-html.js` 和 `ansi-parser.js`
- 终端输出区域CSS优化
  - 隐藏scroll-area黑框
  - 正确处理overflow和滚动条

### 🧪 测试增强
- 新增26个TerminalManager单元测试
- 更新83个现有测试以适配新实现
- 总测试数更新为109个（JS）+ 70个（Python）+ 13个（集成）

## [1.3.1] - 2025-12-23

### 🐛 错误修复
- **主题持久化**: 刷新页面保持当前选择的主题
- **文档持久化**: 刷新页面保持当前选择的文档
- **浏览器缓存**: JS/CSS添加版本号?v=2防止缓存导致的问题

### 🔧 代码优化
- 移除冗余 import 语句
- 添加 `_timestamp()` 辅助函数，避免重复代码
- 修复 bare except 为具体异常处理
- 插件管理器添加缓存 TTL (60秒)
- 优化 `get_plugin` 查找逻辑

### 🧪 测试增强
- 新增3个Python回归测试（markdown渲染相关）
- 新增16个JavaScript测试（持久化功能）
- 总测试数更新为86个（70 Python + 16 JS）

## [1.3.0] - 2025-12-22

### ✨ 新增功能
- **ANSI转义序列解析**: 脚本输出的颜色和格式在浏览器中正确显示
  - 支持 `\x1b[`、`\033[` 和 `[` 格式的ANSI序列
  - 支持16种基础颜色（黑、红、绿、黄、蓝、紫、青、白）
  - 支持粗体、斜体、下划线、反色等格式效果
  - 自动检测并转换ANSI序列为HTML

### 🎨 界面改进
- **按钮布局优化**: 所有操作按钮移至脚本块头部同一行
  - 执行按钮（绿色）+ 复制按钮（蓝色）+ 停止按钮（红色）
  - 统一按钮样式和间距
  - 响应式布局，移动端自适应换行
- **输出区域优化**:
  - 移除输出行之间的水平分隔线
  - 极紧凑的行间距（垂直padding: 0）
  - 时间戳与内容水平对齐（baseline对齐）
  - 优化字体大小和边距，提升可读性

### 🔧 技术改进
- **新增模块化架构**:
  - `output-optimizers/ansi-parser.js` - ANSI检测与转换模块
  - `lib/ansi-html.js` - 自定义ANSI到HTML转换器
- **CSS主题增强**:
  - 默认主题和暗色主题均支持ANSI颜色
  - 添加 `.ansi-bold`、`.ansi-italic`、`.ansi-underline` 样式类
  - 确保ANSI颜色与主题系统完美融合
- **HTML结构优化**:
  - 脚本块按钮统一在头部显示
  - 移除底部按钮容器，简化DOM结构

### 📚 文档更新
- 新增 `content/ansi_examples.md` - 15+个ANSI使用示例
  - 基本颜色示例（红、绿、黄、蓝）
  - 带格式的颜色示例（粗体、下划线、反色）
  - 构建过程示例（模拟真实项目构建）
  - 高级格式化示例（256色、RGB色）
- 更新 `content/example.md` - 添加ANSI颜色演示

### 🧪 测试增强
- **新增15个JavaScript测试**:
  - ANSI序列检测测试（5个）
  - ANSI转换测试（5个）
  - 集成测试（5个）
- **测试覆盖场景**:
  - 支持 `\x1b[` 转义字符格式
  - 支持 `\033[` 八进制格式
  - 支持字面 `[` 字符格式
  - 多行ANSI序列处理
  - 非字符串输入处理
  - 与app.js集成测试
- **总测试数更新**: 153个测试（72 JS + 64 Python + 17 集成）

## [1.2.0] - 2025-12-22

### 📚 新增功能
- **发布流程文档**: 新增RELEASE_PROCESS.md，规范化代码整理和发布流程
- **项目结构文档**: 新增CLAUDE.md，详细说明项目目录结构
- **更新日志文档**: 新增CHANGELOG.md，完整记录版本变更

### 🔧 技术改进
- **项目结构优化**: 清理开发过程文档，整理docs/testing/目录
- **文档体系完善**: 建立README、CHANGELOG、RELEASE_PROCESS、CLAUDE四大文档体系
- **发布流程简化**: 优化RELEASE_PROCESS.md，从6KB简化为2KB，提高可读性

### 🎨 界面改进
- 无

### 📚 文档更新
- 更新README.md添加v1.2.0功能说明
- 创建完整的文档导航体系

### 🧪 测试增强
- 无

### 🔧 工具改进
- 无

## [1.1.0] - 2025-12-22

### ✨ 新增功能
- **脚本结果持久化**: 页面刷新后自动恢复脚本执行结果（使用localStorage）
- **停止脚本执行**: 点击红色停止按钮立即终止正在执行的脚本
- **WebSocket并发优化**: 改进连接处理，支持页面刷新场景

### 🐛 错误修复
- 修复WebSocket "Unexpected ASGI message" 错误
- 修复停止按钮不可见问题
- 改进异常处理和资源清理

### 🧪 测试增强
- 新增25个JavaScript测试用例
- 总测试数更新为138个（61 JS + 64 Python + 13 集成）
- 新增测试文件：
  - `script-results-persistence.test.js` - 结果持久化测试
  - `script-results-persistence-integration.test.js` - 集成测试
  - `websocket-concurrency.test.js` - 并发处理测试
  - `script-stop-functionality.test.js` - 停止功能测试

### 🎨 界面改进
- 停止按钮：红色背景 + 白色边框，清晰可见
- 按钮状态：执行时启用，停止后恢复
- 视觉反馈：显示"=== 脚本已被用户停止 ==="

### 📚 文档更新
- 更新README.md，添加新功能说明
- 创建PROJECT_STRUCTURE.md项目结构文档
- 移动测试文档到`docs/testing/`目录

### 🔧 技术改进
- 前端：`app.js`添加持久化和停止逻辑
- 后端：`scripts.py`改进WebSocket错误处理
- 样式：`main.css`修复按钮可见性
- 渲染：`markdown.py`添加内联样式确保显示

## [1.0.0] - 2025-12-21

### ✨ 初始版本
- 项目重命名为Scriptbook
- 交互式输入功能（stdin支持）
- WebSocket实时输出流
- 多文档支持
- 主题切换（明亮/暗色）
- 25个JavaScript单元测试
- 64个Python单元测试
- 13个集成测试

---

## 测试覆盖率详情

### JavaScript测试 (61个)
- App类基础功能：25个
- 脚本结果持久化：9个
- 脚本结果持久化集成：7个
- WebSocket并发处理：8个
- 脚本停止功能：12个

### Python测试 (64个)
- 文件扫描：15个
- Markdown解析：20个
- 插件管理：15个
- 脚本执行：14个

### 集成测试 (13个)
- WebSocket集成：8个
- 端到端测试：5个

**总测试数：138个，全部通过 ✅**

## 贡献者

- **lzy** - 初始开发和所有功能实现

## 许可证

MIT License
