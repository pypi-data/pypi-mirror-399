# ðŸ¤– Theus Framework v2: AI Developer Context & Guidelines

**Target Audience:** AI Assistants (GPT-4, Claude 3.5, Gemini) & Human Developers.
**Purpose:** Rapid understanding of architectural invariants, coding standards, and safety constraints within Theus v2.

---

## 1. Core Philosophy: The 3-Axis Context Model

Theus v2 is a **Process-Oriented Operating System** for your code. It revolves around a strictly structured Context:

### The 3 Axes (Mental Model)
1.  **Layer (Scope):** `Global` (Config) / `Domain` (Session) / `Local` (Ephemeral).
2.  **Semantic (Role):** `Input` (Read) / `Output` (Write).
3.  **Zone (Policy):**
    *   **DATA:** Persistent Assets. Transactional. Replayable.
    *   **SIGNAL (`sig_`, `cmd_`):** Transient Events. Reset on Read/Rollback. **Non-Replayable**.
    *   **META (`meta_`):** Observability only.

**CRITICAL INVARIANT:** Never mutate the `Context` directly outside of a registered `@process`. The Engine will raise `ContextLockedError`.

---

## 2. Architectural Components

### The Kernel (`TheusEngine`)
*   **Role:** Safe Execution Environment.
*   **Pipeline:** `Audit Input` -> `Lock` -> `Guard` -> `Tx Start` -> `Exec` -> `Audit Output` -> `Commit/Rollback`.
*   **Safety:** Zero Trust. Wraps Context in a `ContextGuard` proxy.

### The Orchestrator (`WorkflowManager`)
*   **Role:** Reactive Flow Control (FSM).
*   **Mechanism:** Listens to `SignalBus`. If a process sets `ctx.domain.sig_done = True`, the Manager triggers the next state.

### The Unit of Work (`@process`)
*   **Decorator:** `@process` is MANDATORY.
*   **Contract:** Must define explicit `inputs` and `outputs`.

---

## 3. Coding Standards & Patterns (v2)

### A. Defining a Process
**DO:**
```python
@process(
    inputs=['domain.items'],           # Only DATA zone allowed in inputs
    outputs=['domain.total', 'domain.sig_done'], # Output can be anything
    errors=['ValueError']
)
def add_item(ctx, item: dict):
    # ctx is a ContextGuard (Proxy)
    ctx.domain.items.append(item)      # TrackedList (Shadow Copy)
    ctx.domain.total += item['price']  # Optimistic Write
    ctx.domain.sig_done = True         # Signal trigger
```

**DON'T (Theus v2 Strict Rules):**
*   **NO SIGNAL INPUTS:** Never put `sig_...` in `inputs`. Signals are for Orchestrators, not Process logic.
*   **NO ZOMBIES:** Do not assign `x = ctx.domain.items` and use `x` after the process returns.
*   **NO RETURN CTX:** Return business values or `None`.

### B. Transaction Safety
Theus uses a **Hybrid Transaction Model**:
1.  **Scalars (int, str):** Optimistic Write + Undo Log.
2.  **Structures (list, dict):** Shadow Copy (Copy-on-Write).

---

## 4. The Audit System (Industrial Policy)

Governance is defined in `AuditRecipe` (YAML), not code.

| Level | Exception | Action | Use Case |
| :--- | :--- | :--- | :--- |
| **S** (Safety) | `AuditInterlockError` | **Emergency Stop** | Physical/System limit violation. |
| **A** (Abort) | `AuditInterlockError` | **Hard Stop** | Critical Logic failure. |
| **B** (Block) | `AuditBlockError` | **Rollback** | Business Rule rejection (e.g. Insufficient Funds). |
| **C** (Campaign)| (None) | **Log Warning** | Monitoring. |

**Rule Spec:**
*   `min_threshold`: Count to start warning.
*   **`max_threshold`**: Count to trigger Action (S/A/B).
*   `reset_on_success`: Configurable (Default: False in current codebase - accumulates errors).

---

## 5. Testing Guidelines

*   **Mocking:** Use `MockSystemContext` and `TheusEngine` for integration tests.
*   **Policy Testing:** Verify that `AuditBlockError` is raised when rules are violated.
*   **Zombie Testing:** Ensure no variables hold references to Context lists after execution.

---

## 6. Project Structure (Navigation)

*   `theus/engine.py`: Kernel & Execution Pipeline.
*   `theus/guards.py`: `ContextGuard` & `Zone` enforcement logic.
*   `theus/audit.py`: Policy enforcement & Tracker.
*   `theus/orchestrator/`: `fsm.py` (StateMachine) & `manager.py`.
*   `specs/`: `context_schema.yaml`, `audit_recipe.yaml`, `workflow.yaml`.

---

## 7. Workflow for AI (How to generate code)

1.  **Check Schema:** Read `specs/context_schema.yaml` to understand the 3-Axis Data Model.
2.  **Check Workflow:** Read `specs/workflow.yaml` to see where the process fits in the FSM.
3.  **Draft Contract:** Identify strict Inputs (Data only) and Outputs.
4.  **Implement:** Write `@process` with strict typing.
5.  **Verify Zone:** Ensure no Signal is used as Input. Ensure `meta_` is used only for logging.

---
*Generated by Theus Architect Agent (v2.0)*