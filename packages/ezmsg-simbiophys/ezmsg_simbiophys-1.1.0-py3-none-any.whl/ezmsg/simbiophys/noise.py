"""Noise signal generators."""

import ezmsg.core as ez
import numpy as np
from ezmsg.baseproc import (
    BaseProcessor,
    BaseStatefulTransformer,
    BaseTransformerUnit,
    CompositeProcessor,
    processor_state,
)
from ezmsg.sigproc.butterworthfilter import (
    ButterworthFilterSettings,
    ButterworthFilterTransformer,
)
from ezmsg.util.messages.axisarray import AxisArray, replace


class WhiteNoiseSettings(ez.Settings):
    """Settings for white noise generators."""

    n_ch: int = 1
    """Number of channels to output."""

    loc: float = 0.0
    """DC offset (mean of the distribution)."""

    scale: float = 1.0
    """Scale (standard deviation of the distribution)."""


@processor_state
class WhiteNoiseTransformerState:
    """State for NoiseTransformer."""

    template: AxisArray | None = None


class WhiteNoiseTransformer(
    BaseStatefulTransformer[WhiteNoiseSettings, AxisArray, AxisArray, WhiteNoiseTransformerState]
):
    """
    Transforms input AxisArray into white noise signal.

    Takes timing information from input message (counter output) and
    generates random data with the specified number of channels.
    """

    def _reset_state(self, message: AxisArray) -> None:
        """Initialize template with channel axis."""
        n_ch = self.settings.n_ch
        self._state.template = AxisArray(
            data=np.zeros((0, n_ch)),
            dims=["time", "ch"],
            axes={
                "time": message.axes["time"],
                "ch": AxisArray.CoordinateAxis(
                    data=np.arange(n_ch),
                    dims=["ch"],
                ),
            },
        )

    def _process(self, message: AxisArray) -> AxisArray:
        n_time = message.data.shape[0]

        # Generate random data
        random_data = np.random.normal(
            loc=self.settings.loc,
            scale=self.settings.scale,
            size=(n_time, self.settings.n_ch),
        )

        # Create output using template
        return replace(
            self._state.template,
            data=random_data,
            axes={
                "time": message.axes["time"],
                "ch": self._state.template.axes["ch"],
            },
        )


class WhiteNoise(BaseTransformerUnit[WhiteNoiseSettings, AxisArray, AxisArray, WhiteNoiseTransformer]):
    """
    Transforms counter input into white noise signal.

    Receives timing from INPUT_SIGNAL (AxisArray from Counter) and outputs
    white noise AxisArray.
    """

    SETTINGS = WhiteNoiseSettings


class PinkNoiseSettings(WhiteNoiseSettings):
    """Settings for pink noise generator."""

    cutoff: float = 300.0
    """
    Highpass Cutoff frequency (Hz). Lowpass corner of first order Butterworth filter.
    """


class PinkNoiseTransformer(CompositeProcessor[PinkNoiseSettings, AxisArray, AxisArray]):
    """
    Transforms input AxisArray into pink (1/f) noise signal.

    Pink noise is generated by filtering white noise with a first-order
    lowpass Butterworth filter with cutoff at fs * 0.01 Hz.
    """

    @staticmethod
    def _initialize_processors(settings: PinkNoiseSettings) -> dict[str, BaseProcessor]:
        return {
            "white_noise": WhiteNoiseTransformer(
                WhiteNoiseSettings(
                    n_ch=settings.n_ch,
                    loc=settings.loc,
                    scale=settings.scale,
                )
            ),
            "filter": ButterworthFilterTransformer(
                ButterworthFilterSettings(axis="time", order=1, cutoff=settings.cutoff)
            ),
        }


class PinkNoise(BaseTransformerUnit[PinkNoiseSettings, AxisArray, AxisArray, PinkNoiseTransformer]):
    """
    Transforms counter input into pink (1/f) noise signal.

    Receives timing from INPUT_SIGNAL (AxisArray from Counter) and outputs
    pink noise AxisArray.
    """

    SETTINGS = PinkNoiseSettings
