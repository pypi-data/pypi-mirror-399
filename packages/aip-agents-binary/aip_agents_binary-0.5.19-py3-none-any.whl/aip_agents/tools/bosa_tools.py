"""Auto-generated tools from BOSA connector.

Authors:
    Saul Sayers (saul.sayers@gdplabs.id)
"""

from bosa_connectors import BosaConnector, BOSAConnectorToolGenerator
from langchain_core.tools import BaseTool

from aip_agents.tools.constants import BOSA_API_BASE_URL, BOSA_API_KEY, BOSA_FETCH_MAX_RETRIES, ToolType
from aip_agents.utils.logger import get_logger

logger = get_logger(__name__)


def get_bosa_modules_with_retry() -> list[str]:
    """Try to get available modules with retries.

    Returns:
        List of available modules.
    """
    if not BOSA_API_BASE_URL or not BOSA_API_KEY:
        logger.warning("BOSA credentials missing (base_url or api_key); returning empty modules list")
        return []

    connector = BosaConnector(api_base_url=BOSA_API_BASE_URL, api_key=BOSA_API_KEY)
    modules = []
    for attempt in range(BOSA_FETCH_MAX_RETRIES):
        try:
            modules = list(connector.get_available_modules())
            if modules:
                return modules
            logger.warning(
                f"Failed to get BOSA available modules, retrying... (attempt {attempt + 1} / {BOSA_FETCH_MAX_RETRIES})"
            )
        except Exception as e:
            logger.exception(
                f"Exception when getting BOSA available modules (attempt {attempt + 1} / {BOSA_FETCH_MAX_RETRIES}): {e}"
            )
    logger.error("Failed to get BOSA available modules after maximum retries")
    return modules


class LazyBosaToolsDict(dict):
    """Lazy dictionary for BOSA tools."""

    def __missing__(self, app):
        """When a key is missing, create the tools and store them in the dictionary.

        Args:
            app: Name of the BOSA connector.

        Returns:
            List of tools generated by BOSAConnectorToolGenerator.
        """
        if app not in get_bosa_modules():
            return []
        tools = []
        for attempt in range(BOSA_FETCH_MAX_RETRIES):
            try:
                tools = BOSAConnectorToolGenerator(
                    api_base_url=BOSA_API_BASE_URL,
                    api_key=BOSA_API_KEY,
                    app_name=app,
                ).generate_tools(tool_type=ToolType.LANGCHAIN)
                if tools:
                    self[app] = tools
                    return tools
                logger.warning(
                    f"Failed to create BOSA tools, retrying... (attempt {attempt + 1} / {BOSA_FETCH_MAX_RETRIES})"
                )
            except Exception as e:
                logger.exception(
                    f"Exception when creating BOSA tools for app '{app}' "
                    f"(attempt {attempt + 1} / {BOSA_FETCH_MAX_RETRIES}): {e}"
                )
        logger.error("Failed to create BOSA tools after maximum retries")
        return tools


# Supported modules (dynamic)
def get_bosa_modules() -> list[str]:
    """Lazily fetch and cache BOSA modules.

    This is for backwards compatibility with the old BOSA modules.

    Returns:
        List of BOSA modules.
    """
    if not hasattr(get_bosa_modules, "_cache"):
        get_bosa_modules._cache = get_bosa_modules_with_retry()
    return get_bosa_modules._cache


# FOR BACKWARDS COMPATIBILITY
BOSA_MODULES = [
    "github",
    "twitter",
    "google",
    "google_drive",
    "google_mail",
    "google_docs",
]

BOSA_AUTOMATED_TOOLS: dict[str, list[BaseTool]] = LazyBosaToolsDict()
