# REQUIRED REPOSITORY SETTING:
# Settings > Actions > General > Workflow permissions
# âœ“ Enable "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, PR creation will fail with:
# "GitHub Actions is not permitted to create or approve pull requests"

name: Implement Extraction Plan
run-name: "Implement Extraction: #${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: true
        type: string
      model_name:
        description: "Claude model to use for implementation"
        required: false
        type: string
        default: "claude-sonnet-4-5"

concurrency:
  group: process-extraction-${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement-extraction:
    # Only run for extraction plan issues (have both erk-plan and erk-extraction labels)
    if: |
      contains(github.event.issue.labels.*.name, 'erk-extraction') &&
      contains(github.event.issue.labels.*.name, 'erk-plan')
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      # =================================================================
      # PHASE 1: CHECKOUT AND SETUP
      # =================================================================
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Setup all tools
        run: |
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          # Install Claude Code
          curl -fsSL https://claude.ai/install.sh | bash

          # Install Prettier via npm
          npm install -g prettier

          cd $GITHUB_WORKSPACE

          # Install workspace packages
          uv tool install --from . --with ./packages/erk-shared erk

      - name: Configure git
        run: |
          git config user.name "erk-bot"
          git config user.email "erk-bot@users.noreply.github.com"

      - name: Detect trunk branch
        id: trunk
        run: |
          source $HOME/.cargo/env
          result=$(erk exec detect-trunk-branch)
          echo "trunk_branch=$(echo "$result" | jq -r '.trunk_branch')" >> $GITHUB_OUTPUT

      - name: Determine issue context
        id: issue_context
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "model_name=${{ inputs.model_name }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "model_name=claude-sonnet-4-5" >> $GITHUB_OUTPUT
          fi

      # =================================================================
      # PHASE 2: CREATE BRANCH AND SETUP
      # =================================================================
      - name: Create extraction branch
        id: branch
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.issue_number }}
          TRUNK_BRANCH: ${{ steps.trunk.outputs.trunk_branch }}
        run: |
          source $HOME/.cargo/env
          result=$(erk exec create-extraction-branch \
            --issue-number "$ISSUE_NUMBER" \
            --trunk-branch "$TRUNK_BRANCH")
          echo "branch_name=$(echo "$result" | jq -r '.branch_name')" >> $GITHUB_OUTPUT

      - name: Create worker-impl from issue
        id: worker_impl
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.issue_number }}
        run: |
          source $HOME/.cargo/env
          result=$(erk exec create-worker-impl-from-issue "$ISSUE_NUMBER")
          success=$(echo "$result" | jq -r '.success')
          echo "worker_impl_success=$success" >> $GITHUB_OUTPUT

      # =================================================================
      # PHASE 3: IMPLEMENTATION
      # =================================================================
      - name: Implement extraction plan
        id: implement
        if: steps.worker_impl.outputs.worker_impl_success == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN == '' && secrets.ANTHROPIC_API_KEY || '' }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set +e
          claude --print \
            --model ${{ steps.issue_context.outputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:plan-implement"

          if [ $? -eq 0 ]; then
            echo "implementation_success=true" >> $GITHUB_OUTPUT
          else
            echo "implementation_success=false" >> $GITHUB_OUTPUT
          fi
          exit 0

      # =================================================================
      # PHASE 4: SUBMISSION
      # =================================================================
      - name: Create PR with documentation changes
        id: submit
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN == '' && secrets.ANTHROPIC_API_KEY || '' }}
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.issue_number }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          claude --print \
            --model ${{ steps.issue_context.outputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:git-pr-push Documentation extraction from issue #$ISSUE_NUMBER"

          PR_URL=$(gh pr view "$BRANCH_NAME" --json url -q '.url' 2>/dev/null || echo "")
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Mark PR ready for review
        if: steps.submit.outputs.has_changes == 'true' && steps.submit.outputs.pr_url != ''
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          gh pr ready "$BRANCH_NAME" 2>/dev/null || true

      - name: Post completion comment
        if: steps.submit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.issue_number }}
          PR_URL: ${{ steps.submit.outputs.pr_url }}
        run: |
          source $HOME/.cargo/env
          erk exec post-extraction-comment \
            --issue-number "$ISSUE_NUMBER" \
            --status complete \
            --pr-url "$PR_URL"

      - name: Post no-changes comment
        if: steps.submit.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.issue_number }}
        run: |
          source $HOME/.cargo/env
          erk exec post-extraction-comment \
            --issue-number "$ISSUE_NUMBER" \
            --status no-changes

      # =================================================================
      # PHASE 5: ERROR HANDLING
      # =================================================================
      - name: Post failure comment
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue_context.outputs.issue_number }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          source $HOME/.cargo/env
          erk exec post-extraction-comment \
            --issue-number "$ISSUE_NUMBER" \
            --status failed \
            --workflow-run-url "$WORKFLOW_RUN_URL"
