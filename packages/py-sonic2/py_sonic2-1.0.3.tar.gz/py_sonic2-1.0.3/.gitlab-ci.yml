# GitLab CI/CD configuration for py-sonic2

stages:
  - test
  - build
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"

# Cache configuration
cache:
  paths:
    - .cache/pip
    - .cache/uv
    - .venv/

# Default image for all jobs
default:
  image: python:3.11
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv --version

# Run linting and type checks
lint:
  stage: test
  script:
    - uv pip install ruff pyright
    - echo "Running code quality checks..."
    - ruff check libsonic/ || echo "⚠ Linting found issues (non-blocking)"
  allow_failure: true
  only:
    - merge_requests
    - main
    - master

# Run tests (placeholder - add actual tests)
test:
  stage: test
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
  image: python:${PYTHON_VERSION}
  script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="/root/.local/bin:$PATH"
    - uv pip install -e .
    - uv pip install pytest pytest-cov
    - echo "⚠ No tests configured yet. Add pytest tests to enable testing."
    # - uv run pytest tests/ --cov=libsonic --cov-report=xml --cov-report=html
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 30 days
  allow_failure: true
  only:
    - merge_requests
    - main
    - master

# Verify package can be built
build:
  stage: build
  script:
    - uv add --dev build twine
    - make clean
    - make build
    - make check
    - echo "✓ Package built successfully"
  artifacts:
    paths:
      - dist/
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - master
    - tags

# Publish to TestPyPI on merge to main/master
publish:testpypi:
  stage: publish
  script:
    - uv add --dev twine
    - echo "Publishing to TestPyPI..."
    - uv run python -m twine upload --repository testpypi dist/* --non-interactive
  dependencies:
    - build
  only:
    - main
    - master
  when: manual
  environment:
    name: testpypi
    url: https://test.pypi.org/project/py-sonic2/

# Publish to PyPI on tags
publish:pypi:
  stage: publish
  script:
    - uv add --dev twine
    - |
      echo "Publishing version $(grep '__version__' libsonic/__init__.py | cut -d"'" -f2) to PyPI..."
    - uv run python -m twine upload dist/* --non-interactive
  dependencies:
    - build
  only:
    - tags
  when: manual
  environment:
    name: production
    url: https://pypi.org/project/py-sonic2/

# Security scanning
security:
  stage: test
  script:
    - uv pip install safety bandit
    - echo "Running security checks..."
    - uv run safety check --json || echo "⚠ Security issues found (non-blocking)"
    - uv run bandit -r libsonic/ -f json || echo "⚠ Bandit found issues (non-blocking)"
  allow_failure: true
  only:
    - merge_requests
    - main
    - master

# Check dependencies for updates
dependency-check:
  stage: test
  script:
    - uv pip install pip-audit
    - echo "Checking for vulnerable dependencies..."
    - uv run pip-audit || echo "⚠ Vulnerable dependencies found (non-blocking)"
  allow_failure: true
  only:
    - schedules
    - main
    - master
