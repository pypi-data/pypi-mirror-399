<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Socket close &mdash; aionetiface 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Future work" href="future_work.html" />
    <link rel="prev" title="Running examples" href="running_examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            aionetiface
          </a>
              <div class="version">
                3.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">General networking</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Knowledge articles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_examples.html">Running examples</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Socket close</a></li>
<li class="toctree-l2"><a class="reference internal" href="future_work.html">Future work</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../built/index.html">Feature showcase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">Development</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">aionetiface</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Knowledge articles</a></li>
      <li class="breadcrumb-item active">Socket close</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/articles/async_close.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="socket-close">
<h1>Socket close<a class="headerlink" href="#socket-close" title="Permalink to this heading"></a></h1>
<p>In Python3 with asyncio, the “correct” way to close a protocol transport
is to call close on the transport. You can also await an event set in
connection_lost. You would think that would be enough to indicate that
the underlying socket was closed (but it’s not.)</p>
<p>At some nebulous point later: the event loop still has to close the socket
and delete it from being monitored. The advice to make sure this happens
is to await asyncio.sleep(0) to ensure the event loop runs to process
the transport.close() properly. But ah… wait, no, that also doesn’t
work. The issue is you have no control on what happens when an
event loop runs / what it prioritized / which is a race condition.
That’s the whole thing with coroutines and concurrency – ordering
is unpredictable. So the whole await sleep … pattern doesn’t work.</p>
<p>This is also the reason why almost all Python network code in the wild
is wrong and littered with resource bugs about unclosed sockets.
So how to properly solve the issue? Just my view, but I think the right
way is to make the event loop set an event when a socket is closed. Then
you can get the awaitable and await when the event loop closes it.</p>
<p>Some caveats in implementing this though: a first attempt might try to
overload internal reader / writer close functions. But the thing with
internal APIs is they can change between Python versions. For 3.13 APIs
like _remove_reader didn’t exist in Python 3.5 (and this project is going
for heavy backwards compatibility.) So the approach I take is this: go
one level deeper – and create a custom Selector. Then it’s possible to
–only– use public APIs to signal socket close behavior: unregister
and modify (available since Python 3.4.)</p>
<p>BTW: this is for asyncio.SelectorEventLoop only. There are other event loops,
this project only uses Selector though as its the one that works with
complex code like TCP hole punching.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="running_examples.html" class="btn btn-neutral float-left" title="Running examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="future_work.html" class="btn btn-neutral float-right" title="Future work" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>