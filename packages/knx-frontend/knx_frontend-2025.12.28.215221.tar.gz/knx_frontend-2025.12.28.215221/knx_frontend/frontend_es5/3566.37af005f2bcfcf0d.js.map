{"version":3,"file":"3566.37af005f2bcfcf0d.js","sources":["webpack://knx-frontend/./homeassistant-frontend/src/dialogs/image-cropper-dialog/image-cropper-dialog.ts"],"sourcesContent":["import Cropper from \"cropperjs\";\n// @ts-ignore\nimport cropperCss from \"cropperjs/dist/cropper.css\";\nimport type { CSSResultGroup, PropertyValues, TemplateResult } from \"lit\";\nimport { css, html, LitElement, nothing, unsafeCSS } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators\";\nimport { classMap } from \"lit/directives/class-map\";\nimport \"../../components/ha-button\";\nimport \"../../components/ha-dialog\";\nimport { haStyleDialog } from \"../../resources/styles\";\nimport type { HomeAssistant } from \"../../types\";\nimport type { HaImageCropperDialogParams } from \"./show-image-cropper-dialog\";\n\n@customElement(\"image-cropper-dialog\")\nexport class HaImagecropperDialog extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @state() private _params?: HaImageCropperDialogParams;\n\n  @state() private _open = false;\n\n  @query(\"img\", true) private _image!: HTMLImageElement;\n\n  private _cropper?: Cropper;\n\n  @state() private _isTargetAspectRatio?: boolean;\n\n  public showDialog(params: HaImageCropperDialogParams): void {\n    this._params = params;\n    this._open = true;\n  }\n\n  public closeDialog() {\n    this._open = false;\n    this._params = undefined;\n    this._cropper?.destroy();\n    this._cropper = undefined;\n    this._isTargetAspectRatio = false;\n  }\n\n  protected updated(changedProperties: PropertyValues) {\n    if (!changedProperties.has(\"_params\") || !this._params) {\n      return;\n    }\n    if (!this._cropper) {\n      this._image.src = URL.createObjectURL(this._params.file);\n      this._cropper = new Cropper(this._image, {\n        aspectRatio: this._params.options.aspectRatio,\n        viewMode: 1,\n        dragMode: \"move\",\n        minCropBoxWidth: 50,\n        ready: () => {\n          this._isTargetAspectRatio = this._checkMatchAspectRatio();\n          URL.revokeObjectURL(this._image!.src);\n        },\n      });\n    } else {\n      this._cropper.replace(URL.createObjectURL(this._params.file));\n    }\n  }\n\n  private _checkMatchAspectRatio(): boolean {\n    const targetRatio = this._params?.options.aspectRatio;\n    if (!targetRatio) {\n      return true;\n    }\n    const imageData = this._cropper!.getImageData();\n    if (imageData.aspectRatio === targetRatio) {\n      return true;\n    }\n\n    // If the image is not exactly the aspect ratio see if it is within a pixel.\n    if (imageData.naturalWidth > imageData.naturalHeight) {\n      const targetHeight = imageData.naturalWidth / targetRatio;\n      return Math.abs(targetHeight - imageData.naturalHeight) <= 1;\n    }\n    const targetWidth = imageData.naturalHeight * targetRatio;\n    return Math.abs(targetWidth - imageData.naturalWidth) <= 1;\n  }\n\n  protected render(): TemplateResult {\n    return html`<ha-dialog\n      @closed=${this.closeDialog}\n      scrimClickAction\n      escapeKeyAction\n      .open=${this._open}\n    >\n      <div\n        class=\"container ${classMap({\n          round: Boolean(this._params?.options.round),\n        })}\"\n      >\n        <img alt=${this.hass.localize(\"ui.dialogs.image_cropper.crop_image\")} />\n      </div>\n      <ha-button\n        appearance=\"plain\"\n        slot=\"primaryAction\"\n        @click=${this.closeDialog}\n      >\n        ${this.hass.localize(\"ui.common.cancel\")}\n      </ha-button>\n      ${this._isTargetAspectRatio\n        ? html`<ha-button\n            appearance=\"plain\"\n            slot=\"primaryAction\"\n            @click=${this._useOriginal}\n          >\n            ${this.hass.localize(\"ui.dialogs.image_cropper.use_original\")}\n          </ha-button>`\n        : nothing}\n\n      <ha-button slot=\"primaryAction\" @click=${this._cropImage}>\n        ${this.hass.localize(\"ui.dialogs.image_cropper.crop\")}\n      </ha-button>\n    </ha-dialog>`;\n  }\n\n  private _cropImage() {\n    this._cropper!.getCroppedCanvas().toBlob(\n      (blob) => {\n        if (!blob) {\n          return;\n        }\n        const file = new File([blob], this._params!.file.name, {\n          type: this._params!.options.type || this._params!.file.type,\n        });\n        this._params!.croppedCallback(file);\n        this.closeDialog();\n      },\n      this._params!.options.type || this._params!.file.type,\n      this._params!.options.quality\n    );\n  }\n\n  private _useOriginal() {\n    this._params!.croppedCallback(this._params!.file);\n    this.closeDialog();\n  }\n\n  static get styles(): CSSResultGroup {\n    return [\n      haStyleDialog,\n      css`\n        ${unsafeCSS(cropperCss)}\n        .container {\n          max-width: 640px;\n        }\n        img {\n          max-width: 100%;\n        }\n        .container.round .cropper-view-box,\n        .container.round .cropper-face {\n          border-radius: var(--ha-border-radius-circle);\n        }\n        .cropper-line,\n        .cropper-point,\n        .cropper-point.point-se::before {\n          background-color: var(--primary-color);\n        }\n      `,\n    ];\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"image-cropper-dialog\": HaImagecropperDialog;\n  }\n}\n"],"names":["HaImagecropperDialog","_LitElement","_this","_callSuper","concat","args","_open","params","this","_params","key","value","_this$_cropper","undefined","_cropper","destroy","_isTargetAspectRatio","changedProperties","has","replace","URL","createObjectURL","file","_image","src","Cropper","aspectRatio","options","viewMode","dragMode","minCropBoxWidth","ready","_checkMatchAspectRatio","revokeObjectURL","_this$_params","targetRatio","imageData","getImageData","naturalWidth","naturalHeight","targetHeight","Math","abs","targetWidth","_this$_params2","html","_t","_","closeDialog","classMap","round","Boolean","hass","localize","_t2","_useOriginal","nothing","_cropImage","getCroppedCanvas","toBlob","blob","File","name","type","croppedCallback","quality","get","haStyleDialog","css","_t3","unsafeCSS","cropperCss","LitElement","attribute"],"mappings":"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"}